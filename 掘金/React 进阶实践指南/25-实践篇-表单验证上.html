<!DOCTYPE html><html lang="en"><head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>第 01 讲：设计一份吸引面试官的简历</title>
<style type="text/css">
:root {
    --control-text-color: #777;
    --select-text-bg-color: rgba(223, 197, 223);  /*#7e66992e;*/
    
    /* side bar */
    --side-bar-bg-color: rgb(255, 255, 255);
    --active-file-text-color: #8163bd;
    --active-file-bg-color: #E9E4F0;
    --item-hover-bg-color: #E9E4F0;
    --active-file-border-color: #8163bd;

    --title-color: #6c549c;
    --font-sans-serif: 'Ubuntu', 'Source Sans Pro', sans-serif !important;
    --font-monospace: 'Fira Code', 'Roboto Mono', monospace !important;
    --purple-1: #8163bd;
    --purple-2: #79589F;
    --purple-3: #fd5eb8;
    --purple-light-1: rgba(99, 99, 172, .05);
    --purple-light-2: rgba(99, 99, 172, .1);
    --purple-light-3: rgba(99, 99, 172, .2);
    --purple-light-4: rgba(129, 99, 189, .3);
    --purple-light-5: #E9E4F0;
    --purple-light-6: rgba(129, 99, 189, .8);
}

/* html {
    font-size: 16px;
} */

body {
    font-family: var(--font-sans-serif);
    color: #34495e;
    -webkit-font-smoothing: antialiased;
    line-height: 1.6rem;
    letter-spacing: 0;
    margin: 0;
    overflow-x: hidden;
}

/* 页边距 和 页面大小 */
#write {
    padding-left: 6ch;
    padding-right: 6ch;
    margin: 0 auto;
}

#write p {
    line-height: 1.6rem;
    word-spacing: .05rem;
}

#write ol li {
    padding-left: 0.5rem;
}

#write > ul:first-child,
#write > ol:first-child {
    margin-top: 30px;
}

body > *:first-child {
    margin-top: 0 !important;
}

body > *:last-child {
    margin-bottom: 0 !important;
}

a {
    color: var(--purple-1);
    padding: 0 2px;
    text-decoration: none;
}
.md-content {
    color: var(--purple-light-6);
}
#write a {
    border-bottom: 1px solid var(--purple-1);
    color: var(--purple-1);
    text-decoration: none;
}

h1,
h2,
h3,
h4,
h5,
h6 {
    position: relative;
    margin-top: 1rem;
    margin-bottom: 0.5rem;
    /* font-weight: bold; */
    font-weight: 500 !important;
    line-height: 1.4;
    cursor: text;
    color: var(--title-color);
    font-family: var(--font-sans-serif);
}

h1:hover a.anchor,
h2:hover a.anchor,
h3:hover a.anchor,
h4:hover a.anchor,
h5:hover a.anchor,
h6:hover a.anchor {
    text-decoration: none;
}

h1 tt,
h1 code {
    font-size: inherit !important;
}
h2 tt,
h2 code {
    font-size: inherit !important;
}
h3 tt,
h3 code {
    font-size: inherit !important;
}
h4 tt,
h4 code {
    font-size: inherit !important;
}
h5 tt,
h5 code {
    font-size: inherit !important;
}
h6 tt,
h6 code {
    font-size: inherit !important;
}


h1 {
    padding-bottom: .4rem;
    font-size: 2.2rem;
    line-height: 1.3;
}
h1 {
    text-align: center;
    padding-bottom: 0.3em;
    font-size: 2.2em;
    line-height: 1.2;
    margin: 2.4em auto 1.2em;
}
h1:after {
    content: '';
    display: block;
    margin: 0.2em auto 0;
    width: 100px;
    height: 2px;
    border-bottom: 2px solid var(--title-color);
}

h2 {
    margin: 1.6em auto 0.5em;
    padding-left: 10px;
    line-height: 1.4;
    font-size: 1.8em;
    border-left: 9px solid var(--title-color);
    border-bottom: 1px solid var(--title-color);
}
h3 {
    font-size: 1.5rem;
    margin: 1.2em auto 0.5em;
}
h4 {
    font-size: 1.3rem;
}
h5 {
    font-size: 1.2rem;
}
h6 {
    font-size: 1.1rem;
}

p,
blockquote,
ul,
ol,
dl,
table {
    margin: 0.8em 0;
}

li > ol,
li > ul {
    margin: 0 0;
}

hr {
    height: 2px;
    padding: 0;
    margin: 16px 0;
    background-color: #e7e7e7;
    border: 0 none;
    overflow: hidden;
    box-sizing: content-box;
}

body > h2:first-child {
    margin-top: 0;
    padding-top: 0;
}

body > h1:first-child {
    margin-top: 0;
    padding-top: 0;
}

body > h1:first-child + h2 {
    margin-top: 0;
    padding-top: 0;
}

body > h3:first-child,
body > h4:first-child,
body > h5:first-child,
body > h6:first-child {
    margin-top: 0;
    padding-top: 0;
}

a:first-child h1,
a:first-child h2,
a:first-child h3,
a:first-child h4,
a:first-child h5,
a:first-child h6 {
    margin-top: 0;
    padding-top: 0;
}

h1 p,
h2 p,
h3 p,
h4 p,
h5 p,
h6 p {
    margin-top: 0;
}

li p.first {
    display: inline-block;
}

ul,
ol {
    padding-left: 30px;
}

ul:first-child,
ol:first-child {
    margin-top: 0;
}

ul:last-child,
ol:last-child {
    margin-bottom: 0;
}

/* 引用 */
blockquote {
    /* margin-left: 1rem; */
    border-left: 4px solid var(--purple-light-4);
    padding: 10px 15px;
    color: #777;
    background-color: var(--purple-light-1);
}

/* 表格 */
table {
    padding: 0;
    word-break: initial;
}

table tr {
    border-top: 1px solid #dfe2e5;
    margin: 0;
    padding: 0;
}

/* 表格 背景色 */
table tr:nth-child(2n),
thead {
    background-color: var(--purple-light-1);
}
#write table thead th {
    background-color: var(--purple-light-2);
}

table tr th {
    font-weight: bold;
    border: 1px solid #dfe2e5;
    border-bottom: 0;
    text-align: left;
    margin: 0;
    padding: 6px 13px;
}

table tr td {
    border: 1px solid #dfe2e5;
    text-align: left;
    margin: 0;
    padding: 6px 13px;
}

table tr th:first-child,
table tr td:first-child {
    margin-top: 0;
}

table tr th:last-child,
table tr td:last-child {
    margin-bottom: 0;
}

/* 粗体 */
#write strong {
    padding: 0 2px;
    color: var(--purple-1);
}

/* 斜体 */
#write em {
    padding: 0 5px 0 2px;
    /* font-style: normal; */
    color: #42b983;
}

/* inline code */
#write code, tt {
    padding: 2px 4px;
    border-radius: 2px;
    font-family: var(--font-monospace);
    font-size: 0.92rem;
    color: var(--purple-3); 
    background-color: rgba(99, 99, 172, .05);
}

tt {
    margin: 0 2px;
}

#write .md-footnote {
    background-color: #f8f8f8;
    color: var(--purple-3);
}

/* heighlight. */
#write mark {
    background-color: #fbd3ea;
    border-radius: 2px;
    padding: 2px 4px;
    margin: 0 2px;
}

#write del {
    padding: 1px 2px;
}

.md-task-list-item > input {
    margin-left: -1.3em;
}

@media print {
    html {
        font-size: 0.9rem;
    }

    table,
    pre {
        page-break-inside: avoid;
    }

    pre {
        word-wrap: break-word;
    }
}

#write pre.md-meta-block {
    padding: 1rem;
    font-size: 85%;
    line-height: 1.45;
    background-color: #f7f7f7;
    border: 0;
    border-radius: 3px;
    color: #777777;
    margin-top: 0 !important;
}

.mathjax-block > .code-tooltip {
    bottom: .375rem;
}

/* 图片 */
.md-image > .md-meta {
    border-radius: 3px;
    font-family: var(--font-monospace);
    padding: 2px 0 0 4px;
    font-size: 0.9em;
    color: inherit;
}
p .md-image:only-child{
    width: auto;
    text-align: left;
    margin-left: 2rem;
}
.md-tag {
    color: inherit;
}
/* 当 “![shadow-随便写]()”写时，会有阴影 */
.md-image img[alt|='shadow'] {
    /* box-shadow: 0 4px 24px -6px #ddd; */
    box-shadow:var(--purple-light-2) 0px 10px 15px;
}

#write a.md-toc-inner {
    line-height: 1.6;
    white-space: pre-line;
    border-bottom: none;
    font-size: 0.9rem;
}

#typora-quick-open {
    border: 1px solid #ddd;
    background-color: #f8f8f8;
}

#typora-quick-open-item {
    background-color: #FAFAFA;
    border-color: #FEFEFE #e5e5e5 #e5e5e5 #eee;
    border-style: solid;
    border-width: 1px;
}

#md-notification:before {
    top: 10px;
}

header,
.context-menu,
.megamenu-content,
footer {
    font-family: var(--font-sans-serif);
}

.file-node-content:hover .file-node-icon,
.file-node-content:hover .file-node-open-state {
    visibility: visible;
}

.md-lang {
    color: #b4654d;
}

.html-for-mac .context-menu {
    --item-hover-bg-color: #E6F0FE;
}

/* 代码框 */
/* CodeMirror 3024 Day theme */

/* 代码段 背景 */
pre {
    --select-text-bg-color: rgba(223, 197, 223) !important;
    margin: .5em 0;
    padding: 1em 1.4em;
    border-radius: 8px;
    background: #f6f8fa;
    overflow-x: auto;
    box-sizing: border-box;
    font-size: 14px;
}

/* 边框 */
.md-fences {
    border: 1px solid #e7eaed;
    border-radius: 3px;
}

.cm-s-inner {
  padding: .25rem;
  border-radius: .25rem;
}

.cm-s-inner.CodeMirror, .cm-s-inner .CodeMirror-gutters {
  background-color: #f8f8f8 !important;
  color: #3a3432 !important;
  border: none;
}

.cm-s-inner .CodeMirror-gutters {
  color: #6d8a88;
}

.cm-s-inner .CodeMirror-cursor {
  border-left: solid thin #5c5855 !important;
}

.cm-s-inner .CodeMirror-linenumber {
  color: #807d7c;
}

.cm-s-inner .CodeMirror-line::selection, .cm-s-inner .CodeMirror-line::-moz-selection,
.cm-s-inner .CodeMirror-line > span::selection,
.cm-s-inner .CodeMirror-line > span::-moz-selection,
.cm-s-inner .CodeMirror-line > span > span::selection,
.cm-s-inner .CodeMirror-line > span > span::-moz-selection {
  background: var(--purple-light-2);
}

.cm-s-inner span.cm-comment {
  color: #cdab53;
}

.cm-s-inner span.cm-string, .cm-s-inner span.cm-string-2 {
  color: #f2b01d;
}

.cm-s-inner span.cm-number {
  color: #a34e8f;
}

.cm-s-inner span.cm-variable {
  color: #01a252;
}

.cm-s-inner span.cm-variable-2 {
  color: #01a0e4;
}

.cm-s-inner span.cm-def {
  /* color: #e8bbd0; */
  color: #e2287f;
}

.cm-s-inner span.cm-operator {
  color: #ff79c6;
}

.cm-s-inner span.cm-keyword {
  color: #db2d20;
}

.cm-s-inner span.cm-atom {
  color: #a34e8f;
}

.cm-s-inner span.cm-meta {
  color: inherit;
}

.cm-s-inner span.cm-tag {
  color: #db2d20;
}

.cm-s-inner span.cm-attribute {
  color: #01a252;
}

.cm-s-inner span.cm-qualifier {
  color: #388aa3;
}

.cm-s-inner span.cm-property {
  color: #01a252;
}

.cm-s-inner span.cm-builtin {
  color: #388aa3;
}

.cm-s-inner span.cm-variable-3, .cm-s-inner span.cm-type {
  color: #ffb86c;
}

.cm-s-inner span.cm-bracket {
  color: #3a3432;
}

.cm-s-inner span.cm-link {
  color: #a34e8f;
}

.cm-s-inner span.cm-error {
  background: #db2d20;
  color: #5c5855;
}

/* .md-fences.md-focus .cm-s-inner .CodeMirror-activeline-background {
  background: var(--purple-light-2);
} */

.cm-s-inner .CodeMirror-matchingbracket {
  text-decoration: underline;
  color: #a34e8f !important;
}

#fences-auto-suggest .active {
  background: #ddd;
}

#write .code-tooltip {
  bottom: initial;
  top: calc(100% - 1px);
  background: #f7f7f7;
  border: 1px solid #ddd;
  border-top: 0;
}

.auto-suggest-container {
  border-color: #b4b4b4;
}

.auto-suggest-container .autoComplt-hint.active {
  background: #b4b4b4;
  color: inherit;
}

/* task list */
#write .md-task-list-item > input {
  -webkit-appearance: initial;
  display: block;
  position: absolute;
  border: 1px solid #b4b4b4;
  border-radius: .25rem;
  margin-top: .1rem;
  margin-left: -1.8rem;
  height: 1.2rem;
  width: 1.2rem;
  transition: background 0.3s;
}

#write .md-task-list-item > input:focus {
  outline: none;
  box-shadow: none;
}

#write .md-task-list-item > input:hover {
  background: #ddd;
}

#write .md-task-list-item > input[checked]::before {
  content: '';
  position: absolute;
  top: 20%;
  left: 50%;
  height: 60%;
  width: 2px;
  transform: rotate(40deg);
  background: #333;
}

#write .md-task-list-item > input[checked]::after {
  content: '';
  position: absolute;
  top: 46%;
  left: 25%;
  height: 30%;
  width: 2px;
  transform: rotate(-40deg);
  background: #333;
}

#write .md-task-list-item > p {
  transition: color 0.3s, opacity 0.3s;
}

#write .md-task-list-item.task-list-done > p {
  color: #b4b4b4;
  text-decoration: line-through;
}

#write .md-task-list-item.task-list-done > p > .md-emoji {
  opacity: .5;
}

#write .md-task-list-item.task-list-done > p > .md-link > a {
  opacity: .6;
}

/* sidebar and outline */
.pin-outline .outline-active {
  color: var(--active-file-text-color); 
}

.file-list-item {
    border-bottom: 1px solid;
    border-color: var(--purple-light-5);
}

.file-list-item-summary {
    font-weight: 400;
}

.file-list-item.active {
    color: var(--active-file-text-color);
    background-color: var(--purple-light-5);
}

.file-tree-node.active>.file-node-background {
    background-color: var(--purple-light-5);
    font-weight: 700;
} 

.file-tree-node.active>.file-node-content {
    color: var(--active-file-text-color);
    font-weight: 700;
}

.file-node-content {
    color: #5e676d;
}

.sidebar-tabs {
    border-bottom: none;
}
.sidebar-tab.active {
    font-weight: 400;
}

.sidebar-content-content {
    font-size: 0.9rem;
}

img {
    max-width: 100%;
}

body {
    background-color: rgb(237, 237, 237);
}
#content {
    width: 836px;
    padding: 50px;
    background: #fff;
    margin: 0 auto;
}/*# sourceURL=/Users/young/Documents/Codes/Fun/lagou/public/purple.css*/</style><style type="text/css">.hljs{display:block;overflow-x:auto;padding:.5em;color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}/*# sourceURL=/Users/young/Documents/Codes/Fun/lagou/public/atom-one-light.min.css*/</style></head>
<body>
<div id="content"><h1>实践篇-表单验证上</h1>
<h2>一 前言</h2>
<p>验证表单的设计，一直是比较复杂棘手的问题，难点在于对表单数据层的管理，以及把状态分配给每一个表单单元项。本章节来实现一套表单验证系统，通过本章节的学习，读者能够掌握以下知识点：</p>
<ul>
<li>表单控件组件设计。</li>
<li>建立表单状态管理，状态分发，表单验证。</li>
<li>自定义 hooks —— <code>useForm</code> 编写。</li>
<li><code>Form</code> ，<code>FormItem</code> 如何建立关联，协调管理表单状态。</li>
</ul>
<p>由于表单验证章节内容过多，分为上下两个章节来介绍。</p>
<ul>
<li>本章节主要介绍表单系统的设计思路和表单状态管理 <code>FormStore</code> 的实现。</li>
<li>下章节将介绍 Form 和 FormItem 的编写，以及功能验证。</li>
</ul>
<h2>二 设计思路</h2>
<p>可能开发者平时使用验证表单控件感觉挺便携方便的，那是因为在整个表单内部，已经为开发者做了大部分的‘脏活’，‘累活’，一个完整验证表单体系实际是很复杂的，整个流程可以分为，<strong>状态收集</strong> ，<strong>状态管理</strong> ，<strong>状态验证</strong> ， <strong>状态下发</strong> ，等诸多环节，所以在开发一套受宠于大众的表单控件，首先每一个环节设计是蛮重要的。接下来首先介绍一下，如何设计一套表单系统。</p>
<p>在设计之前，拿 antd 为例子，看一下一个基本的表单长什么样子 （ 可以称之为 <code>Demo1</code> ） ：</p>
<pre><code class="hljs language-js">&#x3C;<span class="hljs-title class_">Form</span>  onFinish={onFinish} >
   <span class="xml"><span class="hljs-tag">&#x3C;<span class="hljs-name">FormItem</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"name"</span>  <span class="hljs-attr">label</span>=<span class="hljs-string">"小册名称"</span> ></span>
       <span class="hljs-tag">&#x3C;<span class="hljs-name">Input</span> /></span>
   <span class="hljs-tag">&#x3C;/<span class="hljs-name">FormItem</span>></span></span>
    <span class="xml"><span class="hljs-tag">&#x3C;<span class="hljs-name">FormItem</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"author"</span>  <span class="hljs-attr">label</span>=<span class="hljs-string">"小册作者"</span> ></span>
       <span class="hljs-tag">&#x3C;<span class="hljs-name">Input</span> /></span>
   <span class="hljs-tag">&#x3C;/<span class="hljs-name">FormItem</span>></span></span>
   <span class="xml"><span class="hljs-tag">&#x3C;<span class="hljs-name">Button</span> <span class="hljs-attr">htmlType</span>=<span class="hljs-string">"submit"</span> ></span>确定<span class="hljs-tag">&#x3C;/<span class="hljs-name">Button</span>></span></span>
&#x3C;/<span class="hljs-title class_">Form</span>>
</code></pre>
<h3>1 表单组件层模型设计</h3>
<p>如上，一套表单系统分为 Form ，FormItem ，表单控件三部分构成，下面一一介绍三个部分作用以及应该如何设计。</p>
<p><code>Form</code> 组件定位以及设计原则：</p>
<ul>
<li><strong>状态保存</strong>： <code>Form</code> 的作用，管理整个表单的状态，这个状态包括具体表单控件的 value，以及获取表单，提交表单，重置表单，验证表单等方法。</li>
<li><strong>状态下发</strong>： <code>Form</code> 不仅仅要管理状态，而且还要下发传递这些状态。把这些状态下发给每一个 FormItem ，由于考虑到 Form 和 FormItem 有可能深层次的嵌套，所以选择通过 React context 保存下发状态最佳。</li>
<li><strong>保存原生 form 功能</strong> ： <code>Form</code> 满足上述两点功能之外，还要和原生的 form 的功能保持一致性。</li>
</ul>
<p><code>FormItem</code>组件定位以及设计原则：</p>
<ul>
<li><strong>状态收集</strong>： 首先很重要的一点，就是收集表单的状态，传递给 Form 组件，比如属性名，属性值，校验规则等。</li>
<li><strong>控制表单组件</strong>：还有一个功能就是，将 <code>FormItem</code> 包裹的组件，变成受控的，一方面能够自由传递值 value 给表单控件，另一方面，能够劫持表单控件的 change 事件，得到最新的 value ，上传状态。</li>
<li><strong>提供Label和验证结果的 UI 层</strong> ： <code>FormItem</code> 还有一个作用就是要提供表单单元项的标签 label ，如果校验不通过的情况下，需要展示错误信息 UI 样式。</li>
</ul>
<p>表单控件设计（比如 Input ，Select 等）：</p>
<ul>
<li>首先表单控件一定是与上述整个表单验证系统零耦合的，也就是说 Input 等控件脱离整个表单验证系统，可以独立使用。</li>
<li>在表单验证系统中，表单控件，不需要自己绑定事件，统一托管于 <code>FormItem</code> 处理。</li>
</ul>
<p>三者关系如下图所示：</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a3125cd41b6948ebbd0bc6cd2ce3157f~tplv-k3u1fbpfcp-watermark.image" alt="1.jpg"></p>
<h3>2 状态管理层设计</h3>
<h4>如何设计表单的状态层？</h4>
<p><strong>保存信息：</strong> 首先最直接的是，需要保存表单的属性名 <code>name</code> ，和当前的属性值 <code>value</code> ，除此之外还要保存当前表单的验证规则 <code>rule</code> ，验证的提示文案 <code>message</code> ，以及验证状态 <code>status</code>。
我这里收到 <code>Promise</code> 的启发，引用了三种状态：</p>
<ul>
<li>resolve -> 成功状态，当表单验证成功之后，就会给 resolve 成功状态标签。</li>
<li>reject -> 失败状态，表单验证失败，就会给  reject 失败状态标签。</li>
<li>pendding -> 待验证状态，初始化，或者重新赋予表单新的值，就会给 pendding 待验证标签。</li>
</ul>
<p><strong>数据结构：</strong></p>
<p>上面介绍了表单状态层保存的信息。接下来用什么数据结构保留这些信息。</p>
<pre><code class="hljs language-js"><span class="hljs-comment">/*  
    <span class="hljs-doctag">TODO:</span> 数据结构
    model = {
       [name] ->  validate  = {
           value     -> 表单值    (可以重新设定)
           rule      -> 验证规则  ( 可以重新设定)
           required  -> 是否必添 -> 在含有 rule 的情况下默认为 true
           message   -> 提示消息
           status    -> 验证状态  resolve -> 成功状态 ｜reject -> 失败状态 ｜ pending -> 待验证状态 |
       }
   }
*/</span>
</code></pre>
<ul>
<li><code>model</code> 为整个 Form 表单的数据层结构。</li>
<li><code>name</code> 为键，对应 FormItem 的每一个 name 属性，</li>
<li><code>validate</code> 为 name 属性对应的值，保存当前的表单信息，包括上面说到那几个重要信息。</li>
</ul>
<p>打个比方：上述 <code>Demo1</code> 中，最后存在 form 的数据结构如下所示：</p>
<pre><code class="hljs language-js">model = {
    name :{ <span class="hljs-comment">/* 小册名称 formItem */</span>
        <span class="hljs-attr">value</span>: ...
        <span class="hljs-attr">rule</span>:...
        <span class="hljs-attr">required</span>:...
        <span class="hljs-attr">message</span>:...
        <span class="hljs-attr">status</span>:...
    },
    <span class="hljs-attr">author</span>:{ <span class="hljs-comment">/* 小册作者 formItem */</span>
        <span class="hljs-attr">value</span>: ...
        <span class="hljs-attr">rule</span>:...
        <span class="hljs-attr">required</span>:...
        <span class="hljs-attr">message</span>:...
        <span class="hljs-attr">status</span>:...
    }
}
</code></pre>
<h4>表单状态层保存在哪里？</h4>
<p>上面说到了整个表单的状态层，那么状态层保存在哪里呢 ？</p>
<p>状态层最佳选择就是保存在 Form 内部，可以通过 <code>useForm</code> 一个自定义 hooks 来维护和管理表单状态实例 <strong><code>FormStore</code></strong> 。</p>
<h3>3 数据通信层设计</h3>
<p>整个表单系统数据通信，还是从<strong>改变状态</strong>，<strong>触发校验</strong>两个方向入手。</p>
<h4>改变状态</h4>
<p>当系统中一个控件比如 <code>Input</code> 值改变的时候，①可以是触发了 <code>onChange</code> 方法，首先由于 <code>FormItem</code> 控制表单控件，所以 FormItem 会最先感知到最新的 value ，②并通知给 Form 中的表单管理 <code>FormStore</code> ， ③ <code>FormStore</code> 会更新状态，④ 然后把最新状态下发到对应的 <code>FormItem</code> ，⑤<code>FormItem</code> 接收到任务，再让  Input 更新最新的值，视觉感受 Input 框会发生变化 ，完成受控组件状态改变流程。</p>
<p>比如触发上述 <code>Demo1</code> 中 name 对应的 Input，内部流程图如下：</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/43639f118ed14c06886f84f69c3a1670~tplv-k3u1fbpfcp-watermark.image" alt="2.jpg"></p>
<h4>表单校验</h4>
<p>表单校验有两种情况：</p>
<p><strong>第一种：</strong> 可能是给 FormItem 绑定的校验事件触发，比如 onBlur 事件触发 ，而引起的对单一表单的校验。流程和上述改变状态相同类似。</p>
<p><strong>第二种：</strong> 有可能是提交事件触发，或者手动触发校验事件，引起的整个表单的校验。流程首先触发 submit 事件，①然后通知给 Form 中 <code>FormStore</code>，② <code>FormStore</code> 会对整个表单进行校验，③然后把每个表单的状态，异步并批量下发到每一个 FormItem ，④ FormItem 就可以展示验证结果。</p>
<p>比如触发 <code>Demo1</code> 中的提交按钮，流程图：</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d0709d5a9fc64383a83227308aa6adbf~tplv-k3u1fbpfcp-watermark.image" alt="3.jpg"></p>
<p>整个表单验证系统的设计阶段，从几个角度介绍了系统设计，当然其中还有很多没有提及细节，会在实现环节详细讲解，接下来就是具体功能的实现环节。</p>
<h2>三 FormStore 表单状态管理</h2>
<p><code>FormStore</code> 是整个表单验证系统最核心的功能了，里面包括保存的表单状态 model， 以及管理这些状态的方法，这些方法有的是对外暴露的，开发者可以通过调用这些对外的 api 实现<strong>提交表单</strong>，<strong>校验表单</strong> ， <strong>重置表单</strong> 等功能。 参考和对标 <code>antd</code> 本质上是 <code>rc-form</code>， 罗列的方法如下。</p>
<h3>FormStore 实例对外接口</h3>
<p><strong>以下接口提供给开发者使用。</strong></p>













































<table><thead><tr><th>对外接口名称</th><th>作用</th><th>参数说明</th></tr></thead><tbody><tr><td>submit</td><td>提交表单</td><td>一个参数 cb，校验完表单执行，通过校验 cb 的参数为表单数据层，未通过校验 cb 参数为 <code>false</code></td></tr><tr><td>resetFields</td><td>重置表单</td><td>无参数</td></tr><tr><td>setFields</td><td>设置一组表单值</td><td>一个参数为 object， key ——为表单名称，value ——表单项，可以是值，校验规则，校验文案 ，例如 <code> setFields({ name: { value : '《React进阶实践指南》' , author:'我不是外星人' } ,  })</code>  或者  <code>setFields({ name:'《React进阶实践指南》', author:'我不是外星人'  })</code></td></tr><tr><td>setFieldsValue</td><td>设置单一表单值</td><td>二个参数，第一个参数为 name 表单项名称，第二个参数 value ，设置表单的值 ， 例如 <code>setFieldsValue('author','我不是外星人')</code></td></tr><tr><td>getFieldValue</td><td>获取对应字段名的值</td><td>一个参数，对应的表单项名称，例如 <code>getFieldValue('name')</code></td></tr><tr><td>getFieldsValue</td><td>获取整个表单的value</td><td>无参数</td></tr><tr><td>validateFields</td><td>验证整个表单层</td><td>一个参数，回调函数，回调函数，参数为验证结果，</td></tr></tbody></table>
<p><strong>以下接口提供给 Form 和 FormItem 使用。</strong></p>






























<table><thead><tr><th>接口名称</th><th>作用</th><th>参数说明</th></tr></thead><tbody><tr><td>setCallback</td><td>注册绑定在 Form 上的事件 ， 比如 <code>onFinish</code> ｜ <code>onFinishFailed</code></td><td>一个参数，为一个对象，存放需要注册的事件。</td></tr><tr><td>dispatch</td><td>可以通过 dispatch 调用 FormStore 内部的方法</td><td>第一个参数是一个对象，里面 type 为调用的方法，其余参数依次为调用方法的参数。</td></tr><tr><td>registerValidateFields</td><td>FormItem 注册表单单元项</td><td>三个参数，第一个参数单元项名称，第二个参数为，FormItem 的控制器，可以让 FormItem 触发更新，第三个参数，为注册的内容，比如 rule，message 等</td></tr><tr><td>unRegisterValidate</td><td>解绑注册的表单单元项</td><td>一个参数，表单单元项名称</td></tr></tbody></table>
<h3>重要属性</h3>
<p>上述介绍了需要完成的对外接口，接下来介绍一下 FormStore 保存的重要属性。</p>
<ul>
<li><code>model</code> ： 首先 model 为整个表单状态层的核心，绑定单元项的内容都存在 model 中，上述已经介绍了。</li>
<li><code>control</code> ：control 存放了每一个 FormItem 的更新函数，因为表单状态改变，Form 需要把状态下发到每一个需要更新的 FormItem 上。</li>
<li><code>callback</code>： callback 存放表单状态改变的监听函数。</li>
<li><code>penddingValidateQueue</code>：由于表单验证状态的下发是采用异步的，显示验证状态的更新，</li>
</ul>
<h3>代码实现</h3>
<p>接下来就是具体的代码实现和流程分析。</p>
<pre><code class="hljs language-js"><span class="hljs-comment">/* 对外接口  */</span>
<span class="hljs-keyword">const</span> formInstanceApi = [
    <span class="hljs-string">'setCallback'</span>,
    <span class="hljs-string">'dispatch'</span>,
    <span class="hljs-string">'registerValidateFields'</span>,
    <span class="hljs-string">'resetFields'</span>,
    <span class="hljs-string">'setFields'</span>,
    <span class="hljs-string">'setFieldsValue'</span>,
    <span class="hljs-string">'getFieldsValue'</span>,
    <span class="hljs-string">'getFieldValue'</span>,
    <span class="hljs-string">'validateFields'</span>,
    <span class="hljs-string">'submit'</span>,
    <span class="hljs-string">'unRegisterValidate'</span>
]

<span class="hljs-comment">/* 判断是否是正则表达式 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">isReg</span> = (<span class="hljs-params">value</span>) => value <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">RegExp</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">FormStore</span>{
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">forceUpdate,defaultFormValue={}</span>){
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">FormUpdate</span> = forceUpdate     <span class="hljs-comment">/* 为 Form 的更新函数，目前没有用到 */</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">model</span> = {}                   <span class="hljs-comment">/* 表单状态层 */</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">control</span> = {}                 <span class="hljs-comment">/* 控制每个 formItem 的控制器  */</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">isSchedule</span> = <span class="hljs-literal">false</span>           <span class="hljs-comment">/* 开启调度 */</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">callback</span> = {}                <span class="hljs-comment">/* 存放监听函数 callback */</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">penddingValidateQueue</span> = []   <span class="hljs-comment">/* 批量更新队列 */</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultFormValue</span> = defaultFormValue <span class="hljs-comment">/* 表单初始化的值 */</span>
    }
    <span class="hljs-comment">/* 提供操作form的方法 */</span>
    <span class="hljs-title function_">getForm</span>(<span class="hljs-params"></span>){
        <span class="hljs-keyword">return</span> formInstanceApi.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">map,item</span>) =></span> {
            map[item] = <span class="hljs-variable language_">this</span>[item].<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>)
            <span class="hljs-keyword">return</span> map
        } ,{})
    }
    <span class="hljs-comment">/* 创建一个验证模块 */</span>
    <span class="hljs-keyword">static</span> <span class="hljs-title function_">createValidate</span>(<span class="hljs-params">validate</span>){
        <span class="hljs-keyword">const</span> { value, rule, required, message } = validate
        <span class="hljs-keyword">return</span> {
            value,
            <span class="hljs-attr">rule</span>: rule || (<span class="hljs-function">() =></span> <span class="hljs-literal">true</span>),
            <span class="hljs-attr">required</span>: required || <span class="hljs-literal">false</span>,
            <span class="hljs-attr">message</span>: message || <span class="hljs-string">''</span>,
            <span class="hljs-attr">status</span>:<span class="hljs-string">'pending'</span>
        }

    }
    <span class="hljs-comment">/* 处理回调函数 */</span>
    <span class="hljs-title function_">setCallback</span>(<span class="hljs-params">callback</span>){
        <span class="hljs-keyword">if</span>(callback) <span class="hljs-variable language_">this</span>.<span class="hljs-property">callback</span> = callback
    }
    <span class="hljs-comment">/* 触发事件 */</span>
    <span class="hljs-title function_">dispatch</span>(<span class="hljs-params">action,...arg</span>){
        <span class="hljs-keyword">if</span>(!action &#x26;&#x26; <span class="hljs-keyword">typeof</span> action !== <span class="hljs-string">'object'</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
       <span class="hljs-keyword">const</span> { type } = action
       <span class="hljs-keyword">if</span>(~formInstanceApi.<span class="hljs-title function_">indexOf</span>(type)){
           <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>[type](...arg)
       }<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">this</span>[type] === <span class="hljs-string">'function'</span>   ){
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>[type](...arg)
       }
    }
    <span class="hljs-comment">/* 注册表单单元项 */</span>
    <span class="hljs-title function_">registerValidateFields</span>(<span class="hljs-params">name,control,model</span>){
       <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultFormValue</span>[name]) model.<span class="hljs-property">value</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultFormValue</span>[name] <span class="hljs-comment">/* 如果存在默认值的情况 */</span>
       <span class="hljs-keyword">const</span> validate = <span class="hljs-title class_">FormStore</span>.<span class="hljs-title function_">createValidate</span>(model)
       <span class="hljs-variable language_">this</span>.<span class="hljs-property">model</span>[name] = validate
       <span class="hljs-variable language_">this</span>.<span class="hljs-property">control</span>[name] = control
    }
    <span class="hljs-comment">/* 卸载注册表单单元项 */</span>
    <span class="hljs-title function_">unRegisterValidate</span>(<span class="hljs-params">name</span>){
       <span class="hljs-keyword">delete</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">model</span>[name]
       <span class="hljs-keyword">delete</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">control</span>[name]
    }
    <span class="hljs-comment">/* 通知对应FormItem更新 */</span>
    <span class="hljs-title function_">notifyChange</span>(<span class="hljs-params">name</span>){
        <span class="hljs-keyword">const</span> controller = <span class="hljs-variable language_">this</span>.<span class="hljs-property">control</span>[name]
        <span class="hljs-keyword">if</span>(controller) controller?.<span class="hljs-title function_">changeValue</span>()
    }
    <span class="hljs-comment">/* 重置表单 */</span>
    <span class="hljs-title function_">resetFields</span>(<span class="hljs-params"></span>){
        <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">model</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">modelName</span> =></span> {
             <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setValueClearStatus</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">model</span>[modelName],modelName,<span class="hljs-literal">null</span>)
        })
    }
    <span class="hljs-comment">/* 设置一组字段状态	  */</span>
    <span class="hljs-title function_">setFields</span>(<span class="hljs-params">object</span>){
        <span class="hljs-keyword">if</span>( <span class="hljs-keyword">typeof</span> object !== <span class="hljs-string">'object'</span> ) <span class="hljs-keyword">return</span>
        <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(object).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">modelName</span>=></span>{
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setFieldsValue</span>(modelName,object[modelName])
        })
    }
    <span class="hljs-comment">/* 设置表单值 */</span>
    <span class="hljs-title function_">setFieldsValue</span>(<span class="hljs-params">name,modelValue</span>){
      <span class="hljs-keyword">const</span> model = <span class="hljs-variable language_">this</span>.<span class="hljs-property">model</span>[name]
       <span class="hljs-keyword">if</span>(!model) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
       <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> modelValue === <span class="hljs-string">'object'</span> ){ <span class="hljs-comment">/* 设置表单项 */</span>
           <span class="hljs-keyword">const</span> { message ,rule , value  } = modelValue
           <span class="hljs-keyword">if</span>(message) model.<span class="hljs-property">message</span> = message
           <span class="hljs-keyword">if</span>(rule)    model.<span class="hljs-property">rule</span> = rule
           <span class="hljs-keyword">if</span>(value)   model.<span class="hljs-property">value</span> = value
           model.<span class="hljs-property">status</span> = <span class="hljs-string">'pending'</span>              <span class="hljs-comment">/* 设置待验证状态 */</span>
           <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">validateFieldValue</span>(name,<span class="hljs-literal">true</span>)     <span class="hljs-comment">/* 如果重新设置了验证规则，那么重新验证一次 */</span>
       }<span class="hljs-keyword">else</span> {
           <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setValueClearStatus</span>(model,name,modelValue)
       }
    }
    <span class="hljs-comment">/* 复制并清空状态 */</span>
    <span class="hljs-title function_">setValueClearStatus</span>(<span class="hljs-params">model,name,value</span>){
        model.<span class="hljs-property">value</span> = value
        model.<span class="hljs-property">status</span> = <span class="hljs-string">'pending'</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">notifyChange</span>(name)
    }
  
    <span class="hljs-comment">/* 获取表单数据层的值 */</span>
    <span class="hljs-title function_">getFieldsValue</span>(<span class="hljs-params"></span>){
       <span class="hljs-keyword">const</span> formData = {}
       <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">model</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">modelName</span>=></span>{
           formData[modelName] = <span class="hljs-variable language_">this</span>.<span class="hljs-property">model</span>[modelName].<span class="hljs-property">value</span>
       })
       <span class="hljs-keyword">return</span> formData
    }
    <span class="hljs-comment">/* 获取表单模型 */</span>
    <span class="hljs-title function_">getFieldModel</span>(<span class="hljs-params">name</span>){
        <span class="hljs-keyword">const</span> model =  <span class="hljs-variable language_">this</span>.<span class="hljs-property">model</span>[name]
        <span class="hljs-keyword">return</span> model ? model : {}
    }
    <span class="hljs-comment">/* 获取对应字段名的值 */</span>
    <span class="hljs-title function_">getFieldValue</span>(<span class="hljs-params">name</span>){
        <span class="hljs-keyword">const</span> model =  <span class="hljs-variable language_">this</span>.<span class="hljs-property">model</span>[name]
        <span class="hljs-keyword">if</span>(!model &#x26;&#x26; <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultFormValue</span>[name]) <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultFormValue</span>[name] <span class="hljs-comment">/* 没有注册，但是存在默认值的情况 */</span>
        <span class="hljs-keyword">return</span> model ? model.<span class="hljs-property">value</span> : <span class="hljs-literal">null</span>
    }
    <span class="hljs-comment">/* 单一表单单元项验证 */</span>
    <span class="hljs-title function_">validateFieldValue</span>(<span class="hljs-params">name,forceUpdate = <span class="hljs-literal">false</span></span>){
        <span class="hljs-keyword">const</span> model = <span class="hljs-variable language_">this</span>.<span class="hljs-property">model</span>[name]
        <span class="hljs-comment">/* 记录上次状态 */</span>
        <span class="hljs-keyword">const</span> lastStatus =  model.<span class="hljs-property">status</span>
        <span class="hljs-keyword">if</span>(!model) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
        <span class="hljs-keyword">const</span> { required, rule , value } = model
        <span class="hljs-keyword">let</span> status = <span class="hljs-string">'resolve'</span>
        <span class="hljs-keyword">if</span>(required &#x26;&#x26; !value ){
            status = <span class="hljs-string">'reject'</span>
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-title function_">isReg</span>(rule)){     <span class="hljs-comment">/* 正则校验规则 */</span>
            status = rule.<span class="hljs-title function_">test</span>(value) ? <span class="hljs-string">'resolve'</span> : <span class="hljs-string">'reject'</span>
        }<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> rule === <span class="hljs-string">'function'</span>){ <span class="hljs-comment">/* 自定义校验规则 */</span>
            status = <span class="hljs-title function_">rule</span>(value) ? <span class="hljs-string">'resolve'</span> : <span class="hljs-string">'reject'</span>
        }
        model.<span class="hljs-property">status</span> = status
        <span class="hljs-keyword">if</span>(lastStatus !==  status || forceUpdate ){
           <span class="hljs-keyword">const</span> notify = <span class="hljs-variable language_">this</span>.<span class="hljs-property">notifyChange</span>.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>,name)
           <span class="hljs-variable language_">this</span>.<span class="hljs-property">penddingValidateQueue</span>.<span class="hljs-title function_">push</span>( notify )
        }
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">scheduleValidate</span>()
        <span class="hljs-keyword">return</span> status
    }
    <span class="hljs-comment">/* 批量调度验证更新任务 */</span>
    <span class="hljs-title function_">scheduleValidate</span>(<span class="hljs-params"></span>){
       <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">isSchedule</span>) <span class="hljs-keyword">return</span>
       <span class="hljs-variable language_">this</span>.<span class="hljs-property">isSchedule</span> = <span class="hljs-literal">true</span>
       <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">()=></span>{
           <span class="hljs-comment">/* 批量更新验证任务 */</span>
          <span class="hljs-title function_">unstable_batchedUpdates</span>(<span class="hljs-function">()=></span>{
              <span class="hljs-keyword">do</span>{
                <span class="hljs-keyword">let</span> notify = <span class="hljs-variable language_">this</span>.<span class="hljs-property">penddingValidateQueue</span>.<span class="hljs-title function_">shift</span>()
                notify &#x26;&#x26; <span class="hljs-title function_">notify</span>()  <span class="hljs-comment">/* 触发更新 */</span>
              }<span class="hljs-keyword">while</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">penddingValidateQueue</span>.<span class="hljs-property">length</span> > <span class="hljs-number">0</span>)
              <span class="hljs-variable language_">this</span>.<span class="hljs-property">isSchedule</span> = <span class="hljs-literal">false</span>
          })
       })
    }
    <span class="hljs-comment">/* 表单整体验证 */</span>
    <span class="hljs-title function_">validateFields</span>(<span class="hljs-params">callback</span>){
       <span class="hljs-keyword">let</span> status = <span class="hljs-literal">true</span>
       <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">model</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">modelName</span>=></span>{
           <span class="hljs-keyword">const</span> modelStates = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">validateFieldValue</span>(modelName,<span class="hljs-literal">true</span>)
           <span class="hljs-keyword">if</span>(modelStates===<span class="hljs-string">'reject'</span>) status = <span class="hljs-literal">false</span>
       })
       <span class="hljs-title function_">callback</span>(status)
    }
    <span class="hljs-comment">/* 提交表单 */</span>
    <span class="hljs-title function_">submit</span>(<span class="hljs-params">cb</span>){
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">validateFields</span>(<span class="hljs-function">(<span class="hljs-params">res</span>)=></span>{
            <span class="hljs-keyword">const</span> { onFinish, onFinishFailed} = <span class="hljs-variable language_">this</span>.<span class="hljs-property">callback</span>
            cb &#x26;&#x26; <span class="hljs-title function_">cb</span>(res)
            <span class="hljs-keyword">if</span>(!res) onFinishFailed &#x26;&#x26; <span class="hljs-keyword">typeof</span> onFinishFailed === <span class="hljs-string">'function'</span> &#x26;&#x26; <span class="hljs-title function_">onFinishFailed</span>() <span class="hljs-comment">/* 验证失败 */</span>
            onFinish &#x26;&#x26; <span class="hljs-keyword">typeof</span> onFinish === <span class="hljs-string">'function'</span> &#x26;&#x26; <span class="hljs-title function_">onFinish</span>( <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getFieldsValue</span>() )     <span class="hljs-comment">/* 验证成功 */</span>
        })
    }

}
</code></pre>
<p><strong>流程分析：</strong></p>
<p><strong>初始化流程</strong></p>
<ul>
<li>
<p><strong>constructor</strong> ，FormStore 通过 new 方式实例化。实例化过程中会绑定 <code>model</code> ， <code>control</code> 等属性。</p>
</li>
<li>
<p><strong>getForm</strong>： 这里思考一下问题，就是需不需要把整个 FormStore 全部向 Form 组件暴露出去，答案是肯定不能这么做，因为如果 FormStore 整个实例暴露出去，就可以获取内部的状态 model 和 control 等重要模块，如果篡改模块下的内容，那么后果无法想象的，所以对外提供的只是改变表单状态的接口。通过 getForm 把重要的 API 暴露出去就好。getForm 通过数组 reduce 把对外注册的接口数组 formInstanceApi 一一绑定 this 然后形成一个对象，传递给 form 组件。</p>
</li>
<li>
<p><strong>setCallback</strong> ： 这个函数做的事情很简单，就是注册 callback 事件。在表单的一些重要阶段，比如提交成功，提交失败的时候，执行这些回调函数。</p>
</li>
</ul>
<p><strong>表单注册流程</strong></p>
<ul>
<li>
<p><strong>static createValidate</strong>： 静态方法——创建一个验证 Validate ，也就是 model 下的每一个模块，主要在注册表单单元项的时候使用。</p>
</li>
<li>
<p><strong>registerValidateFields</strong> ：注册表单单元项，这个在 FormItem 初始化时候调用，把验证信息，验证文案，等信息，通过 ·<code>createValidate</code> 注册到 model 中， 把 FormItem 的更新函数注册到 control 中。</p>
</li>
<li>
<p><strong>unRegisterValidate</strong>：在 FormItem 的生命周期销毁阶段执行，解绑上面 <code>registerValidateFields</code> 注册的内容。</p>
</li>
</ul>
<p><strong>表单状态设置，获取，重置</strong></p>
<ul>
<li>
<p><strong>notifyChange</strong>：每当给表单单元项 FormItem 重新赋值的时候，就会执行当前 FormItem 的更新函数，派发视图更新。（这里可以提前透露一下，control 存放的就是每个 FormItem 组件的 <code>useState</code> 方法 ）</p>
</li>
<li>
<p><strong>setValueClearStatus</strong>： 重新设置表单值，并重置待验证状态 <code>pendding</code>，然后触发 notifyChange 促使 FormItem 更新。</p>
</li>
<li>
<p><strong>setFieldsValue</strong>：设置一个表单值， 如果重新设置了验证规则，那么重新验证一次，如果只是设置了表单项的值，调用 setValueClearStatus 更新。</p>
</li>
<li>
<p><strong>setFields</strong>： 设置一组表单值，本质上对每一个单元项触发 setFieldsValue。</p>
</li>
<li>
<p><strong>getFieldValue</strong>：获取表单值，本质上就是获取 model 下每一个模块的 value 值。</p>
</li>
<li>
<p><strong>getFieldsValue</strong>：获取整个表单的数据层（分别获取每一个模块下的 value ）。</p>
</li>
<li>
<p><strong>getFieldModel</strong>：获取表单的模型，这个 api 设计为了让 UI 显示验证成功或者失败的状态，以及提示的文案。</p>
</li>
<li>
<p><strong>resetFields</strong>：本质上就是调用 <code>setValueClearStatus</code> 重新设置每一个表单单元项的状态。</p>
</li>
</ul>
<p><strong>表单验证</strong></p>
<ul>
<li>
<p><strong>validateFieldValue</strong>：验证表单的单元项，通过判断规则，如果规则是正则表达式那么触发正则 test 方法，如果是自定义规则，那么执行函数，返回值布尔值判断是否通过校验。如果状态改变，把当前更新任务放在 <code>penddingValidateQueue</code> 待验证队列中。<strong>为什么采用异步校验更新呢？</strong> 首先验证状态改变，带来的视图更新，不是那么重要，可以先执行更高优先级的任务，还有一点就是整个验证功能，有可能在异步情况下，表单会有多个表单单元项，如果直接执行更新任务，可能会让表单更新多次，所以放入<code>penddingValidateQueue</code> 在配合 <code>unstable_batchedUpdates</code>批量更新，统一更新这些状态。</p>
</li>
<li>
<p><strong>scheduleValidate</strong>：scheduleValidate 执行会开启 <code>isSchedule = true</code>开关，如果有多个验证任务，都会放入 <code>penddingValidateQueue</code> ，最后统一执行一次任务处理逻辑。调用 <code>Promise.resolve()</code>和 <code>unstable_batchedUpdates</code> 异步批量更新 ，批量更新完毕，关闭开关 <code>this.isSchedule = false</code> 。</p>
</li>
<li>
<p><strong>validateFields</strong>： validateFields 会对每一个表单单元项触发 validateFieldValue ，然后执行回调函数，回调函数参数，代表验证是否通过，如果有一个验证不通过，那么整体就不通过验证。</p>
</li>
<li>
<p><strong>submit</strong>：submit 本质就是调用 <code>validateFields</code> 验证这个表单，然后在 validateFields 回调函数中，触发对应的监听方法 <code>callback</code> ， 成功触发 <code>onFinish</code>， 失败调用 <code>onFinishFailed</code> ，这些方法都是绑定在 Form 的回调函数。</p>
</li>
</ul>
<h2>四 useForm 表单状态管理 hooks 设计</h2>
<p>上面的 <code>FormStore</code> 就是通过自定义 hooks —— <code>useForm</code> 创建出来的。useForm 可以独立使用，创建一个 <code>formInstance</code> ，然后作为 form 属性赋值给 Form 表单。 如果没有传递  默认会在 Form 里通过 <code>useForm</code> 自动创建一个。（参考 antd，用法一致 ）。</p>
<p><strong>代码实现：</strong></p>
<pre><code class="hljs language-js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">useForm</span>(<span class="hljs-params">form,defaultFormValue = {}</span>){
   <span class="hljs-keyword">const</span> formRef = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>)
   <span class="hljs-keyword">const</span> [, forceUpdate] = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useState</span>({})
   <span class="hljs-keyword">if</span>(!formRef.<span class="hljs-property">current</span>){
      <span class="hljs-keyword">if</span>(form){
          formRef.<span class="hljs-property">current</span> = form  <span class="hljs-comment">/* 如果已经有 form，那么复用当前 form  */</span>
      }<span class="hljs-keyword">else</span> { <span class="hljs-comment">/* 没有 form 创建一个 form */</span>
        <span class="hljs-keyword">const</span> formStoreCurrent = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormStore</span>(forceUpdate,defaultFormValue)
        <span class="hljs-comment">/* 获取实例方法 */</span>
        formRef.<span class="hljs-property">current</span> = formStoreCurrent.<span class="hljs-title function_">getForm</span>()
      }
   }
   <span class="hljs-keyword">return</span> formRef.<span class="hljs-property">current</span>
}
</code></pre>
<p>useForm 的逻辑实际很简单：</p>
<ul>
<li>通过一个 useRef 来保存 FormStore 的重要 api。</li>
<li>首先会判断有没有 form ，如果没有，会实例化 FormStore ，上面讲的 FormStore 终于用到了，然后会调用 <strong><code>getForm</code></strong> ，把重要的 api 暴露出去。</li>
<li>什么情况下有 form ，当开发者用 useForm 单独创建一个 FormStore 再赋值给 Form 组件的 form 属性，这个时候就会存在 form 了。</li>
</ul>
<h2>五 总结</h2>
<p>本章节主要学习内容如下：</p>
<ul>
<li>表单的设计思路与细节。</li>
<li>编写一个表单状态管理工具—— FormStore 。</li>
<li>编写一个自定义 hooks —— useForm 。</li>
<li>异步批量处理表单验证更新任务。</li>
</ul>
<p>下一章节，将继续完成表单的 Form 和 FormItem 组件。</p></div>
</body></html>