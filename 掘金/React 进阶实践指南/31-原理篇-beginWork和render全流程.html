<!DOCTYPE html><html lang="en"><head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç¬¬ 01 è®²ï¼šè®¾è®¡ä¸€ä»½å¸å¼•é¢è¯•å®˜çš„ç®€å†</title>
<style type="text/css">
:root {
    --control-text-color: #777;
    --select-text-bg-color: rgba(223, 197, 223);  /*#7e66992e;*/
    
    /* side bar */
    --side-bar-bg-color: rgb(255, 255, 255);
    --active-file-text-color: #8163bd;
    --active-file-bg-color: #E9E4F0;
    --item-hover-bg-color: #E9E4F0;
    --active-file-border-color: #8163bd;

    --title-color: #6c549c;
    --font-sans-serif: 'Ubuntu', 'Source Sans Pro', sans-serif !important;
    --font-monospace: 'Fira Code', 'Roboto Mono', monospace !important;
    --purple-1: #8163bd;
    --purple-2: #79589F;
    --purple-3: #fd5eb8;
    --purple-light-1: rgba(99, 99, 172, .05);
    --purple-light-2: rgba(99, 99, 172, .1);
    --purple-light-3: rgba(99, 99, 172, .2);
    --purple-light-4: rgba(129, 99, 189, .3);
    --purple-light-5: #E9E4F0;
    --purple-light-6: rgba(129, 99, 189, .8);
}

/* html {
    font-size: 16px;
} */

body {
    font-family: var(--font-sans-serif);
    color: #34495e;
    -webkit-font-smoothing: antialiased;
    line-height: 1.6rem;
    letter-spacing: 0;
    margin: 0;
    overflow-x: hidden;
}

/* é¡µè¾¹è· å’Œ é¡µé¢å¤§å° */
#write {
    padding-left: 6ch;
    padding-right: 6ch;
    margin: 0 auto;
}

#write p {
    line-height: 1.6rem;
    word-spacing: .05rem;
}

#write ol li {
    padding-left: 0.5rem;
}

#write > ul:first-child,
#write > ol:first-child {
    margin-top: 30px;
}

body > *:first-child {
    margin-top: 0 !important;
}

body > *:last-child {
    margin-bottom: 0 !important;
}

a {
    color: var(--purple-1);
    padding: 0 2px;
    text-decoration: none;
}
.md-content {
    color: var(--purple-light-6);
}
#write a {
    border-bottom: 1px solid var(--purple-1);
    color: var(--purple-1);
    text-decoration: none;
}

h1,
h2,
h3,
h4,
h5,
h6 {
    position: relative;
    margin-top: 1rem;
    margin-bottom: 0.5rem;
    /* font-weight: bold; */
    font-weight: 500 !important;
    line-height: 1.4;
    cursor: text;
    color: var(--title-color);
    font-family: var(--font-sans-serif);
}

h1:hover a.anchor,
h2:hover a.anchor,
h3:hover a.anchor,
h4:hover a.anchor,
h5:hover a.anchor,
h6:hover a.anchor {
    text-decoration: none;
}

h1 tt,
h1 code {
    font-size: inherit !important;
}
h2 tt,
h2 code {
    font-size: inherit !important;
}
h3 tt,
h3 code {
    font-size: inherit !important;
}
h4 tt,
h4 code {
    font-size: inherit !important;
}
h5 tt,
h5 code {
    font-size: inherit !important;
}
h6 tt,
h6 code {
    font-size: inherit !important;
}


h1 {
    padding-bottom: .4rem;
    font-size: 2.2rem;
    line-height: 1.3;
}
h1 {
    text-align: center;
    padding-bottom: 0.3em;
    font-size: 2.2em;
    line-height: 1.2;
    margin: 2.4em auto 1.2em;
}
h1:after {
    content: '';
    display: block;
    margin: 0.2em auto 0;
    width: 100px;
    height: 2px;
    border-bottom: 2px solid var(--title-color);
}

h2 {
    margin: 1.6em auto 0.5em;
    padding-left: 10px;
    line-height: 1.4;
    font-size: 1.8em;
    border-left: 9px solid var(--title-color);
    border-bottom: 1px solid var(--title-color);
}
h3 {
    font-size: 1.5rem;
    margin: 1.2em auto 0.5em;
}
h4 {
    font-size: 1.3rem;
}
h5 {
    font-size: 1.2rem;
}
h6 {
    font-size: 1.1rem;
}

p,
blockquote,
ul,
ol,
dl,
table {
    margin: 0.8em 0;
}

li > ol,
li > ul {
    margin: 0 0;
}

hr {
    height: 2px;
    padding: 0;
    margin: 16px 0;
    background-color: #e7e7e7;
    border: 0 none;
    overflow: hidden;
    box-sizing: content-box;
}

body > h2:first-child {
    margin-top: 0;
    padding-top: 0;
}

body > h1:first-child {
    margin-top: 0;
    padding-top: 0;
}

body > h1:first-child + h2 {
    margin-top: 0;
    padding-top: 0;
}

body > h3:first-child,
body > h4:first-child,
body > h5:first-child,
body > h6:first-child {
    margin-top: 0;
    padding-top: 0;
}

a:first-child h1,
a:first-child h2,
a:first-child h3,
a:first-child h4,
a:first-child h5,
a:first-child h6 {
    margin-top: 0;
    padding-top: 0;
}

h1 p,
h2 p,
h3 p,
h4 p,
h5 p,
h6 p {
    margin-top: 0;
}

li p.first {
    display: inline-block;
}

ul,
ol {
    padding-left: 30px;
}

ul:first-child,
ol:first-child {
    margin-top: 0;
}

ul:last-child,
ol:last-child {
    margin-bottom: 0;
}

/* å¼•ç”¨ */
blockquote {
    /* margin-left: 1rem; */
    border-left: 4px solid var(--purple-light-4);
    padding: 10px 15px;
    color: #777;
    background-color: var(--purple-light-1);
}

/* è¡¨æ ¼ */
table {
    padding: 0;
    word-break: initial;
}

table tr {
    border-top: 1px solid #dfe2e5;
    margin: 0;
    padding: 0;
}

/* è¡¨æ ¼ èƒŒæ™¯è‰² */
table tr:nth-child(2n),
thead {
    background-color: var(--purple-light-1);
}
#write table thead th {
    background-color: var(--purple-light-2);
}

table tr th {
    font-weight: bold;
    border: 1px solid #dfe2e5;
    border-bottom: 0;
    text-align: left;
    margin: 0;
    padding: 6px 13px;
}

table tr td {
    border: 1px solid #dfe2e5;
    text-align: left;
    margin: 0;
    padding: 6px 13px;
}

table tr th:first-child,
table tr td:first-child {
    margin-top: 0;
}

table tr th:last-child,
table tr td:last-child {
    margin-bottom: 0;
}

/* ç²—ä½“ */
#write strong {
    padding: 0 2px;
    color: var(--purple-1);
}

/* æ–œä½“ */
#write em {
    padding: 0 5px 0 2px;
    /* font-style: normal; */
    color: #42b983;
}

/* inline code */
#write code, tt {
    padding: 2px 4px;
    border-radius: 2px;
    font-family: var(--font-monospace);
    font-size: 0.92rem;
    color: var(--purple-3); 
    background-color: rgba(99, 99, 172, .05);
}

tt {
    margin: 0 2px;
}

#write .md-footnote {
    background-color: #f8f8f8;
    color: var(--purple-3);
}

/* heighlight. */
#write mark {
    background-color: #fbd3ea;
    border-radius: 2px;
    padding: 2px 4px;
    margin: 0 2px;
}

#write del {
    padding: 1px 2px;
}

.md-task-list-item > input {
    margin-left: -1.3em;
}

@media print {
    html {
        font-size: 0.9rem;
    }

    table,
    pre {
        page-break-inside: avoid;
    }

    pre {
        word-wrap: break-word;
    }
}

#write pre.md-meta-block {
    padding: 1rem;
    font-size: 85%;
    line-height: 1.45;
    background-color: #f7f7f7;
    border: 0;
    border-radius: 3px;
    color: #777777;
    margin-top: 0 !important;
}

.mathjax-block > .code-tooltip {
    bottom: .375rem;
}

/* å›¾ç‰‡ */
.md-image > .md-meta {
    border-radius: 3px;
    font-family: var(--font-monospace);
    padding: 2px 0 0 4px;
    font-size: 0.9em;
    color: inherit;
}
p .md-image:only-child{
    width: auto;
    text-align: left;
    margin-left: 2rem;
}
.md-tag {
    color: inherit;
}
/* å½“ â€œ![shadow-éšä¾¿å†™]()â€å†™æ—¶ï¼Œä¼šæœ‰é˜´å½± */
.md-image img[alt|='shadow'] {
    /* box-shadow: 0 4px 24px -6px #ddd; */
    box-shadow:var(--purple-light-2) 0px 10px 15px;
}

#write a.md-toc-inner {
    line-height: 1.6;
    white-space: pre-line;
    border-bottom: none;
    font-size: 0.9rem;
}

#typora-quick-open {
    border: 1px solid #ddd;
    background-color: #f8f8f8;
}

#typora-quick-open-item {
    background-color: #FAFAFA;
    border-color: #FEFEFE #e5e5e5 #e5e5e5 #eee;
    border-style: solid;
    border-width: 1px;
}

#md-notification:before {
    top: 10px;
}

header,
.context-menu,
.megamenu-content,
footer {
    font-family: var(--font-sans-serif);
}

.file-node-content:hover .file-node-icon,
.file-node-content:hover .file-node-open-state {
    visibility: visible;
}

.md-lang {
    color: #b4654d;
}

.html-for-mac .context-menu {
    --item-hover-bg-color: #E6F0FE;
}

/* ä»£ç æ¡† */
/* CodeMirror 3024 Day theme */

/* ä»£ç æ®µ èƒŒæ™¯ */
pre {
    --select-text-bg-color: rgba(223, 197, 223) !important;
    margin: .5em 0;
    padding: 1em 1.4em;
    border-radius: 8px;
    background: #f6f8fa;
    overflow-x: auto;
    box-sizing: border-box;
    font-size: 14px;
}

/* è¾¹æ¡† */
.md-fences {
    border: 1px solid #e7eaed;
    border-radius: 3px;
}

.cm-s-inner {
  padding: .25rem;
  border-radius: .25rem;
}

.cm-s-inner.CodeMirror, .cm-s-inner .CodeMirror-gutters {
  background-color: #f8f8f8 !important;
  color: #3a3432 !important;
  border: none;
}

.cm-s-inner .CodeMirror-gutters {
  color: #6d8a88;
}

.cm-s-inner .CodeMirror-cursor {
  border-left: solid thin #5c5855 !important;
}

.cm-s-inner .CodeMirror-linenumber {
  color: #807d7c;
}

.cm-s-inner .CodeMirror-line::selection, .cm-s-inner .CodeMirror-line::-moz-selection,
.cm-s-inner .CodeMirror-line > span::selection,
.cm-s-inner .CodeMirror-line > span::-moz-selection,
.cm-s-inner .CodeMirror-line > span > span::selection,
.cm-s-inner .CodeMirror-line > span > span::-moz-selection {
  background: var(--purple-light-2);
}

.cm-s-inner span.cm-comment {
  color: #cdab53;
}

.cm-s-inner span.cm-string, .cm-s-inner span.cm-string-2 {
  color: #f2b01d;
}

.cm-s-inner span.cm-number {
  color: #a34e8f;
}

.cm-s-inner span.cm-variable {
  color: #01a252;
}

.cm-s-inner span.cm-variable-2 {
  color: #01a0e4;
}

.cm-s-inner span.cm-def {
  /* color: #e8bbd0; */
  color: #e2287f;
}

.cm-s-inner span.cm-operator {
  color: #ff79c6;
}

.cm-s-inner span.cm-keyword {
  color: #db2d20;
}

.cm-s-inner span.cm-atom {
  color: #a34e8f;
}

.cm-s-inner span.cm-meta {
  color: inherit;
}

.cm-s-inner span.cm-tag {
  color: #db2d20;
}

.cm-s-inner span.cm-attribute {
  color: #01a252;
}

.cm-s-inner span.cm-qualifier {
  color: #388aa3;
}

.cm-s-inner span.cm-property {
  color: #01a252;
}

.cm-s-inner span.cm-builtin {
  color: #388aa3;
}

.cm-s-inner span.cm-variable-3, .cm-s-inner span.cm-type {
  color: #ffb86c;
}

.cm-s-inner span.cm-bracket {
  color: #3a3432;
}

.cm-s-inner span.cm-link {
  color: #a34e8f;
}

.cm-s-inner span.cm-error {
  background: #db2d20;
  color: #5c5855;
}

/* .md-fences.md-focus .cm-s-inner .CodeMirror-activeline-background {
  background: var(--purple-light-2);
} */

.cm-s-inner .CodeMirror-matchingbracket {
  text-decoration: underline;
  color: #a34e8f !important;
}

#fences-auto-suggest .active {
  background: #ddd;
}

#write .code-tooltip {
  bottom: initial;
  top: calc(100% - 1px);
  background: #f7f7f7;
  border: 1px solid #ddd;
  border-top: 0;
}

.auto-suggest-container {
  border-color: #b4b4b4;
}

.auto-suggest-container .autoComplt-hint.active {
  background: #b4b4b4;
  color: inherit;
}

/* task list */
#write .md-task-list-item > input {
  -webkit-appearance: initial;
  display: block;
  position: absolute;
  border: 1px solid #b4b4b4;
  border-radius: .25rem;
  margin-top: .1rem;
  margin-left: -1.8rem;
  height: 1.2rem;
  width: 1.2rem;
  transition: background 0.3s;
}

#write .md-task-list-item > input:focus {
  outline: none;
  box-shadow: none;
}

#write .md-task-list-item > input:hover {
  background: #ddd;
}

#write .md-task-list-item > input[checked]::before {
  content: '';
  position: absolute;
  top: 20%;
  left: 50%;
  height: 60%;
  width: 2px;
  transform: rotate(40deg);
  background: #333;
}

#write .md-task-list-item > input[checked]::after {
  content: '';
  position: absolute;
  top: 46%;
  left: 25%;
  height: 30%;
  width: 2px;
  transform: rotate(-40deg);
  background: #333;
}

#write .md-task-list-item > p {
  transition: color 0.3s, opacity 0.3s;
}

#write .md-task-list-item.task-list-done > p {
  color: #b4b4b4;
  text-decoration: line-through;
}

#write .md-task-list-item.task-list-done > p > .md-emoji {
  opacity: .5;
}

#write .md-task-list-item.task-list-done > p > .md-link > a {
  opacity: .6;
}

/* sidebar and outline */
.pin-outline .outline-active {
  color: var(--active-file-text-color); 
}

.file-list-item {
    border-bottom: 1px solid;
    border-color: var(--purple-light-5);
}

.file-list-item-summary {
    font-weight: 400;
}

.file-list-item.active {
    color: var(--active-file-text-color);
    background-color: var(--purple-light-5);
}

.file-tree-node.active>.file-node-background {
    background-color: var(--purple-light-5);
    font-weight: 700;
} 

.file-tree-node.active>.file-node-content {
    color: var(--active-file-text-color);
    font-weight: 700;
}

.file-node-content {
    color: #5e676d;
}

.sidebar-tabs {
    border-bottom: none;
}
.sidebar-tab.active {
    font-weight: 400;
}

.sidebar-content-content {
    font-size: 0.9rem;
}

img {
    max-width: 100%;
}

body {
    background-color: rgb(237, 237, 237);
}
#content {
    width: 836px;
    padding: 50px;
    background: #fff;
    margin: 0 auto;
}/*# sourceURL=/Users/young/Documents/Codes/Fun/lagou/public/purple.css*/</style><style type="text/css">.hljs{display:block;overflow-x:auto;padding:.5em;color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}/*# sourceURL=/Users/young/Documents/Codes/Fun/lagou/public/atom-one-light.min.css*/</style></head>
<body>
<div id="content"><h1>åŸç†ç¯‡-beginWorkå’Œrenderå…¨æµç¨‹</h1>
<h2>ä¸€ å‰è¨€</h2>
<p>åœ¨ fiber ç« èŠ‚ä»‹ç»è¿‡ï¼Œå½“ç»„ä»¶æ›´æ–°ï¼Œæœ¬è´¨ä¸Šæ˜¯ä» fiberRoot å¼€å§‹æ·±åº¦è°ƒå’Œ fiber æ ‘ã€‚é‚£ä¹ˆæœ¬ç« èŠ‚å°†ç»§ç»­å›´ç»• React è°ƒå’Œæµç¨‹ã€‚ä»‹ç»ä¸€ä¸‹è°ƒå’Œæµç¨‹ï¼Œé¦–å…ˆæ€è€ƒå‡ ä¸ªé—®é¢˜ï¼š</p>
<ul>
<li>ç»„ä»¶ A è§¦å‘ <code>setState</code> æˆ–è€… <code>useState</code> æ›´æ–°è§†å›¾ï¼Œæ—¢ç„¶ <code>fiber</code> æ˜¯ä» root å¼€å§‹æ›´æ–°ï¼Œé‚£ä¹ˆå¦‚ä½•æ‰¾åˆ°å¯¹åº”çš„ A å¹¶ rerender çš„å‘¢ï¼Ÿ</li>
<li>ç»„ä»¶ç±»å‹ fiber è¿›è¡Œ <code>beginWork</code> å°±ä¸€å®šä¼šè¿›è¡Œ <code>render</code> å—ï¼Ÿ</li>
</ul>
<h2>äºŒ  state æ›´æ–°æºæ³‰</h2>
<h3>1 æ›´æ–°çš„æœ€å°å•å…ƒ</h3>
<p>è™½ç„¶åœ¨ ReactV18 å¼•å…¥è®¢é˜…å¤–éƒ¨æ•°æ®æºçš„ <code>useMutableSource</code>ã€‚ä½†åœ¨å½“å‰ç‰ˆæœ¬çš„ React ä¸­ï¼Œè§†å›¾çš„æ›´æ–°åŸºæœ¬éƒ½æ¥æºäºå†…éƒ¨ state çš„æ”¹å˜ã€‚å¦‚æœæœ‰ä¸€ä¸ªç»„ä»¶ A ï¼Œå¦‚æœæƒ³è¦å®ƒæ›´æ–°ï¼Œé‚£ä¹ˆåœºæ™¯æœ‰å¦‚ä¸‹æƒ…å†µï¼š</p>
<ul>
<li>ç»„ä»¶æœ¬èº«æ”¹å˜ <code>state</code> ã€‚å‡½æ•° <code>useState</code> | <code>useReducer</code> ï¼Œç±»ç»„ä»¶ <code>setState</code> | <code>forceUpdate</code>ã€‚</li>
<li><code>props</code> æ”¹å˜ï¼Œç”±ç»„ä»¶æ›´æ–°å¸¦æ¥çš„å­ç»„ä»¶çš„æ›´æ–°ã€‚</li>
<li><code>context</code>æ›´æ–°ï¼Œå¹¶ä¸”è¯¥ç»„ä»¶æ¶ˆè´¹äº†å½“å‰ <code>context</code> ã€‚</li>
</ul>
<p>æ— è®ºæ˜¯ä¸Šé¢å“ªç§æ–¹å¼ï¼Œæœ¬è´¨ä¸Šéƒ½æ˜¯ state çš„å˜åŒ–ã€‚</p>
<ul>
<li>props æ”¹å˜æ¥æºäºçˆ¶çº§ç»„ä»¶çš„ state å˜åŒ–ã€‚</li>
<li>context å˜åŒ–æ¥æºäº <code>Provider</code> ä¸­ value å˜åŒ–ï¼Œè€Œ value ä¸€èˆ¬æƒ…å†µä¸‹ä¹Ÿæ˜¯ state æˆ–è€…æ˜¯ state è¡ç”Ÿäº§ç‰©ã€‚</li>
</ul>
<p><code>state</code> æ”¹å˜æ˜¯åœ¨ç»„ä»¶å¯¹åº”çš„ fiber å•ä½ä¸Šçš„ï¼Œä¹‹å‰çš„ fiber ç« èŠ‚è®²åˆ°äº†åœ¨ React çš„ä¸–ç•Œé‡Œä¼šå­˜åœ¨å¤šç§å¤šæ ·çš„ fiber ç±»å‹ï¼Œ è€Œå¼€å‘è€…å¹³æ—¶ä½¿ç”¨çš„ç»„ä»¶ <code>function Component</code> æˆ–è€… <code>Class Component</code> ä¹Ÿæ˜¯ä¸¤ç§ä¸åŒçš„ fiber ç±»å‹ã€‚è€Œä¸” React åº•å±‚å¯¹å®ƒä»¬çš„å¤„ç†é€»è¾‘ä¹Ÿä¸ç›¸åŒã€‚</p>
<ul>
<li>æ¯”å¦‚æ›´æ–°ç±»ç»„ä»¶ç”¨çš„æ˜¯ <code>updateClassComponent</code>ï¼Œå®ƒåšçš„äº‹æƒ…æ˜¯åˆå§‹åŒ–æ—¶å€™å®ä¾‹åŒ–ç±»ç»„ä»¶ï¼Œæ›´æ–°çš„è¯é‚£ä¹ˆç›´æ¥è°ƒç”¨ render å¾—åˆ°æ–°çš„ <code>children</code> ï¼›</li>
<li>æ›´æ–°å‡½æ•°ç»„ä»¶ç”¨çš„æ˜¯ <code>updateFunctionComponent</code>ï¼Œé‡Œé¢è°ƒç”¨ <code>renderWithHooks</code> æ‰§è¡Œå‡½æ•°ç»„ä»¶å¹¶ä¾æ¬¡è°ƒç”¨ <code>hooks</code>ã€‚è¿™é‡Œç»†èŠ‚é—®é¢˜ä¸éœ€è¦æ‹˜æ³¥ã€‚</li>
</ul>
<p>é‚£ä¹ˆåœ¨æ•´ä¸ª <code>React</code> ç³»ç»Ÿä¸­ï¼Œèƒ½å¤Ÿæ›´æ–° state çš„åŸºæœ¬éƒ½åœ¨ç»„ä»¶å±‚é¢ä¸Šï¼Œæ¢å¥è¯è¯´åªæœ‰ç»„ä»¶æ‰èƒ½å‡ºå‘æ›´æ–°ï¼Œæ¯”å¦‚ <code>div</code> å…ƒç´   hostComponent ç±»å‹çš„ fiberï¼Œå®ƒæ˜¯æ— æ³•ç‹¬ç«‹çš„è‡ªæˆ‘æ›´æ–°çš„ï¼Œåªèƒ½ä¾èµ–äºçˆ¶ç±»çš„ç»„ä»¶æ›´æ–° state ï¼Œä½†æ˜¯åœ¨è°ƒå’Œé˜¶æ®µï¼Œå®ƒä¹Ÿä¼šä½œä¸ºä¸€ä¸ªä»»åŠ¡å•å…ƒè¿›å…¥åˆ° workLoop ä¸­ ï¼›ç»¼ä¸Šæ‰€è¿°ï¼Œå¯ä»¥è¿™ä¹ˆç†è§£</p>
<ul>
<li>
<p><strong>fiberæ˜¯è°ƒå’Œè¿‡ç¨‹ä¸­çš„æœ€å°å•å…ƒï¼Œæ¯ä¸€ä¸ªéœ€è¦è°ƒå’Œçš„ fiber éƒ½ä¼šè¿›å…¥ workLoop ä¸­ã€‚</strong></p>
</li>
<li>
<p><strong>è€Œç»„ä»¶æ˜¯æœ€å°çš„æ›´æ–°å•å…ƒï¼ŒReact çš„æ›´æ–°æºäºæ•°æ®å±‚ state çš„å˜åŒ–ã€‚</strong></p>
</li>
</ul>
<h3>2 beginWork æ›´æ–°æºæ³‰</h3>
<p>é‚£ä¹ˆæˆ‘ä»¬ä»Šå¤©çš„ä¸»è§’å°±æ˜¯ç»„ä»¶ç±»å‹çš„ fiber ã€‚æ·±å…¥ç ”ç©¶ä¸€ä¸‹ç»„ä»¶ç±»å‹çš„ fiber è°ƒå’Œæµç¨‹ã€‚ç±»ç»„ä»¶åœ¨ render é˜¶æ®µçš„ä¸€ä¸ªé‡è¦ä½œç”¨å°±æ˜¯äº§ç”Ÿæ–°çš„ children ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„ <code>rerender</code>ã€‚åªæœ‰äº§ç”Ÿæ–°çš„ children ï¼Œæ¥ä¸‹æ¥æ‰èƒ½æ·±åº¦éå† children ï¼Œæ”¹å˜è§†å›¾ã€‚æ¯ä¸€ä¸ªéœ€è¦è°ƒå’Œçš„ fiber éƒ½è¦ç»å†ä¸€ä¸ªè¿‡ç¨‹å«åš <strong><code>beginWork</code></strong> ï¼Œåœ¨ beginWork æµç¨‹ä¸­å°†æ‰§è¡Œä¸Šè¿°å„ç§ fiber çš„æ›´æ–°å‡½æ•°ã€‚</p>
<p>é‚£ä¹ˆå¯¹äºç»„ä»¶ç±»å‹ fiber è¯´ï¼Œè¿›å…¥åˆ° workLoop ä¸­ï¼Œé‚£ä¹ˆä¸€å®šä¼š <code>rerender</code> å—ï¼Ÿ ç­”æ¡ˆæ˜¯å¦å®šçš„ï¼Œè§£ææ¥çœ‹å‡ ç§æƒ…å†µã€‚</p>
<p>ä¸»è¦çœ‹ä¸€ä¸‹å¦‚ä¸‹ demo ï¼š</p>
<pre><code class="hljs language-js">
<span class="hljs-comment">/* å­ç»„ä»¶2 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Child2</span>(<span class="hljs-params"></span>){
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&#x3C;<span class="hljs-name">div</span>></span>å­ç»„ä»¶ 2<span class="hljs-tag">&#x3C;/<span class="hljs-name">div</span>></span></span>
}
<span class="hljs-comment">/* å­ç»„ä»¶1 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Child1</span>(<span class="hljs-params"></span>){
    <span class="hljs-keyword">const</span> [ num , setNumber ] = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>)
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&#x3C;<span class="hljs-name">div</span>></span>
        å­ç»„ä»¶ {num}
        <span class="hljs-tag">&#x3C;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =></span> setNumber(num+1)} >æŒ‰é’®1<span class="hljs-tag">&#x3C;/<span class="hljs-name">button</span>></span>
     <span class="hljs-tag">&#x3C;/<span class="hljs-name">div</span>></span></span>
}
<span class="hljs-comment">/* çˆ¶ç»„ä»¶ */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Index</span>(<span class="hljs-params"></span>){
    <span class="hljs-keyword">const</span> [ num , setNumber ] = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>)
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&#x3C;<span class="hljs-name">div</span>></span>
        <span class="hljs-tag">&#x3C;<span class="hljs-name">p</span>></span>çˆ¶ç»„ä»¶ {num} <span class="hljs-tag">&#x3C;/<span class="hljs-name">p</span>></span>
        <span class="hljs-tag">&#x3C;<span class="hljs-name">Child1</span> /></span>
        <span class="hljs-tag">&#x3C;<span class="hljs-name">Child2</span> /></span>
        <span class="hljs-tag">&#x3C;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span>=></span> setNumber(num+1)} >æŒ‰é’®2<span class="hljs-tag">&#x3C;/<span class="hljs-name">button</span>></span>
    <span class="hljs-tag">&#x3C;/<span class="hljs-name">div</span>></span></span>
}
</code></pre>
<p><strong>åœºæ™¯ä¸€</strong>ï¼šå¦‚ä¸Š demo ä¸­ï¼Œå½“ç‚¹å‡» <code>Child1</code> çš„ <strong>æŒ‰é’®1</strong> çš„æ—¶å€™ï¼ŒChild1 ä¼šæ¸²æŸ“ï¼Œé‚£ä¹ˆ Child1 è‡ªç„¶ä¼šè¿›å…¥åˆ° <code>beginWork</code> æµç¨‹ä¸­ï¼Œé‚£ä¹ˆç–‘é—®æ¥äº†ï¼š</p>
<ul>
<li>é—®é¢˜ä¸€ï¼šçˆ¶ç»„ä»¶ <code>Index</code> æ²¡æœ‰æ›´æ–°ï¼Œä¼š rerender å—ï¼Ÿé‚£ä¹ˆæœ‰ä¼šè¿›å…¥ <code>beginWork</code> æµç¨‹å— ï¼Ÿ</li>
<li>é—®é¢˜äºŒï¼š<code>Child2</code> ä¼šè¿›å…¥ <code>beginWork</code>æµç¨‹å— ï¼Ÿ</li>
<li>é—®é¢˜ä¸‰ï¼šå¦‚æœ <code>Index</code> ä¼š <code>beginWork</code>ï¼Œé‚£ä¹ˆ React ä» Root fiber å¼€å§‹è°ƒå’Œçš„æ—¶å€™ï¼Œæ˜¯å¦‚ä½•æ‰¾åˆ°æ›´æ–°çš„äº‹å‘ç‚¹ Index çš„å‘¢ï¼Ÿ</li>
</ul>
<p><strong>åœºæ™¯äºŒ</strong>ï¼šåœ¨å¦‚ä¸Š demo ä¸­ï¼Œå½“ç‚¹å‡» Index ä¸­çš„ <strong>æŒ‰é’®2</strong> çš„æ—¶å€™ï¼š</p>
<ul>
<li>é—®é¢˜å››ï¼š<code>Index</code> å› ä¸ºæœ¬èº«çš„ <code>state</code> æ”¹å˜ä¼šæ›´æ–°ï¼Œé‚£ä¹ˆ <code>Child1</code> å’Œ <code>Child2</code> ä¸ºä»€ä¹ˆä¼šè·Ÿç€æ›´æ–°ã€‚</li>
</ul>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬å¼€å§‹ä»¥ä¸€æ¬¡æ›´æ–°å¼€å§‹ï¼Œåˆ†æè°ƒå’Œè¿‡ç¨‹ä¸­ beginWork æµç¨‹ã€‚</p>
<p>åœ¨æ­£å¼æµç¨‹åˆ†æä¹‹å‰ï¼Œå…ˆæ¥çœ‹ä¸€ä¸‹ v17 å¼•å‡ºçš„æ–°çš„æ¦‚å¿µï¼Œåœ¨ v16 ç‰ˆæœ¬ï¼Œä»»åŠ¡çš„ä¼˜å…ˆçº§ç”¨ expirationTime è¡¨ç¤ºï¼Œåœ¨ v17 ç‰ˆæœ¬è¢« lane å–ç¼”ã€‚</p>
<ul>
<li><strong>lane</strong> ï¼š æ›´æ–°ä¼˜å…ˆçº§ã€‚ï¼ˆåœ¨ä¸€æ¬¡æ›´æ–°ä»»åŠ¡ä¸­ï¼Œå°†èµ‹äºˆç»™æ›´æ–°çš„ fiber çš„ä¸€ä¸ªæ›´æ–°ä¼˜å…ˆçº§ laneã€‚ï¼‰</li>
<li><strong>childLanes</strong>ï¼š<code>children</code> ä¸­æ›´æ–°ä¼˜å…ˆçº§ã€‚ï¼ˆå¦‚æœå½“å‰ fiber çš„ child ä¸­æœ‰é«˜ä¼˜å…ˆçº§ä»»åŠ¡ï¼Œé‚£ä¹ˆå½“å‰ fiber çš„ childLanes ç­‰äºå½“å‰ä¼˜å…ˆçº§ï¼‰ã€‚</li>
</ul>
<p>è®°ä½è¿™ä¸¤ä¸ªæ¦‚å¿µå¯¹äºä¸‹é¢æµç¨‹åˆ†æå¾ˆæœ‰å¸®åŠ©ã€‚æ¥ä¸‹æ¥å¸¦ç€ä¸Šé¢çš„å››ä¸ªé—®é¢˜ï¼Œå¼€å§‹å¾€ä¸‹åˆ†æã€‚</p>
<h2>ä¸‰ èµ·æº: ä» state æ”¹å˜åˆ° scheduleUpdateOnFiber</h2>
<p>ä¸‹é¢ä»¥å‰é¢çš„ç‚¹å‡»æŒ‰é’®è§¦å‘ä¸€æ¬¡æ›´æ–°ä¸ºä¾‹å­ğŸŒ°ï¼Œæ·±å…¥æ¢è®¨ä¸€ä¸‹æ›´æ–°çš„å§‹æœ«æºå¤´ã€‚é¦–å…ˆä¸Šè¿°è®²åˆ°è¿‡æ›´æ–°æ˜¯ä»¥<strong>ç»„ä»¶</strong>ä¸ºç²’åº¦ï¼Œé‚£ä¹ˆè°ƒç”¨ <code>useState</code> æˆ–è€…æ˜¯ <code>setState</code> æ¥ä¸‹æ¥ä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿ</p>
<p><strong>ç±»ç»„ä»¶ setState æ›´æ–°</strong></p>
<blockquote>
<p>react-reconciler/src/ReactFiberClassComponent.new.js  -> classComponentUpdater</p>
</blockquote>
<pre><code class="hljs language-js"><span class="hljs-title function_">enqueueSetState</span>(<span class="hljs-params">inst, payload, callback</span>){
     <span class="hljs-keyword">const</span> fiber = <span class="hljs-title function_">getInstance</span>(inst);       
     <span class="hljs-keyword">const</span> lane = <span class="hljs-title function_">requestUpdateLane</span>(fiber);
     <span class="hljs-title function_">scheduleUpdateOnFiber</span>(fiber, lane, eventTime);
}
</code></pre>
<p><strong>å‡½æ•°ç»„ä»¶ useState æ›´æ–°</strong></p>
<blockquote>
<p>react-reconciler/src/ReactFiberHooks.new.js -> dispatchReducerAction</p>
</blockquote>
<pre><code class="hljs language-js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">dispatchReducerAction</span>(<span class="hljs-params">fiber,queue,action</span>){
    <span class="hljs-keyword">const</span> lane = <span class="hljs-title function_">requestUpdateLane</span>(fiber);
    <span class="hljs-title function_">scheduleUpdateOnFiber</span>(fiber, lane, eventTime);
}
</code></pre>
<p>å¦‚ä¸Šä»£ç éƒ½æ˜¯ç²¾ç®€åï¼Œä¿ç•™çš„æœ€æ ¸å¿ƒçš„æµç¨‹ã€‚å¯ä»¥æ˜ç¡®çœ‹åˆ°ï¼Œæ— è®ºæ˜¯ç»„ä»¶æ›´æ–°çš„æœ¬è´¨å°±æ˜¯ï¼š</p>
<ul>
<li>åˆ›å»ºä¸€ä¸ªä»»åŠ¡ä¼˜å…ˆçº§ laneã€‚</li>
<li>ç„¶åè¿›è¡Œ <strong>scheduleUpdateOnFiber</strong>ã€‚ é‚£ä¹ˆè¿™ä¸ª scheduleUpdateOnFiber åº”è¯¥å°±æ˜¯æ•´ä¸ª React æ›´æ–°ä»»åŠ¡çš„å¼€å§‹ã€‚é‚£ä¹ˆè¿™ä¸ªå‡½æ•°åˆ°åº•åšäº†äº›ä»€ä¹ˆå‘¢ ï¼Ÿ</li>
</ul>
<h3>1 scheduleUpdateOnFiber å¼€å§‹æ›´æ–° fiber</h3>
<blockquote>
<p>react-reconciler/src/ReactFiberWorkLoop.new.js  -> scheduleUpdateOnFiber</p>
</blockquote>
<pre><code class="hljs language-js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">scheduleUpdateOnFiber</span>(<span class="hljs-params">fiber,lane</span>){
    <span class="hljs-comment">/* é€’å½’å‘ä¸Šæ ‡è®°æ›´æ–°ä¼˜å…ˆçº§ */</span>
    <span class="hljs-keyword">const</span> root = <span class="hljs-title function_">markUpdateLaneFromFiberToRoot</span>(fiber, lane);
    <span class="hljs-keyword">if</span>(root === <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
    <span class="hljs-comment">/* å¦‚æœå½“å‰ root ç¡®å®šæ›´æ–°ï¼Œé‚£ä¹ˆä¼šæ‰§è¡Œ ensureRootIsScheduled */</span>
    <span class="hljs-title function_">ensureRootIsScheduled</span>(root, eventTime);
}
</code></pre>
<p>scheduleUpdateOnFiber ä¸»è¦åšäº†ä¸¤ä»¶äº‹ï¼š</p>
<ul>
<li>ç¬¬ä¸€ä¸ªå°±æ˜¯é€šè¿‡å½“å‰çš„æ›´æ–°ä¼˜å…ˆçº§ lane ï¼ŒæŠŠå½“å‰ fiber  åˆ° rootFiber çš„çˆ¶çº§é“¾è¡¨ä¸Šçš„æ‰€æœ‰ä¼˜å…ˆçº§éƒ½ç»™æ›´æ–°äº†ã€‚</li>
<li>å¦‚æœå½“å‰ fiber ç¡®å®šæ›´æ–°ï¼Œé‚£ä¹ˆä¼šè°ƒç”¨ ensureRootIsScheduled ï¼Œ</li>
</ul>
<p><strong>é‚£ä¹ˆ markUpdateLaneFromFiberToRoot å¦‚ä½•æ ‡è®°çš„ä¼˜å…ˆçº§ï¼Ÿ è¿™ä¸ªå¾ˆé‡è¦ï¼</strong></p>
<blockquote>
<p>react-reconciler/src/ReactFiberWorkLoop.new.js  -> markUpdateLaneFromFiberToRoot</p>
</blockquote>
<pre><code class="hljs language-js"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">*</span>} sourceFiber å‘ç”Ÿ state å˜åŒ–çš„fiber ï¼Œæ¯”å¦‚ç»„ä»¶ A è§¦å‘äº† useState ï¼Œé‚£ä¹ˆç»„ä»¶ A å¯¹åº”çš„ fiber å°±æ˜¯ sourceFiber
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">*</span>} lane        äº§ç”Ÿçš„æ›´æ–°ä¼˜å…ˆçº§
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">markUpdateLaneFromFiberToRoot</span>(<span class="hljs-params">sourceFiber,lane</span>){
    <span class="hljs-comment">/* æ›´æ–°å½“å‰ fiber ä¸Š */</span>
    sourceFiber.<span class="hljs-property">lanes</span> = <span class="hljs-title function_">mergeLanes</span>(sourceFiber.<span class="hljs-property">lanes</span>, lane);
    <span class="hljs-comment">/* æ›´æ–°ç¼“å­˜æ ‘ä¸Šçš„ lanes */</span>
    <span class="hljs-keyword">let</span> alternate = sourceFiber.<span class="hljs-property">alternate</span>;
    <span class="hljs-keyword">if</span> (alternate !== <span class="hljs-literal">null</span>) alternate.<span class="hljs-property">lanes</span> = <span class="hljs-title function_">mergeLanes</span>(alternate.<span class="hljs-property">lanes</span>, lane);
    <span class="hljs-comment">/* å½“å‰æ›´æ–°çš„ fiber */</span>
    <span class="hljs-keyword">let</span> node = sourceFiber;
    <span class="hljs-comment">/* æ‰¾åˆ°è¿”å›çˆ¶çº§ */</span>
    <span class="hljs-keyword">let</span> parent = sourceFiber.<span class="hljs-property">return</span>;
    <span class="hljs-keyword">while</span>(parent !== <span class="hljs-literal">null</span>){
        <span class="hljs-comment">/* <span class="hljs-doctag">TODO:</span> æ›´æ–° childLanes å­—æ®µ */</span>
        parent.<span class="hljs-property">childLanes</span> = <span class="hljs-title function_">mergeLanes</span>(parent.<span class="hljs-property">childLanes</span>, lane);
        <span class="hljs-keyword">if</span> (alternate !== <span class="hljs-literal">null</span>) {  alternate.<span class="hljs-property">childLanes</span> = <span class="hljs-title function_">mergeLanes</span>(alternate.<span class="hljs-property">childLanes</span>, lane); }
        <span class="hljs-comment">/* é€’å½’éå†æ›´æ–° */</span>
        node = parent;
        parent = parent.<span class="hljs-property">return</span>;
    }
}
</code></pre>
<p>markUpdateLaneFromFiberToRoot åšçš„äº‹å¾ˆé‡è¦ã€‚</p>
<ul>
<li>é¦–å…ˆä¼šæ›´æ–°å½“å‰ fiber ä¸Šçš„æ›´æ–°ä¼˜å…ˆçº§ã€‚åœ¨ fiber ç« èŠ‚æˆ‘ä»¬è®²è¿‡ï¼Œfiber æ¶æ„é‡‡ç”¨ â€˜è¿ä½“å©´â€™å½¢å¼çš„åŒç¼“å†²æ ‘ï¼Œæ‰€æœ‰è¿˜è¦æ›´æ–°å½“å‰ fiber çš„ç¼“å†²æ ‘ <code>alternate</code> ä¸Šçš„ä¼˜å…ˆçº§ã€‚</li>
<li>ç„¶åä¼šé€’å½’å‘ä¸ŠæŠŠçˆ¶çº§è¿ä¸Šçš„ childLanes éƒ½æ›´æ–°ï¼Œæ›´æ–°æˆå½“å‰çš„ä»»åŠ¡ä¼˜å…ˆçº§ã€‚</li>
</ul>
<p>é‡ç‚¹æƒ³ä¸€æƒ³ä¸ºä»€ä¹ˆå‘ä¸Šé€’å½’æ›´æ–°çˆ¶çº§çš„ childLanes ï¼Ÿ</p>
<ul>
<li>é¦–å…ˆé€šè¿‡ fiber ç« èŠ‚æˆ‘ä»¬çŸ¥é“ï¼Œæ‰€æœ‰çš„ fiber æ˜¯é€šè¿‡ä¸€é¢— fiber æ ‘å…³è”åˆ°ä¸€èµ·çš„ï¼Œå¦‚æœç»„ä»¶ A å‘ç”Ÿä¸€æ¬¡æ›´æ–°ï¼ŒReact æ˜¯ä» root å¼€å§‹æ·±åº¦éå†æ›´æ–° fiber æ ‘ã€‚</li>
<li>é‚£ä¹ˆæ›´æ–°è¿‡ç¨‹ä¸­éœ€è¦æ·±åº¦éå†æ•´ä¸ª fiber æ ‘å—ï¼Ÿï¼Œå½“ç„¶ä¹Ÿä¸æ˜¯ï¼Œé‚£ä¹ˆåªæœ‰ä¸€ä¸ªç»„ä»¶æ›´æ–°ï¼Œæ‰€æœ‰çš„ fiber èŠ‚ç‚¹éƒ½è°ƒå’Œæ— ç–‘æ˜¯æ€§èƒ½ä¸Šçš„æµªè´¹ã€‚</li>
<li>æ—¢ç„¶è¦ä»å¤´æ›´æ–°ï¼Œåˆä¸æƒ³è°ƒå’Œæ•´ä¸ª fiber æ ‘ï¼Œé‚£ä¹ˆå¦‚ä½•æ‰¾åˆ°æ›´æ–°çš„ç»„ä»¶ A å‘¢ï¼Ÿè¿™ä¸ªæ—¶å€™ <strong><code>childLanes</code></strong> å°±æ´¾ä¸Šç”¨åœºäº†ï¼Œå¦‚æœ A å‘ç”Ÿäº†æ›´æ–°ï¼Œé‚£ä¹ˆå…ˆå‘ä¸Šé€’å½’æ›´æ–°çˆ¶çº§é“¾çš„ <code>childLanes</code>ï¼Œæ¥ä¸‹æ¥ä» Root Fiber å‘ä¸‹è°ƒå’Œçš„æ—¶å€™ï¼Œå‘ç° childLanes ç­‰äºå½“å‰æ›´æ–°ä¼˜å…ˆçº§ï¼Œé‚£ä¹ˆè¯´æ˜å®ƒçš„ child é“¾ä¸Šæœ‰æ–°çš„æ›´æ–°ä»»åŠ¡ï¼Œåˆ™ä¼šç»§ç»­å‘ä¸‹è°ƒå’Œï¼Œåä¹‹é€€å‡ºè°ƒå’Œæµç¨‹ã€‚</li>
</ul>
<p>è¿™æ ·å°±è§£å†³äº†ä¸Šé¢é—®é¢˜3 <code>å¦‚æœ </code>Index<code>ä¼š</code>beginWork<code>ï¼Œé‚£ä¹ˆ React ä» Root fiber å¼€å§‹è°ƒå’Œçš„æ—¶å€™ï¼Œæ˜¯å¦‚ä½•æ‰¾åˆ°æ›´æ–°çš„äº‹å‘ç‚¹ Index çš„å‘¢ï¼Ÿ</code>ï¼Œ<strong>Root Fiber æ˜¯é€šè¿‡ childLanes é€æ¸å‘ä¸‹è°ƒå’Œæ‰¾åˆ°éœ€è¦æ›´æ–°çš„ç»„ä»¶çš„ã€‚</strong></p>
<p>ä¸ºäº†æ›´æ¸…æ™°çš„äº†è§£æµç¨‹è¿™é‡Œç”»äº†ä¸€ä¸ªæµç¨‹å›¾ã€‚å¦‚ä¸‹ï¼š</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2421bbf350134d438f1bdc12b2882974~tplv-k3u1fbpfcp-watermark.image?" alt="1.jpg">
ä¸Šé¢æè¿°äº†æ•´ä¸ª fiber æ ‘è°ƒå’Œæµç¨‹ã€‚</p>
<ul>
<li>ç¬¬ä¸€é˜¶æ®µæ˜¯å‘ç”Ÿæ›´æ–°ï¼Œé‚£ä¹ˆäº§ç”Ÿä¸€ä¸ªæ›´æ–°ä¼˜å…ˆçº§ <code>lane</code> ã€‚</li>
<li>ç¬¬äºŒé˜¶æ®µå‘ä¸Šæ ‡è®° childLanes è¿‡ç¨‹ã€‚</li>
<li>ç¬¬ä¸‰é˜¶æ®µæ˜¯å‘ä¸‹è°ƒå’Œè¿‡ç¨‹ï¼Œæœ‰çš„åŒå­¦ä¼šé—®ï¼Œä¸ºä»€ä¹ˆ A ä¼šè¢«è°ƒå’Œï¼ŒåŸå› æ˜¯ A å’Œ B æ˜¯åŒçº§ï¼Œå¦‚æœçˆ¶çº§å…ƒç´ è°ƒå’Œï¼Œå¹¶ä¸”å‘ä¸‹è°ƒå’Œï¼Œé‚£ä¹ˆçˆ¶çº§çš„ç¬¬ä¸€çº§å­é“¾ä¸Šçš„ fiber éƒ½ä¼šè¿›å…¥è°ƒå’Œæµç¨‹ã€‚ä» fiber å…³ç³»ä¸Šçœ‹ï¼ŒRoot å…ˆè°ƒå’Œçš„æ˜¯ child æŒ‡é’ˆä¸Šçš„ A ï¼Œç„¶å A ä¼šé€€å‡ºå‘ä¸‹è°ƒå’Œï¼Œæ¥ä¸‹æ¥æ‰æ˜¯ sibling Bï¼Œæ¥ä¸‹æ¥ B ä¼šå‘ä¸‹è°ƒå’Œï¼Œé€šè¿‡ childLanes æ‰¾åˆ°å½“äº‹äºº Fï¼Œç„¶å F ä¼šè§¦å‘ render æ›´æ–°ã€‚è¿™ä¹Ÿå°±è§£å†³é—®é¢˜2ï¼ŒChild2 çš„è°ƒå’Œé—®é¢˜ã€‚</li>
</ul>
<p>é€šè¿‡ä¸Šè¿°æˆ‘ä»¬çŸ¥é“äº†å¦‚ä½•æ‰¾åˆ° F å¹¶æ‰§è¡Œ render çš„ï¼Œé‚£ä¹ˆè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯ Bï¼ŒE ä¼šå‘ä¸‹è°ƒå’Œï¼Œå¦‚æœå®ƒä»¬æ˜¯ç»„ä»¶ï¼Œé‚£ä¹ˆä¼š render ä¹ˆï¼Œç­”æ¡ˆæ˜¯å¦å®šçš„ï¼Œè¦è®°ä½çš„æ˜¯<strong>è°ƒå’Œè¿‡ç¨‹å¹¶é render è¿‡ç¨‹</strong>ï¼Œè°ƒå’Œè¿‡ç¨‹æœ‰å¯èƒ½ä¼šè§¦å‘ render å‡½æ•°ï¼Œä¹Ÿæœ‰å¯èƒ½åªæ˜¯ç»§ç»­å‘ä¸‹è°ƒå’Œï¼Œè€Œæœ¬èº«ä¸ä¼šæ‰§è¡Œ render ã€‚è¿™å°±è§£é‡Šäº†ä¸Šè¿°çš„é—®é¢˜1ã€‚</p>
<p>æ—¢ç„¶çŸ¥é“äº†å¦‚ä½•å»æ›´æ–° childLanes ï¼Œä»¥åŠæ›´æ–° childLanes çš„æ„ä¹‰ï¼Œæˆ‘ä»¬æ¥ç€å‘ä¸‹åˆ†ææµç¨‹ã€‚åœ¨ scheduleUpdateOnFiber ä¸­ï¼Œæœ€åä¼šè°ƒç”¨ <code>ensureRootIsScheduled</code> ï¼Œé‚£ä¹ˆå®ƒçš„ä½œç”¨åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p>
<p>ç”±äº ensureRootIsScheduled æºç æ¯”è¾ƒç¹çï¼Œè¿™é‡Œå°±ä¸å ç¯‡å¹…äº†ï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯æ ¹æ®ä»»åŠ¡çš„ç±»å‹ï¼Œå‘èµ·å¼‚æ­¥è°ƒåº¦ä»»åŠ¡ï¼Œåœ¨è°ƒåº¦ç« èŠ‚å·²ç»è®²äº†è°ƒåº¦æµç¨‹ã€‚æ¥ä¸‹æ¥ä¼šèµ°è°ƒåº¦çš„æµç¨‹ã€‚</p>
<ul>
<li>å¯¹äº <code>legacy sync</code> æ¨¡å¼æœ€åçš„æ›´æ–°ä»»åŠ¡æ˜¯ <code>performSyncWorkOnRoot</code> ã€‚</li>
<li>å¯¹äº <code>Concurrent</code> æ¨¡å¼æœ€åçš„æ›´æ–°ä»»åŠ¡æ˜¯ <code>performConcurrentWorkOnRoot</code>ã€‚</li>
</ul>
<p>æˆ‘ä»¬ä»Šå¤©ä¸»è¦è®²çš„æ˜¯ç»„ä»¶ beginWork æ›´æ–°æµç¨‹ï¼Œæ‰€ä»¥è¿™é‡Œä¸»è¦ä»¥ legacy æ¨¡å¼ä¸ºä¸»ï¼Œæ‰€ä»¥è·Ÿç€ performSyncWorkOnRoot æµç¨‹å¾€ä¸‹çœ‹ï¼š</p>
<blockquote>
<p>react-reconciler/src/ReactFiberWorkLoop.new.js  -> performSyncWorkOnRoot</p>
</blockquote>
<pre><code class="hljs language-js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">performSyncWorkOnRoot</span>(<span class="hljs-params">root</span>) {
    <span class="hljs-comment">/* render é˜¶æ®µ */</span>
    <span class="hljs-keyword">let</span> exitStatus = <span class="hljs-title function_">renderRootSync</span>(root, lanes);
    <span class="hljs-comment">/* commit é˜¶æ®µ */</span>
    <span class="hljs-title function_">commitRoot</span>(root);
    <span class="hljs-comment">/* å¦‚æœæœ‰å…¶ä»–çš„ç­‰å¾…ä¸­çš„ä»»åŠ¡ï¼Œé‚£ä¹ˆç»§ç»­æ›´æ–° */</span>
    <span class="hljs-title function_">ensureRootIsScheduled</span>(root, <span class="hljs-title function_">now</span>());
}
</code></pre>
<p>ä¹‹å‰çš„ç« èŠ‚ä¸­ä»‹ç»äº†è°ƒå’Œçš„ä¸¤å¤§é˜¶æ®µ <code>render</code> å’Œ <code>commit</code> éƒ½åœ¨è¿™ä¸ªå‡½æ•°ä¸­æ‰§è¡Œã€‚</p>
<ul>
<li><code>renderRootSync</code> ä»£è¡¨ render é˜¶æ®µã€‚</li>
<li><code>commitRoot</code> ä»£è¡¨ commit é˜¶æ®µã€‚</li>
<li>å½“ render å’Œ commit é˜¶æ®µæ‰§è¡Œä¹‹åï¼Œå¦‚æœæœ‰å…¶ä»–çš„ç­‰å¾…ä¸­çš„ä»»åŠ¡ï¼Œé‚£ä¹ˆç»§ç»­æ‰§è¡Œè°ƒåº¦ä»»åŠ¡ã€‚</li>
</ul>
<p>åˆ°æ­¤ä¸ºæ­¢ï¼Œä¸€æ¬¡æ›´æ–°è°ƒåº¦ä»»åŠ¡çš„åˆå§‹åŒ–å·¥ä½œå®Œæˆã€‚å¼€å§‹æ­£å¼è¿›å…¥è°ƒå’Œé˜¶æ®µã€‚æˆ‘å¯¹å‰æˆé˜¶æ®µåšä¸€ä¸‹æ€»ç»“ï¼Œæµç¨‹å›¾å¦‚ä¸‹ï¼š</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c8710f7ad77f44ecb97cd6200c4a5b76~tplv-k3u1fbpfcp-watermark.image?" alt="2.jpg"></p>
<h2>å›› æ¢ç´¢ï¼šä» workLoop åˆ° beginWork</h2>
<p>ä¸Šè¿°è®²åˆ°äº† performSyncWorkOnRoot æ­£å¼è¿›å…¥äº† fiber çš„è°ƒå’Œæµç¨‹ã€‚å› ä¸ºæœ¬ç« èŠ‚ä¸»è¦è®² beginWork å’Œç»„ä»¶æ›´æ–°æµç¨‹ï¼Œè¿™äº›ä¸»è¦éƒ½å‘ç”Ÿåœ¨ <code>render</code> é˜¶æ®µï¼Œæ‰€ä»¥ä¸‹é¢å°†å›´ç»• <code>renderRootSync</code> å±•å¼€ã€‚é¦–å…ˆçœ‹ä¸€ä¸‹ renderRootSync åšäº†ä»€ä¹ˆï¼Ÿ</p>
<blockquote>
<p>react-reconciler/src/ReactFiberWorkLoop.new.js  -> renderRootSync</p>
</blockquote>
<pre><code class="hljs language-js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">renderRootSync</span>(<span class="hljs-params">root,lanes</span>){
    <span class="hljs-title function_">workLoopSync</span>();
    <span class="hljs-comment">/* workLoopå®Œæ¯•åï¼Œè¯æ˜æ‰€æœ‰èŠ‚ç‚¹éƒ½éå†å®Œæ¯•ï¼Œé‚£ä¹ˆé‡ç½®çŠ¶æ€ï¼Œè¿›å…¥ commit é˜¶æ®µ */</span>
    workInProgressRoot = <span class="hljs-literal">null</span>;
    workInProgressRootRenderLanes = <span class="hljs-title class_">NoLanes</span>;
}
</code></pre>
<p>renderRootSync æ ¸å¿ƒåŠŸèƒ½ï¼š</p>
<ul>
<li>æ‰§è¡Œ <code>workLoopSync</code>ã€‚</li>
<li><code>workLoop</code> å®Œæ¯•åï¼Œè¯æ˜æ‰€æœ‰èŠ‚ç‚¹éƒ½éå†å®Œæ¯•ï¼Œé‚£ä¹ˆé‡ç½®çŠ¶æ€ï¼Œè¿›å…¥ <code>commit</code> é˜¶æ®µã€‚</li>
</ul>
<p><code>workLoopSync</code> åœ¨æ•´ä¸ª render æµç¨‹ä¸­å……å½“çš„è§’è‰²éå¸¸é‡è¦ï¼Œå¯ä»¥æŠŠ <code>workLoopSync</code> å½“ä½œä¸€ä¸ªå¾ªç¯è¿ä½œçš„åŠ å·¥å™¨ï¼Œæ¯ä¸€ä¸ªéœ€è¦è°ƒå’Œçš„ fiber å¯ä»¥å½“ä½œä¸€ä¸ªé›¶ä»¶ï¼Œæ¯ä¸€ä¸ªé›¶ä»¶éƒ½éœ€è¦è¿›å…¥åŠ å·¥å™¨ï¼Œå¦‚æœæ²¡æœ‰å¾…åŠ å·¥çš„é›¶ä»¶ï¼Œé‚£ä¹ˆåŠ å·¥å™¨æ‰åœæ­¢è¿è½¬ã€‚ä¸‹é¢å°±æ˜¯åŠ å·¥å™¨çš„å…·ä½“å®ç°ã€‚</p>
<blockquote>
<p>react-reconciler/src/ReactFiberWorkLoop.new.js -> workLoopSync</p>
</blockquote>
<pre><code class="hljs language-js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">workLoopSync</span>(<span class="hljs-params"></span>) {
  <span class="hljs-comment">/* å¾ªç¯æ‰§è¡Œ performUnitOfWork ï¼Œä¸€ç›´åˆ° workInProgress ä¸ºç©º */</span>
  <span class="hljs-keyword">while</span> (workInProgress !== <span class="hljs-literal">null</span>) {
    <span class="hljs-title function_">performUnitOfWork</span>(workInProgress);
  }
}
</code></pre>
<ul>
<li>å¦‚ä¸Šåªè¦ <code>workInProgress</code> ä¸ä¸º <code>null</code>ï¼ˆè¿˜æœ‰éœ€è¦è°ƒå’Œçš„ fiberï¼‰ï¼Œé‚£ä¹ˆ workLoopSync ä¼šå¾ªç¯è°ƒç”¨ performUnitOfWorkã€‚</li>
</ul>
<p>åœ¨è°ƒåº¦ç« èŠ‚è®²åˆ°è¿‡ï¼Œå½“ Concurrent æ¨¡å¼ä¸‹ä¼šé€šè¿‡ <code>shouldYield</code> ï¼Œæ¥åˆ¤æ–­æœ‰æ²¡æœ‰è¿‡æœŸçš„ä»»åŠ¡ï¼Œæœ‰è¿‡æœŸä»»åŠ¡ï¼Œä¼šä¸­æ–­ workLoop ï¼Œé‚£ä¹ˆä¹Ÿå°±æ˜¯è¯´æ˜äº†<strong>renderé˜¶æ®µæ˜¯å¯ä»¥è¢«æ‰“æ–­çš„ã€‚</strong></p>
<pre><code class="hljs language-js"><span class="hljs-keyword">while</span> (workInProgress !== <span class="hljs-literal">null</span> &#x26;&#x26; !<span class="hljs-title function_">shouldYield</span>()) {
  <span class="hljs-title function_">performUnitOfWork</span>(workInProgress);
}
</code></pre>
<p>å›åˆ° workLoopSync æµç¨‹ä¸Šæ¥ï¼Œé€šè¿‡ fiber ç« èŠ‚ï¼Œè®²åˆ° fiber æ ‘æ˜¯æ·±åº¦ä¼˜å…ˆéå†å¾—åˆ°çš„ï¼Œåœ¨éå†å®Œçˆ¶èŠ‚ç‚¹ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±ä¼šéå†å­èŠ‚ç‚¹ã€‚åœ¨è¿™å…¶ä¸­ï¼Œæ¯ä¸€ä¸ªè°ƒå’Œçš„ fiber éƒ½å°†ä½œä¸º <code>workInProgress</code> è¿›è¡Œè°ƒå’Œæ›´æ–°ã€‚</p>
<p>æ— è®ºä»€ä¹ˆæ¨¡å¼ï¼ŒworkLoop çš„æ‰§è¡Œå•å…ƒéƒ½æ˜¯ fiber ã€‚è€Œä¸”æ›´æ–°å•å…ƒçš„å‡½æ•°å«åš performUnitOfWork ã€‚</p>
<blockquote>
<p>react-reconciler/src/ReactFiberWorkLoop.new.js -> performUnitOfWork</p>
</blockquote>
<pre><code class="hljs language-js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">performUnitOfWork</span>(<span class="hljs-params">unitOfWork</span>){
    <span class="hljs-keyword">const</span> current = unitOfWork.<span class="hljs-property">alternate</span>;
    <span class="hljs-keyword">let</span>  next = <span class="hljs-title function_">beginWork</span>(current, unitOfWork, subtreeRenderLanes);
    unitOfWork.<span class="hljs-property">memoizedProps</span> = unitOfWork.<span class="hljs-property">pendingProps</span>;
    <span class="hljs-keyword">if</span> (next === <span class="hljs-literal">null</span>) {
       <span class="hljs-title function_">completeUnitOfWork</span>(unitOfWork);
    } <span class="hljs-keyword">else</span> {
      workInProgress = next;
    }
}
</code></pre>
<p>åœ¨ fiber ç« èŠ‚è®²åˆ°è¿‡, beginWork æ˜¯å‘ä¸‹è°ƒå’Œæµç¨‹ï¼ŒcompleteUnitOfWork æ˜¯å‘ä¸Šå½’å¹¶çš„æµç¨‹ã€‚é‚£ä¹ˆä»¥ç»„ä»¶æ›´æ–°æµç¨‹ä¸ºç›®çš„ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥é‡ç‚¹ç ”ç©¶ beginWork æµç¨‹ã€‚</p>
<p>åœ¨ä»‹ç» beginWork ä¹‹å‰å…ˆæ¥çœ‹å‡ ä¸ªåœºæ™¯ï¼š</p>
<p>å‡è®¾æœ‰ä¸€ä¸ªç»„ä»¶ fiber é“¾ã€‚æˆ‘ä»¬åœ¨è¿™ä¸ª fiber é“¾ä¸Šæš‚ä¸”æ— è§†å…¶ä»–ç±»å‹çš„ fiberï¼Œåªä¿ç•™ç»„ä»¶ç±»å‹çš„ fiberã€‚ç»“æ„å¦‚ä¸‹ï¼š</p>
<p>root Fiber --child--> Aç»„ä»¶ --child--> Bç»„ä»¶ --child--> Cç»„ä»¶ã€‚</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/46a8441e883f4d70a39e5e56b58d6ff9~tplv-k3u1fbpfcp-watermark.image?" alt="4.jpg"></p>
<p>è€Œä¸»è§’å°±æ˜¯<strong>ç»„ä»¶B</strong>ï¼Œä»¥ç»„ä»¶B ä¸ºå‚è€ƒã€‚æ¥çœ‹ä¸€ä¸‹ React å¦‚ä½•è°ƒå’Œçš„ã€‚é‚£ä¹ˆä¸€æ¬¡æ›´æ–°å°±æœ‰å¯èƒ½æœ‰ä¸‰ç§åœºæ™¯ï¼š</p>
<ul>
<li>åœºæ™¯ä¸€ï¼š<strong>æ›´æ–° A ç»„ä»¶ state</strong>ï¼Œé‚£ä¹ˆ A è§¦å‘æ›´æ–°ï¼Œé‚£ä¹ˆå¦‚æœ B,C æ²¡æœ‰åšæ¸²æŸ“æ§åˆ¶å¤„ç†ï¼ˆæ¯”å¦‚ memo PureComponentï¼‰ï¼Œé‚£ä¹ˆæ›´æ–°ä¼šæ³¢åŠ¨åˆ° B ï¼Œ Cï¼Œé‚£ä¹ˆ Aï¼ŒBï¼ŒC éƒ½ä¼š rerenderã€‚</li>
</ul>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/37a14aa23434495aba1b9dfb985ff219~tplv-k3u1fbpfcp-watermark.image?" alt="5.jpg"></p>
<ul>
<li>åœºæ™¯äºŒï¼š<strong>å½“æ›´æ–° B ç»„ä»¶</strong>ï¼Œé‚£ä¹ˆç»„ä»¶ A fiber ä¼šè¢«æ ‡è®°ï¼Œç„¶å A ä¼šè°ƒå’Œï¼Œä½†æ˜¯ä¸ä¼š rerenderï¼›ç»„ä»¶ B æ˜¯å½“äº‹äººï¼Œæ—¢ä¼šè¿›å…¥è°ƒå’Œï¼Œä¹Ÿä¼š rerenderï¼›ç»„ä»¶ C å—åˆ°çˆ¶ç»„ä»¶ B çš„å½±å“ï¼Œä¼š rerenderã€‚</li>
</ul>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e21e929037b04614897e20338752f324~tplv-k3u1fbpfcp-watermark.image?" alt="6.jpg"></p>
<ul>
<li>åœºæ™¯ä¸‰ï¼›<strong>å½“æ›´æ–° Cç»„ä»¶</strong>ï¼Œé‚£ä¹ˆ Aï¼ŒB ä¼šè¿›å…¥è°ƒå’Œæµç¨‹ï¼Œä½†æ˜¯ä¸ä¼š rerenderï¼ŒC æ˜¯å½“äº‹äººï¼Œä¼šè°ƒå’Œå¹¶ rerenderã€‚</li>
</ul>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3691b87d164a427b8c7a180e53b6d84d~tplv-k3u1fbpfcp-watermark.image?" alt="7.jpg"></p>
<p>é‚£ä¹ˆå¦‚ä¸Šçš„åœºæ™¯æœ¬è´¨ä¸Šéƒ½åœ¨ <strong><code>beginWork</code></strong> ä¸­è¿›è¡Œçš„ï¼Œè¿™ä¸ª beginWork æ˜¯å¦‚ä½•å¤„ç†è¿™äº›é€»è¾‘çš„ã€‚</p>
<h2>äº” æ­ç§˜ï¼šä» beginWork åˆ°ç»„ä»¶æ›´æ–°å…¨æµç¨‹</h2>
<p>æ¥ä¸‹æ¥ä» beginWork å¼€å§‹ï¼Œé‡ç‚¹ç ”ç©¶ä¸€ä¸‹æµç¨‹ã€‚</p>
<h3>1 beginWork æ›´æ–°çš„è°ƒåº¦ç«™</h3>
<blockquote>
<p>react-reconciler/src/ReactFiberBeginWork.new.js  -> beginWork</p>
</blockquote>
<pre><code class="hljs language-js"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">*</span>} current         current æ ‘ fiber 
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">*</span>} workInProgress  workInProgress æ ‘ fiber 
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">*</span>} renderLanes     å½“å‰çš„ render ä¼˜å…ˆçº§
 * <span class="hljs-doctag">@returns</span> 
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">beginWork</span>(<span class="hljs-params">current,workInProgress,renderLanes</span>){
    <span class="hljs-comment">/* -------------------ç¬¬ä¸€éƒ¨åˆ†-------------------- */</span>
    <span class="hljs-keyword">if</span>(current !== <span class="hljs-literal">null</span>){ 
        <span class="hljs-comment">/* æ›´æ–°æµç¨‹ */</span>
        <span class="hljs-comment">/* current æ ‘ä¸Šä¸Šä¸€æ¬¡æ¸²æŸ“åçš„ props */</span>
        <span class="hljs-keyword">const</span> oldProps = current.<span class="hljs-property">memoizedProps</span>;
        <span class="hljs-comment">/* workInProgress æ ‘ä¸Šè¿™ä¸€æ¬¡æ›´æ–°çš„ props  */</span>
        <span class="hljs-keyword">const</span> newProps = workInProgress.<span class="hljs-property">pendingProps</span>;
        
        <span class="hljs-keyword">if</span>(oldProps !== newProps ||  <span class="hljs-title function_">hasLegacyContextChanged</span>()){
          didReceiveUpdate = <span class="hljs-literal">true</span>;
        }<span class="hljs-keyword">else</span>{
          <span class="hljs-comment">/* props å’Œ context æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œæ£€æŸ¥æ˜¯å¦æ›´æ–°æ¥è‡ªè‡ªèº«æˆ–è€… context æ”¹å˜ */</span>
          <span class="hljs-keyword">const</span> hasScheduledUpdateOrContext = <span class="hljs-title function_">checkScheduledUpdateOrContext</span>(current,renderLanes)
          <span class="hljs-keyword">if</span>(!hasScheduledUpdateOrContext){
              didReceiveUpdate = <span class="hljs-literal">false</span>;
              <span class="hljs-keyword">return</span>  <span class="hljs-title function_">attemptEarlyBailoutIfNoScheduledUpdate</span>(current,workInProgress,renderLanes)
          }
          <span class="hljs-comment">/* è¿™é‡Œçœç•¥äº†ä¸€äº›åˆ¤æ–­é€»è¾‘ */</span>
          didReceiveUpdate = <span class="hljs-literal">false</span>;
        }

    }<span class="hljs-keyword">else</span>{
      didReceiveUpdate = <span class="hljs-literal">false</span>
    }
    <span class="hljs-comment">/* -------------------ç¬¬äºŒéƒ¨åˆ†-------------------- */</span>
    <span class="hljs-comment">/* <span class="hljs-doctag">TODO:</span> èµ°åˆ°è¿™é‡Œæµç¨‹ä¼šè¢«è°ƒå’Œ | æ›´æ–°ï¼Œæ¯”å¦‚å‡½æ•°æ‰§è¡Œä¼šæ‰§è¡Œï¼Œç±»ç»„ä»¶ä¼šæ‰§è¡Œ render ã€‚ */</span>
    <span class="hljs-keyword">switch</span>(workInProgress.<span class="hljs-property">tag</span>){
        <span class="hljs-comment">/* å‡½æ•°ç»„ä»¶çš„æƒ…å†µ */</span>
        <span class="hljs-keyword">case</span> <span class="hljs-title class_">FunctionComponent</span>: {
           <span class="hljs-keyword">return</span> <span class="hljs-title function_">updateFunctionComponent</span>( current, workInProgress, <span class="hljs-title class_">Component</span>, resolvedProps, renderLanes )
        }
        <span class="hljs-comment">/* ç±»ç»„ä»¶çš„æƒ…å†µ */</span>
        <span class="hljs-keyword">case</span> <span class="hljs-title class_">ClassComponent</span>:{
          <span class="hljs-keyword">return</span> <span class="hljs-title function_">updateClassComponent</span>(current,workInProgress,<span class="hljs-title class_">Component</span>,resolvedProps,renderLanes)
        }
        <span class="hljs-comment">/* å…ƒç´ ç±»å‹ fiber &#x3C;div>, &#x3C;span>  */</span>
        <span class="hljs-keyword">case</span> <span class="hljs-title class_">HostComponent</span>:{
          <span class="hljs-keyword">return</span> <span class="hljs-title function_">updateHostComponent</span>(current, workInProgress, renderLanes)
        }
        <span class="hljs-comment">/* å…¶ä»– fiber æƒ…å†µ */</span> 
    }
}
</code></pre>
<p>å¦‚ä¸Šå°±æ˜¯ <code>beginWork</code> çš„å…¨æµç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ•´ä¸ªæµç¨‹åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µã€‚</p>
<h3>2 ç¬¬ä¸€é˜¶æ®µ</h3>
<p>ç¬¬ä¸€éƒ¨åˆ†ï¼Œè¿™éƒ¨åˆ†éå¸¸é‡è¦å°±æ˜¯åˆ¤æ–­æ›´æ–°æƒ…å†µçš„ï¼Œä¸Šé¢çš„ä¸‰ç§åœºæ™¯éƒ½å¯ä»¥åœ¨ç¬¬ä¸€é˜¶æ®µè¿›è¡Œåˆ¤æ–­å¤„ç†ã€‚å…ˆæ¥åˆ†æä¸€ä¸‹ç¬¬ä¸€é˜¶æ®µåšäº†å“ªäº›äº‹ã€‚æ­£å¼è®²è§£ä¹‹å‰å…ˆæ¥çœ‹ä¸€ä¸ªå˜é‡çš„æ„ä¹‰ï¼Œé‚£å°±æ˜¯ <code>didReceiveUpdate</code> ã€‚</p>
<ul>
<li>
<p>didReceiveUpdate ï¼šè¿™ä¸ªå˜é‡ä¸»è¦è¯æ˜å½“å‰æ›´æ–°æ˜¯å¦æ¥æºäºçˆ¶çº§çš„æ›´æ–°ï¼Œé‚£ä¹ˆè‡ªèº«å¹¶æ²¡æœ‰æ›´æ–°ã€‚æ¯”å¦‚æ›´æ–° B ç»„ä»¶ï¼Œé‚£ä¹ˆ Cç»„ä»¶ä¹Ÿä¼šè·Ÿç€æ›´æ–°ï¼Œè¿™ä¸ªæƒ…å†µä¸‹ <code>didReceiveUpdate = true</code>ã€‚</p>
</li>
<li>
<p>é¦–å…ˆé€šè¿‡ <code>current!== null</code> æ¥åˆ¤æ–­å½“å‰ fiber æ˜¯å¦åˆ›å»ºè¿‡ï¼Œå¦‚æœç¬¬ä¸€æ¬¡ mounted ï¼Œ é‚£ä¹ˆ current ä¸º nullï¼Œè€Œç¬¬ä¸€é˜¶æ®µä¸»è¦é’ˆå¯¹æ›´æ–°çš„æƒ…å†µã€‚å¦‚æœåˆå§‹åŒ–ï¼Œé‚£ä¹ˆç›´æ¥è·³è¿‡ç¬¬ä¸€é˜¶æ®µï¼Œ<strong>åˆ°ç¬¬äºŒé˜¶æ®µã€‚</strong></p>
</li>
<li>
<p>å¦‚æœæ˜¯æ›´æ–°æµç¨‹ã€‚é‚£ä¹ˆåˆ¤æ–­ oldProps === newPropsï¼ˆæºç ä¸­è¿˜åˆ¤æ–­äº†è€ç‰ˆæœ¬ context æ˜¯å¦å˜åŒ–ï¼‰ï¼Œé‚£ä¹ˆä¸¤è€…ç›¸ç­‰ã€‚ä¸€èˆ¬ä¼šæœ‰ä»¥ä¸‹å‡ ç§æƒ…å†µï¼š</p>
</li>
</ul>
<p><strong>æƒ…å†µä¸€</strong>ï¼šè¿˜æ˜¯å›åˆ°ä¸Šé¢åœºæ™¯ä¸Šæ¥ï¼Œå¦‚æœ C ç»„ä»¶æ›´æ–°ï¼Œé‚£ä¹ˆ B ç»„ä»¶è¢«æ ‡è®° ChildLanes ä¼šè¿›å…¥åˆ° beginWork è°ƒå’Œé˜¶æ®µï¼Œä½†æ˜¯ B ç»„ä»¶æœ¬èº« props ä¸ä¼šå‘ç”Ÿå˜åŒ–ã€‚<br></p>
<p><strong>æƒ…å†µäºŒ</strong>ï¼šé€šè¿‡ useMemo ç­‰æ–¹å¼ç¼“å­˜äº† React element å…ƒç´ ï¼Œåœ¨æ¸²æŸ“æ§åˆ¶ç« èŠ‚è®²åˆ°è¿‡ã€‚<br></p>
<p><strong>æƒ…å†µä¸‰</strong>ï¼šå°±æ˜¯æ›´æ–°å‘ç”Ÿåœ¨å½“å‰ç»„ä»¶æœ¬èº«ï¼Œæ¯”å¦‚ B ç»„ä»¶å‘ç”Ÿæ›´æ–°ï¼Œä½†æ˜¯ B ç»„ä»¶çš„ props å¹¶æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œæ‰€ä»¥ä¹Ÿä¼šèµ°åˆ°è¿™ä¸ªæµç¨‹ä¸Šæ¥ã€‚</p>
<p>åä¹‹å¦‚æœä¸¤è€…ä¸æƒ³ç­‰ï¼Œè¯æ˜çˆ¶çº§ fiber é‡æ–° rerender å¯¼è‡´äº† props æ”¹å˜ï¼Œæ­¤æ—¶ didReceiveUpdate = true ï¼Œé‚£ä¹ˆç¬¬ä¸€é˜¶æ®µå®Œæˆï¼Œ<strong>è¿›å…¥åˆ°ç¬¬äºŒé˜¶æ®µã€‚</strong></p>
<p>åˆšæ‰è®²åˆ°å¦‚æœ<strong>æ–°è€ props ç›¸ç­‰</strong>ï¼Œä¼šæœ‰ä¸€äº›å¤„ç†é€»è¾‘ã€‚é‚£ä¹ˆå¦‚æœå¤„ç†çš„å‘¢ï¼Ÿç¬¬ä¸€ä¸ªå°±æ˜¯è°ƒç”¨ <code>checkScheduledUpdateOrContext</code></p>
<p><strong>checkScheduledUpdateOrContext</strong></p>
<blockquote>
<p>react-reconciler/src/ReactFiberBeginWork.new.js  -> checkScheduledUpdateOrContext</p>
</blockquote>
<pre><code class="hljs language-js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">checkScheduledUpdateOrContext</span>(<span class="hljs-params">current,renderLanes</span>){
    <span class="hljs-keyword">const</span> updateLanes = current.<span class="hljs-property">lanes</span>;
    <span class="hljs-comment">/* è¿™ç§æƒ…å†µè¯´æ˜å½“å‰æ›´æ–° */</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">includesSomeLane</span>(updateLanes, renderLanes)) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
     <span class="hljs-comment">/* å¦‚æœè¯¥ fiber æ¶ˆè´¹äº† context ï¼Œå¹¶ä¸” context å‘ç”Ÿäº†æ”¹å˜ã€‚ */</span>
    <span class="hljs-keyword">if</span> (enableLazyContextPropagation) {
      <span class="hljs-keyword">const</span> dependencies = current.<span class="hljs-property">dependencies</span>;
      <span class="hljs-keyword">if</span> (dependencies !== <span class="hljs-literal">null</span> &#x26;&#x26; <span class="hljs-title function_">checkIfContextChanged</span>(dependencies)) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      }
    }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}
</code></pre>
<ul>
<li>å½“æ–°è€ props ç›¸ç­‰æƒ…å†µï¼Œé¦–å…ˆä¼šæ£€æŸ¥å½“å‰ fiber çš„ <code>lane</code> æ˜¯å¦ç­‰äºå½“å‰çš„æ›´æ–°ä¼˜å…ˆçº§ï¼Œå¦‚æœç›¸ç­‰ï¼Œé‚£ä¹ˆè¯æ˜æ›´æ–°æ¥æºå½“å‰ fiberï¼Œæ¯”å¦‚ B ç»„ä»¶å‘ç”Ÿæ›´æ–°ï¼Œé‚£ä¹ˆä¼šèµ°è¿™é‡Œï¼ˆæƒ…å†µä¸‰ï¼‰ã€‚å½“ç„¶æœŸé—´ä¹Ÿä¼šåˆ¤æ–­æ˜¯å¦æœ‰æ¶ˆè´¹ <code>context</code> å¹¶å‘ç”Ÿäº†å˜åŒ–ã€‚æœ€åè¿”å›çŠ¶æ€ hasScheduledUpdateOrContext ã€‚</li>
</ul>
<p>å¦‚æœ <code>hasScheduledUpdateOrContext</code> ä¸º falseï¼Œè¯æ˜å½“å‰ç»„ä»¶æ²¡æœ‰æ›´æ–°ï¼Œä¹Ÿæ²¡æœ‰ context ä¸Šçš„å˜åŒ–ï¼Œé‚£ä¹ˆè¿˜æœ‰ä¸€ç§æƒ…å†µå°±æ˜¯ child å¯èƒ½æœ‰æ›´æ–°ï¼Œä½†æ˜¯å½“å‰ fiber ä¸éœ€è¦æ›´æ–°ï¼ˆæƒ…å†µä¸€ï¼‰ã€‚é‚£ä¹ˆä¼šç›´æ¥è¿”å› <code>attemptEarlyBailoutIfNoScheduledUpdate</code> ï¼Œ<strong>é€€å‡ºç¬¬äºŒé˜¶æ®µ</strong>ã€‚</p>
<p>attemptEarlyBailoutIfNoScheduledUpdate è¿™ä¸ªå‡½æ•°ä¼šå¤„ç†éƒ¨åˆ† Context é€»è¾‘ï¼Œä½†æ˜¯æœ€é‡è¦çš„æ˜¯è°ƒç”¨äº† <strong><code>bailoutOnAlreadyFinishedWork</code></strong> ã€‚</p>
<blockquote>
<p>react-reconciler/src/ReactFiberBeginWork.new.js -> bailoutOnAlreadyFinishedWork</p>
</blockquote>
<pre><code class="hljs language-js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">bailoutOnAlreadyFinishedWork</span>(<span class="hljs-params">current,workInProgress,renderLanes</span>){
     <span class="hljs-comment">/* å¦‚æœ children æ²¡æœ‰é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ï¼Œè¯´æ˜æ‰€æœ‰çš„ child éƒ½æ²¡æœ‰æ›´æ–°ï¼Œé‚£ä¹ˆç›´æ¥ è¿”å›ï¼Œchild ä¹Ÿä¸ä¼šè¢«è°ƒå’Œ  */</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">includesSomeLane</span>(renderLanes, workInProgress.<span class="hljs-property">childLanes</span>)) {
      <span class="hljs-comment">/* è¿™é‡Œåšäº†æµç¨‹ç®€åŒ– */</span>
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span> 
    }
    <span class="hljs-comment">/* å½“å‰fiberæ²¡æœ‰æ›´æ–°ã€‚ä½†æ˜¯å®ƒçš„children éœ€è¦æ›´æ–°ã€‚  */</span>
    <span class="hljs-title function_">cloneChildFibers</span>(current, workInProgress);
    <span class="hljs-keyword">return</span> workInProgress.<span class="hljs-property">child</span>;
}
</code></pre>
<p>bailoutOnAlreadyFinishedWork æµç¨‹éå¸¸é‡è¦ã€‚å®ƒä¸»è¦åšäº†ä¸¤ä»¶äº‹ã€‚</p>
<ul>
<li>
<p>é¦–å…ˆé€šè¿‡ includesSomeLane åˆ¤æ–­ childLanes æ˜¯å¦æ˜¯é«˜ä¼˜å…ˆçº§ä»»åŠ¡ï¼Œå¦‚æœä¸æ˜¯ï¼Œé‚£ä¹ˆæ‰€æœ‰å­å­™ fiber éƒ½ä¸éœ€è¦è°ƒå’Œ ï¼Œé‚£ä¹ˆç›´æ¥è¿”å› nullï¼Œchild ä¹Ÿä¸ä¼šè¢«è°ƒå’Œã€‚</p>
</li>
<li>
<p>å¦‚æœ childLanes ä¼˜å…ˆçº§é«˜ï¼Œé‚£ä¹ˆè¯æ˜ child éœ€è¦è¢«è°ƒå’Œï¼Œä½†æ˜¯å½“å‰ç»„ä»¶ä¸éœ€è¦ï¼Œæ‰€ä»¥ä¼šå…‹éš†ä¸€ä¸‹ childrenï¼Œè¿”å› children ï¼Œé‚£ä¹ˆæœ¬èº«ä¸ä¼š <code>rerender</code>ã€‚</p>
</li>
</ul>
<p>åˆ°è¿™é‡Œç¬¬ä¸€é˜¶æ®µå®Œæˆäº†ï¼Œå®Œæˆäº†ç»„ä»¶æ›´æ–°æµç¨‹çš„æ‰€æœ‰æƒ…å†µã€‚ç¬¬ä¸€é˜¶æ®µå®Œæˆä¼šè¿›å…¥åˆ°æ›´æ–°çš„ç¬¬äºŒé˜¶æ®µã€‚</p>
<h3>3 ç¬¬äºŒé˜¶æ®µ</h3>
<p>ä» beginWork çš„æºç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œç¬¬äºŒé˜¶æ®µå°±æ˜¯æ›´æ–° fiberï¼Œæ¯”å¦‚æ˜¯å‡½æ•°ç»„ä»¶ï¼Œå°±ä¼šè°ƒç”¨ <code>updateFunctionComponent</code>ï¼Œç±»ç»„ä»¶å°±è°ƒç”¨ <code>updateClassComponent</code>ï¼Œç„¶åè¿›è¡Œ rerender äº†ã€‚</p>
<h3>4 æµç¨‹æ€»ç»“</h3>
<p>æ¥ä¸‹æ¥ä»¥ä¸Šè¿°ä¸­çš„<strong>ç»„ä»¶B</strong>ä¸ºä¾‹å­ï¼Œåœ¨å¼ºåŒ–ä¸€ä¸‹æ›´æ–°æµç¨‹ã€‚</p>
<p><strong>åœºæ™¯ä¸€</strong>ï¼šå½“æ›´æ–° A æ—¶å€™ï¼Œé‚£ä¹ˆ A ç»„ä»¶çš„ fiber ä¼šè¿›å…¥è°ƒå’Œæµç¨‹ï¼Œä¼šæ‰§è¡Œ render å½¢æˆæ–°çš„ç»„ä»¶ B å¯¹åº”çš„ element å…ƒç´ ï¼Œæ¥ä¸‹æ¥è°ƒå’Œ B ï¼Œå› ä¸º B çš„ newProps ä¸ç­‰äº oldPropsï¼Œæ‰€ä»¥ä¼š didReceiveUpdate = true ï¼Œç„¶åæ›´æ–°ç»„ä»¶ï¼Œä¹Ÿä¼šè§¦å‘ renderã€‚ï¼ˆè¿™é‡Œéƒ½æ˜¯é»˜è®¤æ²¡æœ‰æ¸²æŸ“æ§åˆ¶çš„åœºæ™¯ï¼Œæ¯”å¦‚ memo PureComponent ç­‰ ï¼‰ï¼Œè¿™æ ·ä¹Ÿå°±è§£å†³äº†æ–‡ç« å¼€å¤´çš„é—®é¢˜å››ã€‚</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d8a6957eadb24a92992c33aae021815c~tplv-k3u1fbpfcp-watermark.image?" alt="8.jpg"></p>
<p><strong>åœºæ™¯äºŒ</strong>ï¼šå½“æ›´æ–° B æ—¶å€™ï¼Œé‚£ä¹ˆ A ç»„ä»¶ä¼šæ ‡è®° childLanesï¼Œæ‰€ä»¥ A ä¼šè¢«è°ƒå’Œï¼Œä½†æ˜¯ä¸ä¼š renderï¼Œç„¶ååˆ°äº†ä¸»è§’ B ï¼ŒB ç”±äºæ–°è€ props ç›¸ç­‰ï¼Œæ‰€ä»¥ä¼š <code>checkScheduledUpdateOrContext</code> æµç¨‹ï¼Œåˆ¤æ–­ lane ç­‰äº renderLanes ï¼Œæ£€æŸ¥åˆ° lane ç­‰äº renderLaneï¼Œæ‰€ä»¥ä¼šæ‰§è¡Œæ›´æ–°ï¼Œè§¦å‘ renderã€‚ C ç»„ä»¶ä¹Ÿå°±è·Ÿç€æ›´æ–°ã€‚</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9d8b4c1d668d47778b52e3c2c5bc843f~tplv-k3u1fbpfcp-watermark.image?" alt="9.jpg"></p>
<p><strong>åœºæ™¯ä¸‰</strong>ï¼šå½“æ›´æ–° C æ—¶å€™ï¼Œé‚£ä¹ˆ A å’Œ B ç»„ä»¶ä¼šæ ‡è®° childLanesï¼Œæ‰€ä»¥ A å’Œ B ä¼šè¢«è°ƒå’Œï¼Œä½†æ˜¯ä¸ä¼šæ›´æ–°ï¼Œç„¶ååˆ° C ï¼ŒC ä¼šèµ°æ­£å¸¸æµç¨‹ã€‚</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8d1bfffd917d4e458c6544ee9aa1ff55~tplv-k3u1fbpfcp-watermark.image?" alt="10.jpg"></p>
<p><strong>åœºæ™¯å››</strong>ï¼šè¿˜æœ‰ä¸€ç§æƒ…å†µï¼Œä»€ä¹ˆæ—¶å€™ B ä¼šè·³å‡ºè°ƒå’Œæµç¨‹å‘¢ã€‚</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/eaf97e258da4462c8b5ddf85a284e2ca~tplv-k3u1fbpfcp-watermark.image?" alt="11.jpg"></p>
<p>åˆ°æ­¤ä¸ºæ­¢å®Œæˆäº†æ•´ä¸ªæ›´æ–°æµç¨‹ã€‚</p>
<h3>5 beginWork æµç¨‹å›¾</h3>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/99afa68f8ab94c93be41df70db0ae488~tplv-k3u1fbpfcp-watermark.image?" alt="3.jpg"></p>
<h2>æ€»ç»“</h2>
<p>é€šè¿‡æœ¬ç« èŠ‚çš„å­¦ä¹ ï¼Œæˆ‘ä»¬åº”è¯¥æŒæ¡çš„çŸ¥è¯†ç‚¹å¦‚ä¸‹ï¼š</p>
<ul>
<li>ç»„ä»¶æ›´æ–°å’Œè°ƒå’Œè¿‡ç¨‹ã€‚rerender ä¸€å®šä¼šè°ƒå’Œï¼Œä½†æ˜¯è°ƒå’Œå¹¶ä¸ä¸€å®š rerenderï¼Œä¹Ÿæœ‰å¯èƒ½æ‰¾åˆ°å¾…æ›´æ–°çš„å­å…ƒç´ ã€‚</li>
<li>ç»„ä»¶ç±»å‹çš„æ›´æ–°çš„å‡ ç§æƒ…å†µã€‚</li>
<li>ä»å‡ºå‘æ›´æ–°åˆ° beginWork å…¨æµç¨‹ã€‚</li>
</ul></div>
</body></html>