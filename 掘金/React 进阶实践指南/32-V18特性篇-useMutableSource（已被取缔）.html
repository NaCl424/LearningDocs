<!DOCTYPE html><html lang="en"><head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç¬¬ 01 è®²ï¼šè®¾è®¡ä¸€ä»½å¸å¼•é¢è¯•å®˜çš„ç®€å†</title>
<style type="text/css">
:root {
    --control-text-color: #777;
    --select-text-bg-color: rgba(223, 197, 223);  /*#7e66992e;*/
    
    /* side bar */
    --side-bar-bg-color: rgb(255, 255, 255);
    --active-file-text-color: #8163bd;
    --active-file-bg-color: #E9E4F0;
    --item-hover-bg-color: #E9E4F0;
    --active-file-border-color: #8163bd;

    --title-color: #6c549c;
    --font-sans-serif: 'Ubuntu', 'Source Sans Pro', sans-serif !important;
    --font-monospace: 'Fira Code', 'Roboto Mono', monospace !important;
    --purple-1: #8163bd;
    --purple-2: #79589F;
    --purple-3: #fd5eb8;
    --purple-light-1: rgba(99, 99, 172, .05);
    --purple-light-2: rgba(99, 99, 172, .1);
    --purple-light-3: rgba(99, 99, 172, .2);
    --purple-light-4: rgba(129, 99, 189, .3);
    --purple-light-5: #E9E4F0;
    --purple-light-6: rgba(129, 99, 189, .8);
}

/* html {
    font-size: 16px;
} */

body {
    font-family: var(--font-sans-serif);
    color: #34495e;
    -webkit-font-smoothing: antialiased;
    line-height: 1.6rem;
    letter-spacing: 0;
    margin: 0;
    overflow-x: hidden;
}

/* é¡µè¾¹è· å’Œ é¡µé¢å¤§å° */
#write {
    padding-left: 6ch;
    padding-right: 6ch;
    margin: 0 auto;
}

#write p {
    line-height: 1.6rem;
    word-spacing: .05rem;
}

#write ol li {
    padding-left: 0.5rem;
}

#write > ul:first-child,
#write > ol:first-child {
    margin-top: 30px;
}

body > *:first-child {
    margin-top: 0 !important;
}

body > *:last-child {
    margin-bottom: 0 !important;
}

a {
    color: var(--purple-1);
    padding: 0 2px;
    text-decoration: none;
}
.md-content {
    color: var(--purple-light-6);
}
#write a {
    border-bottom: 1px solid var(--purple-1);
    color: var(--purple-1);
    text-decoration: none;
}

h1,
h2,
h3,
h4,
h5,
h6 {
    position: relative;
    margin-top: 1rem;
    margin-bottom: 0.5rem;
    /* font-weight: bold; */
    font-weight: 500 !important;
    line-height: 1.4;
    cursor: text;
    color: var(--title-color);
    font-family: var(--font-sans-serif);
}

h1:hover a.anchor,
h2:hover a.anchor,
h3:hover a.anchor,
h4:hover a.anchor,
h5:hover a.anchor,
h6:hover a.anchor {
    text-decoration: none;
}

h1 tt,
h1 code {
    font-size: inherit !important;
}
h2 tt,
h2 code {
    font-size: inherit !important;
}
h3 tt,
h3 code {
    font-size: inherit !important;
}
h4 tt,
h4 code {
    font-size: inherit !important;
}
h5 tt,
h5 code {
    font-size: inherit !important;
}
h6 tt,
h6 code {
    font-size: inherit !important;
}


h1 {
    padding-bottom: .4rem;
    font-size: 2.2rem;
    line-height: 1.3;
}
h1 {
    text-align: center;
    padding-bottom: 0.3em;
    font-size: 2.2em;
    line-height: 1.2;
    margin: 2.4em auto 1.2em;
}
h1:after {
    content: '';
    display: block;
    margin: 0.2em auto 0;
    width: 100px;
    height: 2px;
    border-bottom: 2px solid var(--title-color);
}

h2 {
    margin: 1.6em auto 0.5em;
    padding-left: 10px;
    line-height: 1.4;
    font-size: 1.8em;
    border-left: 9px solid var(--title-color);
    border-bottom: 1px solid var(--title-color);
}
h3 {
    font-size: 1.5rem;
    margin: 1.2em auto 0.5em;
}
h4 {
    font-size: 1.3rem;
}
h5 {
    font-size: 1.2rem;
}
h6 {
    font-size: 1.1rem;
}

p,
blockquote,
ul,
ol,
dl,
table {
    margin: 0.8em 0;
}

li > ol,
li > ul {
    margin: 0 0;
}

hr {
    height: 2px;
    padding: 0;
    margin: 16px 0;
    background-color: #e7e7e7;
    border: 0 none;
    overflow: hidden;
    box-sizing: content-box;
}

body > h2:first-child {
    margin-top: 0;
    padding-top: 0;
}

body > h1:first-child {
    margin-top: 0;
    padding-top: 0;
}

body > h1:first-child + h2 {
    margin-top: 0;
    padding-top: 0;
}

body > h3:first-child,
body > h4:first-child,
body > h5:first-child,
body > h6:first-child {
    margin-top: 0;
    padding-top: 0;
}

a:first-child h1,
a:first-child h2,
a:first-child h3,
a:first-child h4,
a:first-child h5,
a:first-child h6 {
    margin-top: 0;
    padding-top: 0;
}

h1 p,
h2 p,
h3 p,
h4 p,
h5 p,
h6 p {
    margin-top: 0;
}

li p.first {
    display: inline-block;
}

ul,
ol {
    padding-left: 30px;
}

ul:first-child,
ol:first-child {
    margin-top: 0;
}

ul:last-child,
ol:last-child {
    margin-bottom: 0;
}

/* å¼•ç”¨ */
blockquote {
    /* margin-left: 1rem; */
    border-left: 4px solid var(--purple-light-4);
    padding: 10px 15px;
    color: #777;
    background-color: var(--purple-light-1);
}

/* è¡¨æ ¼ */
table {
    padding: 0;
    word-break: initial;
}

table tr {
    border-top: 1px solid #dfe2e5;
    margin: 0;
    padding: 0;
}

/* è¡¨æ ¼ èƒŒæ™¯è‰² */
table tr:nth-child(2n),
thead {
    background-color: var(--purple-light-1);
}
#write table thead th {
    background-color: var(--purple-light-2);
}

table tr th {
    font-weight: bold;
    border: 1px solid #dfe2e5;
    border-bottom: 0;
    text-align: left;
    margin: 0;
    padding: 6px 13px;
}

table tr td {
    border: 1px solid #dfe2e5;
    text-align: left;
    margin: 0;
    padding: 6px 13px;
}

table tr th:first-child,
table tr td:first-child {
    margin-top: 0;
}

table tr th:last-child,
table tr td:last-child {
    margin-bottom: 0;
}

/* ç²—ä½“ */
#write strong {
    padding: 0 2px;
    color: var(--purple-1);
}

/* æ–œä½“ */
#write em {
    padding: 0 5px 0 2px;
    /* font-style: normal; */
    color: #42b983;
}

/* inline code */
#write code, tt {
    padding: 2px 4px;
    border-radius: 2px;
    font-family: var(--font-monospace);
    font-size: 0.92rem;
    color: var(--purple-3); 
    background-color: rgba(99, 99, 172, .05);
}

tt {
    margin: 0 2px;
}

#write .md-footnote {
    background-color: #f8f8f8;
    color: var(--purple-3);
}

/* heighlight. */
#write mark {
    background-color: #fbd3ea;
    border-radius: 2px;
    padding: 2px 4px;
    margin: 0 2px;
}

#write del {
    padding: 1px 2px;
}

.md-task-list-item > input {
    margin-left: -1.3em;
}

@media print {
    html {
        font-size: 0.9rem;
    }

    table,
    pre {
        page-break-inside: avoid;
    }

    pre {
        word-wrap: break-word;
    }
}

#write pre.md-meta-block {
    padding: 1rem;
    font-size: 85%;
    line-height: 1.45;
    background-color: #f7f7f7;
    border: 0;
    border-radius: 3px;
    color: #777777;
    margin-top: 0 !important;
}

.mathjax-block > .code-tooltip {
    bottom: .375rem;
}

/* å›¾ç‰‡ */
.md-image > .md-meta {
    border-radius: 3px;
    font-family: var(--font-monospace);
    padding: 2px 0 0 4px;
    font-size: 0.9em;
    color: inherit;
}
p .md-image:only-child{
    width: auto;
    text-align: left;
    margin-left: 2rem;
}
.md-tag {
    color: inherit;
}
/* å½“ â€œ![shadow-éšä¾¿å†™]()â€å†™æ—¶ï¼Œä¼šæœ‰é˜´å½± */
.md-image img[alt|='shadow'] {
    /* box-shadow: 0 4px 24px -6px #ddd; */
    box-shadow:var(--purple-light-2) 0px 10px 15px;
}

#write a.md-toc-inner {
    line-height: 1.6;
    white-space: pre-line;
    border-bottom: none;
    font-size: 0.9rem;
}

#typora-quick-open {
    border: 1px solid #ddd;
    background-color: #f8f8f8;
}

#typora-quick-open-item {
    background-color: #FAFAFA;
    border-color: #FEFEFE #e5e5e5 #e5e5e5 #eee;
    border-style: solid;
    border-width: 1px;
}

#md-notification:before {
    top: 10px;
}

header,
.context-menu,
.megamenu-content,
footer {
    font-family: var(--font-sans-serif);
}

.file-node-content:hover .file-node-icon,
.file-node-content:hover .file-node-open-state {
    visibility: visible;
}

.md-lang {
    color: #b4654d;
}

.html-for-mac .context-menu {
    --item-hover-bg-color: #E6F0FE;
}

/* ä»£ç æ¡† */
/* CodeMirror 3024 Day theme */

/* ä»£ç æ®µ èƒŒæ™¯ */
pre {
    --select-text-bg-color: rgba(223, 197, 223) !important;
    margin: .5em 0;
    padding: 1em 1.4em;
    border-radius: 8px;
    background: #f6f8fa;
    overflow-x: auto;
    box-sizing: border-box;
    font-size: 14px;
}

/* è¾¹æ¡† */
.md-fences {
    border: 1px solid #e7eaed;
    border-radius: 3px;
}

.cm-s-inner {
  padding: .25rem;
  border-radius: .25rem;
}

.cm-s-inner.CodeMirror, .cm-s-inner .CodeMirror-gutters {
  background-color: #f8f8f8 !important;
  color: #3a3432 !important;
  border: none;
}

.cm-s-inner .CodeMirror-gutters {
  color: #6d8a88;
}

.cm-s-inner .CodeMirror-cursor {
  border-left: solid thin #5c5855 !important;
}

.cm-s-inner .CodeMirror-linenumber {
  color: #807d7c;
}

.cm-s-inner .CodeMirror-line::selection, .cm-s-inner .CodeMirror-line::-moz-selection,
.cm-s-inner .CodeMirror-line > span::selection,
.cm-s-inner .CodeMirror-line > span::-moz-selection,
.cm-s-inner .CodeMirror-line > span > span::selection,
.cm-s-inner .CodeMirror-line > span > span::-moz-selection {
  background: var(--purple-light-2);
}

.cm-s-inner span.cm-comment {
  color: #cdab53;
}

.cm-s-inner span.cm-string, .cm-s-inner span.cm-string-2 {
  color: #f2b01d;
}

.cm-s-inner span.cm-number {
  color: #a34e8f;
}

.cm-s-inner span.cm-variable {
  color: #01a252;
}

.cm-s-inner span.cm-variable-2 {
  color: #01a0e4;
}

.cm-s-inner span.cm-def {
  /* color: #e8bbd0; */
  color: #e2287f;
}

.cm-s-inner span.cm-operator {
  color: #ff79c6;
}

.cm-s-inner span.cm-keyword {
  color: #db2d20;
}

.cm-s-inner span.cm-atom {
  color: #a34e8f;
}

.cm-s-inner span.cm-meta {
  color: inherit;
}

.cm-s-inner span.cm-tag {
  color: #db2d20;
}

.cm-s-inner span.cm-attribute {
  color: #01a252;
}

.cm-s-inner span.cm-qualifier {
  color: #388aa3;
}

.cm-s-inner span.cm-property {
  color: #01a252;
}

.cm-s-inner span.cm-builtin {
  color: #388aa3;
}

.cm-s-inner span.cm-variable-3, .cm-s-inner span.cm-type {
  color: #ffb86c;
}

.cm-s-inner span.cm-bracket {
  color: #3a3432;
}

.cm-s-inner span.cm-link {
  color: #a34e8f;
}

.cm-s-inner span.cm-error {
  background: #db2d20;
  color: #5c5855;
}

/* .md-fences.md-focus .cm-s-inner .CodeMirror-activeline-background {
  background: var(--purple-light-2);
} */

.cm-s-inner .CodeMirror-matchingbracket {
  text-decoration: underline;
  color: #a34e8f !important;
}

#fences-auto-suggest .active {
  background: #ddd;
}

#write .code-tooltip {
  bottom: initial;
  top: calc(100% - 1px);
  background: #f7f7f7;
  border: 1px solid #ddd;
  border-top: 0;
}

.auto-suggest-container {
  border-color: #b4b4b4;
}

.auto-suggest-container .autoComplt-hint.active {
  background: #b4b4b4;
  color: inherit;
}

/* task list */
#write .md-task-list-item > input {
  -webkit-appearance: initial;
  display: block;
  position: absolute;
  border: 1px solid #b4b4b4;
  border-radius: .25rem;
  margin-top: .1rem;
  margin-left: -1.8rem;
  height: 1.2rem;
  width: 1.2rem;
  transition: background 0.3s;
}

#write .md-task-list-item > input:focus {
  outline: none;
  box-shadow: none;
}

#write .md-task-list-item > input:hover {
  background: #ddd;
}

#write .md-task-list-item > input[checked]::before {
  content: '';
  position: absolute;
  top: 20%;
  left: 50%;
  height: 60%;
  width: 2px;
  transform: rotate(40deg);
  background: #333;
}

#write .md-task-list-item > input[checked]::after {
  content: '';
  position: absolute;
  top: 46%;
  left: 25%;
  height: 30%;
  width: 2px;
  transform: rotate(-40deg);
  background: #333;
}

#write .md-task-list-item > p {
  transition: color 0.3s, opacity 0.3s;
}

#write .md-task-list-item.task-list-done > p {
  color: #b4b4b4;
  text-decoration: line-through;
}

#write .md-task-list-item.task-list-done > p > .md-emoji {
  opacity: .5;
}

#write .md-task-list-item.task-list-done > p > .md-link > a {
  opacity: .6;
}

/* sidebar and outline */
.pin-outline .outline-active {
  color: var(--active-file-text-color); 
}

.file-list-item {
    border-bottom: 1px solid;
    border-color: var(--purple-light-5);
}

.file-list-item-summary {
    font-weight: 400;
}

.file-list-item.active {
    color: var(--active-file-text-color);
    background-color: var(--purple-light-5);
}

.file-tree-node.active>.file-node-background {
    background-color: var(--purple-light-5);
    font-weight: 700;
} 

.file-tree-node.active>.file-node-content {
    color: var(--active-file-text-color);
    font-weight: 700;
}

.file-node-content {
    color: #5e676d;
}

.sidebar-tabs {
    border-bottom: none;
}
.sidebar-tab.active {
    font-weight: 400;
}

.sidebar-content-content {
    font-size: 0.9rem;
}

img {
    max-width: 100%;
}

body {
    background-color: rgb(237, 237, 237);
}
#content {
    width: 836px;
    padding: 50px;
    background: #fff;
    margin: 0 auto;
}/*# sourceURL=/Users/young/Documents/Codes/Fun/lagou/public/purple.css*/</style><style type="text/css">.hljs{display:block;overflow-x:auto;padding:.5em;color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}/*# sourceURL=/Users/young/Documents/Codes/Fun/lagou/public/atom-one-light.min.css*/</style></head>
<body>
<div id="content"><h1>V18ç‰¹æ€§ç¯‡-useMutableSourceï¼ˆå·²è¢«å–ç¼”ï¼‰</h1>
<h2>ä¸€ å‰è¨€</h2>
<p><code>useMutableSource</code> æœ€æ—©çš„ <a href="https://github.com/reactjs/rfcs/blob/main/text/0147-use-mutable-source.md" target="_blank" rel="nofollow noopener noreferrer">RFC</a> ææ¡ˆåœ¨ 2020å¹´ 2 æœˆä»½å°±å¼€å§‹äº†ã€‚åœ¨ React 18 ä¸­å®ƒå°†ä½œä¸ºæ–°ç‰¹æ€§å‡ºç°ã€‚ç”¨ä¸€æ®µææ¡ˆä¸­çš„æè¿°æ¥æ¦‚æ‹¬ <code>useMutableSource</code>ã€‚</p>
<blockquote>
<p>useMutableSource èƒ½å¤Ÿè®© React ç»„ä»¶åœ¨ Concurrent Mode æ¨¡å¼ä¸‹å®‰å…¨åœ°æœ‰æ•ˆåœ°è¯»å–å¤–æ¥æ•°æ®æºï¼Œåœ¨ç»„ä»¶æ¸²æŸ“è¿‡ç¨‹ä¸­èƒ½å¤Ÿæ£€æµ‹åˆ°å˜åŒ–ï¼Œå¹¶ä¸”åœ¨æ•°æ®æºå‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œèƒ½å¤Ÿè°ƒåº¦æ›´æ–°ã€‚</p>
</blockquote>
<p>è¯´èµ·å¤–éƒ¨æ•°æ®æºå°±è¦ä» state å’Œæ›´æ–°è¯´èµ· ï¼Œæ— è®ºæ˜¯ React è¿˜æ˜¯ Vue è¿™ç§ä¼ ç»Ÿ UI æ¡†æ¶ä¸­ï¼Œè™½ç„¶å®ƒä»¬éƒ½é‡‡ç”¨è™šæ‹Ÿ DOM æ–¹å¼ï¼Œä½†æ˜¯è¿˜æ˜¯ä¸èƒ½å¤ŸæŠŠæ›´æ–°å•å…ƒå§”æ‰˜åˆ°è™šæ‹Ÿ DOM èº«ä¸Šæ¥ï¼Œæ‰€ä»¥æ›´æ–°çš„æœ€å°ç²’åº¦è¿˜æ˜¯åœ¨ç»„ä»¶å±‚é¢ä¸Šï¼Œç”±ç»„ä»¶ç»Ÿä¸€ç®¡ç†æ•°æ® stateï¼Œå¹¶å‚ä¸è°ƒåº¦æ›´æ–°ã€‚</p>
<p>å›åˆ°æˆ‘ä»¬çš„ä¸»è§’ React ä¸Šï¼Œæ—¢ç„¶ç”±ç»„ä»¶ component ç®¡æ§ç€çŠ¶æ€ stateã€‚é‚£ä¹ˆåœ¨ v17 å’Œä¹‹å‰çš„ç‰ˆæœ¬ï¼ŒReact æƒ³è¦è§†å›¾ä¸Šçš„æ›´æ–°ï¼Œé‚£ä¹ˆåªèƒ½é€šè¿‡æ›´æ”¹å†…éƒ¨æ•°æ® state ã€‚çºµè§ˆ React çš„å‡ ç§æ›´æ–°æ–¹å¼ï¼Œæ— ä¸€ç¦»ä¸å¼€è‡ªèº« state ã€‚å…ˆæ¥çœ‹ä¸€ä¸‹ React çš„å‡ ç§æ›´æ–°æ¨¡å¼ã€‚</p>
<ul>
<li>ç»„ä»¶æœ¬èº«æ”¹å˜ state ã€‚å‡½æ•° <code>useState</code> | <code>useReducer</code> ï¼Œç±»ç»„ä»¶ <code>setState</code> | <code>forceUpdate</code> ã€‚</li>
<li><code>props</code> æ”¹å˜ï¼Œç”±ç»„ä»¶æ›´æ–°å¸¦æ¥çš„å­ç»„ä»¶çš„æ›´æ–°ã€‚</li>
<li><code>context</code> æ›´æ–°ï¼Œå¹¶ä¸”è¯¥ç»„ä»¶æ¶ˆè´¹äº†å½“å‰ <code>context</code> ã€‚</li>
</ul>
<p>æ— è®ºæ˜¯ä¸Šé¢å“ªç§æ–¹å¼ï¼Œæœ¬è´¨ä¸Šéƒ½æ˜¯ state çš„å˜åŒ–ã€‚</p>
<ul>
<li><code>props</code> æ”¹å˜æ¥æºäºçˆ¶çº§ç»„ä»¶çš„ <code>state</code> å˜åŒ–ã€‚</li>
<li><code>context</code> å˜åŒ–æ¥æºäº Provider ä¸­ value å˜åŒ–ï¼Œè€Œ value ä¸€èˆ¬æƒ…å†µä¸‹ä¹Ÿæ˜¯ state æˆ–è€…æ˜¯ state è¡ç”Ÿäº§ç‰©ã€‚</li>
</ul>
<p>ä»ä¸Šé¢å¯ä»¥æ¦‚æ‹¬å‡ºï¼šstateå’Œè§†å›¾æ›´æ–°çš„å…³ç³» <code>Model</code> => <code>View</code> ã€‚ä½†æ˜¯ state ä»…é™äºç»„ä»¶å†…éƒ¨çš„æ•°æ®ï¼Œå¦‚æœ state æ¥æºäºå¤–éƒ¨ï¼ˆè„±ç¦»ç»„ä»¶å±‚é¢ï¼‰ã€‚é‚£ä¹ˆå¦‚ä½•å®Œæˆå¤–éƒ¨æ•°æ®æºè½¬æ¢æˆå†…éƒ¨çŠ¶æ€ï¼Œ å¹¶ä¸”æ•°æ®æºå˜åŒ–ï¼Œç»„ä»¶é‡æ–° render å‘¢ï¼Ÿ</p>
<p>å¸¸è§„æ¨¡å¼ä¸‹ï¼Œå…ˆæŠŠå¤–éƒ¨æ•°æ® external Data é€šè¿‡ selector é€‰æ‹©å™¨æŠŠç»„ä»¶éœ€è¦çš„æ•°æ®æ˜ å°„åˆ° state | props ä¸Šã€‚è¿™ç®—æ˜¯å®Œæˆäº†ä¸€æ­¥ï¼Œæ¥ä¸‹æ¥è¿˜éœ€è¦ subscribe è®¢é˜…å¤–éƒ¨æ•°æ®æºçš„å˜åŒ–ï¼Œå¦‚æœå‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆè¿˜éœ€è¦è‡ªèº«å»å¼ºåˆ¶æ›´æ–° forceUpdate ã€‚ä¸‹é¢ä¸¤å¹…å›¾è¡¨ç¤ºæ•°æ®æ³¨å…¥å’Œæ•°æ®è®¢é˜…æ›´æ–°ã€‚</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0734aca032e046d58d9c263b6d3d5cb3~tplv-k3u1fbpfcp-watermark.image?" alt="1.jpg"></p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dd8b70d275ad4f8aa84f18f4029960ea~tplv-k3u1fbpfcp-watermark.image?" alt="2.jpg"></p>
<p>å…¸å‹çš„å¤–éƒ¨æ•°æ®æºå°±æ˜¯ redux ä¸­çš„ store ï¼Œredux æ˜¯å¦‚ä½•æŠŠ Store ä¸­çš„ state ï¼Œå®‰å…¨çš„å˜æˆç»„ä»¶çš„ state çš„ã€‚</p>
<p>æˆ–è®¸æˆ‘å¯ä»¥ç”¨ä¸€æ®µä»£ç æ¥è¡¨ç¤ºä» react-redux ä¸­ state æ”¹å˜åˆ°è§†å›¾æ›´æ–°çš„æµç¨‹ã€‚</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> store = createStore(reducer,initState)

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">App</span>(<span class="hljs-params">{ selector }</span>)</span>{
    <span class="hljs-keyword">const</span> [ state , setReduxState ] = React.useState({})
    <span class="hljs-keyword">const</span> contextValue = useMemo(<span class="hljs-function">()=></span>{
        <span class="hljs-comment">/* è®¢é˜… store å˜åŒ– */</span>
        store.subscribe(<span class="hljs-function">()=></span>{
             <span class="hljs-comment">/* ç”¨é€‰æ‹©å™¨é€‰æ‹©è®¢é˜… state */</span>
             <span class="hljs-keyword">const</span> value = selector(data.getState())
             <span class="hljs-comment">/* å¦‚æœå‘ç”Ÿå˜åŒ–  */</span>
             <span class="hljs-keyword">if</span>(ifHasChange(state,value)){
                 setReduxState(value)
             }
        })
    },[ store ])    
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&#x3C;<span class="hljs-name">div</span>></span>...<span class="hljs-tag">&#x3C;/<span class="hljs-name">div</span>></span></span>
}
</code></pre>
<p>ä½†æ˜¯ä¾‹å­ä¸­ä»£ç ï¼Œæ²¡æœ‰å®é™…æ„ä¹‰ï¼Œä¹Ÿä¸æ˜¯æºä»£ç ï¼Œæˆ‘è¿™é‡Œå°±æ˜¯è®©å¤§å®¶æ¸…æ™°åœ°äº†è§£æµç¨‹ã€‚redux å’Œ react æœ¬è´¨ä¸Šæ˜¯è¿™æ ·å·¥ä½œçš„ã€‚</p>
<ul>
<li>é€šè¿‡ store.subscribe æ¥è®¢é˜… state å˜åŒ–ï¼Œä½†æ˜¯æœ¬è´¨ä¸Šè¦æ¯”ä»£ç ç‰‡æ®µä¸­å¤æ‚çš„å¤šï¼Œé€šè¿‡ selector ï¼ˆé€‰æ‹©å™¨ï¼‰æ‰¾åˆ°ç»„ä»¶éœ€è¦çš„ stateã€‚ æˆ‘åœ¨è¿™é‡Œå…ˆè§£é‡Šä¸€ä¸‹<strong>selector</strong>ï¼Œå› ä¸ºåœ¨ä¸šåŠ¡ç»„ä»¶å¾€å¾€ä¸éœ€è¦æ•´ä¸ª store ä¸­çš„ state å…¨éƒ¨æ•°æ®ï¼Œè€Œæ˜¯ä»…ä»…éœ€è¦ä¸‹é¢çš„éƒ¨åˆ†çŠ¶æ€ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦ä» state ä¸­é€‰æ‹©â€˜æœ‰ç”¨çš„â€™ï¼Œå¹¶ä¸”å’Œ props åˆå¹¶ï¼Œç»†å¿ƒçš„åŒå­¦åº”è¯¥å‘ç°ï¼Œé€‰æ‹©å™¨éœ€è¦å’Œ <code>react-redux</code> ä¸­ connect ç¬¬ä¸€å‚æ•° mapStateToProps è”åŠ¨ã€‚å¯¹äºç»†èŠ‚ï¼Œæ— å…³ç´§è¦ï¼Œå› ä¸ºä»Šå¤©é‡ç‚¹æ˜¯ <code>useMutableSource</code>ã€‚</li>
</ul>
<p>å¦‚ä¸Šæ˜¯æ²¡æœ‰ <code>useMutableSource</code> çš„æƒ…å†µï¼Œç°åœ¨ç”¨ useMutableSource ä¸åœ¨éœ€è¦æŠŠè®¢é˜…åˆ°æ›´æ–°æµç¨‹äº¤ç»™ç»„ä»¶å¤„ç†ã€‚å¦‚ä¸‹ï¼š</p>
<pre><code class="hljs language-js"><span class="hljs-comment">/* åˆ›å»º store */</span>
<span class="hljs-keyword">const</span> store = createStore(reducer,initState)
<span class="hljs-comment">/* åˆ›å»ºå¤–éƒ¨æ•°æ®æºÂ */</span>
<span class="hljs-keyword">const</span> externalDataSource = createMutableSource( store ,store.getState() )
<span class="hljs-comment">/* è®¢é˜…æ›´æ–° */</span>
<span class="hljs-keyword">const</span> subscribe = <span class="hljs-function">(<span class="hljs-params">store, callback</span>) =></span> store.subscribe(callback);
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">App</span>(<span class="hljs-params">{ selector }</span>)</span>{
    <span class="hljs-comment">/* è®¢é˜…çš„ state å‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆç»„ä»¶ä¼šæ›´æ–° */</span>
    <span class="hljs-keyword">const</span> state = useMutableSource(externalDataSource,selector,subscribe)
}
</code></pre>
<ul>
<li>é€šè¿‡ createMutableSource åˆ›å»ºå¤–éƒ¨æ•°æ®æºï¼Œé€šè¿‡ useMutableSource æ¥ä½¿ç”¨å¤–éƒ¨æ•°æ®æºã€‚å¤–éƒ¨æ•°æ®æºå˜åŒ–ï¼Œç»„ä»¶è‡ªåŠ¨æ¸²æŸ“ã€‚</li>
</ul>
<p>å¦‚ä¸Šæ˜¯é€šè¿‡ useMutableSource å®ç°çš„è®¢é˜…æ›´æ–°ï¼Œè¿™æ ·å‡å°‘äº† APP å†…éƒ¨ç»„ä»¶ä»£ç ï¼Œä»£ç å¥å£®æ€§æå‡ï¼Œä¸€å®šç¨‹åº¦ä¸Šä¹Ÿé™ä½äº†è€¦åˆã€‚æ¥ä¸‹æ¥è®©æˆ‘ä»¬å…¨æ–¹é¢è®¤è¯†ä¸€ä¸‹è¿™ä¸ª V18 çš„æ–°ç‰¹æ€§ã€‚</p>
<h2>äºŒ åŠŸèƒ½ä»‹ç»</h2>
<p>å…·ä½“åŠŸèƒ½ä»‹ç»æµç¨‹è¿˜æ˜¯å‚è€ƒæœ€æ–°çš„ RFCï¼Œ createMutableSource å’Œ useMutableSource åœ¨ä¸€å®šçš„ç¨‹åº¦ä¸Šï¼Œæœ‰ç‚¹åƒ <code>createContext</code> å’Œ <code>useContext</code> ï¼Œè§åçŸ¥æ„ï¼Œå°±æ˜¯<strong>åˆ›å»º</strong>ä¸<strong>ä½¿ç”¨</strong>ã€‚ä¸åŒçš„æ˜¯ context éœ€è¦ <code>Provider</code> å»æ³¨å…¥å†…éƒ¨çŠ¶æ€ï¼Œè€Œä»Šå¤©çš„ä¸»è§’æ˜¯æ³¨å…¥å¤–éƒ¨çŠ¶æ€ã€‚é‚£ä¹ˆé¦–å…ˆåº”è¯¥çœ‹ä¸€ä¸‹ä¸¤è€…å¦‚ä½•ä½¿ç”¨ã€‚</p>
<h3>åˆ›å»º</h3>
<p>createMutableSource åˆ›å»ºä¸€ä¸ªæ•°æ®æºã€‚å®ƒæœ‰ä¸¤ä¸ªå‚æ•°ï¼š</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> externalDataSource = createMutableSource( store ,store.getState() ) 
</code></pre>
<ul>
<li>ç¬¬ä¸€ä¸ªå‚æ•°ï¼šå°±æ˜¯å¤–éƒ¨çš„æ•°æ®æºï¼Œæ¯”å¦‚ redux ä¸­çš„ store,</li>
<li>ç¬¬äºŒä¸ªå‚æ•°ï¼šä¸€ä¸ªå‡½æ•°ï¼Œå‡½æ•°çš„è¿”å›å€¼ä½œä¸ºæ•°æ®æºçš„ç‰ˆæœ¬å·ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„âš ï¸çš„æ˜¯ï¼Œè¦ä¿æŒæ•°æ®æºå’Œæ•°æ®ç‰ˆæœ¬å·çš„ä¸€è‡´æ€§ï¼Œå°±æ˜¯æ•°æ®æºå˜åŒ–äº†ï¼Œé‚£ä¹ˆæ•°æ®ç‰ˆæœ¬å·å°±è¦å˜åŒ–ï¼Œä¸€å®šç¨‹åº¦ä¸Šéµå¾ª <code>immutable</code> åŸåˆ™ï¼ˆä¸å¯å˜æ€§ï¼‰ã€‚å¯ä»¥ç†è§£ä¸ºæ•°æ®ç‰ˆæœ¬å·æ˜¯è¯æ˜æ•°æ®æºå”¯ä¸€æ€§çš„æ ‡ç¤ºã€‚</li>
</ul>
<h3>apiä»‹ç»</h3>
<p>useMutableSource å¯ä»¥ä½¿ç”¨éä¼ ç»Ÿçš„æ•°æ®æºã€‚å®ƒçš„åŠŸèƒ½å’Œ Context API  è¿˜æœ‰ <a href="https://www.npmjs.com/package/use-subscription" target="_blank" rel="nofollow noopener noreferrer">useSubscription</a> ç±»ä¼¼ã€‚ï¼ˆæ²¡æœ‰ä½¿ç”¨è¿‡ useSubscription çš„åŒå­¦ï¼Œå¯ä»¥äº†è§£ä¸€ä¸‹ ï¼‰ã€‚</p>
<p>å…ˆæ¥çœ‹ä¸€ä¸‹ useMutableSource çš„åŸºæœ¬ä½¿ç”¨ï¼š</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> value = useMutableSource(source,getSnapShot,subscribe)
</code></pre>
<p>useMutableSource æ˜¯ä¸€ä¸ª hooks ï¼Œå®ƒæœ‰ä¸‰ä¸ªå‚æ•°ï¼š</p>
<ul>
<li><code>sourceï¼šMutableSource &#x3C; Source ></code> å¯ä»¥ç†è§£ä¸ºå¸¦è®°å¿†çš„æ•°æ®æºå¯¹è±¡ã€‚</li>
<li><code>getSnapshotï¼š( source : Source ) => Snapshot</code> ï¼šä¸€ä¸ªå‡½æ•°ï¼Œæ•°æ®æºä½œä¸ºå‡½æ•°çš„å‚æ•°ï¼Œè·å–å¿«ç…§ä¿¡æ¯ï¼Œå¯ä»¥ç†è§£ä¸º <code>selector</code> ï¼ŒæŠŠå¤–éƒ¨çš„æ•°æ®æºçš„æ•°æ®è¿‡æ»¤ï¼Œæ‰¾å‡ºæƒ³è¦çš„æ•°æ®æºã€‚</li>
<li><code>subscribe: (source: Source, callback: () => void) => () => void</code>ï¼šè®¢é˜…å‡½æ•°ï¼Œæœ‰ä¸¤ä¸ªå‚æ•°ï¼ŒSource å¯ä»¥ç†è§£ä¸º useMutableSource ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œcallback å¯ä»¥ç†è§£ä¸º useMutableSource ç¬¬äºŒä¸ªå‚æ•°ï¼Œå½“æ•°æ®æºå˜åŒ–çš„æ—¶å€™ï¼Œæ‰§è¡Œå¿«ç…§ï¼Œè·å–æ–°çš„æ•°æ®ã€‚</li>
</ul>
<p><strong>useMutableSource ç‰¹ç‚¹</strong></p>
<p>useMutableSource å’Œ useSubscription åŠŸèƒ½ç±»ä¼¼ï¼š</p>
<ul>
<li>ä¸¤è€…éƒ½éœ€è¦å¸¦æœ‰è®°å¿†åŒ–çš„â€˜é…ç½®åŒ–å¯¹è±¡â€™ï¼Œä»è€Œä»å¤–éƒ¨å–å€¼ã€‚</li>
<li>ä¸¤è€…éƒ½éœ€è¦ä¸€ç§è®¢é˜…å’Œå–æ¶ˆè®¢é˜…æºçš„æ–¹æ³• <code>subscribe</code>ã€‚</li>
</ul>
<p>é™¤æ­¤ä¹‹å¤– useMutableSource è¿˜æœ‰ä¸€äº›ç‰¹ç‚¹ï¼š</p>
<ul>
<li>useMutableSource éœ€è¦æºä½œä¸ºæ˜¾å¼å‚æ•°ã€‚ä¹Ÿå°±æ˜¯éœ€è¦æŠŠæ•°æ®æºå¯¹è±¡ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ä¼ å…¥ã€‚</li>
<li>useMutableSource ç”¨ getSnapshot è¯»å–çš„æ•°æ®ï¼Œæ˜¯ä¸å¯å˜çš„ã€‚</li>
</ul>
<p><strong>å…³äº MutableSource ç‰ˆæœ¬å·</strong> <br>
<code>useMutableSource</code> ä¼šè¿½è¸ª MutableSource çš„ç‰ˆæœ¬å·ï¼Œç„¶åè¯»å–æ•°æ®ï¼Œæ‰€ä»¥å¦‚æœä¸¤è€…ä¸ä¸€è‡´ï¼Œå¯èƒ½ä¼šé€ æˆè¯»å–å¼‚å¸¸çš„æƒ…å†µã€‚useMutableSource ä¼šæ£€æŸ¥ç‰ˆæœ¬å·ï¼š</p>
<ul>
<li>åœ¨ç¬¬ä¸€æ¬¡ç»„ä»¶æŒ‚è½½çš„æ—¶å€™ï¼Œè¯»å–ç‰ˆæœ¬å·ã€‚</li>
<li>åœ¨ç»„ä»¶ rerender çš„æ—¶å€™ï¼Œç¡®ä¿ç‰ˆæœ¬å·ä¸€è‡´ï¼Œç„¶ååœ¨è¯»å–æ•°æ®ã€‚ä¸ç„¶ä¼šé€ æˆé”™è¯¯å‘ç”Ÿã€‚</li>
<li>ç¡®ä¿æ•°æ®æºå’Œç‰ˆæœ¬å·çš„ä¸€è‡´æ€§ã€‚</li>
</ul>
<p><strong>è®¾è®¡è§„èŒƒ</strong></p>
<p>å½“é€šè¿‡ getSnapshot è¯»å–å¤–éƒ¨æ•°æ®æºçš„æ—¶å€™ï¼Œè¿”å›çš„ value åº”è¯¥æ˜¯ä¸å¯å˜çš„ã€‚</p>
<ul>
<li>âœ… æ­£ç¡®å†™æ³•ï¼šgetSnapshot: source => Array.from(source.friendIDs)</li>
<li>âŒ é”™è¯¯å†™æ³•ï¼šgetSnapshot: source => source.friendIDs</li>
</ul>
<p>æ•°æ®æºå¿…é¡»æœ‰ä¸€ä¸ªå…¨å±€çš„ç‰ˆæœ¬å·ï¼Œè¿™ä¸ªç‰ˆæœ¬å·ä»£è¡¨æ•´ä¸ªæ•°æ®æºï¼š</p>
<ul>
<li>âœ… æ­£ç¡®å†™æ³•ï¼šgetVersion: () => source.version</li>
<li>âŒ é”™è¯¯å†™æ³•ï¼šgetVersion: () => source.user.version</li>
</ul>
<p>æ¥ä¸‹æ¥å‚è€ƒ github ä¸Šçš„ä¾‹å­ï¼Œæˆ‘è®²ä¸€ä¸‹å…·ä½“æ€ä¹ˆä½¿ç”¨ï¼š</p>
<h3>ä¾‹å­ä¸€</h3>
<p><strong>ä¾‹å­ä¸€ï¼šè®¢é˜… history æ¨¡å¼ä¸‹è·¯ç”±å˜åŒ–</strong></p>
<p>æ¯”å¦‚æœ‰ä¸€ä¸ªåœºæ™¯å°±æ˜¯åœ¨éäººä¸ºæƒ…å†µä¸‹ï¼Œè®¢é˜…è·¯ç”±å˜åŒ–ï¼Œå±•ç¤ºå¯¹åº”çš„ <code>location.pathname</code>ï¼Œçœ‹ä¸€ä¸‹æ˜¯å¦‚ä½•ä½¿ç”¨ useMutableSource å¤„ç†çš„ã€‚åœ¨è¿™ç§åœºæ™¯ä¸‹ï¼Œå¤–éƒ¨æ•°æ®æºå°±æ˜¯ location ä¿¡æ¯ã€‚</p>
<pre><code class="hljs language-js"><span class="hljs-comment">// é€šè¿‡ createMutableSource åˆ›å»ºä¸€ä¸ªå¤–éƒ¨æ•°æ®æºã€‚</span>
<span class="hljs-comment">// æ•°æ®æºå¯¹è±¡ä¸º windowã€‚</span>
<span class="hljs-comment">// ç”¨ location.href ä½œä¸ºæ•°æ®æºçš„ç‰ˆæœ¬å·ï¼Œhref å‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆè¯´æ˜æ•°æ®æºå‘ç”Ÿå˜åŒ–ã€‚</span>
<span class="hljs-keyword">const</span> locationSource = createMutableSource(
  <span class="hljs-built_in">window</span>,
  <span class="hljs-function">() =></span> <span class="hljs-built_in">window</span>.location.href
);

<span class="hljs-comment">// è·å–å¿«ç…§ä¿¡æ¯ï¼Œè¿™é‡Œè·å–çš„æ˜¯ location.pathname å­—æ®µï¼Œè¿™ä¸ªæ˜¯å¯ä»¥å¤ç”¨çš„ï¼Œå½“è·¯ç”±å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œé‚£ä¹ˆä¼šè°ƒç”¨å¿«ç…§å‡½æ•°ï¼Œæ¥å½¢æˆæ–°çš„å¿«ç…§ä¿¡æ¯ã€‚</span>
<span class="hljs-keyword">const</span> getSnapshot = <span class="hljs-function"><span class="hljs-params">window</span> =></span> <span class="hljs-built_in">window</span>.location.pathname

<span class="hljs-comment">// è®¢é˜…å‡½æ•°ã€‚</span>
<span class="hljs-keyword">const</span> subscribe = <span class="hljs-function">(<span class="hljs-params"><span class="hljs-built_in">window</span>, callback</span>) =></span> {
   <span class="hljs-comment">//é€šè¿‡ popstate ç›‘å¬ history æ¨¡å¼ä¸‹çš„è·¯ç”±å˜åŒ–ï¼Œè·¯ç”±å˜åŒ–çš„æ—¶å€™ï¼Œæ‰§è¡Œå¿«ç…§å‡½æ•°ï¼Œå¾—åˆ°æ–°çš„å¿«ç…§ä¿¡æ¯ã€‚</span>
  <span class="hljs-built_in">window</span>.addEventListener(<span class="hljs-string">"popstate"</span>, callback);
   <span class="hljs-comment">//å–æ¶ˆç›‘å¬</span>
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =></span> <span class="hljs-built_in">window</span>.removeEventListener(<span class="hljs-string">"popstate"</span>, callback);
};

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Example</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-comment">// é€šè¿‡ useMutableSourceï¼ŒæŠŠæ•°æ®æºå¯¹è±¡ï¼Œå¿«ç…§å‡½æ•°ï¼Œè®¢é˜…å‡½æ•°ä¼ å…¥ï¼Œå½¢æˆ pathNameã€‚  </span>
  <span class="hljs-keyword">const</span> pathName = useMutableSource(locationSource, getSnapshot, subscribe);

  <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>æ¥æç»˜ä¸€ä¸‹æµç¨‹ï¼š</p>
<ul>
<li>é¦–å…ˆé€šè¿‡ <code>createMutableSource</code> åˆ›å»ºä¸€ä¸ªæ•°æ®æºå¯¹è±¡ï¼Œè¯¥æ•°æ®æºå¯¹è±¡ä¸º windowã€‚ ç”¨ location.href ä½œä¸ºæ•°æ®æºçš„ç‰ˆæœ¬å·ï¼Œhref å‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆè¯´æ˜æ•°æ®æºå‘ç”Ÿå˜åŒ–ã€‚</li>
<li>è·å–å¿«ç…§ä¿¡æ¯ï¼Œè¿™é‡Œè·å–çš„æ˜¯ location.pathname å­—æ®µï¼Œè¿™ä¸ªæ˜¯å¯ä»¥å¤ç”¨çš„ï¼Œå½“è·¯ç”±å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œé‚£ä¹ˆä¼šè°ƒç”¨å¿«ç…§å‡½æ•°ï¼Œæ¥å½¢æˆæ–°çš„å¿«ç…§ä¿¡æ¯ã€‚</li>
<li>é€šè¿‡ <code>popstate</code> ç›‘å¬ <code>history</code> æ¨¡å¼ä¸‹çš„è·¯ç”±å˜åŒ–ï¼Œè·¯ç”±å˜åŒ–çš„æ—¶å€™ï¼Œæ‰§è¡Œå¿«ç…§å‡½æ•°ï¼Œå¾—åˆ°æ–°çš„å¿«ç…§ä¿¡æ¯ã€‚</li>
<li>é€šè¿‡ <code>useMutableSource</code> ï¼ŒæŠŠæ•°æ®æºå¯¹è±¡ï¼Œå¿«ç…§å‡½æ•°ï¼Œè®¢é˜…å‡½æ•°ä¼ å…¥ï¼Œå½¢æˆ <code>pathName</code> ã€‚</li>
</ul>
<p>å¯èƒ½è¿™ä¸ªä¾‹å­ğŸŒ°ï¼Œä¸è¶³ä»¥è®©ä½ æ¸…æ¥š useMutableSource çš„ä½œç”¨ï¼Œæˆ‘ä»¬å†ä¸¾ä¸€ä¸ªä¾‹å­çœ‹ä¸€ä¸‹ useMutableSource å¦‚ä½•å’Œ redux å¥‘åˆä½¿ç”¨çš„ã€‚</p>
<h3>ä¾‹å­äºŒ</h3>
<p><strong>ä¾‹å­äºŒï¼šredux ä¸­ <code>useMutableSource</code> ä½¿ç”¨</strong></p>
<p>redux å¯ä»¥é€šè¿‡ useMutableSource ç¼–å†™è‡ªå®šä¹‰ hooks â€”â€” <code>useSelector</code>ï¼ŒuseSelector å¯ä»¥è¯»å–æ•°æ®æºçš„çŠ¶æ€ï¼Œå½“æ•°æ®æºæ”¹å˜çš„æ—¶å€™ï¼Œé‡æ–°æ‰§è¡Œå¿«ç…§è·å–çŠ¶æ€ï¼Œåšåˆ°è®¢é˜…æ›´æ–°ã€‚æˆ‘ä»¬çœ‹ä¸€ä¸‹ useSelector æ˜¯å¦‚ä½•å®ç°çš„ã€‚</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> mutableSource = createMutableSource(
  reduxStore, <span class="hljs-comment">// å°† redux çš„ store ä½œä¸ºæ•°æ®æºã€‚</span>
  <span class="hljs-comment">// state æ˜¯ä¸å¯å˜çš„ï¼Œå¯ä»¥ä½œä¸ºæ•°æ®æºçš„ç‰ˆæœ¬å·</span>
  <span class="hljs-function">() =></span> reduxStore.getState()
);

<span class="hljs-comment">// é€šè¿‡åˆ›å»º context ä¿å­˜æ•°æ®æº mutableSourceã€‚</span>
<span class="hljs-keyword">const</span> MutableSourceContext = createContext(mutableSource);

<span class="hljs-comment">// è®¢é˜… store å˜åŒ–ã€‚store å˜åŒ–ï¼Œæ‰§è¡Œ getSnapshot</span>
<span class="hljs-keyword">const</span> subscribe = <span class="hljs-function">(<span class="hljs-params">store, callback</span>) =></span> store.subscribe(callback);

<span class="hljs-comment">// è‡ªå®šä¹‰ hooks useSelector å¯ä»¥åœ¨æ¯ä¸€ä¸ª connect å†…éƒ¨ä½¿ç”¨ï¼Œé€šè¿‡ useContext è·å– æ•°æ®æºå¯¹è±¡ã€‚ </span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">useSelector</span>(<span class="hljs-params">selector</span>) </span>{
  <span class="hljs-keyword">const</span> mutableSource = useContext(MutableSourceContext);
   <span class="hljs-comment">// ç”¨ useCallback è®© getSnapshot å˜æˆæœ‰è®°å¿†çš„ã€‚ </span>
  <span class="hljs-keyword">const</span> getSnapshot = useCallback(<span class="hljs-function"><span class="hljs-params">store</span> =></span> selector(store.getState()), [
    selector
  ]);
   <span class="hljs-comment">// æœ€åæœ¬è´¨ä¸Šç”¨çš„æ˜¯ useMutableSource è®¢é˜… state å˜åŒ–ã€‚  </span>
  <span class="hljs-keyword">return</span> useMutableSource(mutableSource, getSnapshot, subscribe);
}
</code></pre>
<p>å¤§è‡´æµç¨‹æ˜¯è¿™æ ·çš„ï¼š</p>
<ul>
<li>å°† redux çš„ store ä½œä¸ºæ•°æ®æºå¯¹è±¡ <code>mutableSource</code> ã€‚ state æ˜¯ä¸å¯å˜çš„ï¼Œå¯ä»¥ä½œä¸ºæ•°æ®æºçš„ç‰ˆæœ¬å·ã€‚</li>
<li>é€šè¿‡åˆ›å»º context ä¿å­˜æ•°æ®æºå¯¹è±¡ <code>mutableSource</code>ã€‚</li>
<li>å£°æ˜è®¢é˜…å‡½æ•°ï¼Œè®¢é˜… store å˜åŒ–ã€‚store å˜åŒ–ï¼Œæ‰§è¡Œ <code>getSnapshot</code> ã€‚</li>
<li>è‡ªå®šä¹‰ hooks <code>useSelector</code> å¯ä»¥åœ¨æ¯ä¸€ä¸ª connect å†…éƒ¨ä½¿ç”¨ï¼Œé€šè¿‡ useContext è·å– æ•°æ®æºå¯¹è±¡ã€‚ ç”¨ <code>useCallback</code> è®© getSnapshot å˜æˆæœ‰è®°å¿†çš„ã€‚</li>
<li>æœ€åæœ¬è´¨ä¸Šç”¨çš„æ˜¯ useMutableSource è®¢é˜…å¤–éƒ¨ state å˜åŒ–ã€‚</li>
</ul>
<p><strong>æ³¨æ„é—®é¢˜</strong> <br></p>
<ul>
<li>åœ¨åˆ›å»º getSnapshot çš„æ—¶å€™ï¼Œéœ€è¦å°† getSnapshot è®°å¿†åŒ–å¤„ç†ï¼Œå°±åƒä¸Šè¿°æµç¨‹ä¸­çš„ useCallback å¤„ç† getSnapshot ä¸€æ ·ï¼Œå¦‚æœä¸è®°å¿†å¤„ç†ï¼Œé‚£ä¹ˆä¼šè®©ç»„ä»¶é¢‘ç¹æ¸²æŸ“ã€‚</li>
<li>åœ¨æœ€æ–°çš„ react-redux æºç ä¸­ï¼Œå·²ç»ä½¿ç”¨æ–°çš„ apiï¼Œè®¢é˜…å¤–éƒ¨æ•°æ®æºï¼Œä¸è¿‡ä¸æ˜¯ <code>useMutableSource</code> è€Œæ˜¯ <code>useSyncExternalStore</code>ï¼Œå…·ä½“å› ä¸º <code>useMutableSource</code> æ²¡æœ‰æä¾›å†…ç½®çš„ selectorAPIï¼Œéœ€è¦æ¯ä¸€æ¬¡å½“é€‰æ‹©å™¨å˜åŒ–æ—¶å€™é‡æ–°è®¢é˜… storeï¼Œå¦‚æœæ²¡æœ‰ useCallback ç­‰ api è®°å¿†åŒ–å¤„ç†ï¼Œé‚£ä¹ˆå°†é‡æ–°è®¢é˜…ã€‚å…·ä½“å†…å®¹è¯·å‚è€ƒ <a href="https://github.com/reactwg/react-18/discussions/86" target="_blank" rel="nofollow noopener noreferrer">useMutableSource â†’ useSyncExternalStore</a>ã€‚</li>
</ul>
<h2>ä¸‰ å®è·µ</h2>
<p>æ¥ä¸‹æ¥æˆ‘ç”¨ä¸€ä¸ªä¾‹å­æ¥å…·ä½“å®è·µä¸€ä¸‹ <code>createMutableSource</code>ï¼Œè®©å¤§å®¶æ›´æ¸…æ™°æµç¨‹ã€‚</p>
<p>è¿™é‡Œè¿˜æ˜¯é‡‡ç”¨ redux å’Œ createMutableSource å®ç°å¤–éƒ¨æ•°æ®æºçš„å¼•ç”¨ã€‚è¿™é‡Œä½¿ç”¨çš„æ˜¯ <code>18.0.0-alpha</code> ç‰ˆæœ¬çš„ <code>react</code> å’Œ <code>react-dom</code> ã€‚</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a000b3baac184fe9903700ad51e03be7~tplv-k3u1fbpfcp-watermark.image?" alt="3.jpg"></p>
<pre><code class="hljs language-js"><span class="hljs-keyword">import</span>  React , {
    unstable_useMutableSource <span class="hljs-keyword">as</span> useMutableSource,
    unstable_createMutableSource <span class="hljs-keyword">as</span> createMutableSource
} <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>

<span class="hljs-keyword">import</span> { combineReducers , createStore  } <span class="hljs-keyword">from</span> <span class="hljs-string">'redux'</span>

<span class="hljs-comment">/* number Reducer */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">numberReducer</span>(<span class="hljs-params">state=<span class="hljs-number">1</span>,action</span>)</span>{
    <span class="hljs-keyword">switch</span> (action.type){
      <span class="hljs-keyword">case</span> <span class="hljs-string">'ADD'</span>:
        <span class="hljs-keyword">return</span> state + <span class="hljs-number">1</span>
      <span class="hljs-keyword">case</span> <span class="hljs-string">'DEL'</span>:
        <span class="hljs-keyword">return</span> state - <span class="hljs-number">1</span>
      <span class="hljs-attr">default</span>:
        <span class="hljs-keyword">return</span> state
    }
}
<span class="hljs-comment">/* æ³¨å†Œreducer */</span>
<span class="hljs-keyword">const</span> rootReducer = combineReducers({ <span class="hljs-attr">number</span>:numberReducer  })
<span class="hljs-comment">/* åˆæˆStore */</span>
<span class="hljs-keyword">const</span> Store = createStore(rootReducer,{ <span class="hljs-attr">number</span>: <span class="hljs-number">1</span>  })
<span class="hljs-comment">/* æ³¨å†Œå¤–éƒ¨æ•°æ®æº */</span>
<span class="hljs-keyword">const</span> dataSource = createMutableSource( Store ,<span class="hljs-function">() =></span> <span class="hljs-number">1</span> )

<span class="hljs-comment">/* è®¢é˜…å¤–éƒ¨æ•°æ®æº */</span>
<span class="hljs-keyword">const</span> subscribe = <span class="hljs-function">(<span class="hljs-params">dataSource,callback</span>)=></span>{
    <span class="hljs-keyword">const</span> unSubScribe = dataSource.subscribe(callback)
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =></span> unSubScribe()
}

<span class="hljs-comment">/* <span class="hljs-doctag">TODO:</span> æƒ…å†µä¸€ */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Index</span>(<span class="hljs-params"></span>)</span>{
    <span class="hljs-comment">/* è·å–æ•°æ®å¿«ç…§ */</span>
     <span class="hljs-keyword">const</span> shotSnop = React.useCallback(<span class="hljs-function">(<span class="hljs-params">data</span>) =></span> ({...data.getState()}),[])
    <span class="hljs-comment">/*  hooks:ä½¿ç”¨ */</span>
    <span class="hljs-keyword">const</span> data = useMutableSource(dataSource,shotSnop,subscribe)
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&#x3C;<span class="hljs-name">div</span>></span>
        <span class="hljs-tag">&#x3C;<span class="hljs-name">p</span>></span> æ‹¥æŠ± React 18 ğŸ‰ğŸ‰ğŸ‰ <span class="hljs-tag">&#x3C;/<span class="hljs-name">p</span>></span>
        èµï¼š{data.number} <span class="hljs-tag">&#x3C;<span class="hljs-name">br</span>/></span>
        <span class="hljs-tag">&#x3C;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span>=></span>Store.dispatch({ type:'ADD' })} >ç‚¹èµ<span class="hljs-tag">&#x3C;/<span class="hljs-name">button</span>></span>
    <span class="hljs-tag">&#x3C;/<span class="hljs-name">div</span>></span></span>
}
</code></pre>
<p>ç¬¬ä¸€éƒ¨åˆ†ç”¨ <code>combineReducers</code> å’Œ <code>createStore</code> åˆ›å»º redux Store çš„è¿‡ç¨‹ã€‚<br>
é‡ç‚¹æ˜¯ç¬¬äºŒéƒ¨åˆ†ï¼š</p>
<ul>
<li>é¦–å…ˆé€šè¿‡ createMutableSource åˆ›å»ºæ•°æ®æºï¼ŒStore ä¸ºæ•°æ®æºï¼Œ<code>data.getState()</code> ä½œä¸ºç‰ˆæœ¬å·ã€‚</li>
<li>ç¬¬äºŒç‚¹å°±æ˜¯å¿«ç…§ä¿¡æ¯ï¼Œè¿™é‡Œçš„å¿«ç…§å°±æ˜¯ store ä¸­çš„ stateã€‚æ‰€ä»¥åœ¨ <code>shotSnop</code> è¿˜æ˜¯é€šè¿‡ getState è·å–çŠ¶æ€ï¼Œæ­£å¸¸æƒ…å†µä¸‹ shotSnop åº”è¯¥ä½œä¸º <code>Selector</code>ï¼Œè¿™é‡ŒæŠŠæ‰€æœ‰çš„ state éƒ½æ˜ å°„å‡ºæ¥äº†ã€‚</li>
<li>ç¬¬ä¸‰å°±æ˜¯é€šè¿‡ <code>useMutableSource</code> æŠŠæ•°æ®æºï¼Œå¿«ç…§ï¼Œè®¢é˜…å‡½æ•°ä¼ å…¥ï¼Œå¾—åˆ°çš„ data å°±æ˜¯å¼•ç”¨çš„å¤–éƒ¨æ•°æ®æºäº†ã€‚</li>
</ul>
<p>æ¥ä¸‹æ¥è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹æ•ˆæœï¼š</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/81ad31834d0941859cf767d22d685c6b~tplv-k3u1fbpfcp-watermark.image?" alt="4.gif"></p>
<h2>å›› åŸç†åˆ†æ</h2>
<p>useMutableSource å·²ç»åœ¨ React v18 çš„è§„åˆ’ä¹‹ä¸­äº†ï¼Œé‚£ä¹ˆå®ƒçš„å®ç°åŸç†ä»¥åŠç»†èŠ‚ï¼Œåœ¨ V18 æ­£å¼æ¨å‡ºä¹‹å‰å¯ä»¥è¿˜ä¼šæœ‰è°ƒæ•´ï¼Œ</p>
<h3>1 createMutableSource</h3>
<blockquote>
<p>react/src/ReactMutableSource.js -> createMutableSource</p>
</blockquote>
<pre><code class="hljs language-js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createMutableSource</span>(<span class="hljs-params">source,getVersion</span>)</span>{
    <span class="hljs-keyword">const</span> mutableSource = {
        <span class="hljs-attr">_getVersion</span>: getVersion,
        <span class="hljs-attr">_source</span>: source,
        <span class="hljs-attr">_workInProgressVersionPrimary</span>: <span class="hljs-literal">null</span>,
        <span class="hljs-attr">_workInProgressVersionSecondary</span>: <span class="hljs-literal">null</span>,
    };
    <span class="hljs-keyword">return</span> mutableSource
}
</code></pre>
<p>createMutableSource çš„åŸç†éå¸¸ç®€å•ï¼Œå’Œ <code>createContext</code> ï¼Œ <code>createRef</code> ç±»ä¼¼ï¼Œ å°±æ˜¯åˆ›å»ºä¸€ä¸ª <code>createMutableSource</code> å¯¹è±¡ï¼Œ</p>
<h3>2 useMutableSource</h3>
<p>å¯¹äº useMutableSource åŸç†ä¹Ÿæ²¡æœ‰é‚£ä¹ˆç„ä¹ï¼ŒåŸæ¥æ˜¯ç”±å¼€å‘è€…è‡ªå·±æŠŠå¤–éƒ¨æ•°æ®æºæ³¨å…¥åˆ° state ä¸­ï¼Œç„¶åå†™è®¢é˜…å‡½æ•°ã€‚ useMutableSource çš„åŸç†å°±æ˜¯æŠŠå¼€å‘è€…è¯¥åšçš„äº‹ï¼Œè‡ªå·±åšäº†ğŸ˜‚ğŸ˜‚ğŸ˜‚ï¼Œè¿™æ ·çœç€å¼€å‘è€…å»å†™ç›¸å…³çš„ä»£ç äº†ã€‚æœ¬è´¨ä¸Šå°±æ˜¯ <strong>useState + useEffect</strong> ï¼š</p>
<ul>
<li>useState è´Ÿè´£æ›´æ–°ã€‚</li>
<li>useEffect è´Ÿè´£è®¢é˜…ã€‚</li>
</ul>
<p>ç„¶åæ¥çœ‹ä¸€ä¸‹åŸç†ã€‚</p>
<blockquote>
<p>react-reconciler/src/ReactFiberHooks.new.js -> useMutableSource</p>
</blockquote>
<pre><code class="hljs language-js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">useMutableSource</span>(<span class="hljs-params">hook,source,getSnapshot</span>)</span>{
    <span class="hljs-comment">/* è·å–ç‰ˆæœ¬å· */</span>
    <span class="hljs-keyword">const</span> getVersion = source._getVersion;
    <span class="hljs-keyword">const</span> version = getVersion(source._source);
    <span class="hljs-comment">/* ç”¨ useState ä¿å­˜å½“å‰ Snapshotï¼Œè§¦å‘æ›´æ–°ã€‚ */</span>
    <span class="hljs-keyword">let</span> [currentSnapshot, setSnapshot] = dispatcher.useState(<span class="hljs-function">() =></span>
       readFromUnsubscribedMutableSource(root, source, getSnapshot),
    );
    dispatcher.useEffect(<span class="hljs-function">() =></span> {
        <span class="hljs-comment">/* åŒ…è£…å‡½æ•°  */</span>
        <span class="hljs-keyword">const</span> handleChange = <span class="hljs-function">() =></span> {
            <span class="hljs-comment">/* è§¦å‘æ›´æ–° */</span>
            setSnapshot()
        }
        <span class="hljs-comment">/* è®¢é˜…æ›´æ–° */</span>
        <span class="hljs-keyword">const</span> unsubscribe = subscribe(source._source, handleChange);
        <span class="hljs-comment">/* å–æ¶ˆè®¢é˜… */</span>
        <span class="hljs-keyword">return</span> unsubscribe;
    },[source, subscribe])
}
</code></pre>
<p>ä¸Šè¿°ä»£ç ä¸­ä¿ç•™äº†æœ€æ ¸å¿ƒçš„é€»è¾‘ï¼š</p>
<ul>
<li>é¦–å…ˆé€šè¿‡ <code>getVersion</code> è·å–æ•°æ®æºç‰ˆæœ¬å·ï¼Œç”¨ <strong><code>useState</code></strong> ä¿å­˜å½“å‰ Snapshotï¼ŒsetSnapshot ç”¨äºè§¦å‘æ›´æ–°ã€‚</li>
<li>åœ¨ <strong><code>useEffect</code></strong> ä¸­ï¼Œè¿›è¡Œè®¢é˜…ï¼Œç»‘å®šçš„æ˜¯åŒ…è£…å¥½çš„ handleChange å‡½æ•°ï¼Œé‡Œé¢è°ƒç”¨ setSnapshot çœŸæ­£çš„æ›´æ–°ç»„ä»¶ã€‚</li>
<li>æ‰€ä»¥ useMutableSource æœ¬è´¨ä¸Šè¿˜æ˜¯ useState ã€‚</li>
</ul>
<h2>äº” æ€»ç»“</h2>
<p>ä»Šå¤©è®²äº† useMutableSource çš„èƒŒæ™¯ï¼Œç”¨æ³•ï¼Œä»¥åŠåŸç†ã€‚å¸Œæœ›é˜…è¯»çš„åŒå­¦å¯ä»¥å…‹éš†ä¸€ä¸‹ React v18 çš„æ–°ç‰ˆæœ¬ï¼Œå°è¯•ä¸€ä¸‹æ–°ç‰¹æ€§ï¼Œå°†å¯¹ç†è§£ useMutableSource å¾ˆæœ‰å¸®åŠ©ã€‚ä¸‹ä¸€ç« æˆ‘ä»¬å°†ç»§ç»­å›´ç»• React v18 å±•å¼€ã€‚</p></div>
</body></html>