<!DOCTYPE html><html lang="en"><head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>第 01 讲：设计一份吸引面试官的简历</title>
<style type="text/css">
:root {
    --control-text-color: #777;
    --select-text-bg-color: rgba(223, 197, 223);  /*#7e66992e;*/
    
    /* side bar */
    --side-bar-bg-color: rgb(255, 255, 255);
    --active-file-text-color: #8163bd;
    --active-file-bg-color: #E9E4F0;
    --item-hover-bg-color: #E9E4F0;
    --active-file-border-color: #8163bd;

    --title-color: #6c549c;
    --font-sans-serif: 'Ubuntu', 'Source Sans Pro', sans-serif !important;
    --font-monospace: 'Fira Code', 'Roboto Mono', monospace !important;
    --purple-1: #8163bd;
    --purple-2: #79589F;
    --purple-3: #fd5eb8;
    --purple-light-1: rgba(99, 99, 172, .05);
    --purple-light-2: rgba(99, 99, 172, .1);
    --purple-light-3: rgba(99, 99, 172, .2);
    --purple-light-4: rgba(129, 99, 189, .3);
    --purple-light-5: #E9E4F0;
    --purple-light-6: rgba(129, 99, 189, .8);
}

/* html {
    font-size: 16px;
} */

body {
    font-family: var(--font-sans-serif);
    color: #34495e;
    -webkit-font-smoothing: antialiased;
    line-height: 1.6rem;
    letter-spacing: 0;
    margin: 0;
    overflow-x: hidden;
}

/* 页边距 和 页面大小 */
#write {
    padding-left: 6ch;
    padding-right: 6ch;
    margin: 0 auto;
}

#write p {
    line-height: 1.6rem;
    word-spacing: .05rem;
}

#write ol li {
    padding-left: 0.5rem;
}

#write > ul:first-child,
#write > ol:first-child {
    margin-top: 30px;
}

body > *:first-child {
    margin-top: 0 !important;
}

body > *:last-child {
    margin-bottom: 0 !important;
}

a {
    color: var(--purple-1);
    padding: 0 2px;
    text-decoration: none;
}
.md-content {
    color: var(--purple-light-6);
}
#write a {
    border-bottom: 1px solid var(--purple-1);
    color: var(--purple-1);
    text-decoration: none;
}

h1,
h2,
h3,
h4,
h5,
h6 {
    position: relative;
    margin-top: 1rem;
    margin-bottom: 0.5rem;
    /* font-weight: bold; */
    font-weight: 500 !important;
    line-height: 1.4;
    cursor: text;
    color: var(--title-color);
    font-family: var(--font-sans-serif);
}

h1:hover a.anchor,
h2:hover a.anchor,
h3:hover a.anchor,
h4:hover a.anchor,
h5:hover a.anchor,
h6:hover a.anchor {
    text-decoration: none;
}

h1 tt,
h1 code {
    font-size: inherit !important;
}
h2 tt,
h2 code {
    font-size: inherit !important;
}
h3 tt,
h3 code {
    font-size: inherit !important;
}
h4 tt,
h4 code {
    font-size: inherit !important;
}
h5 tt,
h5 code {
    font-size: inherit !important;
}
h6 tt,
h6 code {
    font-size: inherit !important;
}


h1 {
    padding-bottom: .4rem;
    font-size: 2.2rem;
    line-height: 1.3;
}
h1 {
    text-align: center;
    padding-bottom: 0.3em;
    font-size: 2.2em;
    line-height: 1.2;
    margin: 2.4em auto 1.2em;
}
h1:after {
    content: '';
    display: block;
    margin: 0.2em auto 0;
    width: 100px;
    height: 2px;
    border-bottom: 2px solid var(--title-color);
}

h2 {
    margin: 1.6em auto 0.5em;
    padding-left: 10px;
    line-height: 1.4;
    font-size: 1.8em;
    border-left: 9px solid var(--title-color);
    border-bottom: 1px solid var(--title-color);
}
h3 {
    font-size: 1.5rem;
    margin: 1.2em auto 0.5em;
}
h4 {
    font-size: 1.3rem;
}
h5 {
    font-size: 1.2rem;
}
h6 {
    font-size: 1.1rem;
}

p,
blockquote,
ul,
ol,
dl,
table {
    margin: 0.8em 0;
}

li > ol,
li > ul {
    margin: 0 0;
}

hr {
    height: 2px;
    padding: 0;
    margin: 16px 0;
    background-color: #e7e7e7;
    border: 0 none;
    overflow: hidden;
    box-sizing: content-box;
}

body > h2:first-child {
    margin-top: 0;
    padding-top: 0;
}

body > h1:first-child {
    margin-top: 0;
    padding-top: 0;
}

body > h1:first-child + h2 {
    margin-top: 0;
    padding-top: 0;
}

body > h3:first-child,
body > h4:first-child,
body > h5:first-child,
body > h6:first-child {
    margin-top: 0;
    padding-top: 0;
}

a:first-child h1,
a:first-child h2,
a:first-child h3,
a:first-child h4,
a:first-child h5,
a:first-child h6 {
    margin-top: 0;
    padding-top: 0;
}

h1 p,
h2 p,
h3 p,
h4 p,
h5 p,
h6 p {
    margin-top: 0;
}

li p.first {
    display: inline-block;
}

ul,
ol {
    padding-left: 30px;
}

ul:first-child,
ol:first-child {
    margin-top: 0;
}

ul:last-child,
ol:last-child {
    margin-bottom: 0;
}

/* 引用 */
blockquote {
    /* margin-left: 1rem; */
    border-left: 4px solid var(--purple-light-4);
    padding: 10px 15px;
    color: #777;
    background-color: var(--purple-light-1);
}

/* 表格 */
table {
    padding: 0;
    word-break: initial;
}

table tr {
    border-top: 1px solid #dfe2e5;
    margin: 0;
    padding: 0;
}

/* 表格 背景色 */
table tr:nth-child(2n),
thead {
    background-color: var(--purple-light-1);
}
#write table thead th {
    background-color: var(--purple-light-2);
}

table tr th {
    font-weight: bold;
    border: 1px solid #dfe2e5;
    border-bottom: 0;
    text-align: left;
    margin: 0;
    padding: 6px 13px;
}

table tr td {
    border: 1px solid #dfe2e5;
    text-align: left;
    margin: 0;
    padding: 6px 13px;
}

table tr th:first-child,
table tr td:first-child {
    margin-top: 0;
}

table tr th:last-child,
table tr td:last-child {
    margin-bottom: 0;
}

/* 粗体 */
#write strong {
    padding: 0 2px;
    color: var(--purple-1);
}

/* 斜体 */
#write em {
    padding: 0 5px 0 2px;
    /* font-style: normal; */
    color: #42b983;
}

/* inline code */
#write code, tt {
    padding: 2px 4px;
    border-radius: 2px;
    font-family: var(--font-monospace);
    font-size: 0.92rem;
    color: var(--purple-3); 
    background-color: rgba(99, 99, 172, .05);
}

tt {
    margin: 0 2px;
}

#write .md-footnote {
    background-color: #f8f8f8;
    color: var(--purple-3);
}

/* heighlight. */
#write mark {
    background-color: #fbd3ea;
    border-radius: 2px;
    padding: 2px 4px;
    margin: 0 2px;
}

#write del {
    padding: 1px 2px;
}

.md-task-list-item > input {
    margin-left: -1.3em;
}

@media print {
    html {
        font-size: 0.9rem;
    }

    table,
    pre {
        page-break-inside: avoid;
    }

    pre {
        word-wrap: break-word;
    }
}

#write pre.md-meta-block {
    padding: 1rem;
    font-size: 85%;
    line-height: 1.45;
    background-color: #f7f7f7;
    border: 0;
    border-radius: 3px;
    color: #777777;
    margin-top: 0 !important;
}

.mathjax-block > .code-tooltip {
    bottom: .375rem;
}

/* 图片 */
.md-image > .md-meta {
    border-radius: 3px;
    font-family: var(--font-monospace);
    padding: 2px 0 0 4px;
    font-size: 0.9em;
    color: inherit;
}
p .md-image:only-child{
    width: auto;
    text-align: left;
    margin-left: 2rem;
}
.md-tag {
    color: inherit;
}
/* 当 “![shadow-随便写]()”写时，会有阴影 */
.md-image img[alt|='shadow'] {
    /* box-shadow: 0 4px 24px -6px #ddd; */
    box-shadow:var(--purple-light-2) 0px 10px 15px;
}

#write a.md-toc-inner {
    line-height: 1.6;
    white-space: pre-line;
    border-bottom: none;
    font-size: 0.9rem;
}

#typora-quick-open {
    border: 1px solid #ddd;
    background-color: #f8f8f8;
}

#typora-quick-open-item {
    background-color: #FAFAFA;
    border-color: #FEFEFE #e5e5e5 #e5e5e5 #eee;
    border-style: solid;
    border-width: 1px;
}

#md-notification:before {
    top: 10px;
}

header,
.context-menu,
.megamenu-content,
footer {
    font-family: var(--font-sans-serif);
}

.file-node-content:hover .file-node-icon,
.file-node-content:hover .file-node-open-state {
    visibility: visible;
}

.md-lang {
    color: #b4654d;
}

.html-for-mac .context-menu {
    --item-hover-bg-color: #E6F0FE;
}

/* 代码框 */
/* CodeMirror 3024 Day theme */

/* 代码段 背景 */
pre {
    --select-text-bg-color: rgba(223, 197, 223) !important;
    margin: .5em 0;
    padding: 1em 1.4em;
    border-radius: 8px;
    background: #f6f8fa;
    overflow-x: auto;
    box-sizing: border-box;
    font-size: 14px;
}

/* 边框 */
.md-fences {
    border: 1px solid #e7eaed;
    border-radius: 3px;
}

.cm-s-inner {
  padding: .25rem;
  border-radius: .25rem;
}

.cm-s-inner.CodeMirror, .cm-s-inner .CodeMirror-gutters {
  background-color: #f8f8f8 !important;
  color: #3a3432 !important;
  border: none;
}

.cm-s-inner .CodeMirror-gutters {
  color: #6d8a88;
}

.cm-s-inner .CodeMirror-cursor {
  border-left: solid thin #5c5855 !important;
}

.cm-s-inner .CodeMirror-linenumber {
  color: #807d7c;
}

.cm-s-inner .CodeMirror-line::selection, .cm-s-inner .CodeMirror-line::-moz-selection,
.cm-s-inner .CodeMirror-line > span::selection,
.cm-s-inner .CodeMirror-line > span::-moz-selection,
.cm-s-inner .CodeMirror-line > span > span::selection,
.cm-s-inner .CodeMirror-line > span > span::-moz-selection {
  background: var(--purple-light-2);
}

.cm-s-inner span.cm-comment {
  color: #cdab53;
}

.cm-s-inner span.cm-string, .cm-s-inner span.cm-string-2 {
  color: #f2b01d;
}

.cm-s-inner span.cm-number {
  color: #a34e8f;
}

.cm-s-inner span.cm-variable {
  color: #01a252;
}

.cm-s-inner span.cm-variable-2 {
  color: #01a0e4;
}

.cm-s-inner span.cm-def {
  /* color: #e8bbd0; */
  color: #e2287f;
}

.cm-s-inner span.cm-operator {
  color: #ff79c6;
}

.cm-s-inner span.cm-keyword {
  color: #db2d20;
}

.cm-s-inner span.cm-atom {
  color: #a34e8f;
}

.cm-s-inner span.cm-meta {
  color: inherit;
}

.cm-s-inner span.cm-tag {
  color: #db2d20;
}

.cm-s-inner span.cm-attribute {
  color: #01a252;
}

.cm-s-inner span.cm-qualifier {
  color: #388aa3;
}

.cm-s-inner span.cm-property {
  color: #01a252;
}

.cm-s-inner span.cm-builtin {
  color: #388aa3;
}

.cm-s-inner span.cm-variable-3, .cm-s-inner span.cm-type {
  color: #ffb86c;
}

.cm-s-inner span.cm-bracket {
  color: #3a3432;
}

.cm-s-inner span.cm-link {
  color: #a34e8f;
}

.cm-s-inner span.cm-error {
  background: #db2d20;
  color: #5c5855;
}

/* .md-fences.md-focus .cm-s-inner .CodeMirror-activeline-background {
  background: var(--purple-light-2);
} */

.cm-s-inner .CodeMirror-matchingbracket {
  text-decoration: underline;
  color: #a34e8f !important;
}

#fences-auto-suggest .active {
  background: #ddd;
}

#write .code-tooltip {
  bottom: initial;
  top: calc(100% - 1px);
  background: #f7f7f7;
  border: 1px solid #ddd;
  border-top: 0;
}

.auto-suggest-container {
  border-color: #b4b4b4;
}

.auto-suggest-container .autoComplt-hint.active {
  background: #b4b4b4;
  color: inherit;
}

/* task list */
#write .md-task-list-item > input {
  -webkit-appearance: initial;
  display: block;
  position: absolute;
  border: 1px solid #b4b4b4;
  border-radius: .25rem;
  margin-top: .1rem;
  margin-left: -1.8rem;
  height: 1.2rem;
  width: 1.2rem;
  transition: background 0.3s;
}

#write .md-task-list-item > input:focus {
  outline: none;
  box-shadow: none;
}

#write .md-task-list-item > input:hover {
  background: #ddd;
}

#write .md-task-list-item > input[checked]::before {
  content: '';
  position: absolute;
  top: 20%;
  left: 50%;
  height: 60%;
  width: 2px;
  transform: rotate(40deg);
  background: #333;
}

#write .md-task-list-item > input[checked]::after {
  content: '';
  position: absolute;
  top: 46%;
  left: 25%;
  height: 30%;
  width: 2px;
  transform: rotate(-40deg);
  background: #333;
}

#write .md-task-list-item > p {
  transition: color 0.3s, opacity 0.3s;
}

#write .md-task-list-item.task-list-done > p {
  color: #b4b4b4;
  text-decoration: line-through;
}

#write .md-task-list-item.task-list-done > p > .md-emoji {
  opacity: .5;
}

#write .md-task-list-item.task-list-done > p > .md-link > a {
  opacity: .6;
}

/* sidebar and outline */
.pin-outline .outline-active {
  color: var(--active-file-text-color); 
}

.file-list-item {
    border-bottom: 1px solid;
    border-color: var(--purple-light-5);
}

.file-list-item-summary {
    font-weight: 400;
}

.file-list-item.active {
    color: var(--active-file-text-color);
    background-color: var(--purple-light-5);
}

.file-tree-node.active>.file-node-background {
    background-color: var(--purple-light-5);
    font-weight: 700;
} 

.file-tree-node.active>.file-node-content {
    color: var(--active-file-text-color);
    font-weight: 700;
}

.file-node-content {
    color: #5e676d;
}

.sidebar-tabs {
    border-bottom: none;
}
.sidebar-tab.active {
    font-weight: 400;
}

.sidebar-content-content {
    font-size: 0.9rem;
}

img {
    max-width: 100%;
}

body {
    background-color: rgb(237, 237, 237);
}
#content {
    width: 836px;
    padding: 50px;
    background: #fff;
    margin: 0 auto;
}/*# sourceURL=/Users/young/Documents/Codes/Fun/lagou/public/purple.css*/</style><style type="text/css">.hljs{display:block;overflow-x:auto;padding:.5em;color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}/*# sourceURL=/Users/young/Documents/Codes/Fun/lagou/public/atom-one-light.min.css*/</style></head>
<body>
<div id="content"><h1>扩展：会议系统容器化部署实战</h1>
<p>上节课我们从会议系统本身的基础配置出发，系统讲解并演示了会议系统部署到线上后云服务器需要注意的点，以及信令服务、流媒体服务、<code>WebRTC</code>网关服务、网络穿透服务如何配置在前端项目中，同时我们也实际操作，将信令服务和会议系统前端文件结合通过 <code>Nginx</code>映射到指定的域名，并让其支持<code>HTTPS</code>访问。</p>
<p>这节课，我们的核心是会议服务容器化，容器化对于现在云原生时代而言是必要的，通过容器我们可以更方便的管理和迁移我们的各种服务。</p>
<h2>基础服务容器化</h2>
<p>首先从信令服务出发，将信令服务容器化。容器化的方式我们则通过 Docker 容器来承载基础服务，那么第一步应该是制作特定的<code>Dockerfile</code>文件。</p>
<p><code>Dockerfile</code>文件是自有服务制作 Docker 镜像的核心文件，我们现在用到的 Docker 镜像都离不开该文件。</p>
<ul>
<li>第一行：信令服务需要依赖 <code>Node</code>环境，因此我们的基准镜像选择 <code>node:14.21.0-buster</code>。</li>
<li>第二行：需要注意的是时区，如果当前服务依赖对时间有严格要求的，请注意时区配置。<code>Docker</code><strong>容器默认时区是</strong> <strong><a href="https://baike.baidu.com/item/%E5%8D%8F%E8%B0%83%E4%B8%96%E7%95%8C%E6%97%B6/787659" target="_blank" rel="nofollow noopener noreferrer">UTC</a></strong> <strong>，此时如果获取服务器时间则比北京时间少8小时</strong>。</li>
<li>第三行：<code>CMD</code>表示自定义的命令，这里我输出的是一段话。</li>
<li>第四行：拷贝文件夹到容器内部。我们所有的核心<code>服务</code>就是这个文件夹，因此需要将这些文件拷贝到镜像中去，后面根据镜像启动容器的时候才可以找到对应的<code>服务</code>。</li>
<li>第五行：设置工作空间，即容器默认启动的工作目录。</li>
<li>第六行：<code>ENTRYPOINT</code>，容器启动后需要执行的命令。这个命令只有在启动容器的时候才会执行，构建镜像的时候不会。</li>
</ul>
<pre><code class="hljs language-bash">FROM node:14.21.0-buster
ENV TZ=Asia/Shanghai
CMD <span class="hljs-string">"echo 信令服务器启动 dist目录为音视频前端目录，请使用nginx代理后访问，代理前端口：18080"</span>
COPY ./server /server
WORKDIR /server
ENTRYPOINT [<span class="hljs-string">"node"</span>, <span class="hljs-string">"/app.js"</span>]
</code></pre>
<p><strong>整体目录</strong></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ead305f879e84f9299a2d68c237cef75~tplv-k3u1fbpfcp-zoom-1.image" alt=""></p>
<p><strong>构建 Docker 镜像</strong></p>
<pre><code class="hljs language-sql"># 在Dockerfile文件同目录执行下面语句 <span class="hljs-operator">-</span>t 表示指定的标签<span class="hljs-operator">+</span>版本号 ；不要网络后面那个点
root<span class="hljs-variable">@VM</span><span class="hljs-number">-4</span><span class="hljs-number">-3</span><span class="hljs-operator">-</span>ubuntu:<span class="hljs-operator">/</span>home<span class="hljs-operator">/</span>ubuntu<span class="hljs-operator">/</span>suke<span class="hljs-operator">-</span>nrtc# docker build <span class="hljs-operator">-</span>t suke<span class="hljs-operator">-</span>media<span class="hljs-operator">-</span>nrtc:<span class="hljs-number">2.0</span>  .
Sending build context <span class="hljs-keyword">to</span> Docker daemon  <span class="hljs-number">70.83</span>MB
Step <span class="hljs-number">1</span><span class="hljs-operator">/</span><span class="hljs-number">6</span> : <span class="hljs-keyword">FROM</span> node:<span class="hljs-number">14.21</span><span class="hljs-number">.0</span><span class="hljs-operator">-</span>buster
 <span class="hljs-comment">---> bd24482b8c86</span>
Step <span class="hljs-number">2</span><span class="hljs-operator">/</span><span class="hljs-number">6</span> : ENV TZ<span class="hljs-operator">=</span>Asia<span class="hljs-operator">/</span>Shanghai
 <span class="hljs-comment">---> Using cache</span>
 <span class="hljs-comment">---> 1331b3ea89ea</span>
Step <span class="hljs-number">3</span><span class="hljs-operator">/</span><span class="hljs-number">6</span> : CMD "echo 信令服务器启动 dist目录为音视频前端目录，请使用nginx代理后访问，代理前端口：18080"
 <span class="hljs-comment">---> Using cache</span>
 <span class="hljs-comment">---> 1a642db0ce12</span>
Step <span class="hljs-number">4</span><span class="hljs-operator">/</span><span class="hljs-number">6</span> : <span class="hljs-keyword">COPY</span> .<span class="hljs-operator">/</span>server <span class="hljs-operator">/</span>server
 <span class="hljs-comment">---> Using cache</span>
 <span class="hljs-comment">---> c0e2a8a0009e</span>
Step <span class="hljs-number">5</span><span class="hljs-operator">/</span><span class="hljs-number">6</span> : WORKDIR <span class="hljs-operator">/</span>server
 <span class="hljs-comment">---> Using cache</span>
 <span class="hljs-comment">---> dfcf81c0644c</span>
Step <span class="hljs-number">6</span><span class="hljs-operator">/</span><span class="hljs-number">6</span> : ENTRYPOINT ["node", "app.js"]
 <span class="hljs-comment">---> Using cache</span>
 <span class="hljs-comment">---> b0ddd996a31d</span>
Successfully built b0ddd996a31d
Successfully tagged suke<span class="hljs-operator">-</span>media<span class="hljs-operator">-</span>nrtc:<span class="hljs-number">2.0</span>
</code></pre>
<p><strong>构建完成后启动容器</strong></p>
<blockquote>
<p><code>--name</code>：指定容器名称；<code>--restart</code> ：自动重启，比如服务器关机重启后，容器会自动重启； <code>-p： 宿主机端口:容器内部服务暴露端口</code>；最后面参数为上一步构建的<code>镜像+版本</code>。</p>
</blockquote>
<pre><code class="hljs language-css">sudo docker run -d <span class="hljs-attr">--name</span> suke-media-nrtc <span class="hljs-attr">--restart</span>=always  -<span class="hljs-selector-tag">p</span> <span class="hljs-number">18080</span>:<span class="hljs-number">18080</span> suke-media-nrtc:<span class="hljs-number">2.0</span>
</code></pre>
<h2>前后端分离容器化部署</h2>
<p>上一步容器化部署是将会议前端和信令服务结合一起部署的，但是有些人并不想前端和后端信令服务绑定到一起，因此就需要拆分部署，也就是所谓的前端和后端分离部署，这个时候就需要用到<code>Nginx</code>了。</p>
<p>我们先大体上梳理下，前后分离部署的基础步骤：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/59ef82eb205d48a78fa8de0d454fe657~tplv-k3u1fbpfcp-zoom-1.image" alt=""></p>
<p>本质上和基础服务容器化一样，都是制作自己的镜像，接下来我们按照上图中的内容步骤制作我们自己的镜像。</p>
<ol>
<li>准备 Nginx 配置文件 <code>nginx.conf</code>。</li>
</ol>
<blockquote>
<p><code>server_name</code> 绑定自己的域名即可。</p>
<p>注意下面的两个路径 <code>/usr/web/nginx/ssl</code>、<code>/usr/web/nginx/html</code>，一个是<code>SSL</code>证书位置，一个是前端静态文件夹。</p>
<p><code>/signal-api/</code>为<code>Nginx</code>代理路径。被代理的服务地址：<code>proxy_pass http://x.x.x.x; </code>。</p>
</blockquote>
<pre><code class="hljs language-ini">server {
listen       19003 ssl<span class="hljs-comment">;</span>
server_name  localhost<span class="hljs-comment">;</span>
client_max_body_size 1024M<span class="hljs-comment">;</span>
ssl_certificate /usr/web/nginx/ssl/cert.crt<span class="hljs-comment">;</span>
ssl_certificate_key /usr/web/nginx/ssl/private.key<span class="hljs-comment">;</span>
ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3<span class="hljs-comment">;</span>
access_log  /var/log/nginx/host.access.log  main<span class="hljs-comment">;</span>
error_log  /var/log/nginx/error.log  error<span class="hljs-comment">;</span>
location / {
    root   /usr/web/nginx/html<span class="hljs-comment">;</span>
    index  index.html index.htm<span class="hljs-comment">;</span>
}
 location  /signal-api/ {
            proxy_pass http://x.x.x.x:18088<span class="hljs-comment">; # 信令服务地址配置</span>
            proxy_http_version 1.1<span class="hljs-comment">;</span>
            proxy_set_header Upgrade $http_upgrade<span class="hljs-comment">;</span>
            proxy_set_header Connection "upgrade"<span class="hljs-comment">;</span>
        }
error_page   500 502 503 504  /50x.html<span class="hljs-comment">;</span>
<span class="hljs-attr">location</span> = /<span class="hljs-number">50</span>x.html {
    root   /usr/share/nginx/html<span class="hljs-comment">;</span>
}
} 
</code></pre>
<ol start="2">
<li>制作镜像基准文件 Dockerfile。</li>
</ol>
<pre><code class="hljs language-bash"><span class="hljs-comment"># 基准镜像</span>
FROM nginx
<span class="hljs-comment"># 拷贝前端资源</span>
COPY ./dist /usr/web/nginx/html/
<span class="hljs-comment"># 拷贝SSL证书</span>
COPY ./ssl /usr/web/nginx/ssl/
<span class="hljs-comment"># 拷贝 nginx配置文件</span>
COPY nginx.conf /etc/nginx/conf.d/default.conf
<span class="hljs-comment"># 声明暴露端口</span>
EXPOSE 19003 
</code></pre>
<ol start="3">
<li>修改会议前端<code>Prod</code>环境信令服务地址。</li>
</ol>
<pre><code class="hljs language-ini">Vue.prototype.$<span class="hljs-attr">serverSocketUrl</span> = process.env.NODE_ENV === <span class="hljs-string">'development'</span> ? <span class="hljs-string">'ws://127.0.0.1:18080'</span> : <span class="hljs-string">'/signal-api/'</span>
</code></pre>
<ol start="4">
<li>准备好上述文件开始构建镜像。</li>
</ol>
<pre><code class="hljs language-bash"><span class="hljs-comment"># Dockerfile 所在目录执行命令 注意看下图</span>
docker build -t test-online-meeting:1.0.2 .
</code></pre>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3bebdc721cb547ff9fe6ac7ab230894e~tplv-k3u1fbpfcp-zoom-1.image" alt=""></p>
<ol start="5">
<li>启动容器。</li>
</ol>
<pre><code class="hljs language-shell"><span class="hljs-meta prompt_"># </span><span class="bash">这里 --<span class="hljs-built_in">rm</span> 为 停止后自动删除退出容器 仅用于测试 正式部署去掉--<span class="hljs-built_in">rm</span> 并使用 -d 后台进程执行</span>
<span class="hljs-meta prompt_"># </span><span class="bash">19003 为前面声明的 Nginx 配置文件中的端口，同时宿主机端口也是19003 【-p 宿主机端口:容器内服务端口】</span>
docker run --rm -p 19003:19003 test-online-meeting:1.0.2
</code></pre>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f0a0e9a5477449339064568203aa25a9~tplv-k3u1fbpfcp-zoom-1.image" alt=""></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8e38244db0ac4a7f8855aa98f497ccfc~tplv-k3u1fbpfcp-zoom-1.image" alt=""></p>
<p>这里<code>SSL</code>证书为自签名测试证书，因此浏览器不信任，不过可以继续访问。正式环境请使用<code>443端口</code>+域名的正式<code>SSL</code>证书。</p>
<h2>注意事项</h2>
<p>前后端分离部署后，对于服务管理和迁移虽然方便了很多，而且所有的过程仅需要脚本就能自动化部署，搭配现有的各种自动化工具也是很方便的，比如 Jenkins、k8s、k3s 等，但是对于不熟悉的人而言会遇到很多问题。</p>
<ul>
<li><code>nginx</code>路径配置问题。这个算是前后端分离部署后所有项目必须要解决的一个问题，不仅仅是我们的会议系统。比如我前面配置的 <code>location /signal-api/ {}</code>信令服务路径，那么你在前端线上环境也要同步做出更改，否则前端无法找到对应的 API 接口服务。</li>
<li>端口映射问题。<code>nginx</code>暴露端口必须要在启动容器的时候映射出去，否则服务无法访问。</li>
<li>静态资源频繁变更问题。上面我们一开始就将静态资源打到镜像里面了，这种方法对于频繁更改的文件而言并不是很友好，因此我们可以优化下，将静态资源通过动态挂载的方式绑定到宿主机文件系统中。</li>
</ul>
<pre><code class="hljs language-bash"><span class="hljs-comment"># /home/html/dist 为宿主机文件位置 /usr/web/nginx/html/为容器内nginx映射的资源位置。</span>
docker run --<span class="hljs-built_in">rm</span> -p 19003:19003 -v /home/html/dist:/usr/web/nginx/html/ test-online-meeting:1.0.2
</code></pre>
<h2>最后</h2>
<p>在实际的企业应用部署中，大多数服务部署都和这两节部署实战课所讲的方式大同小异，希望学完部署实战的内容，不仅仅对于我们自身会议系统的部署有所帮助，对于大家在实际工作中所有的服务部署都能起到推进作用。</p>
<p>这节课是我们课程的最后一节，从第一节的基础知识，到使用<code>WebRTC</code>打造三种架构直播会议系统实战，再到系统的部署实战，我们算是从 0 到 1 系统性地熟悉了 <code>WebRTC</code>这门技术，这也算是目前为止全网第一本将<code>WebRTC</code>+各种开源流媒体组合打造多样性应用的课程，<strong>希望这节课仅仅是本课程的最后一节，更是你开启前端音视频的第一节课，是大家将技术带入实际工作的第一节课</strong>。</p>
<p>加油！我们共同进步，后续有任何疑问评论区或者社群大家一起交流。课程会停止，但是技术会一直迭代更新，而我们更需要持续的进步。</p></div>
</body></html>