<!DOCTYPE html><html lang="en"><head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>第 01 讲：设计一份吸引面试官的简历</title>
<style type="text/css">
:root {
    --control-text-color: #777;
    --select-text-bg-color: rgba(223, 197, 223);  /*#7e66992e;*/
    
    /* side bar */
    --side-bar-bg-color: rgb(255, 255, 255);
    --active-file-text-color: #8163bd;
    --active-file-bg-color: #E9E4F0;
    --item-hover-bg-color: #E9E4F0;
    --active-file-border-color: #8163bd;

    --title-color: #6c549c;
    --font-sans-serif: 'Ubuntu', 'Source Sans Pro', sans-serif !important;
    --font-monospace: 'Fira Code', 'Roboto Mono', monospace !important;
    --purple-1: #8163bd;
    --purple-2: #79589F;
    --purple-3: #fd5eb8;
    --purple-light-1: rgba(99, 99, 172, .05);
    --purple-light-2: rgba(99, 99, 172, .1);
    --purple-light-3: rgba(99, 99, 172, .2);
    --purple-light-4: rgba(129, 99, 189, .3);
    --purple-light-5: #E9E4F0;
    --purple-light-6: rgba(129, 99, 189, .8);
}

/* html {
    font-size: 16px;
} */

body {
    font-family: var(--font-sans-serif);
    color: #34495e;
    -webkit-font-smoothing: antialiased;
    line-height: 1.6rem;
    letter-spacing: 0;
    margin: 0;
    overflow-x: hidden;
}

/* 页边距 和 页面大小 */
#write {
    padding-left: 6ch;
    padding-right: 6ch;
    margin: 0 auto;
}

#write p {
    line-height: 1.6rem;
    word-spacing: .05rem;
}

#write ol li {
    padding-left: 0.5rem;
}

#write > ul:first-child,
#write > ol:first-child {
    margin-top: 30px;
}

body > *:first-child {
    margin-top: 0 !important;
}

body > *:last-child {
    margin-bottom: 0 !important;
}

a {
    color: var(--purple-1);
    padding: 0 2px;
    text-decoration: none;
}
.md-content {
    color: var(--purple-light-6);
}
#write a {
    border-bottom: 1px solid var(--purple-1);
    color: var(--purple-1);
    text-decoration: none;
}

h1,
h2,
h3,
h4,
h5,
h6 {
    position: relative;
    margin-top: 1rem;
    margin-bottom: 0.5rem;
    /* font-weight: bold; */
    font-weight: 500 !important;
    line-height: 1.4;
    cursor: text;
    color: var(--title-color);
    font-family: var(--font-sans-serif);
}

h1:hover a.anchor,
h2:hover a.anchor,
h3:hover a.anchor,
h4:hover a.anchor,
h5:hover a.anchor,
h6:hover a.anchor {
    text-decoration: none;
}

h1 tt,
h1 code {
    font-size: inherit !important;
}
h2 tt,
h2 code {
    font-size: inherit !important;
}
h3 tt,
h3 code {
    font-size: inherit !important;
}
h4 tt,
h4 code {
    font-size: inherit !important;
}
h5 tt,
h5 code {
    font-size: inherit !important;
}
h6 tt,
h6 code {
    font-size: inherit !important;
}


h1 {
    padding-bottom: .4rem;
    font-size: 2.2rem;
    line-height: 1.3;
}
h1 {
    text-align: center;
    padding-bottom: 0.3em;
    font-size: 2.2em;
    line-height: 1.2;
    margin: 2.4em auto 1.2em;
}
h1:after {
    content: '';
    display: block;
    margin: 0.2em auto 0;
    width: 100px;
    height: 2px;
    border-bottom: 2px solid var(--title-color);
}

h2 {
    margin: 1.6em auto 0.5em;
    padding-left: 10px;
    line-height: 1.4;
    font-size: 1.8em;
    border-left: 9px solid var(--title-color);
    border-bottom: 1px solid var(--title-color);
}
h3 {
    font-size: 1.5rem;
    margin: 1.2em auto 0.5em;
}
h4 {
    font-size: 1.3rem;
}
h5 {
    font-size: 1.2rem;
}
h6 {
    font-size: 1.1rem;
}

p,
blockquote,
ul,
ol,
dl,
table {
    margin: 0.8em 0;
}

li > ol,
li > ul {
    margin: 0 0;
}

hr {
    height: 2px;
    padding: 0;
    margin: 16px 0;
    background-color: #e7e7e7;
    border: 0 none;
    overflow: hidden;
    box-sizing: content-box;
}

body > h2:first-child {
    margin-top: 0;
    padding-top: 0;
}

body > h1:first-child {
    margin-top: 0;
    padding-top: 0;
}

body > h1:first-child + h2 {
    margin-top: 0;
    padding-top: 0;
}

body > h3:first-child,
body > h4:first-child,
body > h5:first-child,
body > h6:first-child {
    margin-top: 0;
    padding-top: 0;
}

a:first-child h1,
a:first-child h2,
a:first-child h3,
a:first-child h4,
a:first-child h5,
a:first-child h6 {
    margin-top: 0;
    padding-top: 0;
}

h1 p,
h2 p,
h3 p,
h4 p,
h5 p,
h6 p {
    margin-top: 0;
}

li p.first {
    display: inline-block;
}

ul,
ol {
    padding-left: 30px;
}

ul:first-child,
ol:first-child {
    margin-top: 0;
}

ul:last-child,
ol:last-child {
    margin-bottom: 0;
}

/* 引用 */
blockquote {
    /* margin-left: 1rem; */
    border-left: 4px solid var(--purple-light-4);
    padding: 10px 15px;
    color: #777;
    background-color: var(--purple-light-1);
}

/* 表格 */
table {
    padding: 0;
    word-break: initial;
}

table tr {
    border-top: 1px solid #dfe2e5;
    margin: 0;
    padding: 0;
}

/* 表格 背景色 */
table tr:nth-child(2n),
thead {
    background-color: var(--purple-light-1);
}
#write table thead th {
    background-color: var(--purple-light-2);
}

table tr th {
    font-weight: bold;
    border: 1px solid #dfe2e5;
    border-bottom: 0;
    text-align: left;
    margin: 0;
    padding: 6px 13px;
}

table tr td {
    border: 1px solid #dfe2e5;
    text-align: left;
    margin: 0;
    padding: 6px 13px;
}

table tr th:first-child,
table tr td:first-child {
    margin-top: 0;
}

table tr th:last-child,
table tr td:last-child {
    margin-bottom: 0;
}

/* 粗体 */
#write strong {
    padding: 0 2px;
    color: var(--purple-1);
}

/* 斜体 */
#write em {
    padding: 0 5px 0 2px;
    /* font-style: normal; */
    color: #42b983;
}

/* inline code */
#write code, tt {
    padding: 2px 4px;
    border-radius: 2px;
    font-family: var(--font-monospace);
    font-size: 0.92rem;
    color: var(--purple-3); 
    background-color: rgba(99, 99, 172, .05);
}

tt {
    margin: 0 2px;
}

#write .md-footnote {
    background-color: #f8f8f8;
    color: var(--purple-3);
}

/* heighlight. */
#write mark {
    background-color: #fbd3ea;
    border-radius: 2px;
    padding: 2px 4px;
    margin: 0 2px;
}

#write del {
    padding: 1px 2px;
}

.md-task-list-item > input {
    margin-left: -1.3em;
}

@media print {
    html {
        font-size: 0.9rem;
    }

    table,
    pre {
        page-break-inside: avoid;
    }

    pre {
        word-wrap: break-word;
    }
}

#write pre.md-meta-block {
    padding: 1rem;
    font-size: 85%;
    line-height: 1.45;
    background-color: #f7f7f7;
    border: 0;
    border-radius: 3px;
    color: #777777;
    margin-top: 0 !important;
}

.mathjax-block > .code-tooltip {
    bottom: .375rem;
}

/* 图片 */
.md-image > .md-meta {
    border-radius: 3px;
    font-family: var(--font-monospace);
    padding: 2px 0 0 4px;
    font-size: 0.9em;
    color: inherit;
}
p .md-image:only-child{
    width: auto;
    text-align: left;
    margin-left: 2rem;
}
.md-tag {
    color: inherit;
}
/* 当 “![shadow-随便写]()”写时，会有阴影 */
.md-image img[alt|='shadow'] {
    /* box-shadow: 0 4px 24px -6px #ddd; */
    box-shadow:var(--purple-light-2) 0px 10px 15px;
}

#write a.md-toc-inner {
    line-height: 1.6;
    white-space: pre-line;
    border-bottom: none;
    font-size: 0.9rem;
}

#typora-quick-open {
    border: 1px solid #ddd;
    background-color: #f8f8f8;
}

#typora-quick-open-item {
    background-color: #FAFAFA;
    border-color: #FEFEFE #e5e5e5 #e5e5e5 #eee;
    border-style: solid;
    border-width: 1px;
}

#md-notification:before {
    top: 10px;
}

header,
.context-menu,
.megamenu-content,
footer {
    font-family: var(--font-sans-serif);
}

.file-node-content:hover .file-node-icon,
.file-node-content:hover .file-node-open-state {
    visibility: visible;
}

.md-lang {
    color: #b4654d;
}

.html-for-mac .context-menu {
    --item-hover-bg-color: #E6F0FE;
}

/* 代码框 */
/* CodeMirror 3024 Day theme */

/* 代码段 背景 */
pre {
    --select-text-bg-color: rgba(223, 197, 223) !important;
    margin: .5em 0;
    padding: 1em 1.4em;
    border-radius: 8px;
    background: #f6f8fa;
    overflow-x: auto;
    box-sizing: border-box;
    font-size: 14px;
}

/* 边框 */
.md-fences {
    border: 1px solid #e7eaed;
    border-radius: 3px;
}

.cm-s-inner {
  padding: .25rem;
  border-radius: .25rem;
}

.cm-s-inner.CodeMirror, .cm-s-inner .CodeMirror-gutters {
  background-color: #f8f8f8 !important;
  color: #3a3432 !important;
  border: none;
}

.cm-s-inner .CodeMirror-gutters {
  color: #6d8a88;
}

.cm-s-inner .CodeMirror-cursor {
  border-left: solid thin #5c5855 !important;
}

.cm-s-inner .CodeMirror-linenumber {
  color: #807d7c;
}

.cm-s-inner .CodeMirror-line::selection, .cm-s-inner .CodeMirror-line::-moz-selection,
.cm-s-inner .CodeMirror-line > span::selection,
.cm-s-inner .CodeMirror-line > span::-moz-selection,
.cm-s-inner .CodeMirror-line > span > span::selection,
.cm-s-inner .CodeMirror-line > span > span::-moz-selection {
  background: var(--purple-light-2);
}

.cm-s-inner span.cm-comment {
  color: #cdab53;
}

.cm-s-inner span.cm-string, .cm-s-inner span.cm-string-2 {
  color: #f2b01d;
}

.cm-s-inner span.cm-number {
  color: #a34e8f;
}

.cm-s-inner span.cm-variable {
  color: #01a252;
}

.cm-s-inner span.cm-variable-2 {
  color: #01a0e4;
}

.cm-s-inner span.cm-def {
  /* color: #e8bbd0; */
  color: #e2287f;
}

.cm-s-inner span.cm-operator {
  color: #ff79c6;
}

.cm-s-inner span.cm-keyword {
  color: #db2d20;
}

.cm-s-inner span.cm-atom {
  color: #a34e8f;
}

.cm-s-inner span.cm-meta {
  color: inherit;
}

.cm-s-inner span.cm-tag {
  color: #db2d20;
}

.cm-s-inner span.cm-attribute {
  color: #01a252;
}

.cm-s-inner span.cm-qualifier {
  color: #388aa3;
}

.cm-s-inner span.cm-property {
  color: #01a252;
}

.cm-s-inner span.cm-builtin {
  color: #388aa3;
}

.cm-s-inner span.cm-variable-3, .cm-s-inner span.cm-type {
  color: #ffb86c;
}

.cm-s-inner span.cm-bracket {
  color: #3a3432;
}

.cm-s-inner span.cm-link {
  color: #a34e8f;
}

.cm-s-inner span.cm-error {
  background: #db2d20;
  color: #5c5855;
}

/* .md-fences.md-focus .cm-s-inner .CodeMirror-activeline-background {
  background: var(--purple-light-2);
} */

.cm-s-inner .CodeMirror-matchingbracket {
  text-decoration: underline;
  color: #a34e8f !important;
}

#fences-auto-suggest .active {
  background: #ddd;
}

#write .code-tooltip {
  bottom: initial;
  top: calc(100% - 1px);
  background: #f7f7f7;
  border: 1px solid #ddd;
  border-top: 0;
}

.auto-suggest-container {
  border-color: #b4b4b4;
}

.auto-suggest-container .autoComplt-hint.active {
  background: #b4b4b4;
  color: inherit;
}

/* task list */
#write .md-task-list-item > input {
  -webkit-appearance: initial;
  display: block;
  position: absolute;
  border: 1px solid #b4b4b4;
  border-radius: .25rem;
  margin-top: .1rem;
  margin-left: -1.8rem;
  height: 1.2rem;
  width: 1.2rem;
  transition: background 0.3s;
}

#write .md-task-list-item > input:focus {
  outline: none;
  box-shadow: none;
}

#write .md-task-list-item > input:hover {
  background: #ddd;
}

#write .md-task-list-item > input[checked]::before {
  content: '';
  position: absolute;
  top: 20%;
  left: 50%;
  height: 60%;
  width: 2px;
  transform: rotate(40deg);
  background: #333;
}

#write .md-task-list-item > input[checked]::after {
  content: '';
  position: absolute;
  top: 46%;
  left: 25%;
  height: 30%;
  width: 2px;
  transform: rotate(-40deg);
  background: #333;
}

#write .md-task-list-item > p {
  transition: color 0.3s, opacity 0.3s;
}

#write .md-task-list-item.task-list-done > p {
  color: #b4b4b4;
  text-decoration: line-through;
}

#write .md-task-list-item.task-list-done > p > .md-emoji {
  opacity: .5;
}

#write .md-task-list-item.task-list-done > p > .md-link > a {
  opacity: .6;
}

/* sidebar and outline */
.pin-outline .outline-active {
  color: var(--active-file-text-color); 
}

.file-list-item {
    border-bottom: 1px solid;
    border-color: var(--purple-light-5);
}

.file-list-item-summary {
    font-weight: 400;
}

.file-list-item.active {
    color: var(--active-file-text-color);
    background-color: var(--purple-light-5);
}

.file-tree-node.active>.file-node-background {
    background-color: var(--purple-light-5);
    font-weight: 700;
} 

.file-tree-node.active>.file-node-content {
    color: var(--active-file-text-color);
    font-weight: 700;
}

.file-node-content {
    color: #5e676d;
}

.sidebar-tabs {
    border-bottom: none;
}
.sidebar-tab.active {
    font-weight: 400;
}

.sidebar-content-content {
    font-size: 0.9rem;
}

img {
    max-width: 100%;
}

body {
    background-color: rgb(237, 237, 237);
}
#content {
    width: 836px;
    padding: 50px;
    background: #fff;
    margin: 0 auto;
}/*# sourceURL=/Users/young/Documents/Codes/Fun/lagou/public/purple.css*/</style><style type="text/css">.hljs{display:block;overflow-x:auto;padding:.5em;color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}/*# sourceURL=/Users/young/Documents/Codes/Fun/lagou/public/atom-one-light.min.css*/</style></head>
<body>
<div id="content"><h1>流媒体 SRS 和 WebRTC ：初步认识 SRS 及服务搭建</h1>
<p>大家好，学完前面两种架构的会议系统搭建，大家是不是已经迫不及待想要实现自己的私有化会议系统，或者想要直接在自己公司的业务中使用了？先不要急，如果你的业务中涉及和流媒体相关的使用场景，比如监控、<code>RTSP</code>、<code>RTMP</code> 等，那么这节课的内容应该能合你胃口。</p>
<p>前面的课程讲的都是简单的音视频场景应用，而没有深入讲音视频本身的东西。想要深入了解音视频，那么必不可少的就是流媒体这一块的知识了。在正式开始学习流媒体服务<code>SRS</code> 之前，我们先学习一些基本的流媒体相关知识。</p>
<h2>RTMP</h2>
<p>Real-Time Messaging Protocol，简称<code>RTMP</code>，是一种支持实时在线视频流的数据传输技术，最初是用在流媒体服务和 <a href="https://en.wikipedia.org/wiki/Adobe_Flash_Player" target="_blank" rel="nofollow noopener noreferrer">Flash播放器</a> 之间传输多媒体流的。因此以前在浏览器中，只要有 Flash 播放器插件，就可以直接在线播放媒体流。然而在2021年左右，谷歌、微软等几大厂商集体做出决策（漏洞安全问题、封闭性、性能等多种因素），正式弃用。在谷歌浏览器 88 版本之后也将 Flash player 正式删除。</p>
<p>现在我们网页端是没法直接播放<code>RTMP</code>的，如果想要播放就必须转换成浏览器中播放器支持的流类型播放，比如：mp4、flv、hls等。</p>
<p>在实际使用场景中我们会用到<code>RTMP</code>的两种传输方式：推送和拉取，即：你可以将自己的视频通过<code>RTMP</code>推送到流媒体服务器和从流媒体拉取对应的流。</p>
<p>常用端口：1935。</p>
<h2>RTSP</h2>
<p>Real Time Streaming Protocol ，简称 <code>RTSP</code>，它本身不会传输媒体流，而是充当客户端和与媒体服务端之间的控制通信，和<code>RTP</code>、<code>RTCP</code> 协议搭配，用于媒体流的传输。</p>
<h2>RTP</h2>
<p>全称：Realtime transport protocol，真正意义上的数据传输协议，数据包构成包含版本号、填充位、标记位、有效荷载类型（这里就是标识不同类型媒体的，比如 H.264 视频、G.711 音频等）、序列号、时间戳等，具体详细解释可以看<a href="https://zh.m.wikipedia.org/zh-hans/%E5%AE%9E%E6%97%B6%E4%BC%A0%E8%BE%93%E5%8D%8F%E8%AE%AE" target="_blank" rel="nofollow noopener noreferrer">这里</a>。</p>
<p>我们只需要知道，RTP 包传输的就是我们音视频会话过程中所需要的流量，当然发送的底层协议还是通过 UDP，因此在前面的数据包构成中，我们可以看到序列号、时间戳参数，目的就是让接收端可以自定义缓冲区，用于乱序纠正或者音画同步。</p>
<h2>RTCP</h2>
<p>全称：Real-time Transport Control Protocol 或 RTP Control Protocol ，或简写 RTCP，是 RTP 的姊妹协议，RTCP 本身并不传输数据，但和上面提到的 RTP 一起协作将媒体数据打包和发送。RTCP 收集相关媒体连接的统计信息，例如：传输字节数、网络状态、丢包状况、单向和双向网络延迟等等，这样可以控制服务质量，诊断网络状况。</p>
<p>我们的课程的主题，WebRTC 实现的会议系统通话过程中数据包的检测、反馈，都是通过这个协议。</p>
<h2>SRS 服务器搭建</h2>
<p>搭建前，按照惯例我们必须要熟悉下 SRS 具体是个什么东西。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/21633c70f0504290922323572e30ae83~tplv-k3u1fbpfcp-zoom-1.image" alt="img"></p>
<p>看上面<a href="https://ossrs.net/lts/zh-cn/docs/v4/doc/introduction" target="_blank" rel="nofollow noopener noreferrer">官网</a>描述，一个简单高效的实时视频服务器，支持各种通用的流媒体协议。常用案例举例：</p>
<ul>
<li>RTMP 服务器；</li>
<li>RTMP 自动转 HLS、FLV；</li>
<li>分布式（K8S）部署；</li>
<li>WebRTC 推流拉流。小册会议功能核心；</li>
<li>HTTP API。可以获取服务端各种推流信息；</li>
<li>DVR 。支持将<code>RTMP</code>流录制成 FLV 或 MP4 文件。</li>
</ul>
<p>还有一些其他的功能，大家课后可以自己看看，这里不再多说。</p>
<p>实际上满足上面条件的开源流媒体服务很多，有大的有小的，比如 <a href="https://github.com/ZLMediaKit/ZLMediaKit" target="_blank" rel="nofollow noopener noreferrer">ZLMediaKit</a>，我们这节课主要是以 SRS 为切入点去实现我们第三套会议系统，等学完后大家可以看看用其他的开源流媒体服务代替 SRS，进而实现多平台兼容的会议系统。</p>
<h3>部署</h3>
<p>考虑到便捷性，我们使用容器化来部署。</p>
<pre><code class="hljs language-yaml"><span class="hljs-string">//</span> <span class="hljs-number">1935 </span><span class="hljs-string">RTMP的常用端口</span>  <span class="hljs-number">1985 </span><span class="hljs-string">API接口端口</span>  <span class="hljs-number">8080</span><span class="hljs-string">默认控制台访问端口</span> <span class="hljs-string">在这里我映射到宿主机8085端口</span>
<span class="hljs-string">docker</span> <span class="hljs-string">run</span> <span class="hljs-string">-d</span> <span class="hljs-string">--name</span> <span class="hljs-string">srs</span> <span class="hljs-string">-p</span> <span class="hljs-number">1935</span><span class="hljs-string">:1935</span> <span class="hljs-string">-p</span> <span class="hljs-number">1985</span><span class="hljs-string">:1985</span> <span class="hljs-string">-p</span> <span class="hljs-number">8085</span><span class="hljs-string">:8080</span> <span class="hljs-string">ossrs/srs:5.0.30</span>
</code></pre>
<p>执行完上面的再继续：</p>
<pre><code class="hljs language-bash">docker <span class="hljs-built_in">cp</span> -a srs:/usr/local/srs/conf /home/srs5/
</code></pre>
<p>这一步的目的是从容器中拷贝配置文件到宿主机的 <code>/home/srs5</code> 目录，因为中间我们可能会配置一些其他的东西，如果在容器内部更改，那么不小心容器被删除，配置历史也就找不到了。</p>
<pre><code class="hljs language-bash">docker <span class="hljs-built_in">rm</span> -f srs
</code></pre>
<p>移除旧的容器，因为我们的目标是从里面拷贝配置文件，因此拷贝完后，这个容器也就没有必要存在了，而我们正式用的容器则是需要挂载上面拷贝配置所启动的容器。</p>
<pre><code class="hljs language-bash">//临时变量，当前服务器的IP，如果是公网服务器的话则为公网IP 用户webrtc UDP 包的传输
CANDIDATE=<span class="hljs-string">"192.168.101.99"</span>
docker run --restart=always -d -v /home/srs5/conf/:/usr/local/srs/conf/ -p 1935:1935 -p 1985:1985 -p 8085:8080 \
    --<span class="hljs-built_in">env</span> CANDIDATE=<span class="hljs-variable">$CANDIDATE</span> -p 8000:8000/udp \
    ossrs/srs:5.0.30 ./objs/srs -c conf/docker.conf
</code></pre>
<p>启动完成后，访问 IP+8085，公网服务器请记得开放安全组和防火墙端口。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1a1bb6f0079b4773bd33dd7b75543a33~tplv-k3u1fbpfcp-zoom-1.image" alt="img"></p>
<p>看到这个界面，则表明 SRS 流媒体服务部署完成，当前界面点击进入 SRS 控制台：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/534315bc657047939e19169576fb3e31~tplv-k3u1fbpfcp-zoom-1.image" alt="img"></p>
<p>更改 API 端口，然后连接到 SRS 控制台实时监控，如下：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0e11f4073e044ef3a2b17bea2ab54f22~tplv-k3u1fbpfcp-zoom-1.image" alt="img"></p>
<h3>FFmpeg 相关命令</h3>
<p>后面的测试需要用到一些 Ffmpeg 基础命令，这里给大家简要介绍下：</p>
<pre><code class="hljs language-diff"><span class="hljs-deletion">-c copy：直接复制，不经过重新编码</span>
<span class="hljs-deletion">-y 覆盖同名输出</span>
<span class="hljs-deletion">-c:v：指定视频编码器 libx265 / libx264</span>
<span class="hljs-deletion">-c:a：指定音频编码器 aac</span>
<span class="hljs-deletion">-i：指定输入文件</span>
<span class="hljs-deletion">-c：指定编码器 </span>
<span class="hljs-deletion">-an： 去除音频</span>
<span class="hljs-deletion">-vn： 去除视频流 </span>
<span class="hljs-deletion">-threads 5 指定多线程数</span>
<span class="hljs-deletion">-preset：指定输出的视频质量，会影响文件的生成速度，有以下几个可用的值 ultrafast, superfast, veryfast, faster, fast, medium, slow, slower, veryslow。</span>
<span class="hljs-deletion">-b 设定视频流量，默认为200Kbit/s 内网设置2048</span>
<span class="hljs-deletion">-b:v  设定视频流量，默认为200Kbit/s 内网设置 2048k 或 1024k</span>
<span class="hljs-deletion">-r 设定帧速率，默认为25</span>
<span class="hljs-deletion">-loop 1 表示图片无限循环</span>
<span class="hljs-deletion">-shortest 表示音频文件结束</span>
<span class="hljs-deletion">-ar 指定音频采样率 比如48000</span>
<span class="hljs-deletion">-ac 设定声音的Channel数</span>
<span class="hljs-deletion">-acodec 设定声音编解码器，未设定时则使用与输入流相同的编解码器</span>
<span class="hljs-deletion">-acodec: 音频选项， 一般后面加copy表示拷贝</span>
<span class="hljs-deletion">-vcodec:视频选项，一般后面加copy表示拷贝 h264则为h264编码</span>
<span class="hljs-deletion">-crf 在优先保证画面质量（也不太在乎转码时间）的情况下，使用-crf参数来控制转码是比较适宜的。这个参数的取值范围为0~51，其中0为无损模式，数值越大，画质越差，生成的文件却越小。从主观上讲，18~28是一个合理的范围。18被认为是视觉无损的（从技术角度上看当然还是有损的），它的输出视频质量和输入视频相当。</span>
</code></pre>
<h3>测试</h3>
<p>我们将某个 mp4 视频推送到流媒体服务器：</p>
<pre><code class="hljs language-bash">ffmpeg -i  http://vfx.mtime.cn/Video/2019/02/04/mp4/190204084208765161.mp4 -c copy -f flv rtmp://192.168.101.99:1935/live/suke01
</code></pre>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9c530fdd951e488e8d3b8922f903ae49~tplv-k3u1fbpfcp-zoom-1.image" alt="img"></p>
<p>然后用 SRS 自带的播放器查看推送的视频：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5f3a2626042a424a9f991fcf45ec41e4~tplv-k3u1fbpfcp-zoom-1.image" alt="img"></p>
<p>上面播放地址我们写的是 <code>FLV</code> 地址，在 Ffmpeg 将视频流通过<code>RTMP</code> 推送到流媒体服务器之后，SRS 会自动将该流转为 <code>FLV</code>，这样就可以直接在网页上播放了。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9d6d002353d64c838a3ab538d6819860~tplv-k3u1fbpfcp-zoom-1.image" alt="img"></p>
<p>上面 SRS 监控台可以实时地看到正在推流的客户端以及播放的客户端，如果某个客户端正在观看视频流，可以通过控制台直接踢掉，而 SRS 的 HTTP API 也是支持这些功能的。</p>
<h2>HTTP API</h2>
<p>访问端口 1985，我们可以看到 SRS API 的版本信息：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/68331416486f4c34aa0f5ef6370a255b~tplv-k3u1fbpfcp-zoom-1.image" alt="img"></p>
<p>在<a href="https://ossrs.net/lts/zh-cn/docs/v4/doc/http-api" target="_blank" rel="nofollow noopener noreferrer">官网</a>也有对应的具体某个 API 的含义。</p>
















































































<table><thead><tr><th>API</th><th>举例</th><th>接口描述</th></tr></thead><tbody><tr><td>versions</td><td>/api/v1/versions</td><td>获取服务器版本信息</td></tr><tr><td>summaries</td><td>/api/v1/summaries</td><td>获取服务器的摘要信息</td></tr><tr><td>rusages</td><td>/api/v1/rusages</td><td>获取服务器资源使用信息</td></tr><tr><td>self_proc_stats</td><td>/api/v1/self_proc_stats</td><td>获取服务器进程信息</td></tr><tr><td>system_proc_stats</td><td>/api/v1/system_proc_stats</td><td>获取服务器所有进程情况</td></tr><tr><td>meminfos</td><td>/api/v1/meminfos</td><td>获取服务器内存使用情况</td></tr><tr><td>features</td><td>/api/v1/features</td><td>获取系统支持的功能列表</td></tr><tr><td>requests</td><td>/api/v1/requests</td><td>获取请求的信息，即当前发起的请求的详细信息</td></tr><tr><td>vhosts</td><td>/api/v1/vhosts</td><td>获取服务器上的vhosts信息</td></tr><tr><td>streams</td><td>/api/v1/streams</td><td>获取服务器的streams信息</td></tr><tr><td>clients</td><td>/api/v1/clients</td><td>获取服务器的clients信息，默认获取前10个</td></tr><tr><td>configs</td><td>/api/v1/configs</td><td>CUID配置，RAW API</td></tr><tr><td>publish</td><td>/rtc/v1/publish/</td><td>WebRTC推流的API</td></tr><tr><td>play</td><td>/rtc/v1/play/</td><td>WebRTC播放流的API</td></tr></tbody></table>
<p>注意最后面两个 API 接口，这两个是 WebRTC 相关的，也是和我们会议系统搭建相关的。</p>
<h2>HTTP 回调</h2>
<p>很多时候你在推流完成之后，如果是在业务中的话，你需要知道推送是否成功，或者其他的反馈，而 HTTP 回调就是干这个事情的。</p>
<pre><code class="hljs language-ruby"> vhost your_vhost {
    http_hooks {
                <span class="hljs-comment"># 启用回调配置</span>
        enabled         on;
                <span class="hljs-regexp">//</span>推流回调配置 回调参数会返回正在推送的流的 host 、ip、client、streamId参数  这些参数在业务中我们可以应用 从而控制对应的推流客户端 支持多个地址配置
        on_publish      <span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/127.0.0.1:8085/api</span><span class="hljs-regexp">/v1/streams</span> <span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/192.168.101.2:8085/api</span><span class="hljs-regexp">/v1/streams</span>;
                <span class="hljs-regexp">//</span>停止推流监听 回调接口
        on_unpublish    <span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/127.0.0.1:8085/api</span><span class="hljs-regexp">/v1/streams</span> <span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/192.168.101.2:8085/api</span><span class="hljs-regexp">/v1/streams</span>;
                <span class="hljs-regexp">//</span>播放回调
        on_play         <span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/127.0.0.1:8085/api</span><span class="hljs-regexp">/v1/sessions</span> <span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/192.168.101.2:8085/api</span><span class="hljs-regexp">/v1/sessions</span>;
       <span class="hljs-regexp">//</span>.....
    }
}
</code></pre>
<p>更多配置大家可以参考 <a href="https://ossrs.net/lts/zh-cn/docs/v4/doc/http-callback" target="_blank" rel="nofollow noopener noreferrer">官网</a> 最新更新。</p>
<h2>课后题</h2>
<p>搭建完成后请大家推流自测，FFmpeg 常用参数以及在线测试视频我在我笔记中也整理了（<a href="https://blog.wangsrbus.cn/archives/ffmpeg-chang-yong-can-shu-yi-ji-hua-zhong-hua-ji-chu-ming-ling.html" target="_blank" rel="nofollow noopener noreferrer">详细点击查看</a>），里面有各种 画中画 画面合成的案例，有问题留言或者在社群里沟通交流。</p></div>
</body></html>