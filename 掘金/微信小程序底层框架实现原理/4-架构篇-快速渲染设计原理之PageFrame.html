<!DOCTYPE html><html lang="en"><head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>第 01 讲：设计一份吸引面试官的简历</title>
<style type="text/css">
:root {
    --control-text-color: #777;
    --select-text-bg-color: rgba(223, 197, 223);  /*#7e66992e;*/
    
    /* side bar */
    --side-bar-bg-color: rgb(255, 255, 255);
    --active-file-text-color: #8163bd;
    --active-file-bg-color: #E9E4F0;
    --item-hover-bg-color: #E9E4F0;
    --active-file-border-color: #8163bd;

    --title-color: #6c549c;
    --font-sans-serif: 'Ubuntu', 'Source Sans Pro', sans-serif !important;
    --font-monospace: 'Fira Code', 'Roboto Mono', monospace !important;
    --purple-1: #8163bd;
    --purple-2: #79589F;
    --purple-3: #fd5eb8;
    --purple-light-1: rgba(99, 99, 172, .05);
    --purple-light-2: rgba(99, 99, 172, .1);
    --purple-light-3: rgba(99, 99, 172, .2);
    --purple-light-4: rgba(129, 99, 189, .3);
    --purple-light-5: #E9E4F0;
    --purple-light-6: rgba(129, 99, 189, .8);
}

/* html {
    font-size: 16px;
} */

body {
    font-family: var(--font-sans-serif);
    color: #34495e;
    -webkit-font-smoothing: antialiased;
    line-height: 1.6rem;
    letter-spacing: 0;
    margin: 0;
    overflow-x: hidden;
}

/* 页边距 和 页面大小 */
#write {
    padding-left: 6ch;
    padding-right: 6ch;
    margin: 0 auto;
}

#write p {
    line-height: 1.6rem;
    word-spacing: .05rem;
}

#write ol li {
    padding-left: 0.5rem;
}

#write > ul:first-child,
#write > ol:first-child {
    margin-top: 30px;
}

body > *:first-child {
    margin-top: 0 !important;
}

body > *:last-child {
    margin-bottom: 0 !important;
}

a {
    color: var(--purple-1);
    padding: 0 2px;
    text-decoration: none;
}
.md-content {
    color: var(--purple-light-6);
}
#write a {
    border-bottom: 1px solid var(--purple-1);
    color: var(--purple-1);
    text-decoration: none;
}

h1,
h2,
h3,
h4,
h5,
h6 {
    position: relative;
    margin-top: 1rem;
    margin-bottom: 0.5rem;
    /* font-weight: bold; */
    font-weight: 500 !important;
    line-height: 1.4;
    cursor: text;
    color: var(--title-color);
    font-family: var(--font-sans-serif);
}

h1:hover a.anchor,
h2:hover a.anchor,
h3:hover a.anchor,
h4:hover a.anchor,
h5:hover a.anchor,
h6:hover a.anchor {
    text-decoration: none;
}

h1 tt,
h1 code {
    font-size: inherit !important;
}
h2 tt,
h2 code {
    font-size: inherit !important;
}
h3 tt,
h3 code {
    font-size: inherit !important;
}
h4 tt,
h4 code {
    font-size: inherit !important;
}
h5 tt,
h5 code {
    font-size: inherit !important;
}
h6 tt,
h6 code {
    font-size: inherit !important;
}


h1 {
    padding-bottom: .4rem;
    font-size: 2.2rem;
    line-height: 1.3;
}
h1 {
    text-align: center;
    padding-bottom: 0.3em;
    font-size: 2.2em;
    line-height: 1.2;
    margin: 2.4em auto 1.2em;
}
h1:after {
    content: '';
    display: block;
    margin: 0.2em auto 0;
    width: 100px;
    height: 2px;
    border-bottom: 2px solid var(--title-color);
}

h2 {
    margin: 1.6em auto 0.5em;
    padding-left: 10px;
    line-height: 1.4;
    font-size: 1.8em;
    border-left: 9px solid var(--title-color);
    border-bottom: 1px solid var(--title-color);
}
h3 {
    font-size: 1.5rem;
    margin: 1.2em auto 0.5em;
}
h4 {
    font-size: 1.3rem;
}
h5 {
    font-size: 1.2rem;
}
h6 {
    font-size: 1.1rem;
}

p,
blockquote,
ul,
ol,
dl,
table {
    margin: 0.8em 0;
}

li > ol,
li > ul {
    margin: 0 0;
}

hr {
    height: 2px;
    padding: 0;
    margin: 16px 0;
    background-color: #e7e7e7;
    border: 0 none;
    overflow: hidden;
    box-sizing: content-box;
}

body > h2:first-child {
    margin-top: 0;
    padding-top: 0;
}

body > h1:first-child {
    margin-top: 0;
    padding-top: 0;
}

body > h1:first-child + h2 {
    margin-top: 0;
    padding-top: 0;
}

body > h3:first-child,
body > h4:first-child,
body > h5:first-child,
body > h6:first-child {
    margin-top: 0;
    padding-top: 0;
}

a:first-child h1,
a:first-child h2,
a:first-child h3,
a:first-child h4,
a:first-child h5,
a:first-child h6 {
    margin-top: 0;
    padding-top: 0;
}

h1 p,
h2 p,
h3 p,
h4 p,
h5 p,
h6 p {
    margin-top: 0;
}

li p.first {
    display: inline-block;
}

ul,
ol {
    padding-left: 30px;
}

ul:first-child,
ol:first-child {
    margin-top: 0;
}

ul:last-child,
ol:last-child {
    margin-bottom: 0;
}

/* 引用 */
blockquote {
    /* margin-left: 1rem; */
    border-left: 4px solid var(--purple-light-4);
    padding: 10px 15px;
    color: #777;
    background-color: var(--purple-light-1);
}

/* 表格 */
table {
    padding: 0;
    word-break: initial;
}

table tr {
    border-top: 1px solid #dfe2e5;
    margin: 0;
    padding: 0;
}

/* 表格 背景色 */
table tr:nth-child(2n),
thead {
    background-color: var(--purple-light-1);
}
#write table thead th {
    background-color: var(--purple-light-2);
}

table tr th {
    font-weight: bold;
    border: 1px solid #dfe2e5;
    border-bottom: 0;
    text-align: left;
    margin: 0;
    padding: 6px 13px;
}

table tr td {
    border: 1px solid #dfe2e5;
    text-align: left;
    margin: 0;
    padding: 6px 13px;
}

table tr th:first-child,
table tr td:first-child {
    margin-top: 0;
}

table tr th:last-child,
table tr td:last-child {
    margin-bottom: 0;
}

/* 粗体 */
#write strong {
    padding: 0 2px;
    color: var(--purple-1);
}

/* 斜体 */
#write em {
    padding: 0 5px 0 2px;
    /* font-style: normal; */
    color: #42b983;
}

/* inline code */
#write code, tt {
    padding: 2px 4px;
    border-radius: 2px;
    font-family: var(--font-monospace);
    font-size: 0.92rem;
    color: var(--purple-3); 
    background-color: rgba(99, 99, 172, .05);
}

tt {
    margin: 0 2px;
}

#write .md-footnote {
    background-color: #f8f8f8;
    color: var(--purple-3);
}

/* heighlight. */
#write mark {
    background-color: #fbd3ea;
    border-radius: 2px;
    padding: 2px 4px;
    margin: 0 2px;
}

#write del {
    padding: 1px 2px;
}

.md-task-list-item > input {
    margin-left: -1.3em;
}

@media print {
    html {
        font-size: 0.9rem;
    }

    table,
    pre {
        page-break-inside: avoid;
    }

    pre {
        word-wrap: break-word;
    }
}

#write pre.md-meta-block {
    padding: 1rem;
    font-size: 85%;
    line-height: 1.45;
    background-color: #f7f7f7;
    border: 0;
    border-radius: 3px;
    color: #777777;
    margin-top: 0 !important;
}

.mathjax-block > .code-tooltip {
    bottom: .375rem;
}

/* 图片 */
.md-image > .md-meta {
    border-radius: 3px;
    font-family: var(--font-monospace);
    padding: 2px 0 0 4px;
    font-size: 0.9em;
    color: inherit;
}
p .md-image:only-child{
    width: auto;
    text-align: left;
    margin-left: 2rem;
}
.md-tag {
    color: inherit;
}
/* 当 “![shadow-随便写]()”写时，会有阴影 */
.md-image img[alt|='shadow'] {
    /* box-shadow: 0 4px 24px -6px #ddd; */
    box-shadow:var(--purple-light-2) 0px 10px 15px;
}

#write a.md-toc-inner {
    line-height: 1.6;
    white-space: pre-line;
    border-bottom: none;
    font-size: 0.9rem;
}

#typora-quick-open {
    border: 1px solid #ddd;
    background-color: #f8f8f8;
}

#typora-quick-open-item {
    background-color: #FAFAFA;
    border-color: #FEFEFE #e5e5e5 #e5e5e5 #eee;
    border-style: solid;
    border-width: 1px;
}

#md-notification:before {
    top: 10px;
}

header,
.context-menu,
.megamenu-content,
footer {
    font-family: var(--font-sans-serif);
}

.file-node-content:hover .file-node-icon,
.file-node-content:hover .file-node-open-state {
    visibility: visible;
}

.md-lang {
    color: #b4654d;
}

.html-for-mac .context-menu {
    --item-hover-bg-color: #E6F0FE;
}

/* 代码框 */
/* CodeMirror 3024 Day theme */

/* 代码段 背景 */
pre {
    --select-text-bg-color: rgba(223, 197, 223) !important;
    margin: .5em 0;
    padding: 1em 1.4em;
    border-radius: 8px;
    background: #f6f8fa;
    overflow-x: auto;
    box-sizing: border-box;
    font-size: 14px;
}

/* 边框 */
.md-fences {
    border: 1px solid #e7eaed;
    border-radius: 3px;
}

.cm-s-inner {
  padding: .25rem;
  border-radius: .25rem;
}

.cm-s-inner.CodeMirror, .cm-s-inner .CodeMirror-gutters {
  background-color: #f8f8f8 !important;
  color: #3a3432 !important;
  border: none;
}

.cm-s-inner .CodeMirror-gutters {
  color: #6d8a88;
}

.cm-s-inner .CodeMirror-cursor {
  border-left: solid thin #5c5855 !important;
}

.cm-s-inner .CodeMirror-linenumber {
  color: #807d7c;
}

.cm-s-inner .CodeMirror-line::selection, .cm-s-inner .CodeMirror-line::-moz-selection,
.cm-s-inner .CodeMirror-line > span::selection,
.cm-s-inner .CodeMirror-line > span::-moz-selection,
.cm-s-inner .CodeMirror-line > span > span::selection,
.cm-s-inner .CodeMirror-line > span > span::-moz-selection {
  background: var(--purple-light-2);
}

.cm-s-inner span.cm-comment {
  color: #cdab53;
}

.cm-s-inner span.cm-string, .cm-s-inner span.cm-string-2 {
  color: #f2b01d;
}

.cm-s-inner span.cm-number {
  color: #a34e8f;
}

.cm-s-inner span.cm-variable {
  color: #01a252;
}

.cm-s-inner span.cm-variable-2 {
  color: #01a0e4;
}

.cm-s-inner span.cm-def {
  /* color: #e8bbd0; */
  color: #e2287f;
}

.cm-s-inner span.cm-operator {
  color: #ff79c6;
}

.cm-s-inner span.cm-keyword {
  color: #db2d20;
}

.cm-s-inner span.cm-atom {
  color: #a34e8f;
}

.cm-s-inner span.cm-meta {
  color: inherit;
}

.cm-s-inner span.cm-tag {
  color: #db2d20;
}

.cm-s-inner span.cm-attribute {
  color: #01a252;
}

.cm-s-inner span.cm-qualifier {
  color: #388aa3;
}

.cm-s-inner span.cm-property {
  color: #01a252;
}

.cm-s-inner span.cm-builtin {
  color: #388aa3;
}

.cm-s-inner span.cm-variable-3, .cm-s-inner span.cm-type {
  color: #ffb86c;
}

.cm-s-inner span.cm-bracket {
  color: #3a3432;
}

.cm-s-inner span.cm-link {
  color: #a34e8f;
}

.cm-s-inner span.cm-error {
  background: #db2d20;
  color: #5c5855;
}

/* .md-fences.md-focus .cm-s-inner .CodeMirror-activeline-background {
  background: var(--purple-light-2);
} */

.cm-s-inner .CodeMirror-matchingbracket {
  text-decoration: underline;
  color: #a34e8f !important;
}

#fences-auto-suggest .active {
  background: #ddd;
}

#write .code-tooltip {
  bottom: initial;
  top: calc(100% - 1px);
  background: #f7f7f7;
  border: 1px solid #ddd;
  border-top: 0;
}

.auto-suggest-container {
  border-color: #b4b4b4;
}

.auto-suggest-container .autoComplt-hint.active {
  background: #b4b4b4;
  color: inherit;
}

/* task list */
#write .md-task-list-item > input {
  -webkit-appearance: initial;
  display: block;
  position: absolute;
  border: 1px solid #b4b4b4;
  border-radius: .25rem;
  margin-top: .1rem;
  margin-left: -1.8rem;
  height: 1.2rem;
  width: 1.2rem;
  transition: background 0.3s;
}

#write .md-task-list-item > input:focus {
  outline: none;
  box-shadow: none;
}

#write .md-task-list-item > input:hover {
  background: #ddd;
}

#write .md-task-list-item > input[checked]::before {
  content: '';
  position: absolute;
  top: 20%;
  left: 50%;
  height: 60%;
  width: 2px;
  transform: rotate(40deg);
  background: #333;
}

#write .md-task-list-item > input[checked]::after {
  content: '';
  position: absolute;
  top: 46%;
  left: 25%;
  height: 30%;
  width: 2px;
  transform: rotate(-40deg);
  background: #333;
}

#write .md-task-list-item > p {
  transition: color 0.3s, opacity 0.3s;
}

#write .md-task-list-item.task-list-done > p {
  color: #b4b4b4;
  text-decoration: line-through;
}

#write .md-task-list-item.task-list-done > p > .md-emoji {
  opacity: .5;
}

#write .md-task-list-item.task-list-done > p > .md-link > a {
  opacity: .6;
}

/* sidebar and outline */
.pin-outline .outline-active {
  color: var(--active-file-text-color); 
}

.file-list-item {
    border-bottom: 1px solid;
    border-color: var(--purple-light-5);
}

.file-list-item-summary {
    font-weight: 400;
}

.file-list-item.active {
    color: var(--active-file-text-color);
    background-color: var(--purple-light-5);
}

.file-tree-node.active>.file-node-background {
    background-color: var(--purple-light-5);
    font-weight: 700;
} 

.file-tree-node.active>.file-node-content {
    color: var(--active-file-text-color);
    font-weight: 700;
}

.file-node-content {
    color: #5e676d;
}

.sidebar-tabs {
    border-bottom: none;
}
.sidebar-tab.active {
    font-weight: 400;
}

.sidebar-content-content {
    font-size: 0.9rem;
}

img {
    max-width: 100%;
}

body {
    background-color: rgb(237, 237, 237);
}
#content {
    width: 836px;
    padding: 50px;
    background: #fff;
    margin: 0 auto;
}/*# sourceURL=/Users/young/Documents/Codes/Fun/lagou/public/purple.css*/</style><style type="text/css">.hljs{display:block;overflow-x:auto;padding:.5em;color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}/*# sourceURL=/Users/young/Documents/Codes/Fun/lagou/public/atom-one-light.min.css*/</style></head>
<body>
<div id="content"><h1>架构篇-快速渲染设计原理之PageFrame</h1>
<h2>前言</h2>
<p>本章内容分解如下：</p>
<ul>
<li>小程序如何做到快速打开新页面</li>
<li>小程序快速渲染流程原理</li>
<li>webview-pageFrame设计原理</li>
</ul>
<h2>PageFrame</h2>
<p>还记得在前面文章中我们寻找渲染层的时候，找到了个奇怪的<code>webview</code>。</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8f882cd51b5642b6980890c252a591f4~tplv-k3u1fbpfcp-watermark.image" alt="image.png"></p>
<p><code>pageFrame</code>这个<code>webview</code>是干嘛的呢？我们这章节就来探索一下。</p>
<p>我们在写小程序页面视图时，貌似并不关心<code>webview</code>中的html结构，这些都是小程序底层帮我们实现，我们只需要写页面ui和业务逻辑即可。下面我们来看看view视图层小程序帮我们做了什么。先来看一下视图层<code>pageframe.html</code>的模板：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/75b040d04f4347be9e3cad790f14c323~tplv-k3u1fbpfcp-watermark.image" alt="image.png"></p>
<p>为了讲解便利，中间部分代码由标识进行替代。从上图上看来是不是和渲染层的<code>HTML</code>非常像。这个<code>webview</code>其实就是一个用来新渲染<code>webview</code>的模板。</p>
<p>我们已知在小程序中使用 WXML 文件描述页面的结构，WXSS 文件描述页面的样式，WXML文件会被编译为虚拟DOM，WXSS会被编译为js。那么每个独立的页面都会经过这样的编译，如何快速的生成webview，或者说如何快速的打开一个页面。会成为一个问题。我们有了虚拟DOM和样式描述表就可以渲染页面了吗。还远远不够。</p>
<p>先分析一下<code>pageFrame</code>的html结构中注入的js资源：</p>
<ul>
<li>
<p><code>./__dev__/wxconfig.js</code>:</p>
<p>小程序默认总配置项，包括用户自定义与系统默认的整合结果。在控制台输入<code>__wxConfig</code>可以看出打印结果
<img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/98711d7ce0534a49ac267da9c6ed6157~tplv-k3u1fbpfcp-watermark.image" alt=""></p>
</li>
<li>
<p><code>./__dev__/devtoolsconfig.js</code></p>
<p>小程序开发者配置，包括<code>navigationBarHeight</code>,标题栏的高度，状态栏高度，等等，控制台输入<code>__devtoolsconfig</code>可以看到其对应的信息</p>
</li>
</ul>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f2a4b4b34fbf494c87b9f20e47785f81~tplv-k3u1fbpfcp-watermark.image" alt="image.png"></p>
<ul>
<li>
<p><code>./__dev__/deviceinfo.js</code></p>
<p>设备信息，包含<code>尺寸/像素点pixelRatio</code></p>
</li>
<li>
<p><code>__dev__/jsdebug.js</code></p>
<p>debug工具。</p>
</li>
<li>
<p><code>./__dev__/WAWebview.js</code></p>
<p>渲染层底层基础库</p>
</li>
<li>
<p><code>./__dev__/hls.js</code></p>
<p>优秀的视频流处理工具。</p>
</li>
<li>
<p><code>./__dev__/WARemoteDebug.js</code></p>
<p>底层基础库调试工具</p>
</li>
</ul>
<p>可以看到pageFrame注入的脚本与我们分析<code>pages/index</code>渲染层webview是一样的。正式因为pageFrame快速启动技术，就像一个工厂一样，可以快速生成webview的基础格式。在这其中pageFrame就是业务webview的模板。</p>
<p>我们继续往下分析，有一些不一样的地方。</p>
<ul>
<li><code>&#x3C;!-- wxappcode --></code></li>
</ul>
<p>可以发现pageFrame中包含一些注释的单词，这些注释的单词为注释占位符，如果你细心对比就会发现，在前面分析渲染层代码的时候，我们见到过这些注释占位符编译后的样子。</p>
<p>比如wxappcode.js在渲染层中为如下形式（老版本基础库）</p>
<p><code>&#x3C;script src="./__dev__/wxappcode.js" chartset="UTF-8">&#x3C;/script></code></p>
<p>或者是这样（新版本基础库）</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4bc422f3ef45495e94bfc334ac6afd90~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p>
<p>无论新老版本，其中的代码都是一样的。我们先看一下内部结构。</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1d3418abe1d84490b664bb341ec19b64~tplv-k3u1fbpfcp-watermark.image" alt="image.png"></p>
<p>文件中包含了所有页面的编译路径，这个编译路径有什么作用呢，小册后面章节virtualDOM章节中，编译<code>WXML</code>后生成的<code>$gwx</code>函数需要的参数就是这个路径。此文件中就进行了保存。</p>
<p>再接着看的话会看到WXSS章节讲到的编译后的WXSS，就跟我们在渲染层看到的一样，<code>eval(setCssToHead....)</code>。</p>
<p>内部记录的属性有：</p>
<ul>
<li><code>decodePathName</code></li>
<li><code>.json</code>配置</li>
<li><code>.wxml</code>编译后的<code>$gwx</code>函数。<code>$gwx</code>函数会在virtualDOM章节重点讲解。</li>
<li><code>.wxss</code>编译后的<code>eval</code>函数。</li>
</ul>
<p>这里就可以想象出来，如果小程序需要打开某个页面的时候，只需要从这里提取出页面特有的这几个属性，配合<code>pageFrame</code>模板就可以快速生成一个新的webview。</p>
<p>那么具体快速启动的方案是怎样的呢？我们继续探索</p>
<h2>如何快速启动</h2>
<p>我们看一下官方给予的一段描述：</p>
<p>在视图层内，小程序的每一个页面都独立运行在一个页面层级上。小程序启动时仅有一个页面层级，每次调用<code>wx.navigateTo</code>，都会创建一个新的页面层级；相对地，<code>wx.navigateBack</code>会销毁一个页面层级。
对于每一个新的页面层级，视图层都需要进行一些额外的准备工作。在小程序启动前，微信会提前准备好一个页面层级用于展示小程序的首页。除此以外，每当一个页面层级被用于渲染页面，微信都会提前开始准备一个新的页面层级，使得每次调用<code>wx.navigateTo</code>都能够尽快展示一个新的页面。
页面层级的准备工作分为三个阶段。第一阶段是启动一个<code>WebView</code>，在iOS和<code>Android</code>系统上，操作系统启动WebView都需要一小段时间。第二阶段是在<code>WebView</code>中初始化基础库，此时还会进行一些基础库内部优化，以提升页面渲染性能。第三阶段是注入小程序<code>WXML</code>结构和<code>WXSS</code>样式，使小程序能在接收到页面初始数据之后马上开始渲染页面（这一阶段无法在小程序启动前执行）。</p>
<p>对于<code>wx.redirectTo</code>，这个调用不会打开一个新的页面层级，而是将当前页面层级重新初始化：重新传入页面的初始数据、路径等，视图层清空当前页面层级的渲染结果然后重新渲染页面。</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f201e6d2de9e41c4b01c3dc589abdc8a~tplv-k3u1fbpfcp-watermark.image" alt="image.png"></p>
<p>我们对官方的这段描述进行一个解释：</p>
<p>视图层内，每个页面我们已经知道了都是一个webview，当小程序启动的时候只有一个首页webview,我们前面的例子中为<code>pages/index</code>页面。</p>
<p>我们在去寻找index页面的渲染层的时候做过这样一件事情，寻找webview标签，进入渲染层的控制台。在寻找webview渲染层的时候，我们找到了四个webview</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/036782085ddf4c5d86a3fb9483c2ef15~tplv-k3u1fbpfcp-watermark.image" alt=""></p>
<ul>
<li>pages/index</li>
<li>pages/pageFrame</li>
<li>appService.js // 逻辑层</li>
<li>微信开发者工具</li>
</ul>
<p><code>wx.navigateTo</code>为新开一个页面，在微信小程序中的表现形式为从右往左划出来的一个页面，为什么如此的丝滑，想必与<code>pageFrame</code>这层<code>webview</code>密不可分。在执行<code>wx.navigateTo</code>新开一个页面的时候，就是创建一个新的webview并插入到视图层中。这里忘记的可以返回到<code>webview</code>章节，有一个部分专门解释了五个<code>webview</code>的部分，并且创建新<code>webview</code>并插入这个操作是有最大值限制的，有关于性能方面的考虑。</p>
<p><code>wx.navigateBack</code>则为销毁webview。</p>
<p>我们在打开<code>pages/logs/logs</code>视图页面时，发现dom中多加载了一个<code>__pageframe__/pageframe.html</code>的视图层，其模板内容正如上方描述的。这个视图层的作用正是为了小程序提前为一个新的页面层准备的。</p>
<p>小程序每个视图层页面内容都是通过<code>pageframe.html</code>模板来生成的，包括小程序启动的首页；下面来看看小程序为快速打开小程序页面做的技术优化：</p>
<ul>
<li>首页启动时，即第一次通过<code>pageframe.html</code>生成内容后，后台服务会缓存<code>pageframe.html</code>模板首次生成的html内容。</li>
<li>非首次新打开页面时，页面请求的<code>pageframe.html</code>内容直接走后台缓存</li>
<li>非首次新打开页面时，<code>pageframe.html</code>页面引入的外链js资源(如上图所示)走本地缓存</li>
</ul>
<p>这样在后续新打开页面时，都会走缓存的<code>pageframe</code>的内容，避免重复生成，快速打开一个新页面。</p>
<p>那么视图层新打开页面的流程是怎样的呢？</p>
<p>其实在小程序开发者工具实现中，在创建每个视图层页的webview时，都会为其绑定了<code>onLoadCommit</code>事件(它会在页面加载完成后触发，包含当前文档的导航和副框架的文档加载)。初始时<code>webview</code>的src会被指定为空页面地址<code>http://127.0.0.1:${global.proxyPort}/aboutblank?${c}</code>，其中<code>c</code>为对应<code>webview</code>的<code>id</code>。<code>webview</code>从空页面到具体页面视图的过程如下：</p>
<ol>
<li>空页面地址webview加载完毕后执行事件中的<code>reload</code>方法，即设置<code>webview</code>的<code>src</code>为<code>pageframe</code>地址</li>
<li>加载完成后，设置其src为<code>pageframe.html</code>, 新的src内容加载完成后再次触发<code>onLoadCommit</code>事件但根据条件不会执行<code>reload</code>方法。</li>
<li><code>pageframe.html</code>页面在<code>dom ready</code>之后触发注入并执行具体页面相关的代码，此时通过<code>history.pushState</code>方法修改webview的src但是webview并不会发送页面请求。</li>
</ol>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/81398349fb3d41cc8d58acfe078b17ee~tplv-k3u1fbpfcp-watermark.image" alt="image.png"></p>
<p><code>pageframe.html</code>模板生成的内容除小程序基础库视图层的底层功能之外，还包括小程序所有页面的模板信息、配置信息以及样式内容，这些在上方讲解的<code>wxappcode.js</code>文件中已经了解过了。</p>
<p>那么，既然每个视图层页面由<code>pageframe</code>模板生成，那么小程序每个页面独有的页面内容如<code>dom</code>和样式等如何生成呢，这主要是利用<code>nw.js</code>的<code>executeScript</code>方法来执行一段js脚本来注入只与当前页面相关的代码，包括当前页面的配置，注入当前页的css以及当前页面的<code>virtual dom</code>的生成.</p>
<p>最终生成的js代码（拿<code>pages/index/index</code>为例）如下图：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/54791d0a3f514a309af3b23f705c89e1~tplv-k3u1fbpfcp-watermark.image" alt="image.png"></p>
<p>其中：</p>
<p><code>history.pushState('','', 'http://127.0.0.1:63444/__pageframe__/pages/index/index')</code>
这句代码的作用修改当前webview的src，因为视图层的webview的src为<code>pageframe.html</code>，通过这句代码将其变更为具体的页面地址。</p>
<p>另外，需要注意的是<code>nw.js</code>的<code>executeScript</code>方法注入的代码是需要时机的，需要等到视图层的初始化工作准备<code>ready</code>之后才行，那么这个时机如何知道呢？细心的读者可能发现，在<code>pageframe</code>模板的最后一个<code>script</code>的内容:</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bc953d61447d4a379643c338b84f79cd~tplv-k3u1fbpfcp-watermark.image" alt="image.png"></p>
<p>这个从字面意思可以看出此时应该是页面<code>dom ready</code>的一个时机，通过<code>alert</code>来进行通知。</p>
<p><code>alert</code>能通知消息？</p>
<p>当然可以的，在<code>nw.js</code>的<code>webview</code>中<code>alert</code>、<code>prompt</code>对应的弹框是被会阻止的，那么通过为<code>webview</code>绑定<code>dialog</code>事件来知道是那种弹框类型，以及提示内容.恍然大悟了没有？</p>
<p>如果你尝试直接打开在<code>webview</code>层的src地址，你会发现只有一个弹窗出现，你会很疑惑。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d54d32840ee9475ba9f8b2a4196d6167~tplv-k3u1fbpfcp-watermark.image" alt="image.png"></p>
<p>这样方法<code>loadPage</code>就会触发nw注入并执行页面相关的代码。最终生成的页面视图对应<code>dom</code>结构如下图：</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/965776ccc3444b45b56a3af5ff61048a~tplv-k3u1fbpfcp-watermark.image" alt="image.png"></p>
<p>可以看出，视图页面生成的<code>dom</code>结构中，<code>document.body</code>已无<code>pageframe.html</code>模板中对应body中的<code>script</code>内容，这是因为视图层的<code>WAWebview.js</code>在通过<code>virtual dom</code>生成真实dom过程中，它会挂载到页面的<code>document.body</code>上，覆盖掉<code>pageframe.html</code>模板中对应<code>document.body</code>的内容。</p>
<p>这样的话就完成了一套快速渲染过程。</p></div>
</body></html>