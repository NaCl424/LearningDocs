<!DOCTYPE html><html lang="en"><head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>第 01 讲：设计一份吸引面试官的简历</title>
<style type="text/css">
:root {
    --control-text-color: #777;
    --select-text-bg-color: rgba(223, 197, 223);  /*#7e66992e;*/
    
    /* side bar */
    --side-bar-bg-color: rgb(255, 255, 255);
    --active-file-text-color: #8163bd;
    --active-file-bg-color: #E9E4F0;
    --item-hover-bg-color: #E9E4F0;
    --active-file-border-color: #8163bd;

    --title-color: #6c549c;
    --font-sans-serif: 'Ubuntu', 'Source Sans Pro', sans-serif !important;
    --font-monospace: 'Fira Code', 'Roboto Mono', monospace !important;
    --purple-1: #8163bd;
    --purple-2: #79589F;
    --purple-3: #fd5eb8;
    --purple-light-1: rgba(99, 99, 172, .05);
    --purple-light-2: rgba(99, 99, 172, .1);
    --purple-light-3: rgba(99, 99, 172, .2);
    --purple-light-4: rgba(129, 99, 189, .3);
    --purple-light-5: #E9E4F0;
    --purple-light-6: rgba(129, 99, 189, .8);
}

/* html {
    font-size: 16px;
} */

body {
    font-family: var(--font-sans-serif);
    color: #34495e;
    -webkit-font-smoothing: antialiased;
    line-height: 1.6rem;
    letter-spacing: 0;
    margin: 0;
    overflow-x: hidden;
}

/* 页边距 和 页面大小 */
#write {
    padding-left: 6ch;
    padding-right: 6ch;
    margin: 0 auto;
}

#write p {
    line-height: 1.6rem;
    word-spacing: .05rem;
}

#write ol li {
    padding-left: 0.5rem;
}

#write > ul:first-child,
#write > ol:first-child {
    margin-top: 30px;
}

body > *:first-child {
    margin-top: 0 !important;
}

body > *:last-child {
    margin-bottom: 0 !important;
}

a {
    color: var(--purple-1);
    padding: 0 2px;
    text-decoration: none;
}
.md-content {
    color: var(--purple-light-6);
}
#write a {
    border-bottom: 1px solid var(--purple-1);
    color: var(--purple-1);
    text-decoration: none;
}

h1,
h2,
h3,
h4,
h5,
h6 {
    position: relative;
    margin-top: 1rem;
    margin-bottom: 0.5rem;
    /* font-weight: bold; */
    font-weight: 500 !important;
    line-height: 1.4;
    cursor: text;
    color: var(--title-color);
    font-family: var(--font-sans-serif);
}

h1:hover a.anchor,
h2:hover a.anchor,
h3:hover a.anchor,
h4:hover a.anchor,
h5:hover a.anchor,
h6:hover a.anchor {
    text-decoration: none;
}

h1 tt,
h1 code {
    font-size: inherit !important;
}
h2 tt,
h2 code {
    font-size: inherit !important;
}
h3 tt,
h3 code {
    font-size: inherit !important;
}
h4 tt,
h4 code {
    font-size: inherit !important;
}
h5 tt,
h5 code {
    font-size: inherit !important;
}
h6 tt,
h6 code {
    font-size: inherit !important;
}


h1 {
    padding-bottom: .4rem;
    font-size: 2.2rem;
    line-height: 1.3;
}
h1 {
    text-align: center;
    padding-bottom: 0.3em;
    font-size: 2.2em;
    line-height: 1.2;
    margin: 2.4em auto 1.2em;
}
h1:after {
    content: '';
    display: block;
    margin: 0.2em auto 0;
    width: 100px;
    height: 2px;
    border-bottom: 2px solid var(--title-color);
}

h2 {
    margin: 1.6em auto 0.5em;
    padding-left: 10px;
    line-height: 1.4;
    font-size: 1.8em;
    border-left: 9px solid var(--title-color);
    border-bottom: 1px solid var(--title-color);
}
h3 {
    font-size: 1.5rem;
    margin: 1.2em auto 0.5em;
}
h4 {
    font-size: 1.3rem;
}
h5 {
    font-size: 1.2rem;
}
h6 {
    font-size: 1.1rem;
}

p,
blockquote,
ul,
ol,
dl,
table {
    margin: 0.8em 0;
}

li > ol,
li > ul {
    margin: 0 0;
}

hr {
    height: 2px;
    padding: 0;
    margin: 16px 0;
    background-color: #e7e7e7;
    border: 0 none;
    overflow: hidden;
    box-sizing: content-box;
}

body > h2:first-child {
    margin-top: 0;
    padding-top: 0;
}

body > h1:first-child {
    margin-top: 0;
    padding-top: 0;
}

body > h1:first-child + h2 {
    margin-top: 0;
    padding-top: 0;
}

body > h3:first-child,
body > h4:first-child,
body > h5:first-child,
body > h6:first-child {
    margin-top: 0;
    padding-top: 0;
}

a:first-child h1,
a:first-child h2,
a:first-child h3,
a:first-child h4,
a:first-child h5,
a:first-child h6 {
    margin-top: 0;
    padding-top: 0;
}

h1 p,
h2 p,
h3 p,
h4 p,
h5 p,
h6 p {
    margin-top: 0;
}

li p.first {
    display: inline-block;
}

ul,
ol {
    padding-left: 30px;
}

ul:first-child,
ol:first-child {
    margin-top: 0;
}

ul:last-child,
ol:last-child {
    margin-bottom: 0;
}

/* 引用 */
blockquote {
    /* margin-left: 1rem; */
    border-left: 4px solid var(--purple-light-4);
    padding: 10px 15px;
    color: #777;
    background-color: var(--purple-light-1);
}

/* 表格 */
table {
    padding: 0;
    word-break: initial;
}

table tr {
    border-top: 1px solid #dfe2e5;
    margin: 0;
    padding: 0;
}

/* 表格 背景色 */
table tr:nth-child(2n),
thead {
    background-color: var(--purple-light-1);
}
#write table thead th {
    background-color: var(--purple-light-2);
}

table tr th {
    font-weight: bold;
    border: 1px solid #dfe2e5;
    border-bottom: 0;
    text-align: left;
    margin: 0;
    padding: 6px 13px;
}

table tr td {
    border: 1px solid #dfe2e5;
    text-align: left;
    margin: 0;
    padding: 6px 13px;
}

table tr th:first-child,
table tr td:first-child {
    margin-top: 0;
}

table tr th:last-child,
table tr td:last-child {
    margin-bottom: 0;
}

/* 粗体 */
#write strong {
    padding: 0 2px;
    color: var(--purple-1);
}

/* 斜体 */
#write em {
    padding: 0 5px 0 2px;
    /* font-style: normal; */
    color: #42b983;
}

/* inline code */
#write code, tt {
    padding: 2px 4px;
    border-radius: 2px;
    font-family: var(--font-monospace);
    font-size: 0.92rem;
    color: var(--purple-3); 
    background-color: rgba(99, 99, 172, .05);
}

tt {
    margin: 0 2px;
}

#write .md-footnote {
    background-color: #f8f8f8;
    color: var(--purple-3);
}

/* heighlight. */
#write mark {
    background-color: #fbd3ea;
    border-radius: 2px;
    padding: 2px 4px;
    margin: 0 2px;
}

#write del {
    padding: 1px 2px;
}

.md-task-list-item > input {
    margin-left: -1.3em;
}

@media print {
    html {
        font-size: 0.9rem;
    }

    table,
    pre {
        page-break-inside: avoid;
    }

    pre {
        word-wrap: break-word;
    }
}

#write pre.md-meta-block {
    padding: 1rem;
    font-size: 85%;
    line-height: 1.45;
    background-color: #f7f7f7;
    border: 0;
    border-radius: 3px;
    color: #777777;
    margin-top: 0 !important;
}

.mathjax-block > .code-tooltip {
    bottom: .375rem;
}

/* 图片 */
.md-image > .md-meta {
    border-radius: 3px;
    font-family: var(--font-monospace);
    padding: 2px 0 0 4px;
    font-size: 0.9em;
    color: inherit;
}
p .md-image:only-child{
    width: auto;
    text-align: left;
    margin-left: 2rem;
}
.md-tag {
    color: inherit;
}
/* 当 “![shadow-随便写]()”写时，会有阴影 */
.md-image img[alt|='shadow'] {
    /* box-shadow: 0 4px 24px -6px #ddd; */
    box-shadow:var(--purple-light-2) 0px 10px 15px;
}

#write a.md-toc-inner {
    line-height: 1.6;
    white-space: pre-line;
    border-bottom: none;
    font-size: 0.9rem;
}

#typora-quick-open {
    border: 1px solid #ddd;
    background-color: #f8f8f8;
}

#typora-quick-open-item {
    background-color: #FAFAFA;
    border-color: #FEFEFE #e5e5e5 #e5e5e5 #eee;
    border-style: solid;
    border-width: 1px;
}

#md-notification:before {
    top: 10px;
}

header,
.context-menu,
.megamenu-content,
footer {
    font-family: var(--font-sans-serif);
}

.file-node-content:hover .file-node-icon,
.file-node-content:hover .file-node-open-state {
    visibility: visible;
}

.md-lang {
    color: #b4654d;
}

.html-for-mac .context-menu {
    --item-hover-bg-color: #E6F0FE;
}

/* 代码框 */
/* CodeMirror 3024 Day theme */

/* 代码段 背景 */
pre {
    --select-text-bg-color: rgba(223, 197, 223) !important;
    margin: .5em 0;
    padding: 1em 1.4em;
    border-radius: 8px;
    background: #f6f8fa;
    overflow-x: auto;
    box-sizing: border-box;
    font-size: 14px;
}

/* 边框 */
.md-fences {
    border: 1px solid #e7eaed;
    border-radius: 3px;
}

.cm-s-inner {
  padding: .25rem;
  border-radius: .25rem;
}

.cm-s-inner.CodeMirror, .cm-s-inner .CodeMirror-gutters {
  background-color: #f8f8f8 !important;
  color: #3a3432 !important;
  border: none;
}

.cm-s-inner .CodeMirror-gutters {
  color: #6d8a88;
}

.cm-s-inner .CodeMirror-cursor {
  border-left: solid thin #5c5855 !important;
}

.cm-s-inner .CodeMirror-linenumber {
  color: #807d7c;
}

.cm-s-inner .CodeMirror-line::selection, .cm-s-inner .CodeMirror-line::-moz-selection,
.cm-s-inner .CodeMirror-line > span::selection,
.cm-s-inner .CodeMirror-line > span::-moz-selection,
.cm-s-inner .CodeMirror-line > span > span::selection,
.cm-s-inner .CodeMirror-line > span > span::-moz-selection {
  background: var(--purple-light-2);
}

.cm-s-inner span.cm-comment {
  color: #cdab53;
}

.cm-s-inner span.cm-string, .cm-s-inner span.cm-string-2 {
  color: #f2b01d;
}

.cm-s-inner span.cm-number {
  color: #a34e8f;
}

.cm-s-inner span.cm-variable {
  color: #01a252;
}

.cm-s-inner span.cm-variable-2 {
  color: #01a0e4;
}

.cm-s-inner span.cm-def {
  /* color: #e8bbd0; */
  color: #e2287f;
}

.cm-s-inner span.cm-operator {
  color: #ff79c6;
}

.cm-s-inner span.cm-keyword {
  color: #db2d20;
}

.cm-s-inner span.cm-atom {
  color: #a34e8f;
}

.cm-s-inner span.cm-meta {
  color: inherit;
}

.cm-s-inner span.cm-tag {
  color: #db2d20;
}

.cm-s-inner span.cm-attribute {
  color: #01a252;
}

.cm-s-inner span.cm-qualifier {
  color: #388aa3;
}

.cm-s-inner span.cm-property {
  color: #01a252;
}

.cm-s-inner span.cm-builtin {
  color: #388aa3;
}

.cm-s-inner span.cm-variable-3, .cm-s-inner span.cm-type {
  color: #ffb86c;
}

.cm-s-inner span.cm-bracket {
  color: #3a3432;
}

.cm-s-inner span.cm-link {
  color: #a34e8f;
}

.cm-s-inner span.cm-error {
  background: #db2d20;
  color: #5c5855;
}

/* .md-fences.md-focus .cm-s-inner .CodeMirror-activeline-background {
  background: var(--purple-light-2);
} */

.cm-s-inner .CodeMirror-matchingbracket {
  text-decoration: underline;
  color: #a34e8f !important;
}

#fences-auto-suggest .active {
  background: #ddd;
}

#write .code-tooltip {
  bottom: initial;
  top: calc(100% - 1px);
  background: #f7f7f7;
  border: 1px solid #ddd;
  border-top: 0;
}

.auto-suggest-container {
  border-color: #b4b4b4;
}

.auto-suggest-container .autoComplt-hint.active {
  background: #b4b4b4;
  color: inherit;
}

/* task list */
#write .md-task-list-item > input {
  -webkit-appearance: initial;
  display: block;
  position: absolute;
  border: 1px solid #b4b4b4;
  border-radius: .25rem;
  margin-top: .1rem;
  margin-left: -1.8rem;
  height: 1.2rem;
  width: 1.2rem;
  transition: background 0.3s;
}

#write .md-task-list-item > input:focus {
  outline: none;
  box-shadow: none;
}

#write .md-task-list-item > input:hover {
  background: #ddd;
}

#write .md-task-list-item > input[checked]::before {
  content: '';
  position: absolute;
  top: 20%;
  left: 50%;
  height: 60%;
  width: 2px;
  transform: rotate(40deg);
  background: #333;
}

#write .md-task-list-item > input[checked]::after {
  content: '';
  position: absolute;
  top: 46%;
  left: 25%;
  height: 30%;
  width: 2px;
  transform: rotate(-40deg);
  background: #333;
}

#write .md-task-list-item > p {
  transition: color 0.3s, opacity 0.3s;
}

#write .md-task-list-item.task-list-done > p {
  color: #b4b4b4;
  text-decoration: line-through;
}

#write .md-task-list-item.task-list-done > p > .md-emoji {
  opacity: .5;
}

#write .md-task-list-item.task-list-done > p > .md-link > a {
  opacity: .6;
}

/* sidebar and outline */
.pin-outline .outline-active {
  color: var(--active-file-text-color); 
}

.file-list-item {
    border-bottom: 1px solid;
    border-color: var(--purple-light-5);
}

.file-list-item-summary {
    font-weight: 400;
}

.file-list-item.active {
    color: var(--active-file-text-color);
    background-color: var(--purple-light-5);
}

.file-tree-node.active>.file-node-background {
    background-color: var(--purple-light-5);
    font-weight: 700;
} 

.file-tree-node.active>.file-node-content {
    color: var(--active-file-text-color);
    font-weight: 700;
}

.file-node-content {
    color: #5e676d;
}

.sidebar-tabs {
    border-bottom: none;
}
.sidebar-tab.active {
    font-weight: 400;
}

.sidebar-content-content {
    font-size: 0.9rem;
}

img {
    max-width: 100%;
}

body {
    background-color: rgb(237, 237, 237);
}
#content {
    width: 836px;
    padding: 50px;
    background: #fff;
    margin: 0 auto;
}/*# sourceURL=/Users/young/Documents/Codes/Fun/lagou/public/purple.css*/</style><style type="text/css">.hljs{display:block;overflow-x:auto;padding:.5em;color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}/*# sourceURL=/Users/young/Documents/Codes/Fun/lagou/public/atom-one-light.min.css*/</style></head>
<body>
<div id="content"><h1>Sourcemap：源码映射原理与应用技巧</h1>
<p><a href="https://docs.google.com/document/d/1U1RGAehQwRypUTovF1KRlpiOFze0b-_2gc6fAH0KY0k/edit#heading=h.qz3o9nc69um5" target="_blank" rel="nofollow noopener noreferrer">Sourcemap 协议</a> 最初由 Google 设计并率先在 Closure Inspector 实现，它的主要作用就是将经过压缩、混淆、合并的产物代码还原回未打包的原始形态，帮助开发者在生产环境中精确定位问题发生的行列位置，例如：</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2fa7318e270d451684c3f8da78bbab5c~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p>
<p>在 Webpack 内部，这段生成 Sourcemap 映射数据的逻辑并不复杂，一句话总结：在 <a href="https://webpack.js.org/api/compilation-hooks/#processassets" target="_blank" rel="nofollow noopener noreferrer">processAssets</a> 钩子遍历产物文件 <code>assets</code> 数组，调用 <code>webpack-sources</code> 提供的 <code>map</code> 方法，最终计算出 <code>asset</code> 与源码 <code>originSource</code> 之间的映射关系。</p>
<p>这个过程真正的难点在于 「如何计算映射关系」，因此本文会展开详细讲解 Sourcemap 映射结构与 VLQ 编码规则，以及 Webpack 提供的 <code>devtool</code> 配置项的详细用法。</p>
<h2>Sourcemap 映射结构</h2>
<p>Sourcemap 最初版本生成的 <code>.map</code> 文件非常大，体积大概为编译产物的 10 倍；V2 之后引入 Base64 编码等算法，将之减少 20% ~ 30%；而最新版本 V3 又在 V2 基础上引入 VLQ 算法，体积进一步压缩了 50%。</p>
<p>这一系列进化造就了一个效率极高的 Sourcemap 体系，但伴随而来的则是较为复杂的 <code>mappings</code> 编码规则。V3 版本 Sourcemap 文件由三部分组成:</p>
<ul>
<li>开发者编写的原始代码；</li>
<li>经过 Webpack 压缩、转化、合并后的产物，且产物中必须包含指向 Sourcemap 文件地址的 <code>//# sourceMappingURL=https://xxxx/bundle.js.map</code> 指令；</li>
<li>记录原始代码与经过工程化处理代码之间位置映射关系 Map 文件。</li>
</ul>
<p>页面初始运行时只会加载编译构建产物，直到特定事件发生 —— 例如在 Chrome 打开 Devtool 面板时，才会根据 <code>//# sourceMappingURL</code> 内容自动加载 Map 文件，并按 Sourcemap 协议约定的映射规则将代码重构还原回原始形态，这既能保证终端用户的性能体验，又能帮助开发者快速还原现场，提升线上问题的定位与调试效率。</p>
<p>例如，在 Webpack 中设置 <code>devtool = 'source-map'</code> 即可同时打包出代码产物 <code>xxx.js</code> 文件与同名 <code>xxx.js.map</code> 文件，Map 文件通常为 JSON 格式，内容如：</p>
<pre><code class="hljs language-json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"sources"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"webpack:///./src/index.js"</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"names"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"name"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"console"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"log"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"mappings"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">";;;;;AAAA,IAAMA,IAAI,GAAG,QAAb;AAEAC,OAAO,CAACC,GAAR,CAAYF,IAAZ,E"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"file"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"main.js"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"sourcesContent"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"const name = 'tecvan';\n\nconsole.log(name)"</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"sourceRoot"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>各字段含义分别为：</p>
<ul>
<li><code>version</code>： 指代 Sourcemap 版本，目前最新版本为 <code>3</code>；</li>
<li><code>names</code>：字符串数组，记录原始代码中出现的变量名；</li>
<li><code>file</code>：字符串，该 Sourcemap 文件对应的编译产物文件名；</li>
<li><code>sourcesContent</code>：字符串数组，原始代码的内容；</li>
<li><code>sourceRoot</code>：字符串，源文件根目录；</li>
<li><code>sources</code>：字符串数组，原始文件路径名，与 <code>sourcesContent</code> 内容一一对应；</li>
<li><code>mappings</code>：字符串数组，记录打包产物与原始代码的位置映射关系。</li>
</ul>
<p>使用时，浏览器会按照 <code>mappings</code> 记录的数值关系，将产物代码映射回 <code>sourcesContent</code> 数组所记录的原始代码文件、行、列位置，这里面最复杂难懂的点就在于 <code>mappings</code> 字段的规则。</p>
<p>举个例子，对于下面的代码：</p>
<table class="ace-table author-6857319138482798593"><tbody><tr><td><div>编译前</div></td><td><div>编译后</div></td></tr><tr><td><div><pre class="language-Delphi"><code class="hljs language-ini">const <span class="hljs-attr">name</span> = <span class="hljs-string">'tecvan'</span><span class="hljs-comment">;</span>



console.log(name)
</code></pre></div></td><td><div><pre class="language-JavaScript"><code class="hljs language-ini">/******/ (() => { // webpackBootstrap

var <span class="hljs-attr">__webpack_exports__</span> = {}<span class="hljs-comment">;</span>

/*!**********************!*\

  !*** ./src/index.js ***!

  \**********************/

var <span class="hljs-attr">name</span> = <span class="hljs-string">'tecvan'</span><span class="hljs-comment">;</span>

console.log(name)<span class="hljs-comment">;</span>

/******/ })()

<span class="hljs-comment">;</span>

//<span class="hljs-comment"># sourceMappingURL=main.js.map</span>
</code></pre></div></td></tr></tbody></table>
<p>当 <code>devtool = 'source-map'</code> 时，Webpack 生成的 <code>mappings</code> 字段为：</p>
<pre><code class="hljs language-objectivec">;;;;;AAAA,IAAMA,IAAI,GAAG,QAAb;AAEAC,OAAO,<span class="hljs-built_in">CAACC</span>,GAAR,<span class="hljs-built_in">CAAYF</span>,IAAZ,E
</code></pre>
<p>字段内容包含三层结构：</p>
<ul>
<li>以 <code>;</code> 分割的<strong>行映射</strong>，每一个 <code>;</code> 对应编译产物每一行到源码的映射，上例经过分割后：</li>
</ul>
<pre><code class="hljs language-js">[
  <span class="hljs-comment">// 产物第 1-5 行内容为 Webpack 生成的 runtime，不需要记录映射关系</span>
  <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, 
  <span class="hljs-comment">// 产物第 6 行的映射信息</span>
  <span class="hljs-string">'AAAA,IAAMA,IAAI,GAAG,QAAb'</span>, 
  <span class="hljs-comment">// 产物第 7 行的映射信息</span>
  <span class="hljs-string">'AAEAC,OAAO,CAACC,GAAR,CAAYF,IAAZ,E'</span>
]
</code></pre>
<ul>
<li>以 <code>,</code> 分割的<strong>片段映射</strong>，每一个 <code>,</code> 对应该行中每一个代码片段到源码的映射，上例经过分割后：</li>
</ul>
<pre><code class="hljs language-js">[
  <span class="hljs-comment">// 产物第 1-5 行内容为 Webpack 生成的 runtime，不需要记录映射关系</span>
  <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, 
  <span class="hljs-comment">// 产物第 6 行的映射信息</span>
  [
    <span class="hljs-comment">// 片段 `var` 到 `const` 的映射</span>
    <span class="hljs-string">'AAAA'</span>, 
    <span class="hljs-comment">// 片段 `name` 到 `name` 的映射</span>
    <span class="hljs-string">'IAAMA'</span>, 
    <span class="hljs-comment">// 等等</span>
    <span class="hljs-string">'IAAI'</span>, <span class="hljs-string">'GAAG'</span>, <span class="hljs-string">'QAAb'</span>], 
  <span class="hljs-comment">// 产物第 7 行的映射信息</span>
  [<span class="hljs-string">'AAEAC'</span>, <span class="hljs-string">'OAAO'</span>, <span class="hljs-string">'CAACC'</span>, <span class="hljs-string">'GAAR'</span>, <span class="hljs-string">'CAAYF'</span>, <span class="hljs-string">'IAAZ'</span>, <span class="hljs-string">'E'</span>]
]
</code></pre>
<ul>
<li>第三层逻辑为片段映射到源码的具体位置，以上例 <code>IAAMA</code> 为例：
<ul>
<li>第一位 <code>I</code> 代表该代码片段在产物中列数；</li>
<li>第二位 <code>A</code> 代表源码文件的索引，即该片段对标到 <code>sources</code> 数组的元素下标；</li>
<li>第三位 <code>A</code> 代表片段在源码文件的行数；</li>
<li>第四位 <code>M</code> 代表片段在源码文件的列数；</li>
<li>第五位 <code>A</code> 代表该片段对应的名称索引，即该片段对标到 <code>names</code> 数组的元素下标。</li>
</ul>
</li>
</ul>
<p>上述第1、2层逻辑比较简单，唯一需要注意的是片段之间是一种相对偏移关系，例如对于上例第六行映射值：<code>AAAA,IAAMA,IAAI,GAAG,QAAb</code>，每一个片段的第一位 —— 即片段列数为 <code>A,I,I,G,Q</code>，分别代表：</p>
<ul>
<li><code>A</code> ：第 <code>A</code> 列；</li>
<li><code>I</code> ：第 <code>A + I</code> 列；</li>
<li><code>I</code> ：第 <code>A + I + I</code> 列；</li>
<li><code>G</code> ：第 <code>A + I + I + G</code> 列；</li>
<li><code>Q</code> ：第 <code>A + I + I + G + Q</code> 列。</li>
</ul>
<p>这种相对偏移能减少 Sourcemap 产物的体积，提升整体性能。注意，第三层逻辑中的片段位置映射则用到了一种比较高效数值编码算法 —— VLQ(Variable-length Quantity)。</p>
<h2>VLQ 编码</h2>
<p><a href="https://en.wikipedia.org/wiki/Variable-lengsth_quantity" target="_blank" rel="nofollow noopener noreferrer">VLQ</a> 是一种将整数数值转换为 Base64 的编码算法，它先将任意大的整数转换为一系列六位字节码，再按 Base64 规则转换为一串可见字符。VLQ 使用六位比特存储一个编码分组，例如：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3885498f30a7462789d05fe8af482c6f~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p>
<p>数字 7 经过 VLQ 编码后，结果为 <code>001110</code>，其中：</p>
<ul>
<li>第一位为连续标志位，标识后续分组是否为同一数字；</li>
<li>第六位表示该数字的正负符号，0为正整数，1为负整数；</li>
<li>中间第 2-5 为实际数值。</li>
</ul>
<p>这样一个六位编码分组，就可以按照 Base64 的映射规则转换为 <code>ABC</code> 等可见字符，例如上述数字 7 编码结果 <code>001110</code>，等于十进制的 14，按 Base64 字码表可映射为字母 <code>O</code>。</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1ebe7f1a58974319badd51afa21d9f62~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p>
<p>但是，分组中只有中间的 4 个字节用于表示数值，因此单个分组只能表达 <strong>-15 ~ 15</strong> 之间的数值范围，对于超过这个范围的整数，需要组合多个分组，共同表达同一数字，具体规则：</p>
<ul>
<li>第一个分组的最后一位为符号位，其它分组从 2-6 均为数值位；</li>
<li>取二进制值最后四位为第一个分组值，之后从后到前，每 5 位划分为一个分组；</li>
<li>除最后一个分组外，其余分组的连续标志位都设置为 1。</li>
</ul>
<p>例如，对于十进制 -17，其二进制为 <code>10001</code> (取 17 的二进制) 共 5 位，首先从后到前拆分为两组，后四位 <code>0001</code> 为第一组，连续标志位为 1，符号位为 1，结果为 <code>1,0001,1</code>；剩下的 <code>1</code> 分配到第二个 —— 也是最后一个分组，连续标志位为 0，结果为 <code>0,00001</code>。按 Base64 规则 <code>[100011, 000001]</code> 最终映射为 <code>jA</code>。</p>
<pre><code class="hljs language-dart">十进制     二进制               VLQ    Base64
  <span class="hljs-number">-17</span> => <span class="hljs-number">1</span>,<span class="hljs-number">0001</span> => <span class="hljs-number">100011</span>, <span class="hljs-number">000001</span> =>     jA
</code></pre>
<p>同样的，对于更大的数字，例如 1200，其二进制为 <code>10010110000</code>，分组为 <code>[10, 01011, 0000]</code>，从后到前编码，第一个分组为 <code>1,0000,0</code>；第二个分组为 <code>1,01011</code>；最后一个分组为 <code>0,00010</code>。按 Base64 映射为 <code>grC</code>。</p>
<pre><code class="hljs language-ini">十进制            二进制                     VLQ    Base64
 <span class="hljs-attr">1200</span> => <span class="hljs-number">10</span><span class="hljs-comment">;01011;0000 => 100000,101011,000010 =>    grC</span>
</code></pre>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5a3c5cc523044b959ec2ae1fcefee6a4~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p>
<p>结合 VLQ 编码规则，我们再回过头来解读本章开头的例子，对于代码：</p>
<table class="ace-table author-6857319138482798593"><tbody><tr><td><div>编译前</div></td><td><div>编译后</div></td></tr><tr><td><div><pre class="language-Delphi"><code class="hljs language-ini">const <span class="hljs-attr">name</span> = <span class="hljs-string">'tecvan'</span><span class="hljs-comment">;</span>



console.log(name)
</code></pre></div></td><td><div><pre class="language-JavaScript"><code class="hljs language-ini">/******/ (() => { // webpackBootstrap

var <span class="hljs-attr">__webpack_exports__</span> = {}<span class="hljs-comment">;</span>

/*!**********************!*\

  !*** ./src/index.js ***!

  \**********************/

var <span class="hljs-attr">name</span> = <span class="hljs-string">'tecvan'</span><span class="hljs-comment">;</span>

console.log(name)<span class="hljs-comment">;</span>

/******/ })()

<span class="hljs-comment">;</span>

//<span class="hljs-comment"># sourceMappingURL=main.js.map</span>
</code></pre></div></td></tr></tbody></table>
<p>编译生成 <code>mappings</code>：</p>
<pre><code class="hljs language-objectivec">;;;;;AAAA,IAAMA,IAAI,GAAG,QAAb;AAEAC,OAAO,<span class="hljs-built_in">CAACC</span>,GAAR,<span class="hljs-built_in">CAAYF</span>,IAAZ,E
</code></pre>
<p>按行、片段规则分割后，得出如下片段：</p>
<pre><code class="hljs language-csharp">[
  <span class="hljs-comment">// 产物第 1-5 行内容为 Webpack 生成的 runtime，不需要记录映射关系</span>
  <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, 
  <span class="hljs-comment">// 产物第 6 行的映射信息</span>
  [<span class="hljs-string">'AAAA'</span>, <span class="hljs-string">'IAAMA'</span>, <span class="hljs-string">'IAAI'</span>, <span class="hljs-string">'GAAG'</span>, <span class="hljs-string">'QAAb'</span>], 
  <span class="hljs-comment">// 产物第 7 行的映射信息</span>
  [<span class="hljs-string">'AAEAC'</span>, <span class="hljs-string">'OAAO'</span>, <span class="hljs-string">'CAACC'</span>, <span class="hljs-string">'GAAR'</span>, <span class="hljs-string">'CAAYF'</span>, <span class="hljs-string">'IAAZ'</span>, <span class="hljs-string">'E'</span>]
]
</code></pre>
<p>以第 6 行 <code>['AAAA', 'IAAMA', 'IAAI', 'GAAG', 'QAAb']</code> 为例：</p>
<ul>
<li><code>AAAA</code> 解码结果为 <code>[000000, 000000, 000000, 000000]</code>，即产物第 6 行<strong>第</strong>  <strong>0</strong>  <strong>列</strong>映射到 <code>sources[0]</code> 文件的<strong>第</strong>  <strong>0</strong>  <strong>行</strong>，<strong>第</strong>  <strong>0</strong>  <strong>列</strong>，实际对应 <code>var</code> 到 <code>const</code> 的位置映射；</li>
<li><code>IAAMA</code> 解码结果为 <code>[001000, 000000, 000000, 001100, 000000]</code>，即产物第 6 行第 4 列映射到 <code>sources[0]</code> 文件的<strong>第</strong>  <strong>0</strong>  <strong>行</strong>，<strong>第</strong>  <strong>6</strong>  <strong>列</strong>，实际对应产物 <code>name</code> 到源码 <code>name</code> 的位置映射。</li>
</ul>
<p>其它片段以此类推，Webpack 生成 <code>.map</code> 文件时，只需要在 <code>webpack-sources</code> 中，按照这个编码规则计算好编译前后的代码映射关系即可。</p>
<h2><code>devtool</code> 规则详解</h2>
<p>Webpack 提供了两种设置 Sourcemap 的方式，一是通过 <code>devtool</code> 配置项设置 Sourcemap 规则短语；二是直接使用 <code>SourceMapDevToolPlugin</code> 或 <code>EvalSourceMapDevToolPlugin</code> 插件深度定制 Sourcemap 的生成逻辑。</p>
<p><a href="https://webpack.js.org/configuration/devtool/" target="_blank" rel="nofollow noopener noreferrer">devtool</a> 支持 25 种字符串枚举值，包括 <code>eval</code>、<code>source-map</code>、<code>eval-source-map</code> 等：</p>
<table><tbody><tr><td height="31" width="149">devtool</td><td height="31" width="193">performance</td><td height="31" width="105">production</td><td height="31" width="105">quality</td><td height="31" width="219">comment</td></tr><tr><td height="77" width="149">(none)</td><td height="77" width="193">build: fastest<br>rebuild: fastest</td><td height="77" width="105">yes</td><td height="77" width="105">bundle</td><td height="77" width="219">Recommended choice for production builds with maximum performance.</td></tr><tr><td height="77" width="149">eval</td><td height="77" width="193">build: fast<br>rebuild: fastest</td><td height="77" width="105">no</td><td height="77" width="105">generated</td><td height="77" width="219">Recommended choice for development builds with maximum performance.</td></tr><tr><td height="54" width="149">eval-cheap-source-map</td><td height="54" width="193">build: ok<br>rebuild: fast</td><td height="54" width="105">no</td><td height="54" width="105">transformed</td><td height="54" width="219">Tradeoff choice for development builds.</td></tr><tr><td height="54" width="149">eval-cheap-module-source-map</td><td height="54" width="193">build: slow<br>rebuild: fast</td><td height="54" width="105">no</td><td height="54" width="105">original lines</td><td height="54" width="219">Tradeoff choice for development builds.</td></tr><tr><td height="77" width="149">eval-source-map</td><td height="77" width="193">build: slowest<br>rebuild: ok</td><td height="77" width="105">no</td><td height="77" width="105">original</td><td height="77" width="219">Recommended choice for development builds with high quality SourceMaps.</td></tr><tr><td height="54" width="149">cheap-source-map</td><td height="54" width="193">build: ok<br>rebuild: slow</td><td height="54" width="105">no</td><td height="54" width="105">transformed</td><td height="54" width="219"></td></tr><tr><td height="54" width="149">cheap-module-source-map</td><td height="54" width="193">build: slow<br>rebuild: slow</td><td height="54" width="105">no</td><td height="54" width="105">original lines</td><td height="54" width="219"></td></tr><tr><td height="77" width="149">source-map</td><td height="77" width="193">build: slowest<br>rebuild: slowest</td><td height="77" width="105">yes</td><td height="77" width="105">original</td><td height="77" width="219">Recommended choice for production builds with high quality SourceMaps.</td></tr><tr><td height="54" width="149">inline-cheap-source-map</td><td height="54" width="193">build: ok<br>rebuild: slow</td><td height="54" width="105">no</td><td height="54" width="105">transformed</td><td height="54" width="219"></td></tr><tr><td height="54" width="149">inline-cheap-module-source-map</td><td height="54" width="193">build: slow<br>rebuild: slow</td><td height="54" width="105">no</td><td height="54" width="105">original lines</td><td height="54" width="219"></td></tr><tr><td height="54" width="149">inline-source-map</td><td height="54" width="193">build: slowest<br>rebuild: slowest</td><td height="54" width="105">no</td><td height="54" width="105">original</td><td height="54" width="219">Possible choice when publishing a single file</td></tr><tr><td height="54" width="149">eval-nosources-cheap-source-map</td><td height="54" width="193">build: ok<br>rebuild: fast</td><td height="54" width="105">no</td><td height="54" width="105">transformed</td><td height="54" width="219">source code not included</td></tr><tr><td height="68" width="149">eval-nosources-cheap-module-source-map</td><td height="68" width="193">build: slow<br>rebuild: fast</td><td height="68" width="105">no</td><td height="68" width="105">original lines</td><td height="68" width="219">source code not included</td></tr><tr><td height="54" width="149">eval-nosources-source-map</td><td height="54" width="193">build: slowest<br>rebuild: ok</td><td height="54" width="105">no</td><td height="54" width="105">original</td><td height="54" width="219">source code not included</td></tr><tr><td height="54" width="149">inline-nosources-cheap-source-map</td><td height="54" width="193">build: ok<br>rebuild: slow</td><td height="54" width="105">no</td><td height="54" width="105">transformed</td><td height="54" width="219">source code not included</td></tr><tr><td height="68" width="149">inline-nosources-cheap-module-source-map</td><td height="68" width="193">build: slow<br>rebuild: slow</td><td height="68" width="105">no</td><td height="68" width="105">original lines</td><td height="68" width="219">source code not included</td></tr><tr><td height="54" width="149">inline-nosources-source-map</td><td height="54" width="193">build: slowest<br>rebuild: slowest</td><td height="54" width="105">no</td><td height="54" width="105">original</td><td height="54" width="219">source code not included</td></tr><tr><td height="54" width="149">nosources-cheap-source-map</td><td height="54" width="193">build: ok<br>rebuild: slow</td><td height="54" width="105">no</td><td height="54" width="105">transformed</td><td height="54" width="219">source code not included</td></tr><tr><td height="54" width="149">nosources-cheap-module-source-map</td><td height="54" width="193">build: slow<br>rebuild: slow</td><td height="54" width="105">no</td><td height="54" width="105">original lines</td><td height="54" width="219">source code not included</td></tr><tr><td height="54" width="149">nosources-source-map</td><td height="54" width="193">build: slowest<br>rebuild: slowest</td><td height="54" width="105">yes</td><td height="54" width="105">original</td><td height="54" width="219">source code not included</td></tr><tr><td height="54" width="149">hidden-nosources-cheap-source-map</td><td height="54" width="193">build: ok<br>rebuild: slow</td><td height="54" width="105">no</td><td height="54" width="105">transformed</td><td height="54" width="219">no reference, source code not included</td></tr><tr><td height="68" width="149">hidden-nosources-cheap-module-source-map</td><td height="68" width="193">build: slow<br>rebuild: slow</td><td height="68" width="105">no</td><td height="68" width="105">original lines</td><td height="68" width="219">no reference, source code not included</td></tr><tr><td height="54" width="149">hidden-nosources-source-map</td><td height="54" width="193">build: slowest<br>rebuild: slowest</td><td height="54" width="105">yes</td><td height="54" width="105">original</td><td height="54" width="219">no reference, source code not included</td></tr><tr><td height="54" width="149">hidden-cheap-source-map</td><td height="54" width="193">build: ok<br>rebuild: slow</td><td height="54" width="105">no</td><td height="54" width="105">transformed</td><td height="54" width="219">no reference</td></tr><tr><td height="54" width="149">hidden-cheap-module-source-map</td><td height="54" width="193">build: slow<br>rebuild: slow</td><td height="54" width="105">no</td><td height="54" width="105">original lines</td><td height="54" width="219">no reference</td></tr><tr><td height="100" width="149">hidden-source-map</td><td height="100" width="193">build: slowest<br>rebuild: slowest</td><td height="100" width="105">yes</td><td height="100" width="105">original</td><td height="100" width="219">no reference. Possible choice when using SourceMap only for error reporting purposes.</td></tr></tbody></table>
<blockquote>
<p>提示：内容摘抄自 Webpack <a href="https://webpack.js.org/configuration/devtool/" target="_blank" rel="nofollow noopener noreferrer">官网</a>。</p>
</blockquote>
<p>分开来看都特别晦涩，但这些枚举值内在有一个潜规则：都是由 <code>inline</code>、<code>eval</code>、<code>source-map</code>、<code>nosources</code>、<code>hidden</code>、<code>cheap</code>、<code>module</code> 七种关键字组合而成，这些关键词各自代表一项 Sourcemap 规则，拆开来看：</p>
<ol>
<li><strong><code>eval</code> 关键字</strong>：当 <code>devtool</code> 值包含 <code>eval</code> 时，生成的模块代码会被包裹进一段 <code>eval</code> 函数中，且模块的 Sourcemap 信息通过 <code>//# sourceURL</code> 直接挂载在模块代码内。例如：</li>
</ol>
<pre><code class="hljs language-ini">eval("var <span class="hljs-attr">foo</span> = <span class="hljs-string">'bar'</span>\n\n\n//<span class="hljs-comment"># sourceURL=webpack:///./src/index.ts?")</span>
</code></pre>
<p><code>eval</code> 模式编译速度通常比较快，但产物中直接包含了 Sourcemap 信息，因此只推荐在开发环境中使用。</p>
<ol start="2">
<li><strong><code>source-map</code> 关键字</strong>：当 <code>devtool</code> 包含 <code>source-map</code> 时，Webpack 才会生成 Sourcemap 内容。例如，对于 <code>devtool = 'source-map'</code>，产物会额外生成 <code>.map</code> 文件，形如：</li>
</ol>
<pre><code class="hljs language-json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"sources"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"webpack:///./src/index.ts"</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"names"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"console"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"log"</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"mappings"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"AACAA,QAAQC,IADI"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"file"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"bundle.js"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"sourcesContent"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"const foo = 'bar';\nconsole.log(foo);"</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"sourceRoot"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>实际上，除 <code>eval</code> 之外的其它枚举值都包含该字段。</p>
<ol start="3">
<li><strong><code>cheap</code> 关键字</strong>：当 <code>devtool</code> 包含 <code>cheap</code> 时，生成的 Sourcemap 内容会抛弃<strong>列</strong>维度的信息，这就意味着浏览器只能映射到代码行维度。例如 <code>devtool = 'cheap-source-map'</code> 时，产物：</li>
</ol>
<pre><code class="hljs language-swift">{
    <span class="hljs-string">"version"</span>: <span class="hljs-number">3</span>,
    <span class="hljs-string">"file"</span>: <span class="hljs-string">"bundle.js"</span>,
    <span class="hljs-string">"sources"</span>: [
        <span class="hljs-string">"webpack:///bundle.js"</span>
    ],
    <span class="hljs-string">"sourcesContent"</span>: [
        <span class="hljs-string">"console.log(<span class="hljs-subst">\"</span>bar<span class="hljs-subst">\"</span>);"</span>
    ],
    <span class="hljs-comment">// 带 cheap 效果：</span>
    <span class="hljs-string">"mappings"</span>: <span class="hljs-string">"AAAA"</span>,
    <span class="hljs-comment">// 不带 cheap 效果：</span>
    <span class="hljs-comment">// "mappings": "AACAA,QAAQC,IADI",</span>
    <span class="hljs-string">"sourceRoot"</span>: <span class="hljs-string">""</span>
}
</code></pre>
<p>浏览器映射效果：</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/830f8d072cfd4b8bae4c95e7d29c974b~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p>
<p>虽然 Sourcemap 提供的映射功能可精确定位到文件、行、列粒度，但有时在<strong>行</strong>级别已经足够帮助我们达到调试定位的目的，此时可选择使用 <code>cheap</code> 关键字，简化 Sourcemap 内容，减少 Sourcemap 文件体积。</p>
<ol start="4">
<li><strong><code>module</code> 关键字</strong>：<code>module</code> 关键字只在 <code>cheap</code> 场景下生效，例如 <code>cheap-module-source-map</code>、<code>eval-cheap-module-source-map</code>。当 <code>devtool</code> 包含 <code>cheap</code> 时，Webpack 根据 <code>module</code> 关键字判断按 loader 联调处理结果作为 source，还是按处理之前的代码作为 source。例如：</li>
</ol>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0630aad5c07744f8be3d2a3d0198d959~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p>
<p>注意观察上例 <code>sourcesContent</code> 字段，左边 <code>devtool</code> 带 <code>module</code> 关键字，因此此处映射的，是包含 <code>class Person</code> 的最原始代码；而右边生成的 <code>sourcesContent</code> ，则是经过 babel-loader 编译处理的内容。</p>
<ol start="5">
<li><strong><code>nosources</code> 关键字</strong>：当 <code>devtool</code> 包含 <code>nosources</code> 时，生成的 Sourcemap 内容中不包含源码内容 —— 即 <code>sourcesContent</code> 字段。例如 <code>devtool = 'nosources-source-map'</code> 时，产物：</li>
</ol>
<pre><code class="hljs language-json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"sources"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"webpack:///./src/index.ts"</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"names"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"console"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"log"</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"mappings"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"AACAA,QAAQC,IADI"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"file"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"bundle.js"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"sourceRoot"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>虽然没有带上源码，但 <code>.map</code> 产物中还带有文件名、 <code>mappings</code> 字段、变量名等信息，依然能够帮助开发者定位到代码对应的原始位置，配合 <code>sentry</code> 等工具提供的源码映射功能，可在异地还原诸如错误堆栈之类的信息。</p>
<ol start="6">
<li><strong><code>inline</code> 关键字</strong>：当 <code>devtool</code> 包含 <code>inline</code> 时，Webpack 会将 Sourcemap 内容编码为 Base64 DataURL，直接追加到产物文件中。例如对于 <code>devtool = 'inline-source-map'</code>，产物：</li>
</ol>
<pre><code class="hljs language-arduino">console.<span class="hljs-built_in">log</span>(<span class="hljs-string">"bar"</span>);
<span class="hljs-comment">//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly8vLi9zcmMvaW5kZXgudHMiXSwibmFtZXMiOlsiY29uc29sZSIsImxvZyJdLCJtYXBwaW5ncyI6IkFBQ0FBLFFBQVFDLElBREkiLCJmaWxlIjoiYnVuZGxlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgZm9vID0gJ2Jhcic7XG5jb25zb2xlLmxvZyhmb28pOyJdLCJzb3VyY2VSb290IjoiIn0=</span>
</code></pre>
<p><code>inline</code> 模式编译速度较慢，且产物体积非常大，只适合开发环境使用。</p>
<ol start="7">
<li><strong><code>hidden</code> 关键字</strong>：通常，产物中必须携带 <code>//# sourceMappingURL=</code> 指令，浏览器才能正确找到 Sourcemap 文件，当 <code>devtool</code> 包含 <code>hidden</code> 时，编译产物中不包含 <code>//# sourceMappingURL=</code> 指令。例如：</li>
</ol>
<table class="ace-table author-6857319138482798593"><tbody><tr><td><div><code>devtool = 'hidden-source-map'</code></div></td><td><div><code>devtool = 'source-map'</code></div></td></tr><tr><td><div><pre class="language-JavaScript"><code class="hljs language-php"><span class="hljs-comment">/******/</span> (() => { <span class="hljs-comment">// webpackBootstrap</span>

<span class="hljs-keyword">var</span> __webpack_exports__ = {};

<span class="hljs-comment">/*!**********************!*\

  !*** ./src/index.ts ***!

  \**********************/</span>

<span class="hljs-keyword">var</span> Person = <span class="hljs-comment">/** <span class="hljs-doctag">@class</span> */</span> (<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

}());



<span class="hljs-comment">/******/</span> })();
</code></pre></div><div></div></td><td><div><pre class="language-JavaScript"><code class="hljs language-php"><span class="hljs-comment">/******/</span> (() => { <span class="hljs-comment">// webpackBootstrap</span>

<span class="hljs-keyword">var</span> __webpack_exports__ = {};

<span class="hljs-comment">/*!**********************!*\

  !*** ./src/index.ts ***!

  \**********************/</span>

<span class="hljs-keyword">var</span> Person = <span class="hljs-comment">/** <span class="hljs-doctag">@class</span> */</span> (<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

}());



<span class="hljs-comment">/******/</span> })();

<span class="hljs-comment">//# sourceMappingURL=bundle.js.map</span>
</code></pre></div><div></div></td></tr></tbody></table>
<p>两者区别仅在于编译产物最后一行的 <code>//# sourceMappingURL=</code> 指令，当你需要 Sourcemap 功能，又不希望浏览器 Devtool 工具自动加载时，可使用此选项。需要打开 Sourcemap 时，可在浏览器中手动加载：</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/98e6b0cd9aa54f6b8f3090dcd36c91b9~tplv-k3u1fbpfcp-watermark.image?" alt="f412b094-f908-42a3-9b51-a3f3622a71c0.gif"></p>
<p>总结一下，Webpack 的 <code>devtool</code> 值都是由以上七种关键字的一个或多个组成，虽然提供了 27 种候选项，但逻辑上都是由上述规则叠加而成，例如：</p>
<ul>
<li><code>cheap-source-map</code>：代表 <strong>不带列映射</strong> 的 Sourcemap ；</li>
<li><code>eval-nosources-cheap-source-map</code>：代表 <strong>以 <code>eval</code> 包裹模块代码</strong> ，且 <strong><code>.map</code> 映射文件中不带源码</strong>，且 <strong>不带列映射</strong> 的 Sourcemap。</li>
</ul>
<p>其它选项以此类推。最后再总结一下：</p>
<ul>
<li>对于开发环境，适合使用：
<ul>
<li><code>eval</code>：速度极快，但只能看到原始文件结构，看不到打包前的代码内容；</li>
<li><code>cheap-eval-source-map</code>：速度比较快，可以看到打包前的代码内容，但看不到 loader 处理之前的源码；</li>
<li><code>cheap-module-eval-source-map</code>：速度比较快，可以看到 loader 处理之前的源码，不过定位不到列级别；</li>
<li><code>eval-source-map</code>：初次编译较慢，但定位精度最高；</li>
</ul>
</li>
<li>对于生产环境，则适合使用：
<ul>
<li><code>source-map</code>：信息最完整，但安全性最低，外部用户可轻易获取到压缩、混淆之前的源码，慎重使用；</li>
<li><code>hidden-source-map</code>：信息较完整，安全性较低，外部用户获取到 <code>.map</code> 文件地址时依然可以拿到源码；</li>
<li><code>nosources-source-map</code>：源码信息缺失，但安全性较高，需要配合 Sentry 等工具实现完整的 Sourcemap 映射。</li>
</ul>
</li>
</ul>
<h2>使用 <code>source-map</code> 插件</h2>
<p>上面介绍的 <code>devtool</code> 配置项，本质上只是一种方便记忆、使用的规则缩写短语，Sourcemap 的底层处理逻辑实际由 <code>SourceMapDevToolPlugin</code> 与 <code>EvalSourceMapDevToolPlugin</code> 插件实现。</p>
<p>在 <code>devtool</code> 基础上，插件还提供了更多、更细粒度的配置项，用于满足更复杂的需求场景，包括：</p>
<ul>
<li>使用 <code>test</code>、<code>include</code>、<code>exclude</code> 配置项过滤需要生成 Sourcemap 的 Bundle；</li>
<li>使用 <code>append</code>、<code>filename</code>、<code>moduleFilenameTemplate</code>、<code>publicPath</code> 配置项设定 Sourcemap 文件的文件名、URL 。</li>
</ul>
<p>使用方法与其它插件无异，如：</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> webpack = <span class="hljs-built_in">require</span>(<span class="hljs-string">'webpack'</span>);
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-comment">// ...</span>
  <span class="hljs-attr">devtool</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">plugins</span>: [<span class="hljs-keyword">new</span> webpack.<span class="hljs-title class_">SourceMapDevToolPlugin</span>({
      <span class="hljs-attr">exclude</span>: [<span class="hljs-string">'vendor.js'</span>]
  })],
};
</code></pre>
<p>插件配置规则较简单，此处不赘述。</p>
<h2>总结</h2>
<p>综上，Sourcemap 是一种高效的位置映射算法，它将产物到源码之间的位置关系表达为 <code>mappings</code> 分层设计与 VLQ 编码，再通过 Chrome、Safari、VS Code、Sentry 等工具异地还原为接近开发状态的源码形式。</p>
<p>在 Webpack 中，通常只需要选择适当的 <code>devtool</code> 短语即可满足大多数场景需求，特殊情况下也可以直接使用 <code>SourceMapDevToolPlugin</code> 做更深度的定制化。</p>
<h2>思考题</h2>
<p>为什么 Sourcemap 要设计分层结构 + VLQ 编码做行列映射？假设直接记录行列号，会有什么问题？</p></div>
</body></html>