<!DOCTYPE html><html lang="en"><head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>第 01 讲：设计一份吸引面试官的简历</title>
<style type="text/css">
:root {
    --control-text-color: #777;
    --select-text-bg-color: rgba(223, 197, 223);  /*#7e66992e;*/
    
    /* side bar */
    --side-bar-bg-color: rgb(255, 255, 255);
    --active-file-text-color: #8163bd;
    --active-file-bg-color: #E9E4F0;
    --item-hover-bg-color: #E9E4F0;
    --active-file-border-color: #8163bd;

    --title-color: #6c549c;
    --font-sans-serif: 'Ubuntu', 'Source Sans Pro', sans-serif !important;
    --font-monospace: 'Fira Code', 'Roboto Mono', monospace !important;
    --purple-1: #8163bd;
    --purple-2: #79589F;
    --purple-3: #fd5eb8;
    --purple-light-1: rgba(99, 99, 172, .05);
    --purple-light-2: rgba(99, 99, 172, .1);
    --purple-light-3: rgba(99, 99, 172, .2);
    --purple-light-4: rgba(129, 99, 189, .3);
    --purple-light-5: #E9E4F0;
    --purple-light-6: rgba(129, 99, 189, .8);
}

/* html {
    font-size: 16px;
} */

body {
    font-family: var(--font-sans-serif);
    color: #34495e;
    -webkit-font-smoothing: antialiased;
    line-height: 1.6rem;
    letter-spacing: 0;
    margin: 0;
    overflow-x: hidden;
}

/* 页边距 和 页面大小 */
#write {
    padding-left: 6ch;
    padding-right: 6ch;
    margin: 0 auto;
}

#write p {
    line-height: 1.6rem;
    word-spacing: .05rem;
}

#write ol li {
    padding-left: 0.5rem;
}

#write > ul:first-child,
#write > ol:first-child {
    margin-top: 30px;
}

body > *:first-child {
    margin-top: 0 !important;
}

body > *:last-child {
    margin-bottom: 0 !important;
}

a {
    color: var(--purple-1);
    padding: 0 2px;
    text-decoration: none;
}
.md-content {
    color: var(--purple-light-6);
}
#write a {
    border-bottom: 1px solid var(--purple-1);
    color: var(--purple-1);
    text-decoration: none;
}

h1,
h2,
h3,
h4,
h5,
h6 {
    position: relative;
    margin-top: 1rem;
    margin-bottom: 0.5rem;
    /* font-weight: bold; */
    font-weight: 500 !important;
    line-height: 1.4;
    cursor: text;
    color: var(--title-color);
    font-family: var(--font-sans-serif);
}

h1:hover a.anchor,
h2:hover a.anchor,
h3:hover a.anchor,
h4:hover a.anchor,
h5:hover a.anchor,
h6:hover a.anchor {
    text-decoration: none;
}

h1 tt,
h1 code {
    font-size: inherit !important;
}
h2 tt,
h2 code {
    font-size: inherit !important;
}
h3 tt,
h3 code {
    font-size: inherit !important;
}
h4 tt,
h4 code {
    font-size: inherit !important;
}
h5 tt,
h5 code {
    font-size: inherit !important;
}
h6 tt,
h6 code {
    font-size: inherit !important;
}


h1 {
    padding-bottom: .4rem;
    font-size: 2.2rem;
    line-height: 1.3;
}
h1 {
    text-align: center;
    padding-bottom: 0.3em;
    font-size: 2.2em;
    line-height: 1.2;
    margin: 2.4em auto 1.2em;
}
h1:after {
    content: '';
    display: block;
    margin: 0.2em auto 0;
    width: 100px;
    height: 2px;
    border-bottom: 2px solid var(--title-color);
}

h2 {
    margin: 1.6em auto 0.5em;
    padding-left: 10px;
    line-height: 1.4;
    font-size: 1.8em;
    border-left: 9px solid var(--title-color);
    border-bottom: 1px solid var(--title-color);
}
h3 {
    font-size: 1.5rem;
    margin: 1.2em auto 0.5em;
}
h4 {
    font-size: 1.3rem;
}
h5 {
    font-size: 1.2rem;
}
h6 {
    font-size: 1.1rem;
}

p,
blockquote,
ul,
ol,
dl,
table {
    margin: 0.8em 0;
}

li > ol,
li > ul {
    margin: 0 0;
}

hr {
    height: 2px;
    padding: 0;
    margin: 16px 0;
    background-color: #e7e7e7;
    border: 0 none;
    overflow: hidden;
    box-sizing: content-box;
}

body > h2:first-child {
    margin-top: 0;
    padding-top: 0;
}

body > h1:first-child {
    margin-top: 0;
    padding-top: 0;
}

body > h1:first-child + h2 {
    margin-top: 0;
    padding-top: 0;
}

body > h3:first-child,
body > h4:first-child,
body > h5:first-child,
body > h6:first-child {
    margin-top: 0;
    padding-top: 0;
}

a:first-child h1,
a:first-child h2,
a:first-child h3,
a:first-child h4,
a:first-child h5,
a:first-child h6 {
    margin-top: 0;
    padding-top: 0;
}

h1 p,
h2 p,
h3 p,
h4 p,
h5 p,
h6 p {
    margin-top: 0;
}

li p.first {
    display: inline-block;
}

ul,
ol {
    padding-left: 30px;
}

ul:first-child,
ol:first-child {
    margin-top: 0;
}

ul:last-child,
ol:last-child {
    margin-bottom: 0;
}

/* 引用 */
blockquote {
    /* margin-left: 1rem; */
    border-left: 4px solid var(--purple-light-4);
    padding: 10px 15px;
    color: #777;
    background-color: var(--purple-light-1);
}

/* 表格 */
table {
    padding: 0;
    word-break: initial;
}

table tr {
    border-top: 1px solid #dfe2e5;
    margin: 0;
    padding: 0;
}

/* 表格 背景色 */
table tr:nth-child(2n),
thead {
    background-color: var(--purple-light-1);
}
#write table thead th {
    background-color: var(--purple-light-2);
}

table tr th {
    font-weight: bold;
    border: 1px solid #dfe2e5;
    border-bottom: 0;
    text-align: left;
    margin: 0;
    padding: 6px 13px;
}

table tr td {
    border: 1px solid #dfe2e5;
    text-align: left;
    margin: 0;
    padding: 6px 13px;
}

table tr th:first-child,
table tr td:first-child {
    margin-top: 0;
}

table tr th:last-child,
table tr td:last-child {
    margin-bottom: 0;
}

/* 粗体 */
#write strong {
    padding: 0 2px;
    color: var(--purple-1);
}

/* 斜体 */
#write em {
    padding: 0 5px 0 2px;
    /* font-style: normal; */
    color: #42b983;
}

/* inline code */
#write code, tt {
    padding: 2px 4px;
    border-radius: 2px;
    font-family: var(--font-monospace);
    font-size: 0.92rem;
    color: var(--purple-3); 
    background-color: rgba(99, 99, 172, .05);
}

tt {
    margin: 0 2px;
}

#write .md-footnote {
    background-color: #f8f8f8;
    color: var(--purple-3);
}

/* heighlight. */
#write mark {
    background-color: #fbd3ea;
    border-radius: 2px;
    padding: 2px 4px;
    margin: 0 2px;
}

#write del {
    padding: 1px 2px;
}

.md-task-list-item > input {
    margin-left: -1.3em;
}

@media print {
    html {
        font-size: 0.9rem;
    }

    table,
    pre {
        page-break-inside: avoid;
    }

    pre {
        word-wrap: break-word;
    }
}

#write pre.md-meta-block {
    padding: 1rem;
    font-size: 85%;
    line-height: 1.45;
    background-color: #f7f7f7;
    border: 0;
    border-radius: 3px;
    color: #777777;
    margin-top: 0 !important;
}

.mathjax-block > .code-tooltip {
    bottom: .375rem;
}

/* 图片 */
.md-image > .md-meta {
    border-radius: 3px;
    font-family: var(--font-monospace);
    padding: 2px 0 0 4px;
    font-size: 0.9em;
    color: inherit;
}
p .md-image:only-child{
    width: auto;
    text-align: left;
    margin-left: 2rem;
}
.md-tag {
    color: inherit;
}
/* 当 “![shadow-随便写]()”写时，会有阴影 */
.md-image img[alt|='shadow'] {
    /* box-shadow: 0 4px 24px -6px #ddd; */
    box-shadow:var(--purple-light-2) 0px 10px 15px;
}

#write a.md-toc-inner {
    line-height: 1.6;
    white-space: pre-line;
    border-bottom: none;
    font-size: 0.9rem;
}

#typora-quick-open {
    border: 1px solid #ddd;
    background-color: #f8f8f8;
}

#typora-quick-open-item {
    background-color: #FAFAFA;
    border-color: #FEFEFE #e5e5e5 #e5e5e5 #eee;
    border-style: solid;
    border-width: 1px;
}

#md-notification:before {
    top: 10px;
}

header,
.context-menu,
.megamenu-content,
footer {
    font-family: var(--font-sans-serif);
}

.file-node-content:hover .file-node-icon,
.file-node-content:hover .file-node-open-state {
    visibility: visible;
}

.md-lang {
    color: #b4654d;
}

.html-for-mac .context-menu {
    --item-hover-bg-color: #E6F0FE;
}

/* 代码框 */
/* CodeMirror 3024 Day theme */

/* 代码段 背景 */
pre {
    --select-text-bg-color: rgba(223, 197, 223) !important;
    margin: .5em 0;
    padding: 1em 1.4em;
    border-radius: 8px;
    background: #f6f8fa;
    overflow-x: auto;
    box-sizing: border-box;
    font-size: 14px;
}

/* 边框 */
.md-fences {
    border: 1px solid #e7eaed;
    border-radius: 3px;
}

.cm-s-inner {
  padding: .25rem;
  border-radius: .25rem;
}

.cm-s-inner.CodeMirror, .cm-s-inner .CodeMirror-gutters {
  background-color: #f8f8f8 !important;
  color: #3a3432 !important;
  border: none;
}

.cm-s-inner .CodeMirror-gutters {
  color: #6d8a88;
}

.cm-s-inner .CodeMirror-cursor {
  border-left: solid thin #5c5855 !important;
}

.cm-s-inner .CodeMirror-linenumber {
  color: #807d7c;
}

.cm-s-inner .CodeMirror-line::selection, .cm-s-inner .CodeMirror-line::-moz-selection,
.cm-s-inner .CodeMirror-line > span::selection,
.cm-s-inner .CodeMirror-line > span::-moz-selection,
.cm-s-inner .CodeMirror-line > span > span::selection,
.cm-s-inner .CodeMirror-line > span > span::-moz-selection {
  background: var(--purple-light-2);
}

.cm-s-inner span.cm-comment {
  color: #cdab53;
}

.cm-s-inner span.cm-string, .cm-s-inner span.cm-string-2 {
  color: #f2b01d;
}

.cm-s-inner span.cm-number {
  color: #a34e8f;
}

.cm-s-inner span.cm-variable {
  color: #01a252;
}

.cm-s-inner span.cm-variable-2 {
  color: #01a0e4;
}

.cm-s-inner span.cm-def {
  /* color: #e8bbd0; */
  color: #e2287f;
}

.cm-s-inner span.cm-operator {
  color: #ff79c6;
}

.cm-s-inner span.cm-keyword {
  color: #db2d20;
}

.cm-s-inner span.cm-atom {
  color: #a34e8f;
}

.cm-s-inner span.cm-meta {
  color: inherit;
}

.cm-s-inner span.cm-tag {
  color: #db2d20;
}

.cm-s-inner span.cm-attribute {
  color: #01a252;
}

.cm-s-inner span.cm-qualifier {
  color: #388aa3;
}

.cm-s-inner span.cm-property {
  color: #01a252;
}

.cm-s-inner span.cm-builtin {
  color: #388aa3;
}

.cm-s-inner span.cm-variable-3, .cm-s-inner span.cm-type {
  color: #ffb86c;
}

.cm-s-inner span.cm-bracket {
  color: #3a3432;
}

.cm-s-inner span.cm-link {
  color: #a34e8f;
}

.cm-s-inner span.cm-error {
  background: #db2d20;
  color: #5c5855;
}

/* .md-fences.md-focus .cm-s-inner .CodeMirror-activeline-background {
  background: var(--purple-light-2);
} */

.cm-s-inner .CodeMirror-matchingbracket {
  text-decoration: underline;
  color: #a34e8f !important;
}

#fences-auto-suggest .active {
  background: #ddd;
}

#write .code-tooltip {
  bottom: initial;
  top: calc(100% - 1px);
  background: #f7f7f7;
  border: 1px solid #ddd;
  border-top: 0;
}

.auto-suggest-container {
  border-color: #b4b4b4;
}

.auto-suggest-container .autoComplt-hint.active {
  background: #b4b4b4;
  color: inherit;
}

/* task list */
#write .md-task-list-item > input {
  -webkit-appearance: initial;
  display: block;
  position: absolute;
  border: 1px solid #b4b4b4;
  border-radius: .25rem;
  margin-top: .1rem;
  margin-left: -1.8rem;
  height: 1.2rem;
  width: 1.2rem;
  transition: background 0.3s;
}

#write .md-task-list-item > input:focus {
  outline: none;
  box-shadow: none;
}

#write .md-task-list-item > input:hover {
  background: #ddd;
}

#write .md-task-list-item > input[checked]::before {
  content: '';
  position: absolute;
  top: 20%;
  left: 50%;
  height: 60%;
  width: 2px;
  transform: rotate(40deg);
  background: #333;
}

#write .md-task-list-item > input[checked]::after {
  content: '';
  position: absolute;
  top: 46%;
  left: 25%;
  height: 30%;
  width: 2px;
  transform: rotate(-40deg);
  background: #333;
}

#write .md-task-list-item > p {
  transition: color 0.3s, opacity 0.3s;
}

#write .md-task-list-item.task-list-done > p {
  color: #b4b4b4;
  text-decoration: line-through;
}

#write .md-task-list-item.task-list-done > p > .md-emoji {
  opacity: .5;
}

#write .md-task-list-item.task-list-done > p > .md-link > a {
  opacity: .6;
}

/* sidebar and outline */
.pin-outline .outline-active {
  color: var(--active-file-text-color); 
}

.file-list-item {
    border-bottom: 1px solid;
    border-color: var(--purple-light-5);
}

.file-list-item-summary {
    font-weight: 400;
}

.file-list-item.active {
    color: var(--active-file-text-color);
    background-color: var(--purple-light-5);
}

.file-tree-node.active>.file-node-background {
    background-color: var(--purple-light-5);
    font-weight: 700;
} 

.file-tree-node.active>.file-node-content {
    color: var(--active-file-text-color);
    font-weight: 700;
}

.file-node-content {
    color: #5e676d;
}

.sidebar-tabs {
    border-bottom: none;
}
.sidebar-tab.active {
    font-weight: 400;
}

.sidebar-content-content {
    font-size: 0.9rem;
}

img {
    max-width: 100%;
}

body {
    background-color: rgb(237, 237, 237);
}
#content {
    width: 836px;
    padding: 50px;
    background: #fff;
    margin: 0 auto;
}/*# sourceURL=/Users/young/Documents/Codes/Fun/lagou/public/purple.css*/</style><style type="text/css">.hljs{display:block;overflow-x:auto;padding:.5em;color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}/*# sourceURL=/Users/young/Documents/Codes/Fun/lagou/public/atom-one-light.min.css*/</style></head>
<body>
<div id="content"><h1>插件开发进阶：如何提升插件健壮性？</h1>
<p>在上一章节中，我们详细介绍了 Webpack 插件的开发方式与基本架构逻辑，并结合若干开源项目剖析插件中如何与 Webpack 上下文交互，从而修改构建逻辑，实现插件功能需求。本文将继续介绍 Webpack 插件开发方法，总结一些较为常用，有助于提升插件可用性、健壮性的开发技巧，包括：</p>
<ul>
<li>如何正确处理插件日志；</li>
<li>如何上报统计信息，帮助用户更好了解插件的运行情况；</li>
<li>如何借助 <code>schema-utils</code> 校验配置参数；</li>
<li>如何搭建自动测试环境。</li>
</ul>
<h2>日志处理</h2>
<p>与 Loader 相似，开发插件时我们也可以复用 Webpack 一系列日志基础设施，包括：</p>
<ul>
<li>通过 <code>compilation.getLogger</code> 获取分级日志管理器；</li>
<li>使用 <code>compilation.errors/wraning</code> 处理异常信息。</li>
</ul>
<p>下面我们逐一展开介绍。</p>
<blockquote>
<p>使用分级日志基础设施</p>
</blockquote>
<p>在前面 《<a href="https://juejin.cn/book/7115598540721618944/section/7119035404715556879" target="_blank" rel="nofollow noopener noreferrer">Loader 开发基础</a>》一文中，我们已经详细介绍了 Webpack 内置的日志接口： <a href="https://webpack.js.org/configuration/other-options/#infrastructurelogging" target="_blank" rel="nofollow noopener noreferrer">infrastructureLogging</a>，与 <a href="https://github.com/log4js-node/log4js-node" target="_blank" rel="nofollow noopener noreferrer">log4js</a>、<a href="https://github.com/winstonjs/winston" target="_blank" rel="nofollow noopener noreferrer">winston</a> 等日志工具类似，借助这一能力我们能实现日志分级筛选能力，适用于处理一些执行过程的日志信息。</p>
<p>开发插件时，我们也能使用这一接口管理日志输出，只是用法稍有不同，如：</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PLUGIN_NAME</span> = <span class="hljs-string">"FooPlugin"</span>;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">FooPlugin</span> {
  <span class="hljs-title function_">apply</span>(<span class="hljs-params">compiler</span>) {
    compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">compilation</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-variable constant_">PLUGIN_NAME</span>, <span class="hljs-function">(<span class="hljs-params">compilation</span>) =></span> {
      <span class="hljs-comment">// 获取日志对象</span>
      <span class="hljs-keyword">const</span> logger = compilation.<span class="hljs-title function_">getLogger</span>(<span class="hljs-variable constant_">PLUGIN_NAME</span>);
      <span class="hljs-comment">// 调用分级日志接口</span>
      logger.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Logging from FooPlugin'</span>)
      logger.<span class="hljs-title function_">error</span>(<span class="hljs-string">"Error from FooPlugin"</span>);
    });
  }
}

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-title class_">FooPlugin</span>;
</code></pre>
<blockquote>
<p>提示：此外，还可以通过 <code>compiler.getInfrastructureLogger</code> 获取日志对象。</p>
</blockquote>
<p>上述代码需要调用 <code>compilation.getLogger</code> 获取日志对象 <code>logger</code>，<code>logger</code> 的用法与 Loader 场景相似，同样支持 <code>verbose/log/info/warn/error</code> 五种日志分级，此处不再赘述。</p>
<blockquote>
<p>正确处理异常信息</p>
</blockquote>
<p>在 Webpack 插件中，可以通过如下方式提交错误信息。</p>
<ul>
<li>使用 <code>logger.error/warning</code> 接口，这种方法同样不会中断构建流程，且能够复用 Webpack 的分级日志体系，由最终用户决定是否输出对应等级日志。</li>
<li>借助 <code>compilation.errors/warnings</code> 数组，如：</li>
</ul>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PLUGIN_NAME</span> = <span class="hljs-string">"FooPlugin"</span>;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">FooPlugin</span> {
  <span class="hljs-title function_">apply</span>(<span class="hljs-params">compiler</span>) {
    compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">compilation</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-variable constant_">PLUGIN_NAME</span>, <span class="hljs-function">(<span class="hljs-params">compilation</span>) =></span> {
      compilation.<span class="hljs-property">errors</span>.<span class="hljs-title function_">push</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"Emit Error From FooPlugin"</span>));
      compilation.<span class="hljs-property">warnings</span>.<span class="hljs-title function_">push</span>(<span class="hljs-string">"Emit Warning From FooPlugin"</span>);
    });
  }
}

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-title class_">FooPlugin</span>;
</code></pre>
<p>执行效果：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1035c8f81506496f90535eb366d762a1~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p>
<p>这种方法仅记录异常日志，不影响构建流程，构建正常结束后 Webpack 还会将错误信息汇总到 <a href="https://webpack.js.org/api/stats/" target="_blank" rel="nofollow noopener noreferrer">stats</a> 统计对象，方便后续二次处理，使用率极高。例如 <a href="https://github1s.com/webpack-contrib/eslint-webpack-plugin" target="_blank" rel="nofollow noopener noreferrer">eslint-webpack-plugin</a> 就是通过这种方式输出 ESLint 检查出来的代码风格问题。</p>
<ul>
<li>使用 Hook Callback，这种方式可将错误信息传递到 Hook 下一个流程，由 Hook 触发者根据错误内容决定后续处理措施(中断、忽略、记录日志等)，如 <code>imagemin-webpack-plugin</code> 中：</li>
</ul>
<pre><code class="hljs language-js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ImageminPlugin</span> {
  apply (compiler) {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">onEmit</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">compilation, callback</span>) => {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([
          ...<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">optimizeWebpackImages</span>(throttle, compilation),
          ...<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">optimizeExternalImages</span>(throttle)
        ])

        <span class="hljs-title function_">callback</span>()
      } <span class="hljs-keyword">catch</span> (err) {
        <span class="hljs-comment">// if at any point we hit a snag, pass the error on to webpack</span>
        <span class="hljs-title function_">callback</span>(err)
      }
    }
    compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">emit</span>.<span class="hljs-title function_">tapAsync</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">constructor</span>.<span class="hljs-property">name</span>, onEmit)
  }
}
</code></pre>
<p>上例第 13 行，在 <code>catch</code> 块中通过 <code>callback</code> 函数传递错误信息。不过，并不是所有 Hook 都会传递 <code>callback</code> 函数，实际开发时建议参考相关用例。</p>
<ul>
<li>直接抛出异常，如：</li>
</ul>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PLUGIN_NAME</span> = <span class="hljs-string">"FooPlugin"</span>;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">FooPlugin</span> {
  <span class="hljs-title function_">apply</span>(<span class="hljs-params">compiler</span>) {
    compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">compilation</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-variable constant_">PLUGIN_NAME</span>, <span class="hljs-function">(<span class="hljs-params">compilation</span>) =></span> {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"Throw Error Directly"</span>)
    });
  }
}

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-title class_">FooPlugin</span>;
</code></pre>
<p>这种方式会导致 Webpack 进程奔溃，多用于插件遇到严重错误，不得不提前中断构建工作的场景。</p>
<p>总的来说，这些方式各自有适用场景，我个人会按如下规则择优选用：</p>
<ul>
<li>多数情况下使用 <code>compilation.errors/warnings</code>，柔和地抛出错误信息；</li>
<li>特殊场景，需要提前结束构建时，则直接抛出异常；</li>
<li>拿捏不准的时候，使用 <code>callback</code> 透传错误信息，交由上游调用者自行判断处理措施。</li>
</ul>
<h2>上报统计信息</h2>
<p>有时候我们需要在插件中执行一些特别耗时的操作，例如：抽取 CSS 代码（如 <a href="https://github.com/webpack-contrib/mini-css-extract-plugin" target="_blank" rel="nofollow noopener noreferrer">mini-css-extract-plugin</a>）、压缩图片（如 <a href="https://github.com/webpack-contrib/image-minimizer-webpack-plugin" target="_blank" rel="nofollow noopener noreferrer">image-minimizer-webpack-plugin</a>）、代码混淆（如 <a href="https://github.com/webpack-contrib/terser-webpack-plugin" target="_blank" rel="nofollow noopener noreferrer">terser-webpack-plugin</a>），这些操作会延长 Webpack 构建的整体耗时，更糟糕的是会阻塞构建主流程，最终用户会感觉到明显卡顿。</p>
<p>针对这种情况，我们可以在插件中上报一些统计信息，帮助用户理解插件的运行进度与性能情况，有两种上报方式：</p>
<ul>
<li>使用 <a href="https://webpack.js.org/plugins/progress-plugin" target="_blank" rel="nofollow noopener noreferrer">ProgressPlugin</a> 插件的 <code>reportProgress</code> 接口上报执行进度；</li>
<li>使用 <a href="https://webpack.js.org/api/stats/" target="_blank" rel="nofollow noopener noreferrer">stats</a> 接口汇总插件运行的统计数据。</li>
</ul>
<blockquote>
<p>使用 <code>reportProgress</code> 接口</p>
</blockquote>
<p><a href="https://webpack.js.org/plugins/progress-plugin" target="_blank" rel="nofollow noopener noreferrer">ProgressPlugin</a> 是 Webpack 内置用于展示构建进度的插件，有两种用法：</p>
<ol>
<li>简化版，执行构建命令时带上 <code>--progress</code> 参数，如：</li>
</ol>
<pre><code class="hljs language-css">npx webpack <span class="hljs-attr">--progress</span>
</code></pre>
<ol start="2">
<li>也可以在 Webpack 配置文件中添加插件实例，如：</li>
</ol>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> { <span class="hljs-title class_">ProgressPlugin</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">"webpack"</span>);

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-comment">//...</span>
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProgressPlugin</span>({
      <span class="hljs-attr">activeModules</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">entries</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-title function_">handler</span>(<span class="hljs-params">percentage, message, ...args</span>) {
        <span class="hljs-comment">// custom logic</span>
      },
      <span class="hljs-comment">//...</span>
    }),
  ],
};
</code></pre>
<p>开发插件时，我们可以使用 <code>ProgressPlugin</code> 插件的 <code>Reporter</code> 方法提交自定义插件的运行进度，例如：</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> { <span class="hljs-title class_">ProgressPlugin</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">"webpack"</span>);
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PLUGIN_NAME</span> = <span class="hljs-string">"BlockPlugin"</span>;
<span class="hljs-keyword">const</span> <span class="hljs-title function_">wait</span> = (<span class="hljs-params">misec</span>) => <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">r</span>) =></span> <span class="hljs-built_in">setTimeout</span>(r, misec));
<span class="hljs-keyword">const</span> <span class="hljs-title function_">noop</span> = (<span class="hljs-params"></span>) => ({});

<span class="hljs-keyword">class</span> <span class="hljs-title class_">BlockPlugin</span> {
  <span class="hljs-title function_">apply</span>(<span class="hljs-params">compiler</span>) {
    compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">compilation</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-variable constant_">PLUGIN_NAME</span>, <span class="hljs-function">(<span class="hljs-params">compilation</span>) =></span> {
      compilation.<span class="hljs-property">hooks</span>.<span class="hljs-property">processAssets</span>.<span class="hljs-title function_">tapAsync</span>(
        <span class="hljs-variable constant_">PLUGIN_NAME</span>,
        <span class="hljs-keyword">async</span> (assets, callback) => {
          <span class="hljs-keyword">const</span> reportProgress = <span class="hljs-title class_">ProgressPlugin</span>.<span class="hljs-title function_">getReporter</span>(compiler) || noop;
          <span class="hljs-keyword">const</span> len = <span class="hljs-number">100</span>;
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &#x3C; len; i++) {
            <span class="hljs-keyword">await</span> <span class="hljs-title function_">wait</span>(<span class="hljs-number">50</span>);
            <span class="hljs-title function_">reportProgress</span>(i / <span class="hljs-number">100</span>, <span class="hljs-string">`Our plugin is working <span class="hljs-subst">${i}</span>%`</span>);
          }
          <span class="hljs-title function_">reportProgress</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"Done work!"</span>);
          <span class="hljs-keyword">await</span> <span class="hljs-title function_">wait</span>(<span class="hljs-number">1000</span>);
          <span class="hljs-title function_">callback</span>();
        }
      );
    });
  }
}

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-title class_">BlockPlugin</span>;
</code></pre>
<blockquote>
<p>提示：示例代码已上传到小册 <a href="https://github.com/Tecvan-fe/webpack-book-samples/blob/main/plugin-progress/package.json" target="_blank" rel="nofollow noopener noreferrer">仓库</a>。</p>
</blockquote>
<p>示例中，最关键的代码在于第 12 行，即调用 <code>ProgressPlugin.getReporter</code> 方法获取 Reporter 函数，之后再用这个函数提交执行进度：</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> reportProgress = <span class="hljs-title class_">ProgressPlugin</span>.<span class="hljs-title function_">getReporter</span>(compiler) || noop;
</code></pre>
<blockquote>
<p>注意：若最终用户没有使用 <code>ProgressPlugin</code> 插件，则这个函数会返回 Undefined，所以需要增加 <code>|| noop</code> 兜底。</p>
</blockquote>
<p><code>reportProgress</code> 接受如下参数：</p>
<pre><code class="hljs language-js"><span class="hljs-title function_">reportProgress</span>(percentage, ...args);
</code></pre>
<ul>
<li><code>percentage</code>：当前执行进度百分比，但这个参数实际并不生效， <code>ProgressPlugin</code> 底层会根据当前处于那个 Hook 计算一个固定的 Progress 百分比值，在自定义插件中无法改变，所以目前来看这个参数值随便填就好；</li>
<li><code>...args</code>：任意数量字符串参数，这些字符串会被拼接到 Progress 输出的信息。</li>
</ul>
<p>最终执行效果：</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3416427756ea48048cddcaf9aa7cbcdc~tplv-k3u1fbpfcp-watermark.image?" alt="3f291b39-e4cd-498c-b1e8-819d964982ab.gif"></p>
<blockquote>
<p>通过 <code>stats</code> 添加统计信息</p>
</blockquote>
<p><a href="https://webpack.js.org/api/stats/" target="_blank" rel="nofollow noopener noreferrer">stats</a> 是 Webpack 内置的数据统计机制，专门用于收集模块构建耗时、模块依赖关系、产物组成等过程信息，我们可以借此分析、优化应用构建性能（后面章节会展开细讲）。在开发插件时，我们可以借用 <code>stats</code> 机制，向用户输出插件各种维度的统计信息，例如：</p>
<pre><code class="hljs language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PLUGIN_NAME</span> = <span class="hljs-string">"FooPlugin"</span>;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">FooPlugin</span> {
  <span class="hljs-title function_">apply</span>(<span class="hljs-params">compiler</span>) {
    compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">compilation</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-variable constant_">PLUGIN_NAME</span>, <span class="hljs-function">(<span class="hljs-params">compilation</span>) =></span> {
      <span class="hljs-keyword">const</span> statsMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
      <span class="hljs-comment">// buildModule 钩子将在开始处理模块时触发</span>
      compilation.<span class="hljs-property">hooks</span>.<span class="hljs-property">buildModule</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-variable constant_">PLUGIN_NAME</span>, <span class="hljs-function">(<span class="hljs-params"><span class="hljs-variable language_">module</span></span>) =></span> {
        <span class="hljs-keyword">const</span> ident = <span class="hljs-variable language_">module</span>.<span class="hljs-title function_">identifier</span>();
        <span class="hljs-keyword">const</span> startTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
        <span class="hljs-comment">// 模拟复杂耗时操作</span>
        <span class="hljs-comment">// ...</span>
        <span class="hljs-comment">// ...</span>
        <span class="hljs-keyword">const</span> endTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
        <span class="hljs-comment">// 记录处理耗时</span>
        statsMap.<span class="hljs-title function_">set</span>(ident, endTime - startTime);
      });

      compilation.<span class="hljs-property">hooks</span>.<span class="hljs-property">statsFactory</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-variable constant_">PLUGIN_NAME</span>, <span class="hljs-function">(<span class="hljs-params">factory</span>) =></span> {
        factory.<span class="hljs-property">hooks</span>.<span class="hljs-property">result</span>
          .<span class="hljs-title function_">for</span>(<span class="hljs-string">"module"</span>)
          .<span class="hljs-title function_">tap</span>(<span class="hljs-variable constant_">PLUGIN_NAME</span>, <span class="hljs-function">(<span class="hljs-params"><span class="hljs-variable language_">module</span>, context</span>) =></span> {
            <span class="hljs-keyword">const</span> { identifier } = <span class="hljs-variable language_">module</span>;
            <span class="hljs-keyword">const</span> duration = statsMap.<span class="hljs-title function_">get</span>(identifier);
            <span class="hljs-comment">// 添加统计信息</span>
            <span class="hljs-variable language_">module</span>.<span class="hljs-property">fooDuration</span> = duration || <span class="hljs-number">0</span>;
          });
      });
    });
  }
}

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-title class_">FooPlugin</span>;
</code></pre>
<p>再次执行 Webpack 构建命令，将产出如下 <code>stats</code> 统计信息：</p>
<pre><code class="hljs language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"hash"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"0a17278b49620a86b126"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"5.73.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// ...</span>
  <span class="hljs-attr">"modules"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"module"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"identifier"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/Users/tecvan/studio/webpack-book-samples/target-sample/src/index.js"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"fooDuration"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">124</span><span class="hljs-punctuation">,</span>
      <span class="hljs-comment">/*...*/</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-comment">/*...*/</span>
    <span class="hljs-comment">/*...*/</span>
    <span class="hljs-comment">/*...*/</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> 
  <span class="hljs-attr">"assets"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-comment">/*...*/</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"chunks"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-comment">/*...*/</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"entrypoints"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-comment">/*...*/</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"namedChunkGroups"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-comment">/*...*/</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"errors"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-comment">/*...*/</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>这种方式有许多优点：</p>
<ul>
<li>用户可以直接通过 <code>stats</code> 了解插件的运行情况，不需要重复学习其它方式；</li>
<li>支持按需执行，用户可通过 <a href="https://webpack.js.org/configuration/stats/" target="_blank" rel="nofollow noopener noreferrer">stats</a> 配置项控制；</li>
<li>支持导出为 JSON 或其它文件格式，方便后续接入自动化分析流程。</li>
</ul>
<p>因此，若明确插件将执行非常重的计算任务，需要消耗比较长的构建时间时，可以通过这种方式上报关键性能数据，帮助用户做好性能分析。</p>
<h2>校验配置参数</h2>
<p>在《<a href="https://juejin.cn/book/7115598540721618944/section/7119035564862472233" target="_blank" rel="nofollow noopener noreferrer">Loader 开发进阶</a>》一文中，我们已经详细介绍了 <a href="https://www.npmjs.com/package/schema-utils" target="_blank" rel="nofollow noopener noreferrer">schema-utils</a> 校验工具的使用方法，开发插件时也使用这一工具校验配置参数，例如：</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> { validate } = <span class="hljs-built_in">require</span>(<span class="hljs-string">"schema-utils"</span>);
<span class="hljs-keyword">const</span> schema = {
  <span class="hljs-comment">/*...*/</span>
};

<span class="hljs-keyword">class</span> <span class="hljs-title class_">FooPlugin</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">options</span>) {
    <span class="hljs-title function_">validate</span>(schema, options);
  }
}
</code></pre>
<p>详细用法可自行回顾《<a href="https://juejin.cn/book/7115598540721618944/section/7119035564862472233" target="_blank" rel="nofollow noopener noreferrer">Loader 开发进阶</a>》章节，此处不再赘述。</p>
<h2>搭建自动测试环境</h2>
<p>为 Webpack Loader 编写单元测试收益非常高，一方面对开发者来说，不用重复搭建测试环境、编写测试 demo；一方面对于最终用户来说，带有一定测试覆盖率的项目通常意味着更高、更稳定的质量。插件测试用例开发有两个关键技术点：</p>
<ol>
<li>如何搭建自动运行 Webpack，并能够读取构建结果的测试环境？</li>
<li>如何分析构建结果，确定插件逻辑符合预期？</li>
</ol>
<blockquote>
<p><strong>搭建测试环境</strong></p>
</blockquote>
<p>Webpack 虽然功能非常复杂，但本质上还是一个 Node 程序，所以我们可以使用一些 Node 测试工具搭建自动测试环境，例如 Jest、Karma 等。以 Jest 为例：</p>
<ol>
<li>安装依赖，考虑到我们即将用 ES6 编写测试用例，这里额外添加了 <a href="https://jestjs.io/docs/getting-started#using-babel" target="_blank" rel="nofollow noopener noreferrer">babel-jest</a> 等包：</li>
</ol>
<pre><code class="hljs language-sql">yarn <span class="hljs-keyword">add</span> <span class="hljs-operator">-</span>D jest babel<span class="hljs-operator">-</span>jest <span class="hljs-variable">@babel</span><span class="hljs-operator">/</span>core <span class="hljs-variable">@babel</span><span class="hljs-operator">/</span>preset<span class="hljs-operator">-</span>env
</code></pre>
<ol start="2">
<li>添加 Babel 配置，如：</li>
</ol>
<pre><code class="hljs language-js"><span class="hljs-comment">// babel.config.js</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">presets</span>: [[<span class="hljs-string">'@babel/preset-env'</span>, {<span class="hljs-attr">targets</span>: {<span class="hljs-attr">node</span>: <span class="hljs-string">'current'</span>}}]],
};
</code></pre>
<ol start="3">
<li>添加 Jest 配置文件，如：</li>
</ol>
<pre><code class="hljs language-js"><span class="hljs-comment">// jest.config.js</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">testEnvironment</span>: <span class="hljs-string">"node"</span>,
};
</code></pre>
<p>到这里，基础环境设置完毕，我们可以开始编写测试用例了。首先需要在测试代码中运行 Webpack，方法很简单，如：</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">import</span> webpack <span class="hljs-keyword">from</span> <span class="hljs-string">'webpack'</span>;

<span class="hljs-title function_">webpack</span>(config).<span class="hljs-title function_">run</span>();
</code></pre>
<p>这部分逻辑比较通用，许多开源仓库都会将其提取为工具函数，类似于：</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">"path"</span>;
<span class="hljs-keyword">import</span> webpack <span class="hljs-keyword">from</span> <span class="hljs-string">"webpack"</span>;
<span class="hljs-keyword">import</span> { merge } <span class="hljs-keyword">from</span> <span class="hljs-string">"webpack-merge"</span>;
<span class="hljs-keyword">import</span> { createFsFromVolume, <span class="hljs-title class_">Volume</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"memfs"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">runCompile</span>(<span class="hljs-params">options</span>) {
  <span class="hljs-keyword">const</span> opt = <span class="hljs-title function_">merge</span>(
    {
      <span class="hljs-attr">mode</span>: <span class="hljs-string">"development"</span>,
      <span class="hljs-attr">devtool</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-comment">// Mock 项目入口文件</span>
      <span class="hljs-attr">entry</span>: path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">"./enter.js"</span>),
      <span class="hljs-attr">output</span>: { <span class="hljs-attr">path</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">"../dist"</span>) },
    },
    options
  );

  <span class="hljs-keyword">const</span> compiler = <span class="hljs-title function_">webpack</span>(opt);
  <span class="hljs-comment">// 使用内存文件系统，节省磁盘 IO 开支</span>
  compiler.<span class="hljs-property">outputFileSystem</span> = <span class="hljs-title function_">createFsFromVolume</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Volume</span>());

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =></span> {
    compiler.<span class="hljs-title function_">run</span>(<span class="hljs-function">(<span class="hljs-params">error, stats</span>) =></span> {
      <span class="hljs-keyword">if</span> (error) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">reject</span>(error);
      }
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">resolve</span>({ stats, compiler });
    });
  });
}
</code></pre>
<blockquote>
<p>提示：示例代码已上传到小册 <a href="https://github.com/Tecvan-fe/webpack-book-samples/blob/main/plugin-testing/test/helpers/index.js" target="_blank" rel="nofollow noopener noreferrer">仓库</a>。</p>
</blockquote>
<p>有了测试所需的基础环境，以及运行 Webpack 实例的能力之后，我们可以正式开始编写测试用例了。</p>
<blockquote>
<p><strong>编写测试用例</strong></p>
</blockquote>
<p>Webpack 插件测试的基本逻辑是：在测试框架中运行 Webpack，之后对比分析构建结果、状态等是否符合预期，对比的内容通常有：</p>
<ul>
<li>分析 <code>compilation.error/warn</code> 数组是否包含或不包含特定错误、异常信息，通常用于判断 Webpack 是否运行成功；</li>
<li>分析构建产物，判断是否符合预期，例如：
<ul>
<li><code>image-minimizer-webpack-plugin</code> 单测中会 <a href="https://github.com/webpack-contrib/image-minimizer-webpack-plugin/blob/master/test/ImageminPlugin.test.js" target="_blank" rel="nofollow noopener noreferrer">判断</a> 最终产物图片有没有经过压缩；</li>
<li><code>copy-webpack-plugn</code> 单测中会 <a href="https://github1s.com/webpack-contrib/copy-webpack-plugin/blob/HEAD/test/CopyPlugin.test.js" target="_blank" rel="nofollow noopener noreferrer">判断</a> 文件有没有被复制到产物文件；</li>
<li><code>mini-css-extract-plugin</code> 单测中会 <a href="https://github1s.com/webpack-contrib/mini-css-extract-plugin/blob/HEAD/test/TestCases.test.js" target="_blank" rel="nofollow noopener noreferrer">判断</a> CSS 文件有没有被正确抽取出来。</li>
</ul>
</li>
</ul>
<p>沿着这个思路，我们构造一个简单的测试用例：</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">"path"</span>;
<span class="hljs-keyword">import</span> { promisify } <span class="hljs-keyword">from</span> <span class="hljs-string">"util"</span>;
<span class="hljs-keyword">import</span> { runCompile } <span class="hljs-keyword">from</span> <span class="hljs-string">"./helpers"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">FooPlugin</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"../src/FooPlugin"</span>;

<span class="hljs-title function_">describe</span>(<span class="hljs-string">"foo plugin"</span>, <span class="hljs-function">() =></span> {
  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should inject foo banner"</span>, <span class="hljs-keyword">async</span> () => {
    <span class="hljs-keyword">const</span> {
      <span class="hljs-attr">stats</span>: { compilation },
      compiler,
    } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">runCompile</span>({
      <span class="hljs-attr">plugins</span>: [<span class="hljs-keyword">new</span> <span class="hljs-title class_">FooPlugin</span>()],
    });
    <span class="hljs-keyword">const</span> { warnings, errors, assets } = compilation;

    <span class="hljs-comment">// 判断 warnings、errors 是否报出异常信息</span>
    <span class="hljs-title function_">expect</span>(warnings).<span class="hljs-title function_">toHaveLength</span>(<span class="hljs-number">0</span>);
    <span class="hljs-title function_">expect</span>(errors).<span class="hljs-title function_">toHaveLength</span>(<span class="hljs-number">0</span>);

    <span class="hljs-keyword">const</span> { <span class="hljs-attr">path</span>: outputPath } = compilation.<span class="hljs-property">options</span>.<span class="hljs-property">output</span>;
    <span class="hljs-comment">// 遍历 assets，判断经过插件处理后，产物内容是否符合预期</span>
    <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(
      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(assets).<span class="hljs-title function_">map</span>(<span class="hljs-keyword">async</span> (name) => {
        <span class="hljs-keyword">const</span> pathToEmitted = path.<span class="hljs-title function_">join</span>(outputPath, name);
        <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">promisify</span>(compiler.<span class="hljs-property">outputFileSystem</span>.<span class="hljs-property">readFile</span>)(
          pathToEmitted,
          { <span class="hljs-attr">encoding</span>: <span class="hljs-string">"UTF-8"</span> }
        );
        <span class="hljs-title function_">expect</span>(result.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">"// Inject By 范文杰"</span>)).<span class="hljs-title function_">toBeTruthy</span>();
      })
    );
  });
});
</code></pre>
<blockquote>
<p>提示：示例代码已上传到小册 <a href="https://github.com/Tecvan-fe/webpack-book-samples/blob/main/plugin-testing/test/helpers/index.js" target="_blank" rel="nofollow noopener noreferrer">仓库</a>。</p>
</blockquote>
<p>示例中，17、18 行通过 <code>errors/warnings</code> 判断运行过程是否出现异常；25 行读入产物文件，之后判断内容是否满足要求。</p>
<h2>总结</h2>
<p>本文主要介绍 Webpack 插件可用性与健壮性层面的开发技巧，包括：</p>
<ul>
<li>我们应该尽量复用 Webpack Infrastructure Logging 接口记录插件运行日志；</li>
<li>若插件运行耗时较大，应该通过 <code>reportProgress</code> 接口上报执行进度，供用户了解运行状态；</li>
<li>应该尽可能使用 <code>schema-utils</code> 工具校验插件参数，确保输入参数的合法性；</li>
<li>可以借助 Node 测试工具，如 Jest、Karma 等搭建插件自动测试环境，之后在测试框架中运行 Webpack，分析比对构建结果、状态(产物文件、<code>warning/errors</code> 数组等)，确定插件是否正常运行。</li>
</ul>
<p>这些技巧与插件主功能无关，但有助于提升插件质量，还可以让用户更了解插件的运行状态、运行性能等，让插件本身更可靠，更容易被用户选择。</p>
<h2>思考题</h2>
<p>综合全文，思考一下 Logger 的 <code>warn/error</code> 接口与 <code>compilation</code> 对象的 <code>errors/warnings</code> 数组有什么区别？分别适用于什么场景？哪种方式更利于自动化测试？</p></div>
</body></html>