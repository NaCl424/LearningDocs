<!DOCTYPE html><html lang="en"><head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>26 | 如何设计一个“万能”项目脚手架？</title>
<style type="text/css">.hljs{display:block;overflow-x:auto;padding:.5em;color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}/*# sourceURL=/Users/young/Documents/Codes/Fun/lagou/public/atom-one-light.min.css*/</style><style type="text/css">/*
 * Copyright (C) 2018 Drake, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

:root {
    --monospace: "JetBrains Mono", HYZhengYuan, "Fira Code", Menlo, "Ubuntu Mono", Consolas; /*code font*/
    --text-font: var(--monospace); /*default font*/
    --title-font: var(--monospace); /*title font*/

    --text-color: #333333;
    --bg-color: #ffffff;
    --control-text-color: var(--text-color);
    --meta-content-color: var(--text-color);
    --active-file-border-color: var(--drake-accent);
    --rawblock-edit-panel-bd: var(--code-block-bg-color);
    --item-hover-bg-color: #E5E5E596;
    --active-file-bg-color: var(--item-hover-bg-color);

    --drake-accent: #e95f59;
    --drake-highlight: #d63200;
    --a-color: #036aca;
    --variable-color: var(--drake-highlight);
    --outline-active-color: var(--a-color);
    --code-block-bg-color: #2b2b2b;
    --code-block-color: #A9B7C6;
    --title-color: #135ce0;
    --blockquote-border-color: #b2aec5;
    --blockquote-color: #595959;
    --blockquote-bg-color: #fff9f9;
    --strong-color: var(--title-color);
    --h2-underline-color: var(--title-color);
    --horizontal-divider-color: var(--title-color);
    --height-light-color: var(--drake-highlight);
    --height-light-border-color: var(--drake-highlight);
    --yaml-color: #777777;
    --yaml-bg-color: #f7f7f7;
    --footnotes-bg-color: #3c3d3e;
    --footnotes-highlight: #FFD760;
    --table-border-color: #dfe2e5;
    --table-header-bg-color: #f6f8fa;
    --table-bg-color: var(--bg-color);
    --table-n2-bg-color: #f6f8fa;
    --input-bg-color: var(--item-hover-bg-color);
    --btn-hover-bg-color: var(--item-hover-bg-color);
    --checkbox-checked: url("data:image/svg+xml,%3Csvg class='icon' viewBox='0 0 1024 1024' xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Cpath d='M425.984 726.016l384-384-59.99-61.995-324.01 324.011-152.021-152.021L213.973 512zm384-598.016q36.01 0 61.013 25.984T896 213.974v596.01q0 34.005-25.003 59.99t-61.013 25.983h-596.01q-36.011 0-61.014-25.984t-25.003-59.989v-596.01q0-34.006 25.003-59.99T213.973 128h596.011z' fill='%2365b73b'/%3E%3C/svg%3E");
    --checkbox-unchecked: url("data:image/svg+xml,%3Csvg class='icon' viewBox='0 0 1024 1024' xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Cpath d='M810.667 213.333v597.334H213.333V213.333h597.334m0-85.333H213.333C166.4 128 128 166.4 128 213.333v597.334C128 857.6 166.4 896 213.333 896h597.334C857.6 896 896 857.6 896 810.667V213.333C896 166.4 857.6 128 810.667 128z' fill='%23333333'/%3E%3C/svg%3E");
}

html {
    font-size: 15px;
}

body {
    font-family: var(--text-font) !important;
    color: var(--text-color);
    -webkit-font-feature-settings: "liga" on, "calt" on;
    -webkit-font-smoothing: subpixel-antialiased;
    text-rendering: optimizeLegibility;
    letter-spacing: 0;
    margin: 0;
    overflow-x: hidden;
    line-height: 1.8rem;
}

img {
    max-width: 100%;
}

#write {
    background-image: linear-gradient(
            90deg
            ,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(
            1turn
            ,rgba(60,10,30,.04) 3%,transparent 0);
    background-size: 20px 20px;
    background-position: 50%;
}

/*code block*/
#write .md-fences {
    font-size: 1rem;
    padding: 0.5rem !important;
    border-radius: 2px;
    word-wrap: normal;
    background-color: var(--code-block-bg-color);
    color: var(--code-block-color);
    border: none;
}

/*code snippet*/
#write code, tt {
    border-radius: 2px;
    color: var(--drake-highlight);
}

/*variable*/
var {
    color: var(--variable-color);
    font-weight: bold;
}

/*raw block*/
.md-rawblock-control:not(.md-rawblock-tooltip) {
    border-radius: 2px 0 2px 2px;
    padding: 0.2rem !important;
}
.md-rawblock:hover > .md-rawblock-container {
    background: none;
}
.md-rawblock-input {
    font-size: 1rem;
}
.md-rawblock-tooltip-btn:hover {
    background: none;
}
.md-rawblock:hover > .md-rawblock-tooltip {
    border-radius: 2px 2px 0 0;
    margin-bottom: 2px !important;
}
.md-rawblock-tooltip.md-rawblock-control {
    border-radius: 2px 2px 0 0;
    color: var(--code-block-color);
}
.md-rawblock-tooltip-name {
    color: var(--code-block-color);
    opacity: 1;
}

/*quote block*/
blockquote:before {
    display: block;
    position: absolute;
    content: '';
    width: 4px;
    left: 0;
    top: 0;
    height: 100%;
    background-color: var(--blockquote-border-color);
    border-radius: 2px;
}

blockquote {
    color: var(--blockquote-color);
    border-radius: 2px;
    padding: 10px 16px;
    background-color: var(--blockquote-bg-color);
    position: relative;
    border-left: none;
}

#write strong {
    color: var(--strong-color);
    font-weight: bold;
}
#write blockquote strong {
    color: var(--blockquote-color);
}

/*link*/
#write a {
    color: var(--a-color);
    text-decoration: none;
}
#write a .md-plain, .md-htmlblock-container a:hover {
    border-bottom: .1rem solid var(--a-color);
}
[md-inline=link] a {
    margin: 0 .2rem;
}
a:any-link {
    color: var(--a-color);
}

img {
    border-left: none;
    border-right: none;
    vertical-align: baseline;
    border-radius: 2px;
}

#write {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px 30px 100px;
}
#typora-source .CodeMirror-lines {
    max-width: 1200px;
}

#write p {
    word-spacing: .05rem;
}

#write > ul:first-child,
#write > ol:first-child {
    margin-top: 30px;
}

body > *:first-child {
    margin-top: 0 !important;
}

body > *:last-child {
    margin-bottom: 0 !important;
}

h1,
h2,
h3,
h4,
h5,
h6 {
    font-family: var(--title-font);
    position: relative;
    margin-top: 2rem;
    margin-bottom: 1rem;
    font-weight: bold;
    cursor: text;
    color: var(--title-color);
}

h3.md-focus:before, h4.md-focus:before, h5.md-focus:before, h6.md-focus:before {
    visibility: hidden;
}

h1 {
    font-size: 1.6rem;
    text-align: center;
    margin-top: 0;
}

h2.md-end-block.md-heading {
    font-size: 1.6rem;
    display: inline-block;
}

h2.md-end-block.md-heading:after {
    display: block;
    content: '';
    height: 2px;
    margin-top: 4px;
    background-color: var(--h2-underline-color);
    border-radius: 2px;
}

h3 {
    font-size: 1.4rem;
}

h4 {
    font-size: 1.2rem;
}

h5 {
    font-size: 1rem;
}

h6 {
    font-size: 1rem;
}

h1:hover a.anchor,
h2:hover a.anchor,
h3:hover a.anchor,
h4:hover a.anchor,
h5:hover a.anchor,
h6:hover a.anchor {
    text-decoration: none;
}

h1 tt,
h1 code {
    font-size: inherit !important;
}

h2 tt,
h2 code {
    font-size: inherit !important;
}

h3 tt,
h3 code {
    font-size: inherit !important;
}

h4 tt,
h4 code {
    font-size: inherit !important;
}

h5 tt,
h5 code {
    font-size: inherit !important;
}

h6 tt,
h6 code {
    font-size: inherit !important;
}

blockquote,
ul,
ol,
dl,
table {
    margin: 0.8em 0;
}
p {
    margin: 0;
}

li > ol,
li > ul {
    margin: 0 0;
}

hr {
    height: 2px;
    padding: 0;
    margin: 16px 0;
    background-color: var(--horizontal-divider-color);
    border: 0 none;
    overflow: hidden;
    box-sizing: content-box;
}

body > h2:first-child {
    margin-top: 0;
    padding-top: 0;
}

body > h1:first-child {
    margin-top: 0;
    padding-top: 0;
}

body > h1:first-child + h2 {
    margin-top: 0;
    padding-top: 0;
}

body > h3:first-child,
body > h4:first-child,
body > h5:first-child,
body > h6:first-child {
    margin-top: 0;
    padding-top: 0;
}

a:first-child h1,
a:first-child h2,
a:first-child h3,
a:first-child h4,
a:first-child h5,
a:first-child h6 {
    margin-top: 0;
    padding-top: 0;
}

h1 p,
h2 p,
h3 p,
h4 p,
h5 p,
h6 p {
    margin-top: 0;
}

li p.first {
    display: inline-block;
}

ul, ol {
    padding-inline-start: 2em;
}

ul:first-child,
ol:first-child {
    margin-top: 0;
}

ul:last-child,
ol:last-child {
    margin-bottom: 0;
}

table {
    padding: 0;
    word-break: initial;
    background-color: var(--table-bg-color);
}
table tr {
    border-top: .1em solid var(--table-border-color);
    margin: 0;
    padding: 0;
}
table th {
    font-weight: bold;
    border: .1em solid var(--table-border-color);
    border-bottom: 0;
    margin: 0;
    padding: 6px 13px;
}
table td {
    border: .1em solid var(--table-border-color);
    margin: 0;
    padding: 6px 13px;
}
table thead {
    background-color: var(--table-header-bg-color);
}
table tr:nth-child(2n) {
    background-color: var(--table-n2-bg-color);
}
table tr th:first-child,
table tr td:first-child {
    margin-top: 0;
}
table tr th:last-child,
table tr td:last-child {
    margin-bottom: 0;
}

#write em {
    padding: 0 5px 0 2px;
}

/* height light */
#write mark {
    border: .1em solid var(--height-light-border-color);
    color: var(--height-light-color);
    background-color: transparent;
    padding: .1rem .5rem;
    border-radius: 2rem;
    margin: 0 .2rem;
    font-size: .95rem;
}

/*shortcut*/
kbd {
    border: .1em solid #5b5b5e;
    background: transparent;
    color: var(--text-color);
    margin: 0 .4rem;
    font-size: .95rem;
    padding: .3em .4em;
    border-radius: .4em;
    vertical-align: top;
    box-shadow: .1em .1em .2em rgba(0, 0, 0, 0.3);
}

#write del {
    padding: 1px 2px;
}

.md-task-list-item > input {
    margin-left: -1.3em;
}

@media print {
    html {
        font-size: 12px;
    }

    table,
    pre {
        page-break-inside: avoid;
    }

    pre {
        word-wrap: break-word;
    }
}

/*YAML*/
#write pre.md-meta-block {
    padding: 1rem;
    font-size: 1rem;
    background-color: var(--yaml-bg-color);
    border: 0;
    border-radius: 2px;
    color: var(--yaml-color);
    margin-top: 0 !important;
}

.mathjax-block > .code-tooltip {
    bottom: .375rem;
}

#write > h3.md-focus:before {
    left: -1.5625rem;
    top: .375rem;
}

#write > h4.md-focus:before {
    left: -1.5625rem;
    top: .285714286rem;
}

#write > h5.md-focus:before {
    left: -1.5625rem;
    top: .285714286rem;
}

#write > h6.md-focus:before {
    left: -1.5625rem;
    top: .285714286rem;
}

.md-image > .md-meta {
    border-radius: 2px;
    font-family: initial;
    padding: 2px 0 0 4px;
    color: inherit;
}

.md-tag {
    color: inherit;
}

.md-toc {
    margin-top: 20px;
    padding-bottom: 20px;
}

.typora-quick-open-item {
    font-size: 1rem !important;
    height: 50px;
    padding-left: 8px;
    padding-top: 4px;
    padding-bottom: 4px;
}

#typora-quick-open {
    box-shadow: 0 0 8px #00000045;
    padding: 0;
}

.ty-quick-open-category.ty-has-prev .ty-quick-open-category-title {
    border-top: none;
}

#typora-quick-open-input {
    margin: 8px;
    box-shadow: none;
    border-radius: 2px;
}

#typora-quick-open-input input {
    font-size: 1rem;
    box-shadow: none;
    padding-top: 2px;
    padding-left: 10px;
    padding-right: 10px;
    line-height: 32px;
    max-height: 32px;
    border: none;
}

.modal-dialog#typora-quick-open {
    border-radius: 8px;
}

.ty-quick-open-category-title {
    padding-left: 8px;
    color: #BEBEBE;
    font-size: 0.8rem;
    margin-bottom: 4px;
}

.typora-quick-open-item-path {
    font-size: 0.8rem;
    text-overflow: ellipsis;
    white-space: nowrap;
    margin-top: 1px;
}

/*search input*/
.form-control {
    border: none;
    border-radius: 2px;
    box-shadow: none;
}

#md-searchpanel .btn {
    border-radius: 2px;
}

#search-panel-replaceall-btn {
    padding-right: 5px !important;
    text-align: center !important;
}

#search-panel-replace-btn {
    text-align: center !important;
}

#md-searchpanel input {
    background: var(--input-bg-color);
    border-radius: 2px;
}

.searchpanel-search-option-btn {
    border-radius: 2px;
    border: none;
    background: transparent;
    color: var(--text-color);
}

.searchpanel-search-option-btn.active {
    background: var(--text-color);
    color: var(--bg-color);
}

.form-control:focus {
    box-shadow: none;
}

#md-notification:before {
    top: 10px;
}

/** focus mode */
.on-focus-mode blockquote {
    border-left-color: rgba(85, 85, 85, 0.12);
}

header,
.context-menu,
.megamenu-content,
footer {
    font-family: initial;
}

/*sidebar*/
.file-node-content:hover .file-node-icon,
.file-node-content:hover .file-node-open-state {
    visibility: visible;
}

#typora-sidebar {
    font-size: 1.1rem;
}

.sidebar-tabs {
    border-bottom: none;
}

.file-list-item-summary, .file-list-item-parent-loc, .file-list-item-time, .file-list-item-summary {
    font-size: 0.9rem !important;
    font-family: var(--text-font);
}

.file-list-item-file-ext-part {
    display: none;
}

.outline-item {
    font-size: 1rem;
}

/*footnotes mark*/
#write .md-footnote {
    background-color: inherit;
    color: var(--drake-highlight);
    font-size: 0.9rem;
    border-radius: 0.9rem;
    padding-left: 0;
}

#write .md-footnote:before {
    content: "[";
}

#write .md-footnote:after {
    content: "]";
}

/*footnotes content*/
.md-hover-tip .code-tooltip-content {
    border-radius: 2px;
}

/*footnotes title*/
span.md-def-name {
    padding-right: 3ch;
    padding-left: 0;
    position: relative;
    font-weight: normal;
}

/*footnotes desc*/
.footnotes {
    font-size: 1rem;
    font-weight: normal;
    color: var(--text-color);
    position: relative;
}

/*footnotes tooltip text*/
.code-tooltip-content .md-plain {
    font-size: 0.9rem;
    font-family: inherit;
}

.code-tooltip-content code {
    padding: 0 2px;
    font-family: inherit;
    color: var(--footnotes-highlight);
    background-color: inherit;
}

.code-tooltip-content a {
    color: var(--footnotes-highlight);
}

div.code-tooltip-content {
    box-shadow: 0 0 8px #00000045;
    background: var(--footnotes-bg-color);
}

.footnotes {
    opacity: 1;
}

.md-def-name:after {
    content: ". ^";
    color: var(--text-color);
}

.md-def-footnote .md-def-name:before {
    content: "";
    color: var(--text-color);
    position: absolute;
}

.md-def-name:before {
    content: "";
    color: var(--text-color);
    position: absolute;
}

.md-content.md-url, .md-def-content.md-def-url.md-auto-disp {
    text-decoration: none;
    border-bottom: .1rem solid var(--text-color);
}

.CodeMirror-scroll::-webkit-scrollbar {
    display: none;
}

.file-list-item-summary {
    font-size: 1em;
}

.pin-outline #outline-content .outline-active strong, .pin-outline .outline-active {
    font-weight: 500;
    color: var(--outline-active-color);
}

.file-list-item.active {
    border-left: 4px solid var(--drake-accent);
}

#md-searchpanel .btn:not(.close-btn):hover {
    box-shadow: none;
    background: var(--btn-hover-bg-color);
}

/*checkbox*/
#write input[type=checkbox] {
    opacity: 0;
    height: 1.6rem;
    width: 1.6rem;
    margin-left: -2em;
    margin-top: 0;
    top: 0;
}

#write .ul-list li.md-task-list-item.task-list-done::before {
    content: "";
    background: var(--checkbox-checked) 0 0 no-repeat;
    background-size: 100%;
    display: inline-block;
    position: absolute;
    height: 1.6rem;
    width: 1.6rem;
    margin-left: -2em;
}

#write .ul-list li.md-task-list-item.task-list-not-done::before {
    content: "";
    background: var(--checkbox-unchecked) 0 0 no-repeat;
    background-size: 100%;
    display: inline-block;
    position: absolute;
    height: 1.6rem;
    width: 1.6rem;
    margin-left: -2em;
}

/*insert table*/
.btn {
    border-radius: 2px;
}

.modal-content {
    border-radius: 8px;
}

.btn-primary:hover, .btn-primary:active {
    background-color: var(--btn-hover-bg-color);
    color: var(--drake-highlight);
}

.btn-primary {
    background-color: transparent;
    color: var(--drake-highlight);
}

.btn-default {
    background-color: transparent;
}

.btn:active {
    box-shadow: none;
    border-color: transparent;
}

.modal-footer {
    border-top: none;
}

#table-insert-col, #table-insert-row {
    background: var(--input-bg-color);
    border-radius: 2px;
}

/*preference panel*/
#megamenu-content {
    background-image: none !important;
    background-color: var(--bg-color);
}
#top-titlebar {
    height: inherit;
    background-color: var(--bg-color);
}
#megamenu-menu-sidebar {
    background-color: var(--bg-color);
    color: var(--text-color);
}
.long-btn {
    width: inherit;
    min-width: 300px;
    border: 1px solid var(--text-color);
    border-radius: 6px;
}
.megamenu-menu-panel h1 {
    margin-bottom: 3rem;
    text-align: left;
}
.megamenu-menu-panel h1, .megamenu-menu-panel h2 {
    font-weight: normal;
}
#recent-file-panel-search-input {
    height: 45px;
    border: none;
    border-bottom: 1px solid var(--text-color);
    padding-left: 8px;
}
#recent-file-panel-search-input::placeholder {
    color: var(--text-color);
    opacity: .5;
}
.megamenu-menu-header {
    border-bottom: none;
}
#recent-file-panel-action-btn {
    background: none;
    border: none;
}
#recent-file-panel-action-btn-container {
    float: none;
    display: inline-block;
}
#top-titlebar .toolbar-icon.btn.hover, #top-titlebar .toolbar-icon.btn:hover {
    background-color: var(--btn-hover-bg-color);
    color: var(--text-color);
}
.megamenu-menu-panel .btn:hover {
    background-color: var(--btn-hover-bg-color) !important;
    color: var(--text-color);
}
#recent-file-panel tbody tr:nth-child(2n-1),
.megamenu-menu-panel table thead,
.megamenu-menu-panel table tr {
    background-color: transparent;
}
.megamenu-menu-panel table {
    font-weight: normal;
}
#megamenu-back-btn {
    color: var(--text-color);
    border: 1px solid var(--text-color);
}
.megamenu-menu-header #megamenu-menu-header-title {
    color: var(--text-color);
}
header, .context-menu, .megamenu-content, footer {
    font-family: var(--text-font);
}
.ty-preferences select {
    padding-left: 2px;
}
.preference-item-hint {
    font-size: 14px;
}
a.ty-link {
    color: var(--a-color);
    margin: 0 .2rem;
}

/**
    code render
    Name: IntelliJ IDEA darcula theme
    From IntelliJ IDEA by JetBrains
 */
.cm-s-inner.CodeMirror {
    background: var(--code-block-bg-color);
    color: var(--code-block-color);
}

.cm-s-inner span.cm-meta {
    color: #BBB529;
}

.cm-s-inner span.cm-number {
    color: #6897BB;
}

.cm-s-inner span.cm-keyword {
    color: #CC7832;
}

.cm-s-inner span.cm-def {
    color: #FFD760;
}

.cm-s-inner span.cm-variable {
    color: var(--code-block-color);
}

.cm-s-inner span.cm-variable-2 {
    color: var(--code-block-color);
}

.cm-s-inner span.cm-variable-3 {
    color: #9876AA;
}

.cm-s-inner span.cm-type {
    color: #AABBCC;
}

.cm-s-inner span.cm-property {
    color: #FFC66D;
}

.cm-s-inner span.cm-operator {
    color: var(--code-block-color);
}

.cm-s-inner span.cm-string {
    color: #6A8759;
}

.cm-s-inner span.cm-string-2 {
    color: #6A8759;
}

.cm-s-inner span.cm-comment {
    color: #787878;
}

.cm-s-inner span.cm-link {
    color: #CC7832;
}

.cm-s-inner span.cm-atom {
    color: #CC7832;
}

.cm-s-inner span.cm-error {
    color: #BC3F3C;
}

.cm-s-inner span.cm-tag {
    color: #E8BF6A;
}

.cm-s-inner span.cm-quote {
    color: #a6e22e;
}

.cm-s-inner span.cm-attribute {
    color: #9876AA;
}

.cm-s-inner span.cm-qualifier {
    color: #6A8759;
}

.cm-s-inner span.cm-bracket {
    color: #E8BF6A;
}

.cm-s-inner span.cm-builtin {
    color: #FF9E59;
}

.cm-s-inner span.cm-special {
    color: #FF9E59;
}

.cm-s-inner span.cm-matchhighlight {
    color: #FFFFFF;
    background-color: rgba(50, 89, 48, .7);
    font-weight: normal;
}

.cm-s-inner span.cm-searching {
    color: #FFFFFF;
    background-color: rgba(61, 115, 59, .7);
    font-weight: normal;
}

.cm-s-inner .CodeMirror-gutters {
    border-right: 1px solid rgba(120, 120, 120, 0.3);
}

.cm-s-inner .CodeMirror-linenumber {
    color: #585b5d;
}

.cm-s-inner .CodeMirror-matchingbracket {
    background-color: #3B514D;
    color: #FFEF28 !important;
}

.cm-s-inner .CodeMirror-selected {
    background: #214283 !important;
}

.cm-s-inner .CodeMirror-selectedtext {
    background: #214283 !important;
}

.cm-s-typora-default .CodeMirror-selectedtext {
    background: var(--select-text-bg-color) !important;
}

.cm-overlay.CodeMirror-selectedtext {
    background: var(--select-text-bg-color) !important;
}

.cm-s-inner div.CodeMirror-cursor {
    border-left: 1px solid var(--code-block-color);
}/*# sourceURL=/Users/didi/Documents/Codes/Fun/lagou/public/drake-juejin.css*/</style></head>
<body>
  <div id="write"><h1>26 | 如何设计一个“万能”项目脚手架？</h1><p data-nodeid="1605" class="">脚手架是工程化中不可缺少的一环。究竟什么是脚手架呢？广义上来说，脚手架就是为了保证各施工过程顺利进行而搭设的工作平台。</p>
<p data-nodeid="1606">编程领域的脚手架主要为了完成新项目的启动和搭建，能够帮助开发者提升效率和开发体验。对于前端来说，从零开始建立一个项目是复杂的，因此也就存在了较多类型的脚手架：</p>
<ul data-nodeid="1607">
<li data-nodeid="1608">
<p data-nodeid="1609">Vue/React 框架类脚手架</p>
</li>
<li data-nodeid="1610">
<p data-nodeid="1611">Webpack 等构建配置类脚手架</p>
</li>
<li data-nodeid="1612">
<p data-nodeid="1613">混合脚手架，比如大家熟悉的 Vue-cli 或者 create-react-app</p>
</li>
</ul>
<p data-nodeid="1614">这一讲我们就深入这些脚手架的原理进行讲解。</p>
<h3 data-nodeid="1615">命令行工具原理和实现</h3>
<p data-nodeid="6062" class="te-preview-highlight">现代脚手架离不开命令行工具，命令行工具即 Command-line interfaces（CLIs） ，是编程领域的重要概念，也是我们开发中经常接触到的工具之一。</p>


<p data-nodeid="1617">比如 Webpack、Babel、npm、Yarn 等都是典型的命令行。此外，流畅的命令行能够迅速启动一个脚手架，实现<strong data-nodeid="1743">自动化和智能化</strong>流程。这一部分，我们就使用 Node.js 来开发一个命令行。</p>
<p data-nodeid="1618">我们先来看几个开发命令行工具的关键依赖。</p>
<ul data-nodeid="1619">
<li data-nodeid="1620">
<p data-nodeid="1621"><a href="http://npm.im/inquirer" data-nodeid="1747"><code data-backticks="1" data-nodeid="1746">inquirer</code></a>、<a href="http://npm.im/enquirer" data-nodeid="1751"><code data-backticks="1" data-nodeid="1750">enquirer</code></a>、<a href="https://npm.im/prompts" data-nodeid="1755"><code data-backticks="1" data-nodeid="1754">prompts</code></a>：可以处理复杂的用户输入，完成命令行输入交互。</p>
</li>
<li data-nodeid="1622">
<p data-nodeid="1623"><a href="http://npm.im/chalk" data-nodeid="1759"><code data-backticks="1" data-nodeid="1758">chalk</code></a>、<a href="https://npm.im/kleur" data-nodeid="1763"><code data-backticks="1" data-nodeid="1762">kleur</code></a>：使终端可以输出彩色信息文案。</p>
</li>
<li data-nodeid="1624">
<p data-nodeid="1625"><a href="http://npm.im/ora" data-nodeid="1767"><code data-backticks="1" data-nodeid="1766">ora</code></a>：可以让命令行出现好看的 Spinners。</p>
</li>
<li data-nodeid="1626">
<p data-nodeid="1627"><a href="http://npm.im/boxen" data-nodeid="1771"><code data-backticks="1" data-nodeid="1770">boxen</code></a>：可以在命令行中画出 Boxes 区块。</p>
</li>
<li data-nodeid="1628">
<p data-nodeid="1629"><a href="http://npm.im/listr" data-nodeid="1775"><code data-backticks="1" data-nodeid="1774">listr</code></a>：可以在命令行中画出进度列表。</p>
</li>
<li data-nodeid="1630">
<p data-nodeid="1631"><a href="http://npm.im/meow" data-nodeid="1779"><code data-backticks="1" data-nodeid="1778">meow</code></a>、<a href="http://npm.im/arg" data-nodeid="1783"><code data-backticks="1" data-nodeid="1782">arg</code></a>：可以进行基础的命令行参数解析。</p>
</li>
<li data-nodeid="1632">
<p data-nodeid="1633"><a href="http://npm.im/commander" data-nodeid="1787"><code data-backticks="1" data-nodeid="1786">commander</code></a>、<a href="https://www.npmjs.com/package/yargs" data-nodeid="1791"><code data-backticks="1" data-nodeid="1790">yargs</code></a>：可以进行更加复杂的命令行参数解析。</p>
</li>
</ul>
<p data-nodeid="1634">我们的目标是支持以下面这种启动方式，建立我们的项目，如下代码：</p>
<pre class="lang-java hljs" data-nodeid="1635"><code data-language="java">npm init <span class="hljs-meta">@lucas</span>/project
</code></pre>
<p data-nodeid="1636">npm 6.1 及以上版本，我们都可以使用<code data-backticks="1" data-nodeid="1795">npm init</code>或<code data-backticks="1" data-nodeid="1797">yarn create</code>来启动我们的项目，比如下面两个命令就是等价的：</p>
<pre class="lang-java hljs" data-nodeid="1637"><code data-language="java"># 使用 Node.js
npm init @lucas/project
# 使用 Yarn
yarn create @lucas/project
</code></pre>
<h4 data-nodeid="1638">启动命令行项目</h4>
<p data-nodeid="1639">下面开始进入开发，首先我们创建项目：</p>
<pre class="lang-java hljs" data-nodeid="1640"><code data-language="java">mkdir create-project &amp;&amp; cd create-project
npm init --yes
</code></pre>
<p data-nodeid="1641">接着进入<code data-backticks="1" data-nodeid="1802">create-project</code>文件中，创建<code data-backticks="1" data-nodeid="1804">src</code>目录及<code data-backticks="1" data-nodeid="1806">src/cli.js</code>文件，<code data-backticks="1" data-nodeid="1808">cli.js</code>文件内容如下：</p>
<pre class="lang-java hljs" data-nodeid="1642"><code data-language="java"><span class="hljs-function">export function <span class="hljs-title">cli</span><span class="hljs-params">(args)</span> </span>{
 console.log(args);
}
</code></pre>
<p data-nodeid="1643">接下来，为了使我们的命令行可以在终端执行，我们新建<code data-backticks="1" data-nodeid="1811">bin/</code>目录，并在其下创建一个<code data-backticks="1" data-nodeid="1813">create-project</code>文件，代码为：</p>
<pre class="lang-java hljs" data-nodeid="1644"><code data-language="java">#!/usr/bin/env node
require = require('esm')(module /*, options*/);
require('../src/cli').cli(process.argv);
</code></pre>
<p data-nodeid="1645">上述代码中，我们使用了<a href="https://www.npmjs.com/package/esm" data-nodeid="1819"><code data-backticks="1" data-nodeid="1817">esm</code> </a> 模块，这样就可以在其他文件中使用<code data-backticks="1" data-nodeid="1821">import</code>关键字，即 ESM 模块规范了。我们在该入口文件中，引入<code data-backticks="1" data-nodeid="1823">cli.js</code>并将命令行参数<a href="https://nodejs.org/api/process.html#process_process_argv" data-nodeid="1827"><code data-backticks="1" data-nodeid="1826">process.argv</code></a>传给<code data-backticks="1" data-nodeid="1829">cli</code>函数执行。</p>
<p data-nodeid="1646">当然，为了能够正常使用<a href="https://www.npmjs.com/package/esm" data-nodeid="1835"><code data-backticks="1" data-nodeid="1833">esm</code> </a> 模块，我们需要先安装，执行<code data-backticks="1" data-nodeid="1837">npm install esm</code>。</p>
<p data-nodeid="1647">此时 package.json 内容如下：</p>
<pre class="lang-java hljs" data-nodeid="1648"><code data-language="java">{
 <span class="hljs-string">"name"</span>: <span class="hljs-string">"@lucas/create-project"</span>,
 <span class="hljs-string">"version"</span>: <span class="hljs-string">"1.0.0"</span>,
 <span class="hljs-string">"description"</span>: <span class="hljs-string">"A CLI to bootstrap my new projects"</span>,
 <span class="hljs-string">"main"</span>: <span class="hljs-string">"src/index.js"</span>,
 <span class="hljs-string">"bin"</span>: {
   <span class="hljs-string">"@lucas/create-project"</span>: <span class="hljs-string">"bin/create-project"</span>,
   <span class="hljs-string">"create-project"</span>: <span class="hljs-string">"bin/create-project"</span>
 },
 <span class="hljs-string">"publishConfig"</span>: {
   <span class="hljs-string">"access"</span>: <span class="hljs-string">"public"</span>
 },
 <span class="hljs-string">"scripts"</span>: {
   <span class="hljs-string">"test"</span>: <span class="hljs-string">"echo \"Error: no test specified\" &amp;&amp; exit 1"</span>
 },
 <span class="hljs-string">"keywords"</span>: [
   <span class="hljs-string">"cli"</span>,
   <span class="hljs-string">"create-project"</span>
 ],
 <span class="hljs-string">"author"</span>: <span class="hljs-string">"YOUR_AUTHOR"</span>,
 <span class="hljs-string">"license"</span>: <span class="hljs-string">"MIT"</span>,
 <span class="hljs-string">"dependencies"</span>: {
   <span class="hljs-string">"esm"</span>: <span class="hljs-string">"^3.2.18"</span>
 }
}
</code></pre>
<p data-nodeid="1649">这里需要注意的是 <code data-backticks="1" data-nodeid="1841">bin</code>字段，我们注册了两个可用命令：一个是带有 npm 命名 scope 的，一个是常规的<code data-backticks="1" data-nodeid="1843">create-project</code>命令。</p>
<p data-nodeid="1650">为了调试方便，我们使用<a href="https://docs.npmjs.com/cli/link.html" data-nodeid="1848"><code data-backticks="1" data-nodeid="1847">npm link</code></a>命令进行调试，在终端中项目目录下执行：</p>
<pre class="lang-java hljs" data-nodeid="1651"><code data-language="java">npm link
</code></pre>
<p data-nodeid="1652">上述命令可以在全局范围内添加一个软链到当前项目中。我们执行：</p>
<pre class="lang-java hljs" data-nodeid="1653"><code data-language="java">create-project --yes
</code></pre>
<p data-nodeid="1654">就会得到下面这样的输出：</p>
<pre class="lang-java hljs" data-nodeid="1655"><code data-language="java">[ <span class="hljs-string">'/usr/local/Cellar/node/11.6.0/bin/node'</span>,
  <span class="hljs-string">'/Users/dkundel/dev/create-project/bin/create-project'</span>,
  <span class="hljs-string">'--yes'</span> ]
</code></pre>
<p data-nodeid="1656">该输出，就对应了代码中的<a href="https://nodejs.org/api/process.html#process_process_argv" data-nodeid="1855"><code data-backticks="1" data-nodeid="1854">process.argv</code></a>。</p>
<h4 data-nodeid="1657">解析处理命令行输入</h4>
<p data-nodeid="1658">在解析处理命令行输入之前，我们需要设计命令行支持的几个选项，如下。</p>
<ul data-nodeid="1659">
<li data-nodeid="1660">
<p data-nodeid="1661"><code data-backticks="1" data-nodeid="1859">[template]</code>：支持默认的几种模板类型，用户可以通过 select 进行选择。</p>
</li>
<li data-nodeid="1662">
<p data-nodeid="1663"><code data-backticks="1" data-nodeid="1861">--git</code>：等同于<code data-backticks="1" data-nodeid="1863">git init</code>去创建一个新的 Git 项目。</p>
</li>
<li data-nodeid="1664">
<p data-nodeid="1665"><code data-backticks="1" data-nodeid="1865">--install</code>：支持自动下载项目依赖。</p>
</li>
<li data-nodeid="1666">
<p data-nodeid="1667"><code data-backticks="1" data-nodeid="1867">--yes</code>：跳过命令行交互，直接使用默认配置。</p>
</li>
</ul>
<p data-nodeid="1668">我们利用<code data-backticks="1" data-nodeid="1870">inquirer</code>使得命令行支持用户交互，同时使用<code data-backticks="1" data-nodeid="1872">arg</code>来解析命令行参数，安装相关依赖命令：</p>
<pre class="lang-java hljs" data-nodeid="1669"><code data-language="java">npm install inquirer arg
</code></pre>
<p data-nodeid="1670">接下来编写命令行参数解析逻辑，在<code data-backticks="1" data-nodeid="1875">cli.js</code>中添加：</p>
<pre class="lang-java hljs" data-nodeid="1671"><code data-language="java"><span class="hljs-keyword">import</span> arg from <span class="hljs-string">'arg'</span>;
<span class="hljs-comment">// 解析命令行参数为 options</span>
<span class="hljs-function">function <span class="hljs-title">parseArgumentsIntoOptions</span><span class="hljs-params">(rawArgs)</span> </span>{
 <span class="hljs-comment">// 使用 arg 进行解析</span>
 <span class="hljs-keyword">const</span> args = arg(
   {
     <span class="hljs-string">'--git'</span>: Boolean,
     <span class="hljs-string">'--yes'</span>: Boolean,
     <span class="hljs-string">'--install'</span>: Boolean,
     <span class="hljs-string">'-g'</span>: <span class="hljs-string">'--git'</span>,
     <span class="hljs-string">'-y'</span>: <span class="hljs-string">'--yes'</span>,
     <span class="hljs-string">'-i'</span>: <span class="hljs-string">'--install'</span>,
   },
   {
     argv: rawArgs.slice(<span class="hljs-number">2</span>),
   }
 );
 <span class="hljs-keyword">return</span> {
   skipPrompts: args[<span class="hljs-string">'--yes'</span>] || <span class="hljs-keyword">false</span>,
   git: args[<span class="hljs-string">'--git'</span>] || <span class="hljs-keyword">false</span>,
   template: args._[<span class="hljs-number">0</span>],
   runInstall: args[<span class="hljs-string">'--install'</span>] || <span class="hljs-keyword">false</span>,
 }
}
<span class="hljs-function">export function <span class="hljs-title">cli</span><span class="hljs-params">(args)</span> </span>{
 <span class="hljs-comment">// 获取命令行配置</span>
 let options = parseArgumentsIntoOptions(args);
 console.log(options);
}
</code></pre>
<p data-nodeid="1672">上述代码很好理解，我已经加入了相关注释。接下来，我们实现使用默认配置和交互式配置选择逻辑，如下代码：</p>
<pre class="lang-java hljs" data-nodeid="1673"><code data-language="java"><span class="hljs-keyword">import</span> arg from <span class="hljs-string">'arg'</span>;
<span class="hljs-keyword">import</span> inquirer from <span class="hljs-string">'inquirer'</span>;
<span class="hljs-function">function <span class="hljs-title">parseArgumentsIntoOptions</span><span class="hljs-params">(rawArgs)</span> </span>{
	<span class="hljs-comment">// ...</span>
}
<span class="hljs-function">async function <span class="hljs-title">promptForMissingOptions</span><span class="hljs-params">(options)</span> </span>{
 <span class="hljs-comment">// 默认使用名为 JavaScript 的模板</span>
 <span class="hljs-keyword">const</span> defaultTemplate = <span class="hljs-string">'JavaScript'</span>;
 <span class="hljs-comment">// 使用默认模板则直接返回</span>
 <span class="hljs-keyword">if</span> (options.skipPrompts) {
   <span class="hljs-keyword">return</span> {
     ...options,
     template: options.template || defaultTemplate,
   };
 }
 <span class="hljs-comment">// 准备交互式问题 </span>
 <span class="hljs-keyword">const</span> questions = [];
 <span class="hljs-keyword">if</span> (!options.template) {
   questions.push({
     type: <span class="hljs-string">'list'</span>,
     name: <span class="hljs-string">'template'</span>,
     message: <span class="hljs-string">'Please choose which project template to use'</span>,
     choices: [<span class="hljs-string">'JavaScript'</span>, <span class="hljs-string">'TypeScript'</span>],
     <span class="hljs-keyword">default</span>: defaultTemplate,
   });
 }
 <span class="hljs-keyword">if</span> (!options.git) {
   questions.push({
     type: <span class="hljs-string">'confirm'</span>,
     name: <span class="hljs-string">'git'</span>,
     message: <span class="hljs-string">'Initialize a git repository?'</span>,
     <span class="hljs-keyword">default</span>: <span class="hljs-keyword">false</span>,
   });
 }
 <span class="hljs-comment">// 使用 inquirer 进行交互式查询，并获取用户答案选项</span>
 <span class="hljs-keyword">const</span> answers = await inquirer.prompt(questions);
 <span class="hljs-keyword">return</span> {
   ...options,
   template: options.template || answers.template,
   git: options.git || answers.git,
 };
}
<span class="hljs-function">export async function <span class="hljs-title">cli</span><span class="hljs-params">(args)</span> </span>{
 let options = parseArgumentsIntoOptions(args);
 options = <span class="hljs-function">await <span class="hljs-title">promptForMissingOptions</span><span class="hljs-params">(options)</span></span>;
 console.log(options);
}
</code></pre>
<p data-nodeid="1674">这样一来，我们就可以获取到类似：</p>
<pre class="lang-java hljs" data-nodeid="1675"><code data-language="java">{ 
	skipPrompts: <span class="hljs-keyword">false</span>,
    git: <span class="hljs-keyword">false</span>,
    template: <span class="hljs-string">'JavaScript'</span>,
    runInstall: <span class="hljs-keyword">false</span> 
}
</code></pre>
<p data-nodeid="1676">相关的配置了。</p>
<p data-nodeid="1677">下面我们需要完成下载模板到本地的逻辑，我们事先准备好两种名为<code data-backticks="1" data-nodeid="1881">typescript</code>和<code data-backticks="1" data-nodeid="1883">javascript</code>的模板，并将相关的模板存储在项目的根目录中。当然你在实际开发应用中，可以内置更多的模板。</p>
<p data-nodeid="1678">我们使用<code data-backticks="1" data-nodeid="1886">ncp</code>包实现跨平台递归拷贝文件，使用<code data-backticks="1" data-nodeid="1888">chalk</code>做个性化输出。安装相关依赖如下：</p>
<pre class="lang-java hljs" data-nodeid="1679"><code data-language="java">npm install ncp chalk
</code></pre>
<p data-nodeid="1680">在<code data-backticks="1" data-nodeid="1891">src/</code>目录下，创建新的文件<code data-backticks="1" data-nodeid="1893">main.js</code>，代码如下：</p>
<pre class="lang-java hljs" data-nodeid="1681"><code data-language="java"><span class="hljs-keyword">import</span> chalk from <span class="hljs-string">'chalk'</span>;
<span class="hljs-keyword">import</span> fs from <span class="hljs-string">'fs'</span>;
<span class="hljs-keyword">import</span> ncp from <span class="hljs-string">'ncp'</span>;
<span class="hljs-keyword">import</span> path from <span class="hljs-string">'path'</span>;
<span class="hljs-keyword">import</span> { promisify } from <span class="hljs-string">'util'</span>;
<span class="hljs-keyword">const</span> access = promisify(fs.access);
<span class="hljs-keyword">const</span> copy = promisify(ncp);
<span class="hljs-comment">// 递归拷贝文件</span>
<span class="hljs-function">async function <span class="hljs-title">copyTemplateFiles</span><span class="hljs-params">(options)</span> </span>{
 <span class="hljs-keyword">return</span> copy(options.templateDirectory, options.targetDirectory, {
   clobber: <span class="hljs-keyword">false</span>,
 });
}
<span class="hljs-comment">// 创建项目</span>
<span class="hljs-function">export async function <span class="hljs-title">createProject</span><span class="hljs-params">(options)</span> </span>{
 options = {
   ...options,
   targetDirectory: options.targetDirectory || process.cwd(),
 };
 <span class="hljs-keyword">const</span> currentFileUrl = <span class="hljs-keyword">import</span>.meta.url;
 <span class="hljs-keyword">const</span> templateDir = path.resolve(
   <span class="hljs-keyword">new</span> URL(currentFileUrl).pathname,
   <span class="hljs-string">'../../templates'</span>,
   options.template.toLowerCase()
 );
 options.templateDirectory = templateDir;
 <span class="hljs-keyword">try</span> {
 	 <span class="hljs-comment">// 判断模板是否存在</span>
   <span class="hljs-function">await <span class="hljs-title">access</span><span class="hljs-params">(templateDir, fs.constants.R_OK)</span></span>;
 } <span class="hljs-keyword">catch</span> (err) {
 	 <span class="hljs-comment">// 模板不存在 </span>
   console.error(<span class="hljs-string">'%s Invalid template name'</span>, chalk.red.bold(<span class="hljs-string">'ERROR'</span>));
   process.exit(<span class="hljs-number">1</span>);
 }
 <span class="hljs-comment">// 拷贝模板</span>
 <span class="hljs-function">await <span class="hljs-title">copyTemplateFiles</span><span class="hljs-params">(options)</span></span>;
 console.log(<span class="hljs-string">'%s Project ready'</span>, chalk.green.bold(<span class="hljs-string">'DONE'</span>));
 <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
}
</code></pre>
<p data-nodeid="4446" class="">上述代码我们通过<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/import.meta" data-nodeid="4450"><code data-backticks="1" data-nodeid="4449">import.meta.url</code></a>来获取当前模块的 URL 路径，并通过<code data-backticks="1" data-nodeid="4452">fs.constants.R_OK</code>判断对应模板是否存在。此时<code data-backticks="1" data-nodeid="4454">cli.js</code>关键内容为：</p>

<pre class="lang-java hljs" data-nodeid="1683"><code data-language="java"><span class="hljs-keyword">import</span> arg from <span class="hljs-string">'arg'</span>;
<span class="hljs-keyword">import</span> inquirer from <span class="hljs-string">'inquirer'</span>;
<span class="hljs-keyword">import</span> { createProject } from <span class="hljs-string">'./main'</span>;
<span class="hljs-function">function <span class="hljs-title">parseArgumentsIntoOptions</span><span class="hljs-params">(rawArgs)</span> </span>{
<span class="hljs-comment">// ...</span>
}
<span class="hljs-function">async function <span class="hljs-title">promptForMissingOptions</span><span class="hljs-params">(options)</span> </span>{
<span class="hljs-comment">// ...</span>
}
<span class="hljs-function">export async function <span class="hljs-title">cli</span><span class="hljs-params">(args)</span> </span>{
 let options = parseArgumentsIntoOptions(args);
 options = <span class="hljs-function">await <span class="hljs-title">promptForMissingOptions</span><span class="hljs-params">(options)</span></span>;
 <span class="hljs-function">await <span class="hljs-title">createProject</span><span class="hljs-params">(options)</span></span>;
}
</code></pre>
<p data-nodeid="1684">接下来，我们需要完成<code data-backticks="1" data-nodeid="1905">git</code>的初始化以及依赖安装工作，这时候需要用到以下内容。</p>
<ul data-nodeid="1685">
<li data-nodeid="1686">
<p data-nodeid="1687"><a href="http://npm.im/execa" data-nodeid="1909"><code data-backticks="1" data-nodeid="1908">execa</code></a>：允许开发中使用类似<code data-backticks="1" data-nodeid="1911">git</code>的外部命令。</p>
</li>
<li data-nodeid="1688">
<p data-nodeid="1689"><a href="http://npm.im/pkg-install" data-nodeid="1915"><code data-backticks="1" data-nodeid="1914">pkg-install</code></a>：使用<code data-backticks="1" data-nodeid="1917">yarn install</code>或<code data-backticks="1" data-nodeid="1919">npm install</code>安装依赖。</p>
</li>
<li data-nodeid="1690">
<p data-nodeid="1691"><a href="http://npm.im/listr" data-nodeid="1923"><code data-backticks="1" data-nodeid="1922">listr</code></a>：给出当前进度 progress。</p>
</li>
</ul>
<p data-nodeid="1692">执行安装依赖：</p>
<pre class="lang-java hljs" data-nodeid="1693"><code data-language="java">npm install execa pkg-install listr
</code></pre>
<p data-nodeid="1694">更新<code data-backticks="1" data-nodeid="1927">main.js</code>为：</p>
<pre class="lang-java hljs" data-nodeid="1695"><code data-language="java"><span class="hljs-keyword">import</span> chalk from <span class="hljs-string">'chalk'</span>;
<span class="hljs-keyword">import</span> fs from <span class="hljs-string">'fs'</span>;
<span class="hljs-keyword">import</span> ncp from <span class="hljs-string">'ncp'</span>;
<span class="hljs-keyword">import</span> path from <span class="hljs-string">'path'</span>;
<span class="hljs-keyword">import</span> { promisify } from <span class="hljs-string">'util'</span>;
<span class="hljs-keyword">import</span> execa from <span class="hljs-string">'execa'</span>;
<span class="hljs-keyword">import</span> Listr from <span class="hljs-string">'listr'</span>;
<span class="hljs-keyword">import</span> { projectInstall } from <span class="hljs-string">'pkg-install'</span>;
<span class="hljs-keyword">const</span> access = promisify(fs.access);
<span class="hljs-keyword">const</span> copy = promisify(ncp);
<span class="hljs-comment">// 拷贝模板</span>
<span class="hljs-function">async function <span class="hljs-title">copyTemplateFiles</span><span class="hljs-params">(options)</span> </span>{
 <span class="hljs-keyword">return</span> copy(options.templateDirectory, options.targetDirectory, {
   clobber: <span class="hljs-keyword">false</span>,
 });
}
<span class="hljs-comment">// 初始化 git</span>
<span class="hljs-function">async function <span class="hljs-title">initGit</span><span class="hljs-params">(options)</span> </span>{
 <span class="hljs-comment">// 执行 git init</span>
 <span class="hljs-keyword">const</span> result = <span class="hljs-function">await <span class="hljs-title">execa</span><span class="hljs-params">(<span class="hljs-string">'git'</span>, [<span class="hljs-string">'init'</span>], {
   cwd: options.targetDirectory,
 })</span></span>;
 <span class="hljs-keyword">if</span> (result.failed) {
   <span class="hljs-keyword">return</span> Promise.reject(<span class="hljs-keyword">new</span> Error(<span class="hljs-string">'Failed to initialize git'</span>));
 }
 <span class="hljs-keyword">return</span>;
}
<span class="hljs-comment">// 创建项目</span>
<span class="hljs-function">export async function <span class="hljs-title">createProject</span><span class="hljs-params">(options)</span> </span>{
 options = {
   ...options,
   targetDirectory: options.targetDirectory || process.cwd()
 };
 <span class="hljs-keyword">const</span> templateDir = path.resolve(
   <span class="hljs-keyword">new</span> URL(<span class="hljs-keyword">import</span>.meta.url).pathname,
   <span class="hljs-string">'../../templates'</span>,
   options.template
 );
 options.templateDirectory = templateDir;
 <span class="hljs-keyword">try</span> {
 	 <span class="hljs-comment">// 判断模板是否存在</span>
   <span class="hljs-function">await <span class="hljs-title">access</span><span class="hljs-params">(templateDir, fs.constants.R_OK)</span></span>;
 } <span class="hljs-keyword">catch</span> (err) {
   console.error(<span class="hljs-string">'%s Invalid template name'</span>, chalk.red.bold(<span class="hljs-string">'ERROR'</span>));
   process.exit(<span class="hljs-number">1</span>);
 }
 <span class="hljs-comment">// 声明 tasks</span>
 <span class="hljs-keyword">const</span> tasks = <span class="hljs-keyword">new</span> Listr([
   {
     title: <span class="hljs-string">'Copy project files'</span>,
     task: () =&gt; copyTemplateFiles(options),
   },
   {
     title: <span class="hljs-string">'Initialize git'</span>,
     task: () =&gt; initGit(options),
     enabled: () =&gt; options.git,
   },
   {
     title: <span class="hljs-string">'Install dependencies'</span>,
     task: () =&gt;
       projectInstall({
         cwd: options.targetDirectory,
       }),
     skip: () =&gt;
       !options.runInstall
         ? <span class="hljs-string">'Pass --install to automatically install dependencies'</span>
         : undefined,
   },
 ]);
 <span class="hljs-comment">// 并行执行 tasks</span>
 await tasks.run();
 console.log(<span class="hljs-string">'%s Project ready'</span>, chalk.green.bold(<span class="hljs-string">'DONE'</span>));
 <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
}
</code></pre>
<p data-nodeid="1696">这样一来，我们的命令行就大功告成了。</p>
<p data-nodeid="1697">接下来我们主要谈谈模板维护问题，上述实现中，模板维护在了本地。为了更大范围的合作，模板可以共享到 GitHub 中。我们可以在 package.json 文件中声明 files 字段，如下所示：</p>
<pre class="lang-java hljs" data-nodeid="1698"><code data-language="java">},
 <span class="hljs-string">"files"</span>: [
   <span class="hljs-string">"bin/"</span>,
   <span class="hljs-string">"src/"</span>,
   <span class="hljs-string">"templates/"</span>
 ]
}
</code></pre>
<p data-nodeid="1699">以此来声明哪些文件可以被<code data-backticks="1" data-nodeid="1932">npm publish</code>出去。</p>
<p data-nodeid="1700">另外一种做法是将模板单独维护到一个 GitHub 仓库当中。在创建一个项目时，我们使用 <a href="https://www.npmjs.com/package/download-git-repo" data-nodeid="1937">download-git-repo</a>来下载模板。</p>
<h3 data-nodeid="1701">从命令行到万能脚手架</h3>
<p data-nodeid="1702">前面我们分析了一个命令行的实现和开发原理，这些内容并不复杂。但如何从一个命令行升级到一个万能脚手架呢？我们继续探讨。</p>
<p data-nodeid="1703">使用命令行启动并创建一个基于模板的项目只能说是一个脚手架的雏形。对比大家熟悉的<code data-backticks="1" data-nodeid="1942">vue-cli</code>、<code data-backticks="1" data-nodeid="1944">create-react-app</code>、<code data-backticks="1" data-nodeid="1946">@tarojs/cli</code>、<code data-backticks="1" data-nodeid="1948">umi</code>等，我们还需要从可伸缩性、用户友好性方面考虑：</p>
<ul data-nodeid="1704">
<li data-nodeid="1705">
<p data-nodeid="1706">如何使模板支持版本管理</p>
</li>
<li data-nodeid="1707">
<p data-nodeid="1708">模板如何进行扩展</p>
</li>
<li data-nodeid="1709">
<p data-nodeid="1710">如何进行版本检查和更新</p>
</li>
<li data-nodeid="1711">
<p data-nodeid="1712">如何自定义构建</p>
</li>
</ul>
<p data-nodeid="1713">下面我们分别来讨论。</p>
<p data-nodeid="1714">模板支持版本管理可以使用 npm 维护模板，这样借助 npm 的版本管理，我们可以天然地支持不同版本的模板。当然在脚手架的设计中，要加入<strong data-nodeid="1960">对版本的选择和处理</strong>。</p>
<p data-nodeid="1715">如前文所说，模板扩展可以借助中心化手段，集成开发者力量，提供模板市场。这里需要注意的是，针对不同模板或功能区块的<strong data-nodeid="1966">可插拔性</strong>是非常重要的。下面我们会具体展开。</p>
<p data-nodeid="3640" class="">版本检查可以使用 npm view @lucas/create-project version\ 来进行版本检查，并根据环境版本，提示用户更新。</p>

<p data-nodeid="2823" class="">构建是一个老大难问题，不同项目的构建需求是不同的。参照<a href="https://kaiwu.lagou.com/course/courseInfo.htm?courseId=584#/detail/pc?id=5952" data-nodeid="2827">第 23 讲“npm scripts：打造一体化的构建和部署流程”</a>所讲，不同构建脚本可以考虑<strong data-nodeid="2837">单独抽象，提供可插拔式封装</strong>。比如<a href="https://github.com/yanhaijing/jslib-base/tree/master/packages" data-nodeid="2835">jslib-base</a>这个库的设计，这也是一个“万能脚手架”。</p>


<p data-nodeid="1718">我们具体来看，使用脚手架初始化一个项目的过程，本质是根据输入信息进行模板填充。比如，如果开发者选择使用 TypeScript 以及英语环境构建项目，并使用 rollup 进行构建。那么核心流程中在初始化 rollup.config.js 文件时，我们读取 rollup.js.tmpl，并将相关信息（比如对 TypeScript 的编译）填写到模板中。</p>
<p data-nodeid="1719">类似的情况还有初始化 .eslintrc.ts.json、package.json、CHANGELOG.en.md、README.en.md，以及 doc.en.md 等。</p>
<p data-nodeid="1720">所有这些文件的生成过程都需要<strong data-nodeid="1991">可插拔，更理想的是，这些插件是一个独立的运行时</strong>。因此我们可以将每一个脚手架文件（即模板文件）的初始化视作一个独立的应用，由命令行统一指挥调度。</p>
<p data-nodeid="1721">比如 <a href="https://github.com/yanhaijing/jslib-base/tree/master/packages" data-nodeid="1995">jslib-base</a> 这个库对于 rollup 构建的处理，支持开发者传入 option，由命令行处理函数，结合不同的配置版本进行自定义分配。具体代码如下：</p>
<pre class="lang-java hljs" data-nodeid="1722"><code data-language="java"><span class="hljs-keyword">const</span> path = require(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">const</span> util = require(<span class="hljs-string">'@js-lib/util'</span>);
<span class="hljs-function">function <span class="hljs-title">init</span><span class="hljs-params">(cmdPath, name, option)</span> </span>{
    <span class="hljs-comment">// type 为 js 和 ts 两种</span>
    <span class="hljs-keyword">const</span> type = option.type;
		<span class="hljs-comment">// module 分为：umd/esm/commonjs</span>
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">module</span> = option.<span class="hljs-keyword">module</span> = option.<span class="hljs-keyword">module</span>.reduce((prev, name) =&gt; (prev[name] = name, prev), ({}));
		<span class="hljs-comment">// rollup 基本配置</span>
    util.copyTmpl(
        path.resolve(__dirname, \`./template/\${type}/rollup.js.tmpl\`),
        path.resolve(cmdPath, name, <span class="hljs-string">'config/rollup.js'</span>),
        option,
    );
		<span class="hljs-comment">// umd 模式</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">module</span>.umd) {
        util.copyFile(
            path.resolve(__dirname, \`./template/\${type}/rollup.config.aio.js\`),
            path.resolve(cmdPath, name, <span class="hljs-string">'config/rollup.config.aio.js'</span>)
        );
    }
    <span class="hljs-comment">// esm 模式</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">module</span>.esm) {
        util.copyFile(
            path.resolve(__dirname, \`./template/\${type}/rollup.config.esm.js\`),
            path.resolve(cmdPath, name, <span class="hljs-string">'config/rollup.config.esm.js'</span>)
        );
    }
    <span class="hljs-comment">// commonjs 模式</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">module</span>.commonjs) {
        util.copyFile(
            path.resolve(__dirname, \`./template/\${type}/rollup.config.js\`),
            path.resolve(cmdPath, name, <span class="hljs-string">'config/rollup.config.js'</span>)
        );
    }

    util.mergeTmpl2JSON(
        path.resolve(__dirname, \`./template/\${type}/<span class="hljs-keyword">package</span>.json.tmpl\`),
        path.resolve(cmdPath, name, <span class="hljs-string">'package.json'</span>),
        option,
    );
    <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'js'</span>) {
        util.copyFile(
            path.resolve(__dirname, \`./template/js/.babelrc\`),
            path.resolve(cmdPath, name, <span class="hljs-string">'.babelrc'</span>)
        );
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'ts'</span>) {
        util.copyFile(
            path.resolve(__dirname, \`./template/ts/tsconfig.json\`),
            path.resolve(cmdPath, name, <span class="hljs-string">'tsconfig.json'</span>)
        );
    }
}
<span class="hljs-keyword">module</span>.<span class="hljs-keyword">exports</span> = {
    init: init,
}
</code></pre>
<p data-nodeid="1723">如上代码，根据用户输入，使用了不同版本的 rollup 构建内容。</p>
<p data-nodeid="1724">相信你了解了这些内容，对于实现一个自己的 create-react-app、vue-cli 会更有心得和启发。</p>
<h3 data-nodeid="1725">总结</h3>
<p data-nodeid="1726">这一讲我们从开发一个命令行入手，分析了实现一个脚手架的方方面面。实现一个企业级脚手架需要不断打磨和优化，不断增强用户体验和可操作性，比如处理边界情况、终端提示等。更重要的是，对构建逻辑的抽象和封装，根据业务需求，不断扩展命令和模板。</p>
<p data-nodeid="1727">本讲内容总结如下：</p>
<p data-nodeid="1728"><img src="https://s0.lgstatic.com/i/image6/M01/17/03/Cgp9HWBHK1WAeFWWAAdEzv-BDFI037.png" alt="前端基建 金句.png" data-nodeid="2004"></p>
<p data-nodeid="1729" class="">从 0 到 1 简单，但是从 1 开始出发，就需要开发者不断思考和总结。下一讲我们将开启 Node.js 的学习，来实现一个 SSR 应用。我们会直入正题，不再过多学习 Node.js 的基础内容，也请你提前做好准备。</p></div>

</body></html>