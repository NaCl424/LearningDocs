<!DOCTYPE html><html lang="en"><head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>20 | SpringBoot 服务性能优化</title>
<style type="text/css">.hljs{display:block;overflow-x:auto;padding:.5em;color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}/*# sourceURL=/Users/young/Documents/Codes/Fun/lagou/public/atom-one-light.min.css*/</style><style type="text/css">/*
 * Copyright (C) 2018 Drake, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

:root {
    --monospace: "JetBrains Mono", HYZhengYuan, "Fira Code", Menlo, "Ubuntu Mono", Consolas; /*code font*/
    --text-font: var(--monospace); /*default font*/
    --title-font: var(--monospace); /*title font*/

    --text-color: #333333;
    --bg-color: #ffffff;
    --control-text-color: var(--text-color);
    --meta-content-color: var(--text-color);
    --active-file-border-color: var(--drake-accent);
    --rawblock-edit-panel-bd: var(--code-block-bg-color);
    --item-hover-bg-color: #E5E5E596;
    --active-file-bg-color: var(--item-hover-bg-color);

    --drake-accent: #e95f59;
    --drake-highlight: #d63200;
    --a-color: #036aca;
    --variable-color: var(--drake-highlight);
    --outline-active-color: var(--a-color);
    --code-block-bg-color: #2b2b2b;
    --code-block-color: #A9B7C6;
    --title-color: #135ce0;
    --blockquote-border-color: #b2aec5;
    --blockquote-color: #595959;
    --blockquote-bg-color: #fff9f9;
    --strong-color: var(--title-color);
    --h2-underline-color: var(--title-color);
    --horizontal-divider-color: var(--title-color);
    --height-light-color: var(--drake-highlight);
    --height-light-border-color: var(--drake-highlight);
    --yaml-color: #777777;
    --yaml-bg-color: #f7f7f7;
    --footnotes-bg-color: #3c3d3e;
    --footnotes-highlight: #FFD760;
    --table-border-color: #dfe2e5;
    --table-header-bg-color: #f6f8fa;
    --table-bg-color: var(--bg-color);
    --table-n2-bg-color: #f6f8fa;
    --input-bg-color: var(--item-hover-bg-color);
    --btn-hover-bg-color: var(--item-hover-bg-color);
    --checkbox-checked: url("data:image/svg+xml,%3Csvg class='icon' viewBox='0 0 1024 1024' xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Cpath d='M425.984 726.016l384-384-59.99-61.995-324.01 324.011-152.021-152.021L213.973 512zm384-598.016q36.01 0 61.013 25.984T896 213.974v596.01q0 34.005-25.003 59.99t-61.013 25.983h-596.01q-36.011 0-61.014-25.984t-25.003-59.989v-596.01q0-34.006 25.003-59.99T213.973 128h596.011z' fill='%2365b73b'/%3E%3C/svg%3E");
    --checkbox-unchecked: url("data:image/svg+xml,%3Csvg class='icon' viewBox='0 0 1024 1024' xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Cpath d='M810.667 213.333v597.334H213.333V213.333h597.334m0-85.333H213.333C166.4 128 128 166.4 128 213.333v597.334C128 857.6 166.4 896 213.333 896h597.334C857.6 896 896 857.6 896 810.667V213.333C896 166.4 857.6 128 810.667 128z' fill='%23333333'/%3E%3C/svg%3E");
}

html {
    font-size: 15px;
}

body {
    font-family: var(--text-font) !important;
    color: var(--text-color);
    -webkit-font-feature-settings: "liga" on, "calt" on;
    -webkit-font-smoothing: subpixel-antialiased;
    text-rendering: optimizeLegibility;
    letter-spacing: 0;
    margin: 0;
    overflow-x: hidden;
    line-height: 1.8rem;
}

img {
    max-width: 100%;
}

#write {
    background-image: linear-gradient(
            90deg
            ,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(
            1turn
            ,rgba(60,10,30,.04) 3%,transparent 0);
    background-size: 20px 20px;
    background-position: 50%;
}

/*code block*/
#write .md-fences {
    font-size: 1rem;
    padding: 0.5rem !important;
    border-radius: 2px;
    word-wrap: normal;
    background-color: var(--code-block-bg-color);
    color: var(--code-block-color);
    border: none;
}

/*code snippet*/
#write code, tt {
    border-radius: 2px;
    color: var(--drake-highlight);
}

/*variable*/
var {
    color: var(--variable-color);
    font-weight: bold;
}

/*raw block*/
.md-rawblock-control:not(.md-rawblock-tooltip) {
    border-radius: 2px 0 2px 2px;
    padding: 0.2rem !important;
}
.md-rawblock:hover > .md-rawblock-container {
    background: none;
}
.md-rawblock-input {
    font-size: 1rem;
}
.md-rawblock-tooltip-btn:hover {
    background: none;
}
.md-rawblock:hover > .md-rawblock-tooltip {
    border-radius: 2px 2px 0 0;
    margin-bottom: 2px !important;
}
.md-rawblock-tooltip.md-rawblock-control {
    border-radius: 2px 2px 0 0;
    color: var(--code-block-color);
}
.md-rawblock-tooltip-name {
    color: var(--code-block-color);
    opacity: 1;
}

/*quote block*/
blockquote:before {
    display: block;
    position: absolute;
    content: '';
    width: 4px;
    left: 0;
    top: 0;
    height: 100%;
    background-color: var(--blockquote-border-color);
    border-radius: 2px;
}

blockquote {
    color: var(--blockquote-color);
    border-radius: 2px;
    padding: 10px 16px;
    background-color: var(--blockquote-bg-color);
    position: relative;
    border-left: none;
}

#write strong {
    color: var(--strong-color);
    font-weight: bold;
}
#write blockquote strong {
    color: var(--blockquote-color);
}

/*link*/
#write a {
    color: var(--a-color);
    text-decoration: none;
}
#write a .md-plain, .md-htmlblock-container a:hover {
    border-bottom: .1rem solid var(--a-color);
}
[md-inline=link] a {
    margin: 0 .2rem;
}
a:any-link {
    color: var(--a-color);
}

img {
    border-left: none;
    border-right: none;
    vertical-align: baseline;
    border-radius: 2px;
}

#write {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px 30px 100px;
}
#typora-source .CodeMirror-lines {
    max-width: 1200px;
}

#write p {
    word-spacing: .05rem;
}

#write > ul:first-child,
#write > ol:first-child {
    margin-top: 30px;
}

body > *:first-child {
    margin-top: 0 !important;
}

body > *:last-child {
    margin-bottom: 0 !important;
}

h1,
h2,
h3,
h4,
h5,
h6 {
    font-family: var(--title-font);
    position: relative;
    margin-top: 2rem;
    margin-bottom: 1rem;
    font-weight: bold;
    cursor: text;
    color: var(--title-color);
}

h3.md-focus:before, h4.md-focus:before, h5.md-focus:before, h6.md-focus:before {
    visibility: hidden;
}

h1 {
    font-size: 1.6rem;
    text-align: center;
    margin-top: 0;
}

h2.md-end-block.md-heading {
    font-size: 1.6rem;
    display: inline-block;
}

h2.md-end-block.md-heading:after {
    display: block;
    content: '';
    height: 2px;
    margin-top: 4px;
    background-color: var(--h2-underline-color);
    border-radius: 2px;
}

h3 {
    font-size: 1.4rem;
}

h4 {
    font-size: 1.2rem;
}

h5 {
    font-size: 1rem;
}

h6 {
    font-size: 1rem;
}

h1:hover a.anchor,
h2:hover a.anchor,
h3:hover a.anchor,
h4:hover a.anchor,
h5:hover a.anchor,
h6:hover a.anchor {
    text-decoration: none;
}

h1 tt,
h1 code {
    font-size: inherit !important;
}

h2 tt,
h2 code {
    font-size: inherit !important;
}

h3 tt,
h3 code {
    font-size: inherit !important;
}

h4 tt,
h4 code {
    font-size: inherit !important;
}

h5 tt,
h5 code {
    font-size: inherit !important;
}

h6 tt,
h6 code {
    font-size: inherit !important;
}

blockquote,
ul,
ol,
dl,
table {
    margin: 0.8em 0;
}
p {
    margin: 0;
}

li > ol,
li > ul {
    margin: 0 0;
}

hr {
    height: 2px;
    padding: 0;
    margin: 16px 0;
    background-color: var(--horizontal-divider-color);
    border: 0 none;
    overflow: hidden;
    box-sizing: content-box;
}

body > h2:first-child {
    margin-top: 0;
    padding-top: 0;
}

body > h1:first-child {
    margin-top: 0;
    padding-top: 0;
}

body > h1:first-child + h2 {
    margin-top: 0;
    padding-top: 0;
}

body > h3:first-child,
body > h4:first-child,
body > h5:first-child,
body > h6:first-child {
    margin-top: 0;
    padding-top: 0;
}

a:first-child h1,
a:first-child h2,
a:first-child h3,
a:first-child h4,
a:first-child h5,
a:first-child h6 {
    margin-top: 0;
    padding-top: 0;
}

h1 p,
h2 p,
h3 p,
h4 p,
h5 p,
h6 p {
    margin-top: 0;
}

li p.first {
    display: inline-block;
}

ul, ol {
    padding-inline-start: 2em;
}

ul:first-child,
ol:first-child {
    margin-top: 0;
}

ul:last-child,
ol:last-child {
    margin-bottom: 0;
}

table {
    padding: 0;
    word-break: initial;
    background-color: var(--table-bg-color);
}
table tr {
    border-top: .1em solid var(--table-border-color);
    margin: 0;
    padding: 0;
}
table th {
    font-weight: bold;
    border: .1em solid var(--table-border-color);
    border-bottom: 0;
    margin: 0;
    padding: 6px 13px;
}
table td {
    border: .1em solid var(--table-border-color);
    margin: 0;
    padding: 6px 13px;
}
table thead {
    background-color: var(--table-header-bg-color);
}
table tr:nth-child(2n) {
    background-color: var(--table-n2-bg-color);
}
table tr th:first-child,
table tr td:first-child {
    margin-top: 0;
}
table tr th:last-child,
table tr td:last-child {
    margin-bottom: 0;
}

#write em {
    padding: 0 5px 0 2px;
}

/* height light */
#write mark {
    border: .1em solid var(--height-light-border-color);
    color: var(--height-light-color);
    background-color: transparent;
    padding: .1rem .5rem;
    border-radius: 2rem;
    margin: 0 .2rem;
    font-size: .95rem;
}

/*shortcut*/
kbd {
    border: .1em solid #5b5b5e;
    background: transparent;
    color: var(--text-color);
    margin: 0 .4rem;
    font-size: .95rem;
    padding: .3em .4em;
    border-radius: .4em;
    vertical-align: top;
    box-shadow: .1em .1em .2em rgba(0, 0, 0, 0.3);
}

#write del {
    padding: 1px 2px;
}

.md-task-list-item > input {
    margin-left: -1.3em;
}

@media print {
    html {
        font-size: 12px;
    }

    table,
    pre {
        page-break-inside: avoid;
    }

    pre {
        word-wrap: break-word;
    }
}

/*YAML*/
#write pre.md-meta-block {
    padding: 1rem;
    font-size: 1rem;
    background-color: var(--yaml-bg-color);
    border: 0;
    border-radius: 2px;
    color: var(--yaml-color);
    margin-top: 0 !important;
}

.mathjax-block > .code-tooltip {
    bottom: .375rem;
}

#write > h3.md-focus:before {
    left: -1.5625rem;
    top: .375rem;
}

#write > h4.md-focus:before {
    left: -1.5625rem;
    top: .285714286rem;
}

#write > h5.md-focus:before {
    left: -1.5625rem;
    top: .285714286rem;
}

#write > h6.md-focus:before {
    left: -1.5625rem;
    top: .285714286rem;
}

.md-image > .md-meta {
    border-radius: 2px;
    font-family: initial;
    padding: 2px 0 0 4px;
    color: inherit;
}

.md-tag {
    color: inherit;
}

.md-toc {
    margin-top: 20px;
    padding-bottom: 20px;
}

.typora-quick-open-item {
    font-size: 1rem !important;
    height: 50px;
    padding-left: 8px;
    padding-top: 4px;
    padding-bottom: 4px;
}

#typora-quick-open {
    box-shadow: 0 0 8px #00000045;
    padding: 0;
}

.ty-quick-open-category.ty-has-prev .ty-quick-open-category-title {
    border-top: none;
}

#typora-quick-open-input {
    margin: 8px;
    box-shadow: none;
    border-radius: 2px;
}

#typora-quick-open-input input {
    font-size: 1rem;
    box-shadow: none;
    padding-top: 2px;
    padding-left: 10px;
    padding-right: 10px;
    line-height: 32px;
    max-height: 32px;
    border: none;
}

.modal-dialog#typora-quick-open {
    border-radius: 8px;
}

.ty-quick-open-category-title {
    padding-left: 8px;
    color: #BEBEBE;
    font-size: 0.8rem;
    margin-bottom: 4px;
}

.typora-quick-open-item-path {
    font-size: 0.8rem;
    text-overflow: ellipsis;
    white-space: nowrap;
    margin-top: 1px;
}

/*search input*/
.form-control {
    border: none;
    border-radius: 2px;
    box-shadow: none;
}

#md-searchpanel .btn {
    border-radius: 2px;
}

#search-panel-replaceall-btn {
    padding-right: 5px !important;
    text-align: center !important;
}

#search-panel-replace-btn {
    text-align: center !important;
}

#md-searchpanel input {
    background: var(--input-bg-color);
    border-radius: 2px;
}

.searchpanel-search-option-btn {
    border-radius: 2px;
    border: none;
    background: transparent;
    color: var(--text-color);
}

.searchpanel-search-option-btn.active {
    background: var(--text-color);
    color: var(--bg-color);
}

.form-control:focus {
    box-shadow: none;
}

#md-notification:before {
    top: 10px;
}

/** focus mode */
.on-focus-mode blockquote {
    border-left-color: rgba(85, 85, 85, 0.12);
}

header,
.context-menu,
.megamenu-content,
footer {
    font-family: initial;
}

/*sidebar*/
.file-node-content:hover .file-node-icon,
.file-node-content:hover .file-node-open-state {
    visibility: visible;
}

#typora-sidebar {
    font-size: 1.1rem;
}

.sidebar-tabs {
    border-bottom: none;
}

.file-list-item-summary, .file-list-item-parent-loc, .file-list-item-time, .file-list-item-summary {
    font-size: 0.9rem !important;
    font-family: var(--text-font);
}

.file-list-item-file-ext-part {
    display: none;
}

.outline-item {
    font-size: 1rem;
}

/*footnotes mark*/
#write .md-footnote {
    background-color: inherit;
    color: var(--drake-highlight);
    font-size: 0.9rem;
    border-radius: 0.9rem;
    padding-left: 0;
}

#write .md-footnote:before {
    content: "[";
}

#write .md-footnote:after {
    content: "]";
}

/*footnotes content*/
.md-hover-tip .code-tooltip-content {
    border-radius: 2px;
}

/*footnotes title*/
span.md-def-name {
    padding-right: 3ch;
    padding-left: 0;
    position: relative;
    font-weight: normal;
}

/*footnotes desc*/
.footnotes {
    font-size: 1rem;
    font-weight: normal;
    color: var(--text-color);
    position: relative;
}

/*footnotes tooltip text*/
.code-tooltip-content .md-plain {
    font-size: 0.9rem;
    font-family: inherit;
}

.code-tooltip-content code {
    padding: 0 2px;
    font-family: inherit;
    color: var(--footnotes-highlight);
    background-color: inherit;
}

.code-tooltip-content a {
    color: var(--footnotes-highlight);
}

div.code-tooltip-content {
    box-shadow: 0 0 8px #00000045;
    background: var(--footnotes-bg-color);
}

.footnotes {
    opacity: 1;
}

.md-def-name:after {
    content: ". ^";
    color: var(--text-color);
}

.md-def-footnote .md-def-name:before {
    content: "";
    color: var(--text-color);
    position: absolute;
}

.md-def-name:before {
    content: "";
    color: var(--text-color);
    position: absolute;
}

.md-content.md-url, .md-def-content.md-def-url.md-auto-disp {
    text-decoration: none;
    border-bottom: .1rem solid var(--text-color);
}

.CodeMirror-scroll::-webkit-scrollbar {
    display: none;
}

.file-list-item-summary {
    font-size: 1em;
}

.pin-outline #outline-content .outline-active strong, .pin-outline .outline-active {
    font-weight: 500;
    color: var(--outline-active-color);
}

.file-list-item.active {
    border-left: 4px solid var(--drake-accent);
}

#md-searchpanel .btn:not(.close-btn):hover {
    box-shadow: none;
    background: var(--btn-hover-bg-color);
}

/*checkbox*/
#write input[type=checkbox] {
    opacity: 0;
    height: 1.6rem;
    width: 1.6rem;
    margin-left: -2em;
    margin-top: 0;
    top: 0;
}

#write .ul-list li.md-task-list-item.task-list-done::before {
    content: "";
    background: var(--checkbox-checked) 0 0 no-repeat;
    background-size: 100%;
    display: inline-block;
    position: absolute;
    height: 1.6rem;
    width: 1.6rem;
    margin-left: -2em;
}

#write .ul-list li.md-task-list-item.task-list-not-done::before {
    content: "";
    background: var(--checkbox-unchecked) 0 0 no-repeat;
    background-size: 100%;
    display: inline-block;
    position: absolute;
    height: 1.6rem;
    width: 1.6rem;
    margin-left: -2em;
}

/*insert table*/
.btn {
    border-radius: 2px;
}

.modal-content {
    border-radius: 8px;
}

.btn-primary:hover, .btn-primary:active {
    background-color: var(--btn-hover-bg-color);
    color: var(--drake-highlight);
}

.btn-primary {
    background-color: transparent;
    color: var(--drake-highlight);
}

.btn-default {
    background-color: transparent;
}

.btn:active {
    box-shadow: none;
    border-color: transparent;
}

.modal-footer {
    border-top: none;
}

#table-insert-col, #table-insert-row {
    background: var(--input-bg-color);
    border-radius: 2px;
}

/*preference panel*/
#megamenu-content {
    background-image: none !important;
    background-color: var(--bg-color);
}
#top-titlebar {
    height: inherit;
    background-color: var(--bg-color);
}
#megamenu-menu-sidebar {
    background-color: var(--bg-color);
    color: var(--text-color);
}
.long-btn {
    width: inherit;
    min-width: 300px;
    border: 1px solid var(--text-color);
    border-radius: 6px;
}
.megamenu-menu-panel h1 {
    margin-bottom: 3rem;
    text-align: left;
}
.megamenu-menu-panel h1, .megamenu-menu-panel h2 {
    font-weight: normal;
}
#recent-file-panel-search-input {
    height: 45px;
    border: none;
    border-bottom: 1px solid var(--text-color);
    padding-left: 8px;
}
#recent-file-panel-search-input::placeholder {
    color: var(--text-color);
    opacity: .5;
}
.megamenu-menu-header {
    border-bottom: none;
}
#recent-file-panel-action-btn {
    background: none;
    border: none;
}
#recent-file-panel-action-btn-container {
    float: none;
    display: inline-block;
}
#top-titlebar .toolbar-icon.btn.hover, #top-titlebar .toolbar-icon.btn:hover {
    background-color: var(--btn-hover-bg-color);
    color: var(--text-color);
}
.megamenu-menu-panel .btn:hover {
    background-color: var(--btn-hover-bg-color) !important;
    color: var(--text-color);
}
#recent-file-panel tbody tr:nth-child(2n-1),
.megamenu-menu-panel table thead,
.megamenu-menu-panel table tr {
    background-color: transparent;
}
.megamenu-menu-panel table {
    font-weight: normal;
}
#megamenu-back-btn {
    color: var(--text-color);
    border: 1px solid var(--text-color);
}
.megamenu-menu-header #megamenu-menu-header-title {
    color: var(--text-color);
}
header, .context-menu, .megamenu-content, footer {
    font-family: var(--text-font);
}
.ty-preferences select {
    padding-left: 2px;
}
.preference-item-hint {
    font-size: 14px;
}
a.ty-link {
    color: var(--a-color);
    margin: 0 .2rem;
}

/**
    code render
    Name: IntelliJ IDEA darcula theme
    From IntelliJ IDEA by JetBrains
 */
.cm-s-inner.CodeMirror {
    background: var(--code-block-bg-color);
    color: var(--code-block-color);
}

.cm-s-inner span.cm-meta {
    color: #BBB529;
}

.cm-s-inner span.cm-number {
    color: #6897BB;
}

.cm-s-inner span.cm-keyword {
    color: #CC7832;
}

.cm-s-inner span.cm-def {
    color: #FFD760;
}

.cm-s-inner span.cm-variable {
    color: var(--code-block-color);
}

.cm-s-inner span.cm-variable-2 {
    color: var(--code-block-color);
}

.cm-s-inner span.cm-variable-3 {
    color: #9876AA;
}

.cm-s-inner span.cm-type {
    color: #AABBCC;
}

.cm-s-inner span.cm-property {
    color: #FFC66D;
}

.cm-s-inner span.cm-operator {
    color: var(--code-block-color);
}

.cm-s-inner span.cm-string {
    color: #6A8759;
}

.cm-s-inner span.cm-string-2 {
    color: #6A8759;
}

.cm-s-inner span.cm-comment {
    color: #787878;
}

.cm-s-inner span.cm-link {
    color: #CC7832;
}

.cm-s-inner span.cm-atom {
    color: #CC7832;
}

.cm-s-inner span.cm-error {
    color: #BC3F3C;
}

.cm-s-inner span.cm-tag {
    color: #E8BF6A;
}

.cm-s-inner span.cm-quote {
    color: #a6e22e;
}

.cm-s-inner span.cm-attribute {
    color: #9876AA;
}

.cm-s-inner span.cm-qualifier {
    color: #6A8759;
}

.cm-s-inner span.cm-bracket {
    color: #E8BF6A;
}

.cm-s-inner span.cm-builtin {
    color: #FF9E59;
}

.cm-s-inner span.cm-special {
    color: #FF9E59;
}

.cm-s-inner span.cm-matchhighlight {
    color: #FFFFFF;
    background-color: rgba(50, 89, 48, .7);
    font-weight: normal;
}

.cm-s-inner span.cm-searching {
    color: #FFFFFF;
    background-color: rgba(61, 115, 59, .7);
    font-weight: normal;
}

.cm-s-inner .CodeMirror-gutters {
    border-right: 1px solid rgba(120, 120, 120, 0.3);
}

.cm-s-inner .CodeMirror-linenumber {
    color: #585b5d;
}

.cm-s-inner .CodeMirror-matchingbracket {
    background-color: #3B514D;
    color: #FFEF28 !important;
}

.cm-s-inner .CodeMirror-selected {
    background: #214283 !important;
}

.cm-s-inner .CodeMirror-selectedtext {
    background: #214283 !important;
}

.cm-s-typora-default .CodeMirror-selectedtext {
    background: var(--select-text-bg-color) !important;
}

.cm-overlay.CodeMirror-selectedtext {
    background: var(--select-text-bg-color) !important;
}

.cm-s-inner div.CodeMirror-cursor {
    border-left: 1px solid var(--code-block-color);
}/*# sourceURL=/Users/didi/Documents/Codes/Fun/lagou/public/drake-juejin.css*/</style></head>
<body>
  <div id="write"><h1>20 | SpringBoot 服务性能优化</h1><p data-nodeid="1385" class="">在开始对 SpringBoot 服务进行性能优化之前，你需要做一些准备，把 SpringBoot 服务的一些数据暴露出来。比如，你的服务用到了缓存，就需要把缓存命中率这些数据进行收集；用到了数据库连接池，就需要把连接池的参数给暴露出来。</p>
<p data-nodeid="1386">我们这里采用的监控工具是 Prometheus，它是一个是时序数据库，能够存储我们的指标。SpringBoot 可以非常方便地接入到 Prometheus 中。</p>
<h3 data-nodeid="1387">SpringBoot 如何开启监控？</h3>
<p data-nodeid="1388">创建一个 SpringBoot 项目后，首先加入 maven 依赖。</p>
<pre class="lang-js hljs" data-nodeid="1389"><code data-language="js">&lt;dependency&gt;
 &nbsp; &nbsp; <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span>
 &nbsp; &nbsp; <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span>
 &lt;/dependency&gt;
 <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
 &nbsp; &nbsp; <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.micrometer<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
 &nbsp; &nbsp; <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>micrometer-registry-prometheus<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span>
 <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
 &nbsp; &nbsp; <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.micrometer<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
 &nbsp; &nbsp; <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>micrometer-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span>
</code></pre>
<p data-nodeid="1390">然后，我们需要在 application.properties 配置文件中，开放相关的监控接口。</p>
<pre class="lang-js hljs" data-nodeid="1391"><code data-language="js">management.endpoint.metrics.enabled=<span class="hljs-literal">true</span>
management.endpoints.web.exposure.include=*
management.endpoint.prometheus.enabled=<span class="hljs-literal">true</span>
management.metrics.export.prometheus.enabled=<span class="hljs-literal">true</span>
</code></pre>
<p data-nodeid="1392">启动之后，我们就可以通过访问<a href="http://localhost:8080/actuator/prometheus" data-nodeid="1532">监控接口</a>来获取监控数据。</p>
<p data-nodeid="1393"><img src="https://s0.lgstatic.com/i/image/M00/50/07/CgqCHl9htcuAAw51AAK0O_g_pbM862.png" alt="Drawing 0.png" data-nodeid="1536"></p>
<p data-nodeid="1394">想要监控业务数据也是比较简单的，你只需要注入一个 MeterRegistry 实例即可，下面是一段示例代码：</p>
<pre class="lang-js hljs" data-nodeid="1395"><code data-language="js">@Autowired
MeterRegistry registry;

@GetMapping(<span class="hljs-string">"/test"</span>)
@ResponseBody
public <span class="hljs-built_in">String</span> test() {
 &nbsp; &nbsp;registry.counter(<span class="hljs-string">"test"</span>,
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="hljs-string">"from"</span>, <span class="hljs-string">"127.0.0.1"</span>,
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="hljs-string">"method"</span>, <span class="hljs-string">"test"</span>
 &nbsp;  ).increment();

 &nbsp; &nbsp;<span class="hljs-keyword">return</span> <span class="hljs-string">"ok"</span>;
}
</code></pre>
<p data-nodeid="1396">从监控连接中，我们可以找到刚刚添加的监控信息。</p>
<pre class="lang-js hljs" data-nodeid="1397"><code data-language="js">test_total{<span class="hljs-keyword">from</span>=<span class="hljs-string">"127.0.0.1"</span>,method=<span class="hljs-string">"test"</span>,} <span class="hljs-number">5.0</span>
</code></pre>
<p data-nodeid="1398">这里简单介绍一下流行的<strong data-nodeid="1544">Prometheus 监控体系</strong>，Prometheus 使用拉的方式获取监控数据，这个暴露数据的过程可以交给功能更加齐全的 telegraf 组件。</p>
<p data-nodeid="1399"><img src="https://s0.lgstatic.com/i/image/M00/50/07/CgqCHl9htdiAO89HAAK1NRYCNZE604.png" alt="Drawing 1.png" data-nodeid="1547"></p>
<p data-nodeid="1400">如上图，我们通常使用 Grafana 进行监控数据的展示，使用 AlertManager 组件进行提前预警。这一部分的搭建工作不是我们的重点，感兴趣的同学可自行研究。</p>
<p data-nodeid="1401">下图便是一张典型的监控图，可以看到 Redis 的缓存命中率等情况。</p>
<p data-nodeid="1402"><img src="https://s0.lgstatic.com/i/image/M00/4F/FB/Ciqc1F9htd-AXIKHAANYYdIDl6g753.png" alt="Drawing 2.png" data-nodeid="1552"></p>
<h3 data-nodeid="1403">Java 生成火焰图</h3>
<p data-nodeid="1404"><strong data-nodeid="1558">火焰图</strong>是用来分析程序运行瓶颈的工具。</p>
<p data-nodeid="1405">火焰图也可以用来分析 Java 应用。可以从 <a href="https://github.com/jvm-profiling-tools/async-profiler" data-nodeid="1562">github</a> 上下载 async-profiler 的压缩包进行相关操作。比如，我们把它解压到 /root/ 目录，然后以 javaagent 的方式来启动 Java 应用，命令行如下：</p>
<pre class="lang-js hljs" data-nodeid="1406"><code data-language="js">java -agentpath:<span class="hljs-regexp">/root/</span>build/libasyncProfiler.so=start,svg,file=profile.svg -jar spring-petclinic<span class="hljs-number">-2.3</span><span class="hljs-number">.1</span>.BUILD-SNAPSHOT.jar
</code></pre>
<p data-nodeid="1407">运行一段时间后，停止进程，可以看到在当前目录下，生成了 profile.svg 文件，这个文件是可以用浏览器打开的。<br>
如下图所示，纵向，表示的是调用栈的深度；横向，表明的是消耗的时间。所以格子的宽度越大，越说明它可能是一个瓶颈。一层层向下浏览，即可找到需要优化的目标。</p>
<p data-nodeid="1408"><img src="https://s0.lgstatic.com/i/image/M00/4F/FC/Ciqc1F9htfOAN3G1AEK7W4TM0AU264.gif" alt="2020-08-21 17-07-35.2020-08-21 17_12_29.gif" data-nodeid="1573"></p>
<h3 data-nodeid="1409">优化思路</h3>
<p data-nodeid="1410">对一个普通的 Web 服务来说，我们来看一下，要访问到具体的数据，都要经历哪些主要的环节？</p>
<p data-nodeid="1411">如下图，在浏览器中输入相应的域名，需要通过 DNS 解析到具体的 IP 地址上，为了保证高可用，我们的服务一般都会部署多份，然后使用 Nginx 做反向代理和负载均衡。</p>
<p data-nodeid="1412"><img src="https://s0.lgstatic.com/i/image/M00/4F/FC/Ciqc1F9htgCAcdwGAAIVQmXnOPo885.png" alt="Drawing 4.png" data-nodeid="1579"></p>
<p data-nodeid="1413">Nginx 根据资源的特性，会承担一部分动静分离的功能。其中，动态功能部分，会进入我们的SpringBoot 服务。</p>
<p data-nodeid="1414">SpringBoot 默认使用内嵌的 tomcat 作为 Web 容器，使用典型的 MVC 模式，最终访问到我们的数据。</p>
<h3 data-nodeid="1415">HTTP 优化</h3>
<p data-nodeid="1416">下面我们举例来看一下，哪些动作能够加快网页的获取。为了描述方便，我们仅讨论 HTTP1.1 协议的。</p>
<p data-nodeid="1417"><strong data-nodeid="1587">1.使用 CDN 加速文件获取</strong></p>
<p data-nodeid="1418">比较大的文件，尽量使用 CDN（Content Delivery Network）分发，甚至是一些常用的前端脚本、样式、图片等，都可以放到 CDN 上。CDN 通常能够加快这些文件的获取，网页加载也更加迅速。</p>
<p data-nodeid="1419"><strong data-nodeid="1592">2.合理设置 Cache-Control 值</strong></p>
<p data-nodeid="1420">浏览器会判断 HTTP 头 Cache-Control 的内容，用来决定是否使用浏览器缓存，这在管理一些静态文件的时候，非常有用，相同作用的头信息还有 Expires。Cache-Control 表示多久之后过期；Expires 则表示什么时候过期。</p>
<p data-nodeid="1421">这个参数可以在 Nginx 的配置文件中进行设置。</p>
<pre class="lang-dart hljs" data-nodeid="1422"><code data-language="dart">location ~* ^.+\.(ico|gif|jpg|jpeg|png)$ { 
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# 缓存<span class="hljs-number">1</span>年
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;add_header Cache-Control: no-cache, max-age=<span class="hljs-number">31536000</span>;
}
</code></pre>
<p data-nodeid="1423"><strong data-nodeid="1598">3.减少单页面请求域名的数量</strong></p>
<p data-nodeid="1424">减少每个页面请求的域名数量，尽量保证在 4 个之内。这是因为，浏览器每次访问后端的资源，都需要先查询一次 DNS，然后找到 DNS 对应的 IP 地址，再进行真正的调用。</p>
<p data-nodeid="1425">DNS 有多层缓存，比如浏览器会缓存一份、本地主机会缓存、ISP 服务商缓存等。从 DNS 到 IP 地址的转变，通常会花费 20-120ms 的时间。减少域名的数量，可加快资源的获取。</p>
<p data-nodeid="1426"><strong data-nodeid="1604">4.开启 gzip</strong></p>
<p data-nodeid="1427">开启 gzip，可以先把内容压缩后，浏览器再进行解压。由于减少了传输的大小，会减少带宽的使用，提高传输效率。</p>
<p data-nodeid="1428">在 nginx 中可以很容易地开启，配置如下：</p>
<pre class="lang-js hljs" data-nodeid="1429"><code data-language="js">gzip on;
gzip_min_length <span class="hljs-number">1</span>k;
gzip_buffers <span class="hljs-number">4</span> <span class="hljs-number">16</span>k;
gzip_comp_level <span class="hljs-number">6</span>;
gzip_http_version <span class="hljs-number">1.1</span>;
gzip_types text/plain application/javascript text/css;
</code></pre>
<p data-nodeid="1430"><strong data-nodeid="1610">5.对资源进行压缩</strong></p>
<p data-nodeid="1431">对 JavaScript 和 CSS，甚至是 HTML 进行压缩。道理类似，现在流行的前后端分离模式，一般都是对这些资源进行压缩的。</p>
<p data-nodeid="1432"><strong data-nodeid="1615">6.使用 keepalive</strong></p>
<p data-nodeid="1433">由于连接的创建和关闭，都需要耗费资源。用户访问我们的服务后，后续也会有更多的互动，所以保持长连接可以显著减少网络交互，提高性能。</p>
<p data-nodeid="1434">nginx 默认开启了对客户端的 keep avlide 支持，你可以通过下面两个参数来调整它的行为。</p>
<pre class="lang-js hljs" data-nodeid="1435"><code data-language="js">http {
 &nbsp; &nbsp;keepalive_timeout &nbsp;<span class="hljs-number">120</span>s <span class="hljs-number">120</span>s;
 &nbsp; &nbsp;keepalive_requests <span class="hljs-number">10000</span>;
}
</code></pre>
<p data-nodeid="1436">nginx 与后端 upstream 的长连接，需要手工开启，参考配置如下：</p>
<pre class="lang-js hljs" data-nodeid="1437"><code data-language="js">location ~ /{ 
 &nbsp; &nbsp; &nbsp; proxy_pass http:<span class="hljs-comment">//backend;</span>
 &nbsp; &nbsp; &nbsp; proxy_http_version <span class="hljs-number">1.1</span>;
 &nbsp; &nbsp; &nbsp; proxy_set_header Connection <span class="hljs-string">""</span>;
}
</code></pre>
<h3 data-nodeid="1438">自定义 Web 容器</h3>
<p data-nodeid="1439">如果你的项目并发量比较高，想要修改最大线程数、最大连接数等配置信息，可以通过自定义Web 容器的方式，代码如下所示。</p>
<pre class="lang-js hljs" data-nodeid="1440"><code data-language="js">@SpringBootApplication(proxyBeanMethods = <span class="hljs-literal">false</span>)
public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">App</span> <span class="hljs-title">implements</span> <span class="hljs-title">WebServerFactoryCustomizer</span>&lt;<span class="hljs-title">ConfigurableServletWebServerFactory</span>&gt; </span>{
    public <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> main(<span class="hljs-built_in">String</span>[] args) {
        SpringApplication.run(PetClinicApplication.class, args);
    }
    @Override
    public <span class="hljs-keyword">void</span> customize(ConfigurableServletWebServerFactory factory) {
        TomcatServletWebServerFactory f = (TomcatServletWebServerFactory) factory;
 &nbsp; &nbsp; &nbsp; &nbsp;f.setProtocol(<span class="hljs-string">"org.apache.coyote.http11.Http11Nio2Protocol"</span>);

        f.addConnectorCustomizers(c -&gt; {
            Http11NioProtocol protocol = (Http11NioProtocol) c.getProtocolHandler();
            protocol.setMaxConnections(<span class="hljs-number">200</span>);
            protocol.setMaxThreads(<span class="hljs-number">200</span>);
            protocol.setSelectorTimeout(<span class="hljs-number">3000</span>);
            protocol.setSessionTimeout(<span class="hljs-number">3000</span>);
            protocol.setConnectionTimeout(<span class="hljs-number">3000</span>);
        });
    }
}
</code></pre>
<p data-nodeid="1441">注意上面的代码，我们设置了它的协议为 org.apache.coyote.http11.Http11Nio2Protocol，意思就是开启了 Nio2。这个参数在 Tomcat 8.0之后才有，开启之后会增加一部分性能。<br>
对比如下（测试项目代码见 <a href="https://gitee.com/xjjdog/tuning-lagou-res/tree/master/tuning-020/spring-petclinic-main" data-nodeid="1626">spring-petclinic-main</a>）：</p>
<p data-nodeid="1442">默认。</p>
<pre class="lang-dart hljs" data-nodeid="1443"><code data-language="dart">[root<span class="hljs-meta">@localhost</span> wrk2-master]# ./wrk -t2 -c100 -d30s -R2000 http:<span class="hljs-comment">//172.16.1.57:8080/owners?lastName=</span>
Running <span class="hljs-number">30</span>s test @ http:<span class="hljs-comment">//172.16.1.57:8080/owners?lastName=</span>
 &nbsp;<span class="hljs-number">2</span> threads and <span class="hljs-number">100</span> connections
  Thread calibration: mean lat.: <span class="hljs-number">4588.131</span>ms, rate sampling interval: <span class="hljs-number">16277</span>ms
  Thread calibration: mean lat.: <span class="hljs-number">4647.927</span>ms, rate sampling interval: <span class="hljs-number">16285</span>ms
  Thread Stats &nbsp; Avg &nbsp; &nbsp;  Stdev &nbsp; &nbsp; Max &nbsp; +/- Stdev
 &nbsp;  Latency &nbsp; &nbsp;<span class="hljs-number">16.49</span>s &nbsp; &nbsp; <span class="hljs-number">4.98</span>s &nbsp; <span class="hljs-number">27.34</span>s &nbsp; &nbsp;<span class="hljs-number">63.90</span>%
 &nbsp;  Req/Sec &nbsp; <span class="hljs-number">106.50</span> &nbsp; &nbsp; &nbsp;<span class="hljs-number">1.50</span> &nbsp; <span class="hljs-number">108.00</span> &nbsp; &nbsp;<span class="hljs-number">100.00</span>%
 &nbsp;<span class="hljs-number">6471</span> requests <span class="hljs-keyword">in</span> <span class="hljs-number">30.03</span>s, <span class="hljs-number">39.31</span>MB read
  Socket errors: connect <span class="hljs-number">0</span>, read <span class="hljs-number">0</span>, write <span class="hljs-number">0</span>, timeout <span class="hljs-number">60</span>
Requests/sec: &nbsp; &nbsp;<span class="hljs-number">215.51</span>
Transfer/sec: &nbsp; &nbsp; &nbsp;<span class="hljs-number">1.31</span>MB
</code></pre>
<p data-nodeid="1444">Nio2。</p>
<pre class="lang-dart hljs" data-nodeid="1445"><code data-language="dart">[root<span class="hljs-meta">@localhost</span> wrk2-master]# ./wrk -t2 -c100 -d30s -R2000 http:<span class="hljs-comment">//172.16.1.57:8080/owners?lastName=</span>
Running <span class="hljs-number">30</span>s test @ http:<span class="hljs-comment">//172.16.1.57:8080/owners?lastName=</span>
 &nbsp;<span class="hljs-number">2</span> threads and <span class="hljs-number">100</span> connections
  Thread calibration: mean lat.: <span class="hljs-number">4358.805</span>ms, rate sampling interval: <span class="hljs-number">15835</span>ms
  Thread calibration: mean lat.: <span class="hljs-number">4622.087</span>ms, rate sampling interval: <span class="hljs-number">16293</span>ms
  Thread Stats &nbsp; Avg &nbsp; &nbsp;  Stdev &nbsp; &nbsp; Max &nbsp; +/- Stdev
 &nbsp;  Latency &nbsp; &nbsp;<span class="hljs-number">17.47</span>s &nbsp; &nbsp; <span class="hljs-number">4.98</span>s &nbsp; <span class="hljs-number">26.90</span>s &nbsp; &nbsp;<span class="hljs-number">57.69</span>%
 &nbsp;  Req/Sec &nbsp; <span class="hljs-number">125.50</span> &nbsp; &nbsp; &nbsp;<span class="hljs-number">2.50</span> &nbsp; <span class="hljs-number">128.00</span> &nbsp; &nbsp;<span class="hljs-number">100.00</span>%
 &nbsp;<span class="hljs-number">7469</span> requests <span class="hljs-keyword">in</span> <span class="hljs-number">30.04</span>s, <span class="hljs-number">45.38</span>MB read
  Socket errors: connect <span class="hljs-number">0</span>, read <span class="hljs-number">0</span>, write <span class="hljs-number">0</span>, timeout <span class="hljs-number">4</span>
Requests/sec: &nbsp; &nbsp;<span class="hljs-number">248.64</span>
Transfer/sec: &nbsp; &nbsp; &nbsp;<span class="hljs-number">1.51</span>MB
</code></pre>
<p data-nodeid="1446">你甚至可以将 tomcat 替换成 undertow。undertow 也是一个 Web 容器，更加轻量级一些，占用的内存更少，启动的守护进程也更少，更改方式如下：</p>
<pre class="lang-js hljs" data-nodeid="1447"><code data-language="js">&lt;dependency&gt;
 &nbsp; &nbsp; &nbsp;<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span>
 &nbsp; &nbsp; &nbsp;<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span>
 &nbsp; &nbsp; &nbsp;<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">exclusions</span>&gt;</span>
 &nbsp; &nbsp; &nbsp; &nbsp;<span class="hljs-tag">&lt;<span class="hljs-name">exclusion</span>&gt;</span>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
 &nbsp; &nbsp; &nbsp; &nbsp;<span class="hljs-tag">&lt;/<span class="hljs-name">exclusion</span>&gt;</span>
 &nbsp; &nbsp; &nbsp;<span class="hljs-tag">&lt;/<span class="hljs-name">exclusions</span>&gt;</span></span>
 &nbsp; &nbsp;&lt;/dependency&gt;
 &nbsp; &nbsp;<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
 &nbsp; &nbsp; &nbsp;<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
 &nbsp; &nbsp; &nbsp;<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-undertow<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
 &nbsp; &nbsp;<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span>
</code></pre>
<p data-nodeid="1448">其实，对于 tomcat 优化最为有效的，还是 JVM 参数的配置，你可以参考上一课时的内容进行调整。<br>
比如，使用下面的参数启动，QPS 由 248 上升到 308。</p>
<pre class="lang-js hljs" data-nodeid="1449"><code data-language="js">-XX:+UseG1GC -Xmx2048m -Xms2048m -XX:+AlwaysPreTouch
</code></pre>
<h3 data-nodeid="1450">Skywalking</h3>
<p data-nodeid="1451">对于一个 web 服务来说，最缓慢的地方就在于数据库操作。所以，使用“07 | 案例分析：无处不在的缓存，高并发系统的法宝”和“08 | 案例分析：Redis 如何助力秒杀业务”提供的本地缓存和分布式缓存优化，能够获得最大的性能提升。</p>
<p data-nodeid="1452">对于如何定位到复杂分布式环境中的问题，我这里想要分享另外一个工具：Skywalking。</p>
<p data-nodeid="1453">Skywalking 是使用探针技术（JavaAgent）来实现的。通过在 Java 的启动参数中，加入 javaagent 的 Jar 包，即可将性能数据和调用链数据封装，并发送到 Skywalking 的服务器。</p>
<p data-nodeid="1454">下载相应的安装包（如果使用 ES 存储，需要下载专用的安装包），配置好存储之后，即可一键启动。</p>
<p data-nodeid="1455">将 agent 的压缩包，解压到相应的目录。</p>
<pre class="lang-js hljs" data-nodeid="1456"><code data-language="js">tar xvf skywalking-agent.tar.gz &nbsp;-C /opt/
</code></pre>
<p data-nodeid="1457">在业务启动参数中加入 agent 的包。比如，原来的启动命令是：</p>
<pre class="lang-dart hljs" data-nodeid="1458"><code data-language="dart">java &nbsp;-jar /opt/test-service/spring-boot-demo.jar &nbsp;--spring.profiles.active=dev
</code></pre>
<p data-nodeid="1459">改造后的启动命令是：</p>
<pre class="lang-js hljs" data-nodeid="1460"><code data-language="js">java -javaagent:<span class="hljs-regexp">/opt/</span>skywalking-agent/skywalking-agent.jar -Dskywalking.agent.service_name=the-demo-name &nbsp;-jar /opt/test-service/spring-boot-demo.ja &nbsp;--spring.profiles.active=dev
</code></pre>
<p data-nodeid="1461">访问一些服务的链接，打开 Skywalking 的 UI，即可看到下图的界面。这些指标可以类比“01 | 理论分析：性能优化，有哪些衡量指标？需要注意什么？”提到的衡量指标去理解，我们就可以从图中找到响应比较慢 QPS 又比较高的接口，进行专项优化。</p>
<p data-nodeid="1462"><img src="https://s0.lgstatic.com/i/image/M00/4F/FD/Ciqc1F9htwyARKqMAAgxG3QYe8A553.png" alt="Drawing 5.png" data-nodeid="1651"></p>
<h3 data-nodeid="1463">各个层次的优化方向</h3>
<h4 data-nodeid="1464">1.Controller 层</h4>
<p data-nodeid="1465">controller 层用于接收前端的查询参数，然后构造查询结果。现在很多项目都采用前后端分离的架构，所以 controller 层的方法，一般会使用 @ResponseBody 注解，把查询的结果，解析成 JSON 数据返回（兼顾效率和可读性）。</p>
<p data-nodeid="1466">由于 controller 只是充当了一个类似功能组合和路由的角色，所以这部分对性能的影响就主要体现在数据集的大小上。如果结果集合非常大，JSON 解析组件就要花费较多的时间进行解析，</p>
<p data-nodeid="1467">大结果集不仅会影响解析时间，还会造成内存浪费。</p>
<p data-nodeid="1468">假如结果集在解析成 JSON 之前，占用的内存是 10MB，那么在解析过程中，有可能会使用 20M 或者更多的内存去做这个工作。</p>
<p data-nodeid="1469">我见过很多案例，由于返回对象的嵌套层次太深、引用了不该引用的对象（比如非常大的 byte[] 对象），造成了内存使用的飙升。</p>
<p data-nodeid="1470">所以，<strong data-nodeid="1667">对于一般的服务，保持结果集的精简，是非常有必要的</strong>，这也是 DTO（data transfer object）存在的必要。如果你的项目，返回的结果结构比较复杂，对结果集进行一次转换是非常有必要的。</p>
<h4 data-nodeid="1471">2.Service 层</h4>
<p data-nodeid="2425" class="">service 层用于处理具体的业务，大部分功能需求都是在这里完成的。service 层一般是使用单例模式，很少会保存状态，而且可以被 controller 复用。</p>


<p data-nodeid="1473">service 层的代码组织，对代码的可读性、性能影响都比较大。我们常说的设计模式，大多数都是针对 service 层来说的。</p>
<p data-nodeid="1474">service 层会频繁使用更底层的资源，通过组合的方式获取我们所需要的数据，大多数可以通过我们前面课时提供的优化思路进行优化。</p>
<p data-nodeid="1475">这里要着重提到的一点，就是分布式事务。</p>
<p data-nodeid="1476"><img src="https://s0.lgstatic.com/i/image/M00/50/08/CgqCHl9htvaAf1S-AAKlZCq3SXg275.png" alt="Drawing 6.png" data-nodeid="1675"></p>
<p data-nodeid="1477">如上图，四个操作分散在三个不同的资源中。要想达到一致性，需要三个不同的资源 MySQL、MQ、ElasticSearch 进行统一协调。它们底层的协议，以及实现方式，都是不一样的，那就无法通过 Spring 提供的 Transaction 注解来解决，需要借助外部的组件来完成。</p>
<p data-nodeid="1478">很多人都体验过，加入了一些保证一致性的代码，一压测，性能掉的惊掉下巴。分布式事务是性能杀手，因为它要使用额外的步骤去保证一致性，常用的方法有：两阶段提交方案、TCC、本地消息表、MQ 事务消息、分布式事务中间件等。</p>
<p data-nodeid="1479"><img src="https://s0.lgstatic.com/i/image/M00/4F/FD/Ciqc1F9htx6ADeh6AAFoqvxy4eM753.png" alt="Drawing 7.png" data-nodeid="1680"></p>
<p data-nodeid="1480">如上图，分布式事务要在改造成本、性能、时效等方面进行综合考虑。有一个介于分布式事务和非事务之间的名词，叫作<strong data-nodeid="1686">柔性事务</strong>。柔性事务的理念是将业务逻辑和互斥操作，从资源层上移至业务层面。</p>
<p data-nodeid="1481"><strong data-nodeid="1690">关于传统事务和柔性事务，我们来简单比较一下。</strong></p>
<p data-nodeid="1482"><strong data-nodeid="1694">ACID</strong></p>
<p data-nodeid="1483">关系数据库, 最大的特点就是事务处理, 即满足 ACID。</p>
<ul data-nodeid="1484">
<li data-nodeid="1485">
<p data-nodeid="1486">原子性（Atomicity）：事务中的操作要么都做，要么都不做。</p>
</li>
<li data-nodeid="1487">
<p data-nodeid="1488">一致性（Consistency）：系统必须始终处在强一致状态下。</p>
</li>
<li data-nodeid="1489">
<p data-nodeid="1490">隔离性（Isolation）：一个事务的执行不能被其他事务所干扰。</p>
</li>
<li data-nodeid="1491">
<p data-nodeid="1492">持久性（Durability）：一个已提交的事务对数据库中数据的改变是永久性的。</p>
</li>
</ul>
<p data-nodeid="1493"><strong data-nodeid="1703">BASE</strong></p>
<p data-nodeid="1494">BASE 方法通过牺牲一致性和孤立性来提高可用性和系统性能。</p>
<p data-nodeid="1495">BASE 为 Basically Available、Soft-state、Eventually consistent 三者的缩写，其中 BASE 分别代表：</p>
<ul data-nodeid="1496">
<li data-nodeid="1497">
<p data-nodeid="1498">基本可用（Basically Available）：系统能够基本运行、一直提供服务。</p>
</li>
<li data-nodeid="1499">
<p data-nodeid="1500">软状态（Soft-state）：系统不要求一直保持强一致状态。</p>
</li>
<li data-nodeid="1501">
<p data-nodeid="1502">最终一致性（Eventual consistency）：系统需要在某一时刻后达到一致性要求。</p>
</li>
</ul>
<p data-nodeid="1503">互联网业务，推荐使用补偿事务，完成最终一致性。比如，通过一系列的定时任务，完成对数据的修复。</p>
<h4 data-nodeid="1504">3.Dao 层</h4>
<p data-nodeid="1505">经过合理的数据缓存，我们都会尽量避免请求穿透到 Dao 层。除非你对 ORM 本身提供的缓存特性特别的熟悉；否则，都推荐你使用更加通用的方式去缓存数据。</p>
<p data-nodeid="1506">Dao 层，主要在于对 ORM 框架的使用上。比如，在 JPA 中，如果加了一对多或者多对多的映射关系，而又没有开启懒加载，级联查询的时候就容易造成深层次的检索，造成了内存开销大、执行缓慢的后果。</p>
<p data-nodeid="1507">在一些数据量比较大的业务中，多采用分库分表的方式。在这些分库分表组件中，很多简单的查询语句，都会被重新解析后分散到各个节点进行运算，最后进行结果合并。</p>
<p data-nodeid="1508">举个例子，select count(*) from a 这句简单的 count 语句，就可能将请求路由到十几张表中去运算，最后在协调节点进行统计，执行效率是可想而知的。目前，分库分表中间件，比较有代表性的是驱动层的 ShardingJdbc 和代理层的 MyCat，它们都有这样的问题。这些组件提供给使用者的视图是一致的，但我们在编码的时候，一定要注意这些区别。</p>
<h3 data-nodeid="1509">小结</h3>
<p data-nodeid="1510">下面我们来总结一下。</p>
<p data-nodeid="1511">本课时，我们简单看了一下 SpringBoot 常见的优化思路，然后介绍了三个新的性能分析工具。</p>
<ul data-nodeid="1512">
<li data-nodeid="1513">
<p data-nodeid="1514">一个是监控系统 Prometheus，可以看到一些具体的指标大小；</p>
</li>
<li data-nodeid="1515">
<p data-nodeid="1516">一个是火焰图，可以看到具体的代码热点；</p>
</li>
<li data-nodeid="1517">
<p data-nodeid="1518">一个是 Skywalking，可以分析分布式环境中的调用链。</p>
</li>
</ul>
<p data-nodeid="1519">SpringBoot 自身的 Web 容器是 Tomcat，那我们就可以通过对 Tomcat 的调优来获取性能提升。当然，对于服务上层的负载均衡 Nginx，我们也提供了一系列的优化思路。</p>
<p data-nodeid="1520">最后，我们看了在经典的 MVC 架构下，Controller、Service、Dao 的一些优化方向，并着重看了 Service 层的分布式事务问题。</p>
<p data-nodeid="1521">SpringBoot 作为一个广泛应用的服务框架，在性能优化方面已经做了很多工作，选用了很多高速组件。比如，数据库连接池默认使用 hikaricp，Redis 缓存框架默认使用 lettuce，本地缓存提供 caffeine 等。对于一个普通的数据库交互的 Web 服务来说，缓存是最主要的优化手段。</p>
<p data-nodeid="1522">但细节决定成败，05-19 课时的内容对性能优化都有借鉴意义。下一课时（也就是咱们专栏的最后一课时），我将从问题发现、目标制定、优化方式上进行整体性的总结。</p>
<p data-nodeid="1523" class=""><a href="https://wj.qq.com/s2/7200077/1134/" data-nodeid="1730">课程评价入口，挑选 5 名小伙伴赠送小礼品~</a></p></div>

</body></html>