<!DOCTYPE html><html lang="en"><head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>18 | 生产环境多数据源的处理方法有哪些？</title>
<style type="text/css">.hljs{display:block;overflow-x:auto;padding:.5em;color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}/*# sourceURL=/Users/young/Documents/Codes/Fun/lagou/public/atom-one-light.min.css*/</style><style type="text/css">/*
 * Copyright (C) 2018 Drake, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

:root {
    --monospace: "JetBrains Mono", HYZhengYuan, "Fira Code", Menlo, "Ubuntu Mono", Consolas; /*code font*/
    --text-font: var(--monospace); /*default font*/
    --title-font: var(--monospace); /*title font*/

    --text-color: #333333;
    --bg-color: #ffffff;
    --control-text-color: var(--text-color);
    --meta-content-color: var(--text-color);
    --active-file-border-color: var(--drake-accent);
    --rawblock-edit-panel-bd: var(--code-block-bg-color);
    --item-hover-bg-color: #E5E5E596;
    --active-file-bg-color: var(--item-hover-bg-color);

    --drake-accent: #e95f59;
    --drake-highlight: #d63200;
    --a-color: #036aca;
    --variable-color: var(--drake-highlight);
    --outline-active-color: var(--a-color);
    --code-block-bg-color: #2b2b2b;
    --code-block-color: #A9B7C6;
    --title-color: #135ce0;
    --blockquote-border-color: #b2aec5;
    --blockquote-color: #595959;
    --blockquote-bg-color: #fff9f9;
    --strong-color: var(--title-color);
    --h2-underline-color: var(--title-color);
    --horizontal-divider-color: var(--title-color);
    --height-light-color: var(--drake-highlight);
    --height-light-border-color: var(--drake-highlight);
    --yaml-color: #777777;
    --yaml-bg-color: #f7f7f7;
    --footnotes-bg-color: #3c3d3e;
    --footnotes-highlight: #FFD760;
    --table-border-color: #dfe2e5;
    --table-header-bg-color: #f6f8fa;
    --table-bg-color: var(--bg-color);
    --table-n2-bg-color: #f6f8fa;
    --input-bg-color: var(--item-hover-bg-color);
    --btn-hover-bg-color: var(--item-hover-bg-color);
    --checkbox-checked: url("data:image/svg+xml,%3Csvg class='icon' viewBox='0 0 1024 1024' xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Cpath d='M425.984 726.016l384-384-59.99-61.995-324.01 324.011-152.021-152.021L213.973 512zm384-598.016q36.01 0 61.013 25.984T896 213.974v596.01q0 34.005-25.003 59.99t-61.013 25.983h-596.01q-36.011 0-61.014-25.984t-25.003-59.989v-596.01q0-34.006 25.003-59.99T213.973 128h596.011z' fill='%2365b73b'/%3E%3C/svg%3E");
    --checkbox-unchecked: url("data:image/svg+xml,%3Csvg class='icon' viewBox='0 0 1024 1024' xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Cpath d='M810.667 213.333v597.334H213.333V213.333h597.334m0-85.333H213.333C166.4 128 128 166.4 128 213.333v597.334C128 857.6 166.4 896 213.333 896h597.334C857.6 896 896 857.6 896 810.667V213.333C896 166.4 857.6 128 810.667 128z' fill='%23333333'/%3E%3C/svg%3E");
}

html {
    font-size: 15px;
}

body {
    font-family: var(--text-font) !important;
    color: var(--text-color);
    -webkit-font-feature-settings: "liga" on, "calt" on;
    -webkit-font-smoothing: subpixel-antialiased;
    text-rendering: optimizeLegibility;
    letter-spacing: 0;
    margin: 0;
    overflow-x: hidden;
    line-height: 1.8rem;
}

img {
    max-width: 100%;
}

#write {
    background-image: linear-gradient(
            90deg
            ,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(
            1turn
            ,rgba(60,10,30,.04) 3%,transparent 0);
    background-size: 20px 20px;
    background-position: 50%;
}

/*code block*/
#write .md-fences {
    font-size: 1rem;
    padding: 0.5rem !important;
    border-radius: 2px;
    word-wrap: normal;
    background-color: var(--code-block-bg-color);
    color: var(--code-block-color);
    border: none;
}

/*code snippet*/
#write code, tt {
    border-radius: 2px;
    color: var(--drake-highlight);
}

/*variable*/
var {
    color: var(--variable-color);
    font-weight: bold;
}

/*raw block*/
.md-rawblock-control:not(.md-rawblock-tooltip) {
    border-radius: 2px 0 2px 2px;
    padding: 0.2rem !important;
}
.md-rawblock:hover > .md-rawblock-container {
    background: none;
}
.md-rawblock-input {
    font-size: 1rem;
}
.md-rawblock-tooltip-btn:hover {
    background: none;
}
.md-rawblock:hover > .md-rawblock-tooltip {
    border-radius: 2px 2px 0 0;
    margin-bottom: 2px !important;
}
.md-rawblock-tooltip.md-rawblock-control {
    border-radius: 2px 2px 0 0;
    color: var(--code-block-color);
}
.md-rawblock-tooltip-name {
    color: var(--code-block-color);
    opacity: 1;
}

/*quote block*/
blockquote:before {
    display: block;
    position: absolute;
    content: '';
    width: 4px;
    left: 0;
    top: 0;
    height: 100%;
    background-color: var(--blockquote-border-color);
    border-radius: 2px;
}

blockquote {
    color: var(--blockquote-color);
    border-radius: 2px;
    padding: 10px 16px;
    background-color: var(--blockquote-bg-color);
    position: relative;
    border-left: none;
}

#write strong {
    color: var(--strong-color);
    font-weight: bold;
}
#write blockquote strong {
    color: var(--blockquote-color);
}

/*link*/
#write a {
    color: var(--a-color);
    text-decoration: none;
}
#write a .md-plain, .md-htmlblock-container a:hover {
    border-bottom: .1rem solid var(--a-color);
}
[md-inline=link] a {
    margin: 0 .2rem;
}
a:any-link {
    color: var(--a-color);
}

img {
    border-left: none;
    border-right: none;
    vertical-align: baseline;
    border-radius: 2px;
}

#write {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px 30px 100px;
}
#typora-source .CodeMirror-lines {
    max-width: 1200px;
}

#write p {
    word-spacing: .05rem;
}

#write > ul:first-child,
#write > ol:first-child {
    margin-top: 30px;
}

body > *:first-child {
    margin-top: 0 !important;
}

body > *:last-child {
    margin-bottom: 0 !important;
}

h1,
h2,
h3,
h4,
h5,
h6 {
    font-family: var(--title-font);
    position: relative;
    margin-top: 2rem;
    margin-bottom: 1rem;
    font-weight: bold;
    cursor: text;
    color: var(--title-color);
}

h3.md-focus:before, h4.md-focus:before, h5.md-focus:before, h6.md-focus:before {
    visibility: hidden;
}

h1 {
    font-size: 1.6rem;
    text-align: center;
    margin-top: 0;
}

h2.md-end-block.md-heading {
    font-size: 1.6rem;
    display: inline-block;
}

h2.md-end-block.md-heading:after {
    display: block;
    content: '';
    height: 2px;
    margin-top: 4px;
    background-color: var(--h2-underline-color);
    border-radius: 2px;
}

h3 {
    font-size: 1.4rem;
}

h4 {
    font-size: 1.2rem;
}

h5 {
    font-size: 1rem;
}

h6 {
    font-size: 1rem;
}

h1:hover a.anchor,
h2:hover a.anchor,
h3:hover a.anchor,
h4:hover a.anchor,
h5:hover a.anchor,
h6:hover a.anchor {
    text-decoration: none;
}

h1 tt,
h1 code {
    font-size: inherit !important;
}

h2 tt,
h2 code {
    font-size: inherit !important;
}

h3 tt,
h3 code {
    font-size: inherit !important;
}

h4 tt,
h4 code {
    font-size: inherit !important;
}

h5 tt,
h5 code {
    font-size: inherit !important;
}

h6 tt,
h6 code {
    font-size: inherit !important;
}

blockquote,
ul,
ol,
dl,
table {
    margin: 0.8em 0;
}
p {
    margin: 0;
}

li > ol,
li > ul {
    margin: 0 0;
}

hr {
    height: 2px;
    padding: 0;
    margin: 16px 0;
    background-color: var(--horizontal-divider-color);
    border: 0 none;
    overflow: hidden;
    box-sizing: content-box;
}

body > h2:first-child {
    margin-top: 0;
    padding-top: 0;
}

body > h1:first-child {
    margin-top: 0;
    padding-top: 0;
}

body > h1:first-child + h2 {
    margin-top: 0;
    padding-top: 0;
}

body > h3:first-child,
body > h4:first-child,
body > h5:first-child,
body > h6:first-child {
    margin-top: 0;
    padding-top: 0;
}

a:first-child h1,
a:first-child h2,
a:first-child h3,
a:first-child h4,
a:first-child h5,
a:first-child h6 {
    margin-top: 0;
    padding-top: 0;
}

h1 p,
h2 p,
h3 p,
h4 p,
h5 p,
h6 p {
    margin-top: 0;
}

li p.first {
    display: inline-block;
}

ul, ol {
    padding-inline-start: 2em;
}

ul:first-child,
ol:first-child {
    margin-top: 0;
}

ul:last-child,
ol:last-child {
    margin-bottom: 0;
}

table {
    padding: 0;
    word-break: initial;
    background-color: var(--table-bg-color);
}
table tr {
    border-top: .1em solid var(--table-border-color);
    margin: 0;
    padding: 0;
}
table th {
    font-weight: bold;
    border: .1em solid var(--table-border-color);
    border-bottom: 0;
    margin: 0;
    padding: 6px 13px;
}
table td {
    border: .1em solid var(--table-border-color);
    margin: 0;
    padding: 6px 13px;
}
table thead {
    background-color: var(--table-header-bg-color);
}
table tr:nth-child(2n) {
    background-color: var(--table-n2-bg-color);
}
table tr th:first-child,
table tr td:first-child {
    margin-top: 0;
}
table tr th:last-child,
table tr td:last-child {
    margin-bottom: 0;
}

#write em {
    padding: 0 5px 0 2px;
}

/* height light */
#write mark {
    border: .1em solid var(--height-light-border-color);
    color: var(--height-light-color);
    background-color: transparent;
    padding: .1rem .5rem;
    border-radius: 2rem;
    margin: 0 .2rem;
    font-size: .95rem;
}

/*shortcut*/
kbd {
    border: .1em solid #5b5b5e;
    background: transparent;
    color: var(--text-color);
    margin: 0 .4rem;
    font-size: .95rem;
    padding: .3em .4em;
    border-radius: .4em;
    vertical-align: top;
    box-shadow: .1em .1em .2em rgba(0, 0, 0, 0.3);
}

#write del {
    padding: 1px 2px;
}

.md-task-list-item > input {
    margin-left: -1.3em;
}

@media print {
    html {
        font-size: 12px;
    }

    table,
    pre {
        page-break-inside: avoid;
    }

    pre {
        word-wrap: break-word;
    }
}

/*YAML*/
#write pre.md-meta-block {
    padding: 1rem;
    font-size: 1rem;
    background-color: var(--yaml-bg-color);
    border: 0;
    border-radius: 2px;
    color: var(--yaml-color);
    margin-top: 0 !important;
}

.mathjax-block > .code-tooltip {
    bottom: .375rem;
}

#write > h3.md-focus:before {
    left: -1.5625rem;
    top: .375rem;
}

#write > h4.md-focus:before {
    left: -1.5625rem;
    top: .285714286rem;
}

#write > h5.md-focus:before {
    left: -1.5625rem;
    top: .285714286rem;
}

#write > h6.md-focus:before {
    left: -1.5625rem;
    top: .285714286rem;
}

.md-image > .md-meta {
    border-radius: 2px;
    font-family: initial;
    padding: 2px 0 0 4px;
    color: inherit;
}

.md-tag {
    color: inherit;
}

.md-toc {
    margin-top: 20px;
    padding-bottom: 20px;
}

.typora-quick-open-item {
    font-size: 1rem !important;
    height: 50px;
    padding-left: 8px;
    padding-top: 4px;
    padding-bottom: 4px;
}

#typora-quick-open {
    box-shadow: 0 0 8px #00000045;
    padding: 0;
}

.ty-quick-open-category.ty-has-prev .ty-quick-open-category-title {
    border-top: none;
}

#typora-quick-open-input {
    margin: 8px;
    box-shadow: none;
    border-radius: 2px;
}

#typora-quick-open-input input {
    font-size: 1rem;
    box-shadow: none;
    padding-top: 2px;
    padding-left: 10px;
    padding-right: 10px;
    line-height: 32px;
    max-height: 32px;
    border: none;
}

.modal-dialog#typora-quick-open {
    border-radius: 8px;
}

.ty-quick-open-category-title {
    padding-left: 8px;
    color: #BEBEBE;
    font-size: 0.8rem;
    margin-bottom: 4px;
}

.typora-quick-open-item-path {
    font-size: 0.8rem;
    text-overflow: ellipsis;
    white-space: nowrap;
    margin-top: 1px;
}

/*search input*/
.form-control {
    border: none;
    border-radius: 2px;
    box-shadow: none;
}

#md-searchpanel .btn {
    border-radius: 2px;
}

#search-panel-replaceall-btn {
    padding-right: 5px !important;
    text-align: center !important;
}

#search-panel-replace-btn {
    text-align: center !important;
}

#md-searchpanel input {
    background: var(--input-bg-color);
    border-radius: 2px;
}

.searchpanel-search-option-btn {
    border-radius: 2px;
    border: none;
    background: transparent;
    color: var(--text-color);
}

.searchpanel-search-option-btn.active {
    background: var(--text-color);
    color: var(--bg-color);
}

.form-control:focus {
    box-shadow: none;
}

#md-notification:before {
    top: 10px;
}

/** focus mode */
.on-focus-mode blockquote {
    border-left-color: rgba(85, 85, 85, 0.12);
}

header,
.context-menu,
.megamenu-content,
footer {
    font-family: initial;
}

/*sidebar*/
.file-node-content:hover .file-node-icon,
.file-node-content:hover .file-node-open-state {
    visibility: visible;
}

#typora-sidebar {
    font-size: 1.1rem;
}

.sidebar-tabs {
    border-bottom: none;
}

.file-list-item-summary, .file-list-item-parent-loc, .file-list-item-time, .file-list-item-summary {
    font-size: 0.9rem !important;
    font-family: var(--text-font);
}

.file-list-item-file-ext-part {
    display: none;
}

.outline-item {
    font-size: 1rem;
}

/*footnotes mark*/
#write .md-footnote {
    background-color: inherit;
    color: var(--drake-highlight);
    font-size: 0.9rem;
    border-radius: 0.9rem;
    padding-left: 0;
}

#write .md-footnote:before {
    content: "[";
}

#write .md-footnote:after {
    content: "]";
}

/*footnotes content*/
.md-hover-tip .code-tooltip-content {
    border-radius: 2px;
}

/*footnotes title*/
span.md-def-name {
    padding-right: 3ch;
    padding-left: 0;
    position: relative;
    font-weight: normal;
}

/*footnotes desc*/
.footnotes {
    font-size: 1rem;
    font-weight: normal;
    color: var(--text-color);
    position: relative;
}

/*footnotes tooltip text*/
.code-tooltip-content .md-plain {
    font-size: 0.9rem;
    font-family: inherit;
}

.code-tooltip-content code {
    padding: 0 2px;
    font-family: inherit;
    color: var(--footnotes-highlight);
    background-color: inherit;
}

.code-tooltip-content a {
    color: var(--footnotes-highlight);
}

div.code-tooltip-content {
    box-shadow: 0 0 8px #00000045;
    background: var(--footnotes-bg-color);
}

.footnotes {
    opacity: 1;
}

.md-def-name:after {
    content: ". ^";
    color: var(--text-color);
}

.md-def-footnote .md-def-name:before {
    content: "";
    color: var(--text-color);
    position: absolute;
}

.md-def-name:before {
    content: "";
    color: var(--text-color);
    position: absolute;
}

.md-content.md-url, .md-def-content.md-def-url.md-auto-disp {
    text-decoration: none;
    border-bottom: .1rem solid var(--text-color);
}

.CodeMirror-scroll::-webkit-scrollbar {
    display: none;
}

.file-list-item-summary {
    font-size: 1em;
}

.pin-outline #outline-content .outline-active strong, .pin-outline .outline-active {
    font-weight: 500;
    color: var(--outline-active-color);
}

.file-list-item.active {
    border-left: 4px solid var(--drake-accent);
}

#md-searchpanel .btn:not(.close-btn):hover {
    box-shadow: none;
    background: var(--btn-hover-bg-color);
}

/*checkbox*/
#write input[type=checkbox] {
    opacity: 0;
    height: 1.6rem;
    width: 1.6rem;
    margin-left: -2em;
    margin-top: 0;
    top: 0;
}

#write .ul-list li.md-task-list-item.task-list-done::before {
    content: "";
    background: var(--checkbox-checked) 0 0 no-repeat;
    background-size: 100%;
    display: inline-block;
    position: absolute;
    height: 1.6rem;
    width: 1.6rem;
    margin-left: -2em;
}

#write .ul-list li.md-task-list-item.task-list-not-done::before {
    content: "";
    background: var(--checkbox-unchecked) 0 0 no-repeat;
    background-size: 100%;
    display: inline-block;
    position: absolute;
    height: 1.6rem;
    width: 1.6rem;
    margin-left: -2em;
}

/*insert table*/
.btn {
    border-radius: 2px;
}

.modal-content {
    border-radius: 8px;
}

.btn-primary:hover, .btn-primary:active {
    background-color: var(--btn-hover-bg-color);
    color: var(--drake-highlight);
}

.btn-primary {
    background-color: transparent;
    color: var(--drake-highlight);
}

.btn-default {
    background-color: transparent;
}

.btn:active {
    box-shadow: none;
    border-color: transparent;
}

.modal-footer {
    border-top: none;
}

#table-insert-col, #table-insert-row {
    background: var(--input-bg-color);
    border-radius: 2px;
}

/*preference panel*/
#megamenu-content {
    background-image: none !important;
    background-color: var(--bg-color);
}
#top-titlebar {
    height: inherit;
    background-color: var(--bg-color);
}
#megamenu-menu-sidebar {
    background-color: var(--bg-color);
    color: var(--text-color);
}
.long-btn {
    width: inherit;
    min-width: 300px;
    border: 1px solid var(--text-color);
    border-radius: 6px;
}
.megamenu-menu-panel h1 {
    margin-bottom: 3rem;
    text-align: left;
}
.megamenu-menu-panel h1, .megamenu-menu-panel h2 {
    font-weight: normal;
}
#recent-file-panel-search-input {
    height: 45px;
    border: none;
    border-bottom: 1px solid var(--text-color);
    padding-left: 8px;
}
#recent-file-panel-search-input::placeholder {
    color: var(--text-color);
    opacity: .5;
}
.megamenu-menu-header {
    border-bottom: none;
}
#recent-file-panel-action-btn {
    background: none;
    border: none;
}
#recent-file-panel-action-btn-container {
    float: none;
    display: inline-block;
}
#top-titlebar .toolbar-icon.btn.hover, #top-titlebar .toolbar-icon.btn:hover {
    background-color: var(--btn-hover-bg-color);
    color: var(--text-color);
}
.megamenu-menu-panel .btn:hover {
    background-color: var(--btn-hover-bg-color) !important;
    color: var(--text-color);
}
#recent-file-panel tbody tr:nth-child(2n-1),
.megamenu-menu-panel table thead,
.megamenu-menu-panel table tr {
    background-color: transparent;
}
.megamenu-menu-panel table {
    font-weight: normal;
}
#megamenu-back-btn {
    color: var(--text-color);
    border: 1px solid var(--text-color);
}
.megamenu-menu-header #megamenu-menu-header-title {
    color: var(--text-color);
}
header, .context-menu, .megamenu-content, footer {
    font-family: var(--text-font);
}
.ty-preferences select {
    padding-left: 2px;
}
.preference-item-hint {
    font-size: 14px;
}
a.ty-link {
    color: var(--a-color);
    margin: 0 .2rem;
}

/**
    code render
    Name: IntelliJ IDEA darcula theme
    From IntelliJ IDEA by JetBrains
 */
.cm-s-inner.CodeMirror {
    background: var(--code-block-bg-color);
    color: var(--code-block-color);
}

.cm-s-inner span.cm-meta {
    color: #BBB529;
}

.cm-s-inner span.cm-number {
    color: #6897BB;
}

.cm-s-inner span.cm-keyword {
    color: #CC7832;
}

.cm-s-inner span.cm-def {
    color: #FFD760;
}

.cm-s-inner span.cm-variable {
    color: var(--code-block-color);
}

.cm-s-inner span.cm-variable-2 {
    color: var(--code-block-color);
}

.cm-s-inner span.cm-variable-3 {
    color: #9876AA;
}

.cm-s-inner span.cm-type {
    color: #AABBCC;
}

.cm-s-inner span.cm-property {
    color: #FFC66D;
}

.cm-s-inner span.cm-operator {
    color: var(--code-block-color);
}

.cm-s-inner span.cm-string {
    color: #6A8759;
}

.cm-s-inner span.cm-string-2 {
    color: #6A8759;
}

.cm-s-inner span.cm-comment {
    color: #787878;
}

.cm-s-inner span.cm-link {
    color: #CC7832;
}

.cm-s-inner span.cm-atom {
    color: #CC7832;
}

.cm-s-inner span.cm-error {
    color: #BC3F3C;
}

.cm-s-inner span.cm-tag {
    color: #E8BF6A;
}

.cm-s-inner span.cm-quote {
    color: #a6e22e;
}

.cm-s-inner span.cm-attribute {
    color: #9876AA;
}

.cm-s-inner span.cm-qualifier {
    color: #6A8759;
}

.cm-s-inner span.cm-bracket {
    color: #E8BF6A;
}

.cm-s-inner span.cm-builtin {
    color: #FF9E59;
}

.cm-s-inner span.cm-special {
    color: #FF9E59;
}

.cm-s-inner span.cm-matchhighlight {
    color: #FFFFFF;
    background-color: rgba(50, 89, 48, .7);
    font-weight: normal;
}

.cm-s-inner span.cm-searching {
    color: #FFFFFF;
    background-color: rgba(61, 115, 59, .7);
    font-weight: normal;
}

.cm-s-inner .CodeMirror-gutters {
    border-right: 1px solid rgba(120, 120, 120, 0.3);
}

.cm-s-inner .CodeMirror-linenumber {
    color: #585b5d;
}

.cm-s-inner .CodeMirror-matchingbracket {
    background-color: #3B514D;
    color: #FFEF28 !important;
}

.cm-s-inner .CodeMirror-selected {
    background: #214283 !important;
}

.cm-s-inner .CodeMirror-selectedtext {
    background: #214283 !important;
}

.cm-s-typora-default .CodeMirror-selectedtext {
    background: var(--select-text-bg-color) !important;
}

.cm-overlay.CodeMirror-selectedtext {
    background: var(--select-text-bg-color) !important;
}

.cm-s-inner div.CodeMirror-cursor {
    border-left: 1px solid var(--code-block-color);
}/*# sourceURL=/Users/didi/Documents/Codes/Fun/lagou/public/drake-juejin.css*/</style></head>
<body>
  <div id="write"><h1>18 | 生产环境多数据源的处理方法有哪些？</h1><p data-nodeid="12437" class="">上一讲我们介绍了 DataSource 的相关内容，今天我们来介绍一下多数据源的处理方法有哪些。</p>


<p data-nodeid="11734">工作中我们时常会遇到跨数据库操作的情况，这时候就需要配置多数据源，那么如何配置呢？常用的方式及其背后的原理支撑是什么呢？我们下面来了解一下。</p>
<p data-nodeid="11735">首先看看两种常见的配置方式，分别为通过多个 @Configuration 文件、利用 AbstractRoutingDataSource 配置多数据源。</p>
<h3 data-nodeid="11736">第一种方式：多个数据源的 @Configuration 的配置方法</h3>
<p data-nodeid="11737">这种方式的主要思路是，不同 Package 下面的实体和 Repository 采用不同的 Datasource。所以我们改造一下我们的 example 目录结构，来看看不同 Repositories 的数据源是怎么处理的。</p>
<p data-nodeid="11738"><strong data-nodeid="11841">第一步：规划 Entity 和 Repository 的目录结构，为了方便配置多数据源。</strong></p>
<p data-nodeid="13363">将 User 和 UserAddress、UserRepository 和 UserAddressRepository 移动到 db1 里面；将 UserInfo 和 UserInfoRepository 移动到 db2 里面。如下图所示：</p>
<p data-nodeid="13364" class=""><img src="https://s0.lgstatic.com/i/image/M00/6C/C0/Ciqc1F-rk6mAO4voAAEl2cIHNqg269.png" alt="Drawing 0.png" data-nodeid="13368"></p>


<p data-nodeid="11741">我们把实体和 Repository 分别放到了 db1 和 db2 两个目录里面，这时我们假设数据源 1 是 MySQL，User 表和 UserAddress 在数据源 1 里面，那么我们需要配置一个 DataSource1 的 Configuration 类，并且在里面配置 DataSource、TransactionManager 和 EntityManager。</p>
<p data-nodeid="11742"><strong data-nodeid="11850">第二步：配置 DataSource1Config 类。</strong></p>
<p data-nodeid="11743">目录结构调整完之后，接下来我们开始配置数据源，完整代码如下：</p>
<pre class="lang-java hljs" data-nodeid="11744"><code data-language="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableTransactionManagement</span><span class="hljs-comment">//开启事务</span>
<span class="hljs-comment">//利用EnableJpaRepositories配置哪些包下面的Repositories，采用哪个EntityManagerFactory和哪个trannsactionManager</span>
<span class="hljs-meta">@EnableJpaRepositories(
      basePackages = {"com.example.jpa.example1.db1"},//数据源1的repository的包路径
      entityManagerFactoryRef = "db1EntityManagerFactory",//改变数据源1的EntityManagerFactory的默认值，改为db1EntityManagerFactory
      transactionManagerRef = "db1TransactionManager"//改变数据源1的transactionManager的默认值，改为db1TransactionManager
      )</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DataSource1Config</span> </span>{
   <span class="hljs-comment">/**
    * 指定数据源1的dataSource配置
    * <span class="hljs-doctag">@return</span>
    */</span>
   <span class="hljs-meta">@Primary</span>
   <span class="hljs-meta">@Bean(name = "db1DataSourceProperties")</span>
   <span class="hljs-meta">@ConfigurationProperties("spring.datasource1")</span> <span class="hljs-comment">//数据源1的db配置前缀采用spring.datasource1</span>
   <span class="hljs-function"><span class="hljs-keyword">public</span> DataSourceProperties <span class="hljs-title">dataSourceProperties</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DataSourceProperties();
   }
   <span class="hljs-comment">/**
    * 可以选择不同的数据源，这里我用HikariDataSource举例，创建数据源1
    * <span class="hljs-doctag">@param</span> db1DataSourceProperties
    * <span class="hljs-doctag">@return</span>
    */</span>
   <span class="hljs-meta">@Primary</span>
   <span class="hljs-meta">@Bean(name = "db1DataSource")</span>
   <span class="hljs-meta">@ConfigurationProperties(prefix = "spring.datasource.hikari.db1")</span> <span class="hljs-comment">//配置数据源1所用的hikari配置key的前缀</span>
   <span class="hljs-function"><span class="hljs-keyword">public</span> HikariDataSource <span class="hljs-title">dataSource</span><span class="hljs-params">(<span class="hljs-meta">@Qualifier("db1DataSourceProperties")</span> DataSourceProperties db1DataSourceProperties)</span> </span>{
      HikariDataSource dataSource = db1DataSourceProperties.initializeDataSourceBuilder().type(HikariDataSource.class).build();
      <span class="hljs-keyword">if</span> (StringUtils.hasText(db1DataSourceProperties.getName())) {
         dataSource.setPoolName(db1DataSourceProperties.getName());
      }
      <span class="hljs-keyword">return</span> dataSource;
   }
   <span class="hljs-comment">/**
    * 配置数据源1的entityManagerFactory命名为db1EntityManagerFactory，用来对实体进行一些操作
    * <span class="hljs-doctag">@param</span> builder
    * <span class="hljs-doctag">@param</span> db1DataSource entityManager依赖db1DataSource
    * <span class="hljs-doctag">@return</span>
    */</span>
   <span class="hljs-meta">@Primary</span>
   <span class="hljs-meta">@Bean(name = "db1EntityManagerFactory")</span>
   <span class="hljs-function"><span class="hljs-keyword">public</span> LocalContainerEntityManagerFactoryBean <span class="hljs-title">entityManagerFactory</span><span class="hljs-params">(EntityManagerFactoryBuilder builder, <span class="hljs-meta">@Qualifier("db1DataSource")</span> DataSource db1DataSource)</span> </span>{
      <span class="hljs-keyword">return</span> builder.dataSource(db2DataSource)
.packages(<span class="hljs-string">"com.example.jpa.example1.db1"</span>) <span class="hljs-comment">//数据1的实体所在的路径</span>
.persistenceUnit(<span class="hljs-string">"db1"</span>)<span class="hljs-comment">// persistenceUnit的名字采用db1</span>
.build();
   }
   <span class="hljs-comment">/**
    * 配置数据源1的事务管理者，命名为db1TransactionManager依赖db1EntityManagerFactory
    * <span class="hljs-doctag">@param</span> db1EntityManagerFactory 
    * <span class="hljs-doctag">@return</span>
    */</span>
   <span class="hljs-meta">@Primary</span>
   <span class="hljs-meta">@Bean(name = "db1TransactionManager")</span>
   <span class="hljs-function"><span class="hljs-keyword">public</span> PlatformTransactionManager <span class="hljs-title">transactionManager</span><span class="hljs-params">(<span class="hljs-meta">@Qualifier("db1EntityManagerFactory")</span> EntityManagerFactory db1EntityManagerFactory)</span> </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> JpaTransactionManager(db1EntityManagerFactory);
   }
}
</code></pre>
<p data-nodeid="13835">到这里，数据源 1 我们就配置完了，下面再配置数据源 2。</p>
<p data-nodeid="13836"><strong data-nodeid="13841">第三步：配置 DataSource2Config类，加载数据源 2。</strong></p>

<pre class="lang-java hljs" data-nodeid="11746"><code data-language="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableTransactionManagement</span><span class="hljs-comment">//开启事务</span>
<span class="hljs-comment">//利用EnableJpaRepositories，配置哪些包下面的Repositories，采用哪个EntityManagerFactory和哪个trannsactionManager</span>
<span class="hljs-meta">@EnableJpaRepositories(
        basePackages = {"com.example.jpa.example1.db2"},//数据源2的repository的包路径
        entityManagerFactoryRef = "db2EntityManagerFactory",//改变数据源2的EntityManagerFactory的默认值，改为db2EntityManagerFactory
        transactionManagerRef = "db2TransactionManager"//改变数据源2的transactionManager的默认值，改为db2TransactionManager
)</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DataSource2Config</span> </span>{
    <span class="hljs-comment">/**
     * 指定数据源2的dataSource配置
     *
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-meta">@Bean(name = "db2DataSourceProperties")</span>
    <span class="hljs-meta">@ConfigurationProperties("spring.datasource2")</span> <span class="hljs-comment">//数据源2的db配置前缀采用spring.datasource2</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> DataSourceProperties <span class="hljs-title">dataSourceProperties</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DataSourceProperties();
    }
    <span class="hljs-comment">/**
     * 可以选择不同的数据源，这里我用HikariDataSource举例，创建数据源2
     *
     * <span class="hljs-doctag">@param</span> db2DataSourceProperties
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-meta">@Bean(name = "db2DataSource")</span>
    <span class="hljs-meta">@ConfigurationProperties(prefix = "spring.datasource.hikari.db2")</span> <span class="hljs-comment">//配置数据源2的hikari配置key的前缀</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> HikariDataSource <span class="hljs-title">dataSource</span><span class="hljs-params">(<span class="hljs-meta">@Qualifier("db2DataSourceProperties")</span> DataSourceProperties db2DataSourceProperties)</span> </span>{
        HikariDataSource dataSource = db2DataSourceProperties.initializeDataSourceBuilder().type(HikariDataSource.class).build();
        <span class="hljs-keyword">if</span> (StringUtils.hasText(db2DataSourceProperties.getName())) {
            dataSource.setPoolName(db2DataSourceProperties.getName());
        }
        <span class="hljs-keyword">return</span> dataSource;
    }
    <span class="hljs-comment">/**
     * 配置数据源2的entityManagerFactory命名为db2EntityManagerFactory，用来对实体进行一些操作
     *
     * <span class="hljs-doctag">@param</span> builder
     * <span class="hljs-doctag">@param</span> db2DataSource entityManager依赖db2DataSource
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-meta">@Bean(name = "db2EntityManagerFactory")</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> LocalContainerEntityManagerFactoryBean <span class="hljs-title">entityManagerFactory</span><span class="hljs-params">(EntityManagerFactoryBuilder builder, <span class="hljs-meta">@Qualifier("db2DataSource")</span> DataSource db2DataSource)</span> </span>{
        <span class="hljs-keyword">return</span> builder.dataSource(db2DataSource)
            .packages(<span class="hljs-string">"com.example.jpa.example1.db2"</span>) <span class="hljs-comment">//数据2的实体所在的路径</span>
            .persistenceUnit(<span class="hljs-string">"db2"</span>)<span class="hljs-comment">// persistenceUnit的名字采用db2</span>
            .build();
    }
    <span class="hljs-comment">/**
     * 配置数据源2的事务管理者，命名为db2TransactionManager依赖db2EntityManagerFactory
     *
     * <span class="hljs-doctag">@param</span> db2EntityManagerFactory
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-meta">@Bean(name = "db2TransactionManager")</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> PlatformTransactionManager <span class="hljs-title">transactionManager</span><span class="hljs-params">(<span class="hljs-meta">@Qualifier("db2EntityManagerFactory")</span> EntityManagerFactory db2EntityManagerFactory)</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> JpaTransactionManager(db2EntityManagerFactory);
    }
}
</code></pre>
<p data-nodeid="14308">这一步你需要注意，DataSource1Config 和 DataSource2Config 不同的是，1 里面每个 @Bean 都 @Primary，而 2 里面不是的。</p>
<p data-nodeid="14309"><strong data-nodeid="14314">第四步：通过 application.properties 配置两个数据源的值，代码如下：</strong></p>

<pre class="lang-java hljs" data-nodeid="11748"><code data-language="java">###########datasource1 采用Mysql数据库
spring.datasource1.url=jdbc:mysql://localhost:3306/test2?logger=Slf4JLogger&amp;profileSQL=true
spring.datasource1.username=root
spring.datasource1.password=root
##数据源1的连接池的名字
spring.datasource.hikari.db1.pool-name=jpa-hikari-pool-db1
##最长生命周期15分钟够了
spring.datasource.hikari.db1.maxLifetime=900000
spring.datasource.hikari.db1.maximumPoolSize=8
###########datasource2 采用h2内存数据库
spring.datasource2.url=jdbc:h2:~/test
spring.datasource2.username=sa
spring.datasource2.password=sa
##数据源2的连接池的名字
spring.datasource.hikari.db2.pool-name=jpa-hikari-pool-db2
##最长生命周期15分钟够了
spring.datasource.hikari.db2.maxLifetime=500000
##最大连接池大小和数据源1区分开，我们配置成6个
spring.datasource.hikari.db2.maximumPoolSize=6
</code></pre>
<p data-nodeid="11749"><strong data-nodeid="11867">第五步：我们写个 Controller 测试一下。</strong></p>
<pre class="lang-java hljs" data-nodeid="11750"><code data-language="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserController</span> </span>{
   <span class="hljs-meta">@Autowired</span>
   <span class="hljs-keyword">private</span> UserRepository userRepository;
   <span class="hljs-meta">@Autowired</span>
   <span class="hljs-keyword">private</span> UserInfoRepository userInfoRepository;
   <span class="hljs-comment">//操作user的Repository</span>
   <span class="hljs-meta">@PostMapping("/user")</span>
   <span class="hljs-function"><span class="hljs-keyword">public</span> User <span class="hljs-title">saveUser</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> User user)</span> </span>{
      <span class="hljs-keyword">return</span> userRepository.save(user);
   }
   <span class="hljs-comment">//操作userInfo的Repository</span>
  <span class="hljs-meta">@PostMapping("/user/info")</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> UserInfo <span class="hljs-title">saveUserInfo</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> UserInfo userInfo)</span> </span>{
     <span class="hljs-keyword">return</span> userInfoRepository.save(userInfo);
  }
}
</code></pre>
<p data-nodeid="11751"><strong data-nodeid="11871">第六步：直接启动我们的项目，测试一下。</strong></p>
<p data-nodeid="15231">请看这一步的启动日志：</p>
<p data-nodeid="15928" class=""><img src="https://s0.lgstatic.com/i/image/M00/6C/CC/CgqCHl-rk8WAV0LYAAIUPl37DVs337.png" alt="Drawing 1.png" data-nodeid="15931"><br>
<img src="https://s0.lgstatic.com/i/image/M00/6C/CC/CgqCHl-rk8qAZkCgAAHBFDKIWG0269.png" alt="Drawing 2.png" data-nodeid="15935"></p>





<p data-nodeid="16860">可以看到启动的是两个数据源，其对应的连接池的监控也是不一样的：数据源 1 有 8 个，数据源 2 有 6 个。</p>
<p data-nodeid="16861" class=""><img src="https://s0.lgstatic.com/i/image/M00/6C/CC/CgqCHl-rk8-AK9nMAABPduIgKR4098.png" alt="Drawing 3.png" data-nodeid="16865"></p>


<p data-nodeid="11757">如果我们分别请求 Controller 写的两个方法的时候，也会分别插入到不同的数据源里面去。</p>
<p data-nodeid="11758">通过上面的六个步骤你应该知道了如何配置多数据源，那么它的原理基础是什么呢？我们看一下</p>
<p data-nodeid="11759">Datasource 与 TransactionManager、EntityManagerFactory 的关系和职责分别是怎么样的。</p>
<h4 data-nodeid="11760">Datasource 与 TransactionManager、EntityManagerFactory 的关系分析</h4>
<p data-nodeid="17790">我们通过一个类的关系图来分析一下：</p>
<p data-nodeid="17791" class=""><img src="https://s0.lgstatic.com/i/image/M00/6C/CC/CgqCHl-rk9aAfRipAAB6oNvBMnM239.png" alt="Drawing 4.png" data-nodeid="17795"></p>


<p data-nodeid="11763">其中，</p>
<ol data-nodeid="11764">
<li data-nodeid="11765">
<p data-nodeid="11766">HikariDataSource 负责实现 DataSource，交给 EntityManager 和 TransactionManager 使用；</p>
</li>
<li data-nodeid="11767">
<p data-nodeid="11768">EntityManager 是利用 Datasouce 来操作数据库，而其实现类是 SessionImpl；</p>
</li>
<li data-nodeid="11769">
<p data-nodeid="11770">EntityManagerFactory 是用来管理和生成 EntityManager 的，而 EntityManagerFactory 的实现类是 LocalContainerEntityManagerFactoryBean，通过实现 FactoryBean<entitymanagerfactory> 接口实现，利用了 FactoryBean 的 Spring 中的 bean 管理机制，所以需要我们在 Datasource1Config 里面配置 LocalContainerEntityManagerFactoryBean 的 bean 的注入方式；</entitymanagerfactory></p>
</li>
<li data-nodeid="11771">
<p data-nodeid="11772">JpaTransactionManager 是用来管理事务的，实现了 TransactionManager 并且通过 EntityFactory 和 Datasource 进行 db 操作，所以我们要在 DataSourceConfig 里面告诉 JpaTransactionManager 用的 TransactionManager 是 db1EntityManagerFactory。</p>
</li>
</ol>
<p data-nodeid="11773">上一讲我们介绍了 Datasource 的默认加载和配置方式，那么默认情况下 Datasource 的 EntityManagerFactory 和 TransactionManager 是怎么加载和配置的呢？</p>
<h4 data-nodeid="11774">默认的 JpaBaseConfiguration 的加载方式分析</h4>
<p data-nodeid="18720">上一讲我只简单说明了 DataSource 的配置，其实我们还可以通过 HibernateJpaConfiguration，找到父类 JpaBaseConfiguration 类，如图所示：</p>
<p data-nodeid="18721" class=""><img src="https://s0.lgstatic.com/i/image/M00/6C/C1/Ciqc1F-rk-GAXBLMAABJWH1P9Qs574.png" alt="Drawing 5.png" data-nodeid="18725"></p>


<p data-nodeid="19650">接着打开 JpaBaseConfiguration 就可以看到多数据源的参考原型，如下图所示：</p>
<p data-nodeid="19651" class=""><img src="https://s0.lgstatic.com/i/image/M00/6C/C1/Ciqc1F-rk-iAMO5TAAIqJTa-4bI250.png" alt="Drawing 6.png" data-nodeid="19655"></p>


<p data-nodeid="11779">通过上面的代码，可以看到在单个数据源情况下的 EntityManagerFactory 和 TransactionManager 的加载方法，并且我们在多数据源的配置里面还加载了一个类：EntityManagerFactoryBuilder entityManagerFactoryBuilder，也正是从上面的方法加载进去的，看第 120 行代码就知道了。</p>
<p data-nodeid="11780">那么除了上述的配置多数据源的方式，还有没有其他方法了呢？我们接着看一下。</p>
<h3 data-nodeid="11781">第二种方式：利用 AbstractRoutingDataSource 配置多数据源</h3>
<p data-nodeid="11782">我们都知道 DataSource 的本质是获得数据库连接，而 AbstractRoutingDataSource 帮我们实现了动态获得数据源的可能性。下面还是通过一个例子看一下它是怎么使用的。</p>
<p data-nodeid="11783"><strong data-nodeid="11915">第一步：定一个数据源的枚举类，用来标示数据源有哪些。</strong></p>
<pre class="lang-java hljs" data-nodeid="11784"><code data-language="java"><span class="hljs-comment">/**
 * 定义一个数据源的枚举类
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> RoutingDataSourceEnum {
   DB1, <span class="hljs-comment">//实际工作中枚举的语义可以更加明确一点；</span>
   DB2;
   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> RoutingDataSourceEnum <span class="hljs-title">findbyCode</span><span class="hljs-params">(String dbRouting)</span> </span>{
      <span class="hljs-keyword">for</span> (RoutingDataSourceEnum e : values()) {
         <span class="hljs-keyword">if</span> (e.name().equals(dbRouting)) {
            <span class="hljs-keyword">return</span> e;
         }
      }
      <span class="hljs-keyword">return</span> db1;<span class="hljs-comment">//没找到的情况下，默认返回数据源1</span>
   }
}
</code></pre>
<p data-nodeid="11785"><strong data-nodeid="11919">第二步：新增 DataSourceRoutingHolder，用来存储当前线程需要采用的数据源。</strong></p>
<pre class="lang-java hljs" data-nodeid="11786"><code data-language="java"><span class="hljs-comment">/**
 * 利用ThreadLocal来存储，当前的线程使用的数据
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DataSourceRoutingHolder</span> </span>{
   <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ThreadLocal&lt;RoutingDataSourceEnum&gt; threadLocal = <span class="hljs-keyword">new</span> ThreadLocal&lt;&gt;();
   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setBranchContext</span><span class="hljs-params">(RoutingDataSourceEnum dataSourceEnum)</span> </span>{
      threadLocal.set(dataSourceEnum);
   }
   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> RoutingDataSourceEnum <span class="hljs-title">getBranchContext</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">return</span> threadLocal.get();
   }
   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">clearBranchContext</span><span class="hljs-params">()</span> </span>{
      threadLocal.remove();
   }
}
</code></pre>
<p data-nodeid="11787"><strong data-nodeid="11923">第三步：配置 RoutingDataSourceConfig，用来指定哪些 Entity 和 Repository 采用动态数据源。</strong></p>
<pre class="lang-java hljs" data-nodeid="11788"><code data-language="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableTransactionManagement</span>
<span class="hljs-meta">@EnableJpaRepositories(
      //数据源的repository的包路径，这里我们覆盖db1和db2的包路径
      basePackages = {"com.example.jpa.example1"},
      entityManagerFactoryRef = "routingEntityManagerFactory",
      transactionManagerRef = "routingTransactionManager"
)</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RoutingDataSourceConfig</span> </span>{
   <span class="hljs-meta">@Autowired</span>
   <span class="hljs-meta">@Qualifier("db1DataSource")</span>
   <span class="hljs-keyword">private</span> DataSource db1DataSource;
   <span class="hljs-meta">@Autowired</span>
   <span class="hljs-meta">@Qualifier("db2DataSource")</span>
   <span class="hljs-keyword">private</span> DataSource db2DataSource;
   <span class="hljs-comment">/**
    * 创建RoutingDataSource，引用我们之前配置的db1DataSource和db2DataSource
    *
    * <span class="hljs-doctag">@return</span>
    */</span>
   <span class="hljs-meta">@Bean(name = "routingDataSource")</span>
   <span class="hljs-function"><span class="hljs-keyword">public</span> DataSource <span class="hljs-title">dataSource</span><span class="hljs-params">()</span> </span>{
      Map&lt;Object, Object&gt; dataSourceMap = Maps.newHashMap();
      dataSourceMap.put(RoutingDataSourceEnum.DB1, db1DataSource);
      dataSourceMap.put(RoutingDataSourceEnum.DB2, db2DataSource);
      RoutingDataSource routingDataSource = <span class="hljs-keyword">new</span> RoutingDataSource();
      <span class="hljs-comment">//设置RoutingDataSource的默认数据源</span>
      routingDataSource.setDefaultTargetDataSource(db1DataSource);
      <span class="hljs-comment">//设置RoutingDataSource的数据源列表</span>
      routingDataSource.setTargetDataSources(dataSourceMap);
      <span class="hljs-keyword">return</span> routingDataSource;
   }
   <span class="hljs-comment">/**
    * 类似db1和db2的配置，唯一不同的是，这里采用routingDataSource
    * <span class="hljs-doctag">@param</span> builder
    * <span class="hljs-doctag">@param</span> routingDataSource entityManager依赖routingDataSource
    * <span class="hljs-doctag">@return</span>
    */</span>
   <span class="hljs-meta">@Bean(name = "routingEntityManagerFactory")</span>
   <span class="hljs-function"><span class="hljs-keyword">public</span> LocalContainerEntityManagerFactoryBean <span class="hljs-title">entityManagerFactory</span><span class="hljs-params">(EntityManagerFactoryBuilder builder, <span class="hljs-meta">@Qualifier("routingDataSource")</span> DataSource routingDataSource)</span> </span>{
      <span class="hljs-keyword">return</span> builder.dataSource(routingDataSource).packages(<span class="hljs-string">"com.example.jpa.example1"</span>) <span class="hljs-comment">//数据routing的实体所在的路径，这里我们覆盖db1和db2的路径</span>
            .persistenceUnit(<span class="hljs-string">"db-routing"</span>)<span class="hljs-comment">// persistenceUnit的名字采用db-routing</span>
            .build();
   }
   <span class="hljs-comment">/**
    * 配置数据的事务管理者，命名为routingTransactionManager依赖routtingEntityManagerFactory
    *
    * <span class="hljs-doctag">@param</span> routingEntityManagerFactory
    * <span class="hljs-doctag">@return</span>
    */</span>
   <span class="hljs-meta">@Bean(name = "routingTransactionManager")</span>
   <span class="hljs-function"><span class="hljs-keyword">public</span> PlatformTransactionManager <span class="hljs-title">transactionManager</span><span class="hljs-params">(<span class="hljs-meta">@Qualifier("routingEntityManagerFactory")</span> EntityManagerFactory routingEntityManagerFactory)</span> </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> JpaTransactionManager(routingEntityManagerFactory);
   }
}
</code></pre>
<p data-nodeid="11789">路由数据源配置与 DataSource1Config 和 DataSource2Config 有相互覆盖关系，这里我们直接覆盖 db1 和 db2 的包路径，以便于我们的动态数据源生效。</p>
<p data-nodeid="11790"><strong data-nodeid="11928">第四步：写一个 MVC 拦截器，用来指定请求分别采用什么数据源。</strong></p>
<p data-nodeid="11791">新建一个类 DataSourceInterceptor，用来在请求前后指定数据源，请看代码：</p>
<pre class="lang-java hljs" data-nodeid="11792"><code data-language="java"><span class="hljs-comment">/**
 * 动态路由的实现逻辑，我们通过请求里面的db-routing，来指定此请求采用什么数据源
 */</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DataSourceInterceptor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">HandlerInterceptorAdapter</span> </span>{
   <span class="hljs-comment">/**
    * 请求处理之前更改线程里面的数据源
    */</span>
   <span class="hljs-meta">@Override</span>
   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">preHandle</span><span class="hljs-params">(HttpServletRequest request,
                      HttpServletResponse response, Object handler)</span> <span class="hljs-keyword">throws</span> Exception </span>{
      String dbRouting = request.getHeader(<span class="hljs-string">"db-routing"</span>);
      DataSourceRoutingHolder.setBranchContext(RoutingDataSourceEnum.findByCode(dbRouting));
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.preHandle(request, response, handler);
   }
   <span class="hljs-comment">/**
    * 请求结束之后清理线程里面的数据源
    */</span>
   <span class="hljs-meta">@Override</span>
   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">afterCompletion</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="hljs-keyword">throws</span> Exception </span>{
      <span class="hljs-keyword">super</span>.afterCompletion(request, response, handler, ex);
      DataSourceRoutingHolder.clearBranchContext();
   }
}
</code></pre>
<p data-nodeid="11793">同时我们需要在实现 WebMvcConfigurer 的配置里面，把我们自定义拦截器 dataSourceInterceptor 加载进去，代码如下：</p>
<pre class="lang-java hljs" data-nodeid="11794"><code data-language="java"><span class="hljs-comment">/**
 * 实现WebMvcConfigurer
 */</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyWebMvcConfigurer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">WebMvcConfigurer</span> </span>{
   <span class="hljs-meta">@Autowired</span>
   <span class="hljs-keyword">private</span> DataSourceInterceptor dataSourceInterceptor;
   <span class="hljs-comment">//添加自定义拦截器</span>
   <span class="hljs-meta">@Override</span>
   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addInterceptors</span><span class="hljs-params">(InterceptorRegistry registry)</span> </span>{
      registry.addInterceptor(dataSourceInterceptor).addPathPatterns(<span class="hljs-string">"/**"</span>);
      WebMvcConfigurer.<span class="hljs-keyword">super</span>.addInterceptors(registry);
   }
...<span class="hljs-comment">//其他不变的代码省略}</span>
</code></pre>
<p data-nodeid="20122">此处我们采用的是 MVC 的拦截器机制动态改变的数据配置，你也可以使用自己的 AOP 任意的拦截器，如事务拦截器、Service 的拦截器等，都可以实现。需要注意的是，要在开启事务之前配置完毕。</p>
<p data-nodeid="20123"><strong data-nodeid="20128">第五步：启动测试。</strong></p>

<p data-nodeid="11796">我们在 Http 请求头里面加上 db-routing：DB2，那么本次请求就会采用数据源 2 进行处理，请求代码如下：</p>
<pre class="lang-java hljs" data-nodeid="11797"><code data-language="java">POST /user/info HTTP/<span class="hljs-number">1.1</span>
Host: <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">8089</span>
Content-Type: application/json
db-routing: DB2
Cache-Control: no-cache
Postman-Token: <span class="hljs-number">56</span>d8dc02-<span class="hljs-number">7f</span>3e-<span class="hljs-number">7</span>b95-<span class="hljs-number">7f</span>f1-<span class="hljs-number">572</span>a4bb7d102
{<span class="hljs-string">"ages"</span>:<span class="hljs-number">10</span>}
</code></pre>
<p data-nodeid="11798">通过上面五个步骤，我们可以利用 AbstractRoutingDataSource 实现动态数据源，实际工作中可能会比我讲述的要复杂，有的需要考虑多线程、线程安全等问题，你要多加注意。<br>
在实际应用场景中，对于多数据源的问题，我还有一些思考，下面分享给你。</p>
<h3 data-nodeid="11799">微服务下多数据源的思考：还需要这样用吗？</h3>
<p data-nodeid="11800">通过上面的两种方式，我们分别可以实现同一个 application 应用的多数据源配置，那么有什么注意事项呢？我简单总结如下几点建议。</p>
<h4 data-nodeid="11801">多数据源实战注意事项</h4>
<ol data-nodeid="21053">
<li data-nodeid="21054">
<p data-nodeid="21055">此种方式利用了当前线程事务不变的原理，所以要注意异步线程的处理方式；</p>
</li>
<li data-nodeid="21056">
<p data-nodeid="21057">此种方式利用了 DataSource 的原理，动态地返回不同的 db 连接，一般需要在开启事务之前使用，需要注意事务的生命周期；</p>
</li>
<li data-nodeid="21058">
<p data-nodeid="21059">比较适合读写操作分开的业务场景；</p>
</li>
<li data-nodeid="21060">
<p data-nodeid="21061">多数据的情况下，避免一个事务里面采用不同的数据源，这样会有意想不到的情况发生，比如死锁现象；</p>
</li>
<li data-nodeid="21062">
<p data-nodeid="21063">学会通过日志检查我们开启请求的方法和开启的数据源是否正确，可以通过 Debug 断点来观察数据源是否选择的正确，如下图所示：</p>
</li>
</ol>
<p data-nodeid="21064" class=""><img src="https://s0.lgstatic.com/i/image/M00/6C/CC/CgqCHl-rlAGARlxqAAVdbojSwxw751.png" alt="Drawing 7.png" data-nodeid="21072"></p>

<h4 data-nodeid="20595">微服务下的实战建议</h4>



<p data-nodeid="11816">在实际工作中，为了便捷省事，更多开发者喜欢配置多个数据源，但是我强烈建议不要在对用户直接提供的 API 服务上面配置多数据源，否则将出现令人措手不及的 Bug。</p>
<p data-nodeid="11817">如果你是做后台管理界面，供公司内部员工使用的，那么这种 API 可以为了方便而使用多数据源。</p>
<p data-nodeid="11818">微服务的大环境下，服务越小，内聚越高，低耦合服务越健壮，所以一般跨库之间一定是是通过 REST 的 API 协议，进行内部服务之间的调用，这是最稳妥的方式，原因有如下几点：</p>
<ol data-nodeid="11819">
<li data-nodeid="11820">
<p data-nodeid="11821">REST 的 API 协议更容易监控，更容易实现事务的原子性；</p>
</li>
<li data-nodeid="11822">
<p data-nodeid="11823">db 之间解耦，使业务领域代码职责更清晰，更容易各自处理各种问题；</p>
</li>
<li data-nodeid="11824">
<p data-nodeid="11825">只读和读写的 API 更容易分离和管理。</p>
</li>
</ol>
<h3 data-nodeid="21772">总结</h3>




<p data-nodeid="11828">到这里，这一讲的内容就结束了。多数据的配置是一个比较复杂的事情，在本讲中我通过两种方式，带领你自定义 entityManager 和 transactionManager，实现了多数据源的配置。如果对此你有不懂的地方，欢迎你在下方留言，我会尽快给你回复。</p>
<p data-nodeid="22236" class="te-preview-highlight">此外，你需要掌握的一个简单的基础知识，就是线程、事务和数据源之间的关系。下一讲我们再详细分析一下事务中需要我们关心的内容有哪些。</p>

<blockquote data-nodeid="11830">
<p data-nodeid="11831">点击下方链接查看源码（不定时更新）<br>
<a href="https://github.com/zhangzhenhuajack/spring-boot-guide/tree/master/spring-data/spring-data-jpa" data-nodeid="11966">https://github.com/zhangzhenhuajack/spring-boot-guide/tree/master/spring-data/spring-data-jpa</a></p>
</blockquote></div>

</body></html>